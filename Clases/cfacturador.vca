SCCTEXT Version 4.0.0.2
PLATFORM C(8,0),UNIQUEID C(10,0),TIMESTAMP N(10,0),CLASS M(4,0),CLASSLOC M(4,0),BASECLASS M(4,0),OBJNAME M(4,0),PARENT M(4,0),PROPERTIES M(4,0),PROTECTED M(4,0),METHODS M(4,0),OBJCODE M(4,0),OLE M(4,0),OLE2 M(4,0),RESERVED1 M(4,0),RESERVED2 M(4,0),RESERVED3 M(4,0),RESERVED4 M(4,0),RESERVED5 M(4,0),RESERVED6 M(4,0),RESERVED7 M(4,0),RESERVED8 M(4,0),USER M(4,0)
1252

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] Class     
[START RESERVED1]
VERSION =   3.00[END RESERVED1]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3KQ1C2BFR
[CLASS] custom
[BASECLASS] custom
[OBJNAME] facturador
[START PROPERTIES]
Height = 15
Width = 98
cantidadultima = .F.
fraccionultima = .F.
pcansumatotales = 0
dirwebservice = .F.
Name = "facturador"
[END PROPERTIES]
[START METHODS]
PROCEDURE Destroy
RELEASE aVendedor, aCondipag, aListaPrecios, aBodega, aSucursales, aDocumentoRef, aEdoRes

ENDPROC
PROCEDURE Init
PUBLIC oHTTP
oHTTP = CREATEOBJECT('MSXML2.XMLHTTP.6.0')

vArcViaUsado=.f.
IF USED("ARCVIA") THEN
	vArcViaUsado=.t.
ELSE
	vTablaSelec=ADDBS(ALLTRIM(StdViaLoc))+"ARCVIA.DBF"
	USE &vTablaSelec IN 0
ENDIF

GO TOP IN ArcVia
This.DirWebService=ALLTRIM(UPPER(ArcVia.Ruta1))

IF !vArcViaUsado THEN
	USE IN ArcVia
ENDIF

This.pActivaParametrosIniciales()

ENDPROC
PROCEDURE backuprutina1c
LPARAMETERS vpCodigo, vpFecha,;
			vpCantidad, vpFraccion, ;
			vpDscto, vpRecargo, ;
			vpPrecio, ;
			vpProveedor, vpTipo, vpLinea, vpDsctoCab, vpDsctoMonCab, vpRecCab, vpRecMonCab, vpDetalle,;
			vpBodega, vpBodegaIN, vpTipoGuia, vpTipoDsctoRecCabecera, vCodIad, vRet

IF !USED("ITEMCUR") .and. !USED("DSCCUR") THEN
	=MESSAGEBOX("No se encuentran uno o mas cursores")
	RETURN .f.
ENDIF

vPrecioOriginal=vpPrecio

CALCULATE SUM(Afecto) TO vSumaAfectosExistente IN ItemCur FOR ItemCur.Exento=0

IF vpLinea=0 THEN
	CALCULATE MAX(Linea) TO vMaximaLinea IN ItemCur
	vSiguienteLinea=vMaximaLinea+1
ELSE
	vSiguienteLinea=vpLinea
ENDIF

STORE "" TO vProductoIla, vUnidadMedida
STORE 0 TO vUnidadesXenvase
STORE 0 TO vPorcentajeListaEspecial, vPorcentajeRegla
STORE 0 TO vMontoILA, vPorcentajeILA
STORE 0 TO vMontoDscto, vMontoFlete, vMontoExento, ;
		   vMontoAfecto, vPrecioNeto, vPrecioNetoDetalle, ;
		   vMontoDsctoCabecera
		
STORE "N" TO vProductoExento, vNoApliDes
vDocGuia=.f.

IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vDocExento=TipoDoc.Exento	
	vDocGuia=TipoDoc.Traslado
ELSE
	=MESSAGEBOX("El Tipo de Documento no es valido")
	RETURN .f.
ENDIF

vProsigueDescuentos=.f.

IF vDocGuia THEN
	IF !vpTipoGuia THEN
		vProsigueDescuentos=.t.
	ENDIF
ELSE
	vProsigueDescuentos=.t.
ENDIF

vPrecioEspecialCliente =0
vPrecioOriginalEspecial=0

IF !EMPTY(ALLTRIM(vpCodigo)) THEN
	IF !SEEK(vpCodigo, "PRODUCTO", 1) THEN
		=MESSAGEBOX("Producto no se encuentra en Maestra de Productos, no es posible Actualizar")
		RETURN .f.
	ENDIF

	vUnidadMedida	=Producto.prUnimed
*	vProductoIla	=Producto.TipoIla
	vProductoExento	=Producto.Exento
	
	IF Producto.UnixEnv<=0 THEN
		vUnidadesXenvase=1
	ELSE
		vUnidadesXenvase=Producto.UnixEnv
	ENDIF

*	vPrecioOriginal=vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)) &&&& Cambio para verificar si sirve
	vPrecioOriginal=This.mRedondeo(vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)))

	********** Localiza Impuesto Adicionales que se puedan cargar
	vBndIla=.f.
	IF !EMPTY(ALLTRIM(vpTipo)) THEN
		IF vgTipoDoc="BO" THEN
			IF prPrm.BolIla THEN
				vBndIla=.t.
			ENDIF
		ELSE
			vBndIla=.t.
		ENDIF
	ENDIF

	IF vBndIla THEN
		IF VAL(vProductoIla)!=0 THEN
			IF SEEK(VAL(vProductoIla),"IMPTOADIC",1) THEN
				IF ImptoAdic.EdoImpto THEN
					vPorcentajeIla=ImptoAdic.Monto
				ENDIF
			ENDIF
		ENDIF
	ENDIF

	IF Producto.TipoFlete>0 THEN
		IF Producto.TipoFlete=1 THEN
			vMontoFlete=This.mRedondeo(vPrecioOriginal*(Producto.Flete2/100))
		ELSE
			vMontoFlete=Producto.Flete
		ENDIF
	ENDIF

	vPrecioNeto=vPrecioOriginal+vMontoFlete
	vNoApliDes=Producto.noApliDes
	
	
	IF Producto.noApliDes="S" THEN
		DELETE FROM DscCur WHERE CodPro=vpCodigo
*!*		ELSE
*!*			IF vProsigueDescuentos THEN

*!*				********* Inicia Busqueda de Descuento x Precio Especial.
*!*				IF !EMPTY(ALLTRIM(vpProveedor)) .and. VAL(vpListaPrecios)!=0 THEN 	
*!*					IF SEEK(vpProveedor, "PROVEEDO",1) THEN
*!*						SELECT NumCon, Descto, fdeIni, fdeFin, valPro ;
*!*							FROM mPrecios ;
*!*							LEFT JOIN mContrat ON mPrecios.NumCon=mContrat.Numero ;
*!*							WHERE mPrecios.RutCli=vpProveedor .and. mPrecios.CodPro=vpCodigo .and. ;
*!*								  mPrecios.CodSuc=vpSucursal .and. ;
*!*								  vpFecha>=mPrecios.fdeIni .and. vpFecha<=mPrecios.fdeFin .and. ;
*!*								  mContrat.tiPrec=vpListaPrecios ;
*!*							ORDER BY NumCon ;
*!*							INTO CURSOR cListaEspecial READWRITE

*!*						SELECT cListaEspecial
*!*						INDEX on NumCon TAG NumCon
*!*							
*!*						vCantidadPreciosEspeciales=_Tally
*!*						
*!*						IF vCantidadPreciosEspeciales>0 THEN
*!*							IF vCantidadPreciosEspeciales>1 THEN
*!*								bResultadoPreciosEspeciales=""
*!*								DO FORM wSelPrecioEspecial TO bResultadoPreciosEspeciales
*!*								
*!*								IF !EMPTY(ALLTRIM(bResultadoPreciosEspeciales)) THEN
*!*									IF SEEK(bResultadoPreciosEspeciales, "cLISTAESPECIAL",1) THEN
*!*										vPorcentajeListaEspecial=cListaEspecial.Descto
*!*										vPrecioEspecialCliente=cListaEspecial.ValPro
*!*									ELSE
*!*										vPorcentajeListaEspecial=0
*!*									ENDIF
*!*								ELSE
*!*									vPorcentajeListaEspecial=0
*!*								ENDIF
*!*							ELSE
*!*								GO TOP IN cListaEspecial
*!*								vPorcentajeListaEspecial=cListaEspecial.Descto
*!*								vPrecioEspecialCliente=cListaEspecial.ValPro
*!*							ENDIF
*!*						ENDIF
*!*						
*!*						************** Verificacion de Dscto x Reglas Comerciales					
*!*						IF Clientes.afRegla THEN
*!*							IF Producto.afRegla THEN
*!*								vUnixEnv=Producto.UnixEnv
*!*								SELECT R02CodReg as IDRegla, R02FecIni as FecIni, R02FecFin as FecFin,;
*!*									   R01PorDes as Descuento ;
*!*									FROM Reglas02 ;
*!*									LEFT JOIN Reglas01 ON Reglas02.r02CodReg=Reglas01.R01CodReg ;
*!*									WHERE vpFechaDoc>=Reglas02.R02FecIni .and. ;
*!*										  vpFechaDoc<=Reglas02.R02FecFin .and. ;
*!*										  Reglas02.R02CodPro=vpCodPro .and. ;
*!*										  ((vpCantidad*vUnixEnv)+vpFraccion)>=((Reglas01.R01CanPro*vUnixEnv)+Reglas01.R01FraPro) ;
*!*									ORDER BY VAL(IdRegla) ;
*!*									INTO CURSOR cPorcentajeRegla
*!*										
*!*								IF _Tally>0 THEN
*!*									GO BOTTOM in cPorcentajeRegla
*!*									vPorcentajeRegla=cPorcentajeReglas.Descuento
*!*								ENDIF
*!*							ENDIF
*!*						ENDIF
*!*					ENDIF
*!*				ENDIF
*!*			ENDIF
	ENDIF
ELSE
	vUnidadMedida="UN"
	vUnidadesXenvase=1
	vProductoIla=""
	vPrecioNeto=vpPrecio*vpCantidad
	vPrecioOriginal=vpPrecio*vpCantidad
	vPrecioNetoDetalle=vPrecioNeto
	vPrecioEspecialCliente=0
ENDIF

*!*	IF vPrecioEspecialCliente!=0 THEN
*!*		vPrecioOriginal=This.mRedondeo(vPrecioEspecialCliente*(vpCantidad+(vpFraccion/vUnidadesXenvase)))
*!*		vPrecioNeto=vPrecioOriginal+vMontoFlete
*!*		vPrecioOriginalEspecial=vPrecioEspecialCliente
*!*	ENDIF
	
*!*	IF vProsigueDescuentos THEN
*!*		IF (vpDscto+vPorcentajeListaEspecial+vPorcentajeRegla)>100 THEN
*!*			=MESSAGEBOX("(000002). Descuentos son Mayores que el 100%"+CHR(13)+;
*!*						" - Descuento x Lista Precios Especiales: "+ALLTRIM(STR(vPorcentajeListaEspecial,7,3))+CHR(13)+;
*!*						" - Descuento x Regla Comercial: "+ALLTRIM(STR(vPorcentajeRegla,7,3))+CHR(13)+;
*!*						" - Descuento x Linea: "+ALLTRIM(STR(vpDscto,7,3)))
*!*			RETURN .f.
*!*		ENDIF

*!*		IF vMontoFlete>0 THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 7, vMontoFlete, vpCodigo, vpFecha, 2)
*!*		ENDIF

*!*		IF vPorcentajeListaEspecial>0 .and. vNoApliDes!="S" THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 1, vPorcentajeListaEspecial, ;
*!*								This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100)), ;
*!*								vpCodigo, vpFecha, 1)
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100))
*!*		ENDIF

*!*		IF vPorcentajeRegla>0 .and. vNoApliDes!="S" THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 2, vPorcentajeRegla, ;
*!*								This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100)), ;
*!*								vpCodigo, vpFecha,1)
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100))
*!*		ENDIF

*!*		IF vpDscto>0 .and. vNoApliDes!="S" THEN
*!*			IF !SEEK(STR(vSiguienteLinea,4)+"3","DSCCUR",3) THEN
*!*				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*							VALUES (vSiguienteLinea, 3, vpDscto, ;
*!*									This.mRedondeo(vPrecioNeto*(vpDscto/100)), ;
*!*									vpCodigo, vpFecha,1)
*!*			ELSE 	
*!*				Replace PorDsc WITH vpDscto, ;
*!*						MonDsc WITH This.mRedondeo(vPrecioNeto*(vpDscto/100)) IN DscCur
*!*			ENDIF
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vpDscto/100))
*!*		ENDIF

*!*	*	vPrecioNetoDetalle=vPrecioNeto-vMontoDscto

*!*		IF (vpDsctoCab>0 .or. vpDsctoMonCab>0) .and. vNoApliDes!="S" THEN
*!*			vContinuaDsctoCab=.f.
*!*			IF vpTipoDsctoCabecera THEN
*!*		*!*			IF vDocExento THEN
*!*		*!*				vContinuaDsctoCab=.t.
*!*		*!*			ENDIF
*!*		*!*		ELSE
*!*				IF vProductoExento!="E" THEN
*!*					vContinuaDsctoCab=.t.
*!*				ENDIF
*!*			ELSE
*!*				IF vDocExento THEN
*!*					vContinuaDsctoCab=.t.
*!*				ELSE
*!*					IF vProductoExento="E" THEN
*!*						vContinuaDsctoCab=.t.
*!*					ENDIF 		
*!*				ENDIF
*!*			ENDIF
*!*			
*!*			IF vContinuaDsctoCab THEN
*!*				IF vpDsctoMonCab>0 THEN
*!*					vDsctoCab=This.mRedondeo((vpDsctoMonCab*100)/(vSumaAfectosExistente+vPrecioNeto))
*!*				ELSE
*!*					vDsctoCab=vpDsctoCab
*!*				ENDIF
*!*				
*!*				vMontoDsctoCabecera=This.mRedondeo((vPrecioNeto-vMontoDscto)*(vpDsctoCab/100))

*!*				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*							VALUES (vSiguienteLinea, 7, vDsctoCab, vMontoDsctoCabecera, vpCodigo, vpFecha,1)
*!*			ENDIF
*!*			
*!*			vPrecioNetoFinal=(vPrecioNeto-vMontoDscto)-vMontoDsctoCabecera
*!*		ELSE
*!*			vPrecioNetoFinal=vPrecioNeto-vMontoDscto
*!*		ENDIF
*!*	ELSE
	vPrecioNetoFinal=vPrecioNeto	
*!*	ENDIF

vPrecioNetoDetalle=vPrecioNeto-vMontoDscto

**** Variable que indica si el documento admite o no, la asignacion de los valores Exento o IVA
*!*	vVarExentoIVA=.t.
*!*	IF vDocGuia .and. vpTipoGuia THEN
*!*		vVarExentoIVA=.f.
*!*	ENDIF

IF !(EMPTY(vCodIad) OR EMPTY(ImptoAdic.Monto))
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 5, ImptoAdic.Monto, ;
						This.mRedondeo(IIF(!vRet, vPrecioNetoFinal, (vPrecioNetoFinal * (-1)))*(ImptoAdic.Monto/100)), ;
						vpCodigo, vpFecha, 2, VCodIad)
ELSE
	STORE '' TO	VCodIad
ENDIF
	
IF vPorcentajeILA>0 THEN
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 5, vPorcentajeIla, ;
						This.mRedondeo(vPrecioNetoFinal*(vPorcentajeIla/100)), ;
						vpCodigo, vpFecha, 2, VCodIad)
ENDIF 	

IF vDocExento THEN
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 8, 0, vPrecioNetoFinal, vpCodigo, vpFecha, 2, '')
	vMontoExento=vPrecioNetoFinal
ELSE
	IF vProductoExento="E" THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
					VALUES (vSiguienteLinea, 8, 0, vPrecioNetoFinal, vpCodigo, vpFecha, 2, '')
		vMontoExento=vPrecioNetoFinal
	ELSE
*		IF vVarExentoIVA THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
						VALUES (vSiguienteLinea, 6, vgTasaIVA,;
								This.mRedondeo(vPrecioNetoFinal*(vgTasaIva/100)), ;
								vpCodigo, vpFecha, 2, '')		
*		ENDIF
	ENDIF 	
ENDIF

*!*	vPrecioOriginal	= El Precio Inicial de 1 producto (s/g Maestra de Productos) por las Cantidades a Vender
*!*	vPrecioNeto		= vPrecioOriginal + Monto Flete (Cargo)
*!*	vpPrecio		= Precio individual de 1 producto como esta en la MAestra de Precios a nivel NETO
*!*	vPrecioNetoFinal= vPrecioOriginal - DescuentosLinea - DescuentosCabecera

IF vMontoExento=0 THEN
	vMontoAfecto=vPrecioNetoFinal
ENDIF


*vPrecioOriginalEspecial=vPrecioEspecialCliente

*!*	IF vPrecioEspecialCliente!=0 THEN
*!*		INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
*!*							 Subtot, Afecto, Detalle, Unimed, CodIla, Exento, Bodega, ;
*!*							 BodegaIN, noApliDes, Envase, NetoDetalle) ;
*!*					VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioNeto, ;
*!*							 vSiguienteLinea, vPrecioOriginalEspecial, IIF(vMontoExento=0,vPrecioOriginal,0), ;
*!*							 vMontoAfecto, ALLTRIM(vpDetalle), ;
*!*							 vUnidadMedida, vProductoIla, vMontoExento, ;
*!*							 vpBodega, vpBodegaIN, vNoApliDes, vUnidadesXenvase, vPrecioNetoDetalle)
*!*	ELSE
	INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						 Subtot, Afecto, Detalle, Unimed, CodIla, Exento, Bodega, ;
						 BodegaIN, noApliDes, Envase, NetoDetalle, Cod_Iad) ;
				VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioNeto, ;
						 vSiguienteLinea, vpPrecio, IIF(vMontoExento=0,vPrecioOriginal,0), ;
						 vMontoAfecto, ALLTRIM(vpDetalle), ;
						 vUnidadMedida, vProductoIla, vMontoExento, ;
						 vpBodega, vpBodegaIN, vNoApliDes, vUnidadesXenvase, vPrecioNetoDetalle, VCodIad)
*!*	ENDIF
ENDPROC
PROCEDURE crearequest
LPARAMETERS tcTipDoc, tcRutEmpresa, tcDigitoVerif

TEXT TO sXMLRequest TEXTMERGE NOSHOW
	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl">
	   <soapenv:Header/>
	   <soapenv:Body>
	      <lsof:GetFolio>
	         <lsof:codigoDTE><<tcTipDoc>></lsof:codigoDTE>
	         <lsof:rutEmisor><<tcRutEmpresa>></lsof:rutEmisor>
	         <lsof:dvEmisor><<tcDigitoVerif>></lsof:dvEmisor>	
	      </lsof:GetFolio>
	   </soapenv:Body>
	</soapenv:Envelope>	
ENDTEXT

RETURN sXMLRequest


ENDPROC
PROCEDURE mactivatablas
LPARAMETERS vpCierreInicial, vpFecha, vtActual, vtDetalle, vtPedido, vtDetPed, vtSaldos, vtMovim, vtInOut, ;
			vtComanda, vtDetCom, vMuestraMensaje, vtPedMov, vtAuditoria, vtGuia, vtDetGui, vtLimDes, vtInvFis,;
			vtOutInv, vtInInv, vtCompra, vtDCompra, vtDscCompra, vtERecorrido, vtDERecorrido, vpImpAdi, vpDscRecGbl, ;
			vpRefDocRec

IF vpCierreInicial THEN
	IF USED("tDetPed") THEN
		USE IN tDetPed
	ENDIF

	IF USED("tActual") THEN
		USE IN tActual
	ENDIF

	IF USED("tDetalle") THEN
		USE IN tDetalle
	ENDIF

	IF USED("tMovim") THEN
		USE IN tmovim
	ENDIF

	IF USED("tInOut") THEN
		USE IN tInOut
	ENDIF

	IF USED("tSaldos") THEN
		USE IN tSaldos
	ENDIF

	IF USED("tPedido") THEN
		USE IN tPedido
	ENDIF

	IF USED("tDetPed") THEN
		USE IN tDetPed
	ENDIF

	IF USED("tComanda") THEN
		USE IN tComanda
	ENDIF

	IF USED("tDetCom") THEN
		USE IN tDetCom
	ENDIF

	IF USED("tPedMov") THEN
		USE IN tPedMov
	ENDIF

	IF USED("tAuditoria") THEN
		USE IN tAuditoria
	ENDIF

	IF USED("tGUIA") THEN
		USE IN tGuia
	ENDIF

	IF USED("tDETGUI") THEN
		USE IN tDetGui
	ENDIF

	IF USED("tLIMDES") THEN
		USE IN tLimDes
	ENDIF

	IF USED("tINVFIS") THEN
		USE IN tInvFis
	ENDIF

	IF USED("tOUTINV") THEN
		USE IN tOutInv
	ENDIF

	IF USED("tININV") THEN
		USE IN tInInv
	ENDIF

	IF USED("tCOMPRA") THEN
		USE IN tCompra
	ENDIF

	IF USED("tDCOMPRA") THEN
		USE IN tDCompra
	ENDIF

	IF USED("tDSCCOMPRA") THEN
		USE IN tDscCompra
	ENDIF

	IF USED("tERecorrido") THEN
		USE IN tERecorrido
	ENDIF

	IF USED("tDRecorrido") THEN
		USE IN tDRecorrido
	ENDIF

	IF USED("tIMPADI") THEN
		USE IN tImpAdi
	ENDIF

	IF USED("tDSCRECGBL") THEN
		USE IN tDscRecGbl
	ENDIF
	
	IF USED("tREFDOCREF") THEN
		USE IN tRefDocRec
	ENDIF
	
	RETURN .t.
ENDIF

vPrefijo=PADL(ALLTRIM(STR(MONTH(vpFecha))),2,"0")+PADL(ALLTRIM(STR(YEAR(vpFecha))),4,"0")

IF vtActual THEN
	vTablaSelec=StdVia+"F1"+vPrefijo+".Dbf"
	vNombreOriginal="F1"+vPrefijo

	IF USED("tActual") THEN
		USE IN tActual
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF
	
	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Encabezados de Factura no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tActual IN 0
ENDIF

IF vtDetalle THEN
	vTablaSelec=StdVia+"F2"+vPrefijo+".Dbf"
	vNombreOriginal="F2"+vPrefijo

	IF USED("tDetalle") THEN
		USE IN tDetalle
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF
	
	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Factura no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDetalle IN 0
ENDIF

IF vtPedido THEN
	vTablaSelec=StdVia+"P1"+vPrefijo+".Dbf"
	vNombreOriginal="P1"+vPrefijo

	IF USED("tPedido") THEN
		USE IN tPedido
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF
	
	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Encabezados de Pedido no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tPedido IN 0
ENDIF

IF vtDetPed THEN
	vTablaSelec=StdVia+"P2"+vPrefijo+".Dbf"
	vNombreOriginal="P2"+vPrefijo

	IF USED("tDetPed") THEN
		USE IN tDetPed
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Pedidos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDetPed IN 0
ENDIF

IF vtSaldos THEN
	vTablaSelec=StdVia+"SD"+vPrefijo+".Dbf"
	vNombreOriginal="SD"+vPrefijo

	IF USED("tSaldos") THEN
		USE IN tSaldos
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Saldos de Producto no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tSaldos IN 0
ENDIF

IF vtMovim THEN
	vTablaSelec=StdVia+"DT"+vPrefijo+".Dbf"
	vNombreOriginal="DT"+vPrefijo

	IF USED("tMovim") THEN
		USE IN tMovim
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Movimientos de Producto, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tMovim IN 0
ENDIF

IF vtInOut THEN
	vTablaSelec=StdVia+"IO"+vPrefijo+".Dbf"
	vNombreOriginal="IO"+vPrefijo

	IF USED("tInOut") THEN
		USE IN tInOut
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Entrada y Salida de Productos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tInOut IN 0
ENDIF

IF vtComanda THEN
	vTablaSelec=StdVia+"K1"+vPrefijo+".Dbf"
	vNombreOriginal="K1"+vPrefijo

	IF USED("tComanda") THEN
		USE IN tComanda
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Cabecera de Comandas, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tComanda IN 0
ENDIF

IF vtDetCom THEN
	vTablaSelec=StdVia+"K2"+vPrefijo+".Dbf"
	vNombreOriginal="K2"+vPrefijo

	IF USED("tDetCom") THEN
		USE IN tDetCom
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Comandas, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDetCom IN 0
ENDIF

IF vtPedMov THEN
	vTablaSelec=StdVia+"P4"+vPrefijo+".Dbf"
	vNombreOriginal="P4"+vPrefijo

	IF USED("tPedMov") THEN
		USE IN tPedMov
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Pedidos Moviles, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tPedMov IN 0
ENDIF

IF vtAuditoria THEN
	vTablaSelec=StdVia+"AU"+vPrefijo+".Dbf"
	vNombreOriginal="AU"+vPrefijo

	IF USED("tAuditoria") THEN
		USE IN tAuditoria
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Auditoria, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tAuditoria IN 0
ENDIF

IF vtGuia THEN
	vTablaSelec=StdVia+"G1"+vPrefijo+".Dbf"
	vNombreOriginal="G1"+vPrefijo

	IF USED("tGUIA") THEN
		USE IN tGuia
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Cabecera de Guia de Despacho, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tGuia IN 0
ENDIF

IF vtDetGui THEN
	vTablaSelec=StdVia+"G2"+vPrefijo+".Dbf"
	vNombreOriginal="G2"+vPrefijo

	IF USED("tDETGUI") THEN
		USE IN tDetGui
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Guia, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDetGui IN 0
ENDIF

IF vtLimDes THEN
	vTablaSelec=StdVia+"LD"+vPrefijo+".Dbf"
	vNombreOriginal="LD"+vPrefijo

	IF USED("tLIMDES") THEN
		USE IN tLimDes
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Descuentos y Recargos en Ventas, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tLimDes IN 0
ENDIF

IF vtInvFis THEN
	vTablaSelec=StdVia+"IF"+vPrefijo+".Dbf"
	vNombreOriginal="IF"+vPrefijo

	IF USED("tINVFIS") THEN
		USE IN tInvFis
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Descuentos y Recargos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tInvFis IN 0
ENDIF

IF vtOutInv THEN
	vTablaSelec=StdVia+"OU"+vPrefijo+".Dbf"
	vNombreOriginal="OU"+vPrefijo

	IF USED("tOUTINV") THEN
		USE IN tOutInv
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Salidas de Inventario, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tOutInv IN 0
ENDIF

IF vtInInv THEN
	vTablaSelec=StdVia+"IN"+vPrefijo+".Dbf"
	vNombreOriginal="IN"+vPrefijo

	IF USED("tININV") THEN
		USE IN tInInv
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Ingresos de Inventarios, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tInInv IN 0
ENDIF


IF vtCompra THEN
	vTablaSelec=StdVia+"FC"+vPrefijo+".Dbf"
	vNombreOriginal="FC"+vPrefijo

	IF USED("tCOMPRA") THEN
		USE IN tCompra
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Encabezados de Compra, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tCompra IN 0
ENDIF

IF vtDCOMPRA THEN
	vTablaSelec=StdVia+"DC"+vPrefijo+".Dbf"
	vNombreOriginal="DC"+vPrefijo

	IF USED("tDCOMPRA") THEN
		USE IN tDCompra
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Descuentos y Recargos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDCOMPRA IN 0
ENDIF

IF vtDscCompra THEN
	vTablaSelec=StdVia+"LC"+vPrefijo+".Dbf"
	vNombreOriginal="LC"+vPrefijo

	IF USED("tDSCCOMPRA") THEN
		USE IN tDscCompra
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Descuentos y Recargos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	
	USE &vTablaSelec ALIAS tDSCCOMPRA IN 0
ENDIF

IF vtERecorrido
	vTablaSelec=StdVia+"ER"+vPrefijo+".Dbf"
	vNombreOriginal="ER"+vPrefijo

	IF USED("tERecorrido") THEN
		USE IN tERecorrido
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Devoluciones de Recorridos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	USE &vTablaSelec ALIAS tERecorrido IN 0
ENDIF

IF vtDERecorrido
	vTablaSelec=StdVia+"DR"+vPrefijo+".Dbf"
	vNombreOriginal="DR"+vPrefijo

	IF USED("tDRecorrido") THEN
		USE IN tDRecorrido
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla de Detalle de Devoluciones de Recorridos, no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	USE &vTablaSelec ALIAS tDRecorrido IN 0
ENDIF

IF vpImpAdi THEN
	vTablaSelec=StdVia+"IA"+vPrefijo+".Dbf"
	vNombreOriginal="IA"+vPrefijo
	
	IF USED("tIMPADI") THEN
		USE IN tImpAdi
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla Auxiliar de Impuestos Adicionales (Recepcion de Compras Electronicas), no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	USE &vTablaSelec ALIAS tImpAdi IN 0
ENDIF

IF vpDscRecGbl THEN
	vTablaSelec=StdVia+"GB"+vPrefijo+".Dbf"
	vNombreOriginal="GB"+vPrefijo
	
	IF USED("tDSCRECGBL") THEN
		USE IN tDscRecGbl
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla Auxiliar de Dsc/Rec Globales (Recepcion de Compras Electronicas), no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	USE &vTablaSelec ALIAS tDscRecGbl IN 0
ENDIF

IF vpRefDocRec THEN
	vTablaSelec=StdVia+"RF"+vPrefijo+".Dbf"
	vNombreOriginal="RF"+vPrefijo
	
	IF USED("tREFDOCREC") THEN
		USE IN tRefDocRec
	ENDIF

	IF USED(vNombreOriginal) THEN
		USE IN &vNombreOriginal
	ENDIF

	IF !FILE(vTablaSelec) THEN
		IF vMuestraMensaje THEN
			=MESSAGEBOX("La Tabla Auxiliar de Documentos de Referencia (Recepcion de Compras Electronicas), no se encuentra Activa")
		ENDIF
		RETURN .f.
	ENDIF
	USE &vTablaSelec ALIAS tRefDocRec IN 0
ENDIF


RETURN .t.
ENDPROC
PROCEDURE marreglomeses
LPARAMETERS vpGestion

RELEASE aMeses

vDiasFebrero=28
IF !EMPTY(vpGestion) THEN
	IF vpGestion<1582 THEN
		IF MOD(vpGestion,4)=0 THEN
			vDiasFebrero=29
		ENDIF
	ELSE
		IF MOD(vpGestion,400)=0 THEN
			vDiasFebrero=29
		ELSE
			IF MOD(vpGestion,100)!=0 THEN
				IF MOD(vpGestion,4)=0 THEN
					vDiasFebrero=29
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

PUBLIC ARRAY aMeses (12,2)

aMeses[1,1]="ENERO"
aMeses[1,2]=31
aMeses[2,1]="FEBRERO"
aMeses[2,2]=vDiasFebrero
aMeses[3,1]="MARZO"
aMeses[3,2]=31
aMeses[4,1]="ABRIL"
aMeses[4,2]=30
aMeses[5,1]="MAYO"
aMeses[5,2]=31
aMeses[6,1]="JUNIO"
aMeses[6,2]=30
aMeses[7,1]="JULIO"
aMeses[7,2]=31
aMeses[8,1]="AGOSTO"
aMeses[8,2]=31
aMeses[9,1]="SEPTIEMBRE"
aMeses[9,2]=30
aMeses[10,1]="OCTUBRE"
aMeses[10,2]=31
aMeses[11,1]="NOVIEMBRE"
aMeses[11,2]=30
aMeses[12,1]="DICIEMBRE"
aMeses[12,2]=31

ENDPROC
PROCEDURE mcargadatoscliente
*!*		Thisform.Facturador1.mCargaDatosCliente(ALLTRIM(Thisform.Text1.Value), ALLTRIM(Thisform.Text2.Value),;
*!*												vGiroCliente, vContactoCliente, vEmailCliente, ;
*!*												ALLTRIM(Thisform.Text3.Value), ALLTRIM(Thisform.Text5.Value),;
*!*												ALLTRIM(Thisform.Text6.Value))

LPARAMETERS vpRutCliente, vpNombreCliente, vpGiroCliente, vpContactoCliente, ;
			vpeMailCliente, vpDireccionCliente, vpComunaCliente, vpCiudadCliente, vpLocalidad
			

GO TOP IN prprm

RELEASE aDatosCliente

PUBLIC ARRAY aDatosCliente(8)

aDatosCliente(1)= vpRutCliente
aDatosCliente(2)= vpNombreCliente
aDatosCliente(3)= vpGiroCliente
aDatosCliente(4)= vpContactoCliente
aDatosCliente(5)= vpeMailCliente
aDatosCliente(6)= vpDireccionCliente
aDatosCliente(7)= vpComunaCliente
aDatosCliente(8)= vpCiudadCliente


ENDPROC
PROCEDURE menviafechastandar
LPARAMETERS vpMes, vpAno

RETURN CTOD("01/"+PADL(ALLTRIM(STR(vpMes)),2,"0")+"/"+PADL(ALLTRIM(STR(vpAno)),4,"0"))

ENDPROC
PROCEDURE menviainformaciondte
LPARAMETERS vpFolio

**** Estructura de Tabla DTE

*!*	DTE_ID 				= Llave primaria que identifica el Documento
*!*	EMIS_ID				=	
*!*	DTE_XMLID			= (Desconocido)
*!*	CAF_ID				= (Desconocido)
*!*	TIPO_DTE_ID			= Codigo IDentificador del Documento ante SNII
*!*	DTE_FOLIO			= Numero correlativo del Documento
*!*	DTE_FCHEMS			= Fecha de Emision
*!*	DTE_INDNOREBAJA		= (Solamente se usa en Notas de Credito sin rebaja fiscal)
*!*	DTE_TIPODESPACHO 	= (No necesario)
*!*	DTE_INDTRASLADO		= (Desconocido)
*!*	DTE_TIPOIMPRESION	= "N"
*!*	DTE_INDSERVICIO		= (Desconocido)
*!*	DTE_MNTNETO			= Monto Neto Original del Documento
*!*	DTE_MNTEXE			= Monto Exento
*!*	DTE_MNTBASE			= Monto Imponible (Neto + Flete-Descuentos)
*!*	DTE_MNTMARGENCOM	= (Desconocido)
*!*	DTE_TASAIVA			= Porcentaje IVA
*!*	DTE_IVA				= Monto Iva
*!*	DTE_IVAPROP			= (Desconocido)
*!*	DTE_IVATERC			= (Desconocido)
*!*	DTE_IVANORET		= (Desconocido)
*!*	DTE_CREDEC			= (Desconocido)
*!*	DTE_GRNTDEP			= (Desconocido)
*!*	DTE_MNTTOTAL		= Monto Total del Documento
*!*	DTE_MONTONF			= (Desconocido)
*!*	DTE_MNTOPERIODO		= (Desconocido)
*!*	DTE_SALDOANTERIOR	= (Desconocido)
*!*	DTE_VLRPAGAR		= (Desconocido)
*!*	ESTA_DTE_ID			= (Desconocido)
*!*	DTE_DTEMONTBRUTO	= Total Monto Bruto del Documento
*!*	FMAPAGO				= Forma de Pago	(1: Contado, 2: Credito)						INT(11)
*!*	DTE_FMAPAGOEXP		= (Desconocido)
*!*	DTE_FCHCANCEL		= Fecha de Cancelacion
*!*	DTE_MNTCANCEL		= Monto Cancelado
*!*	DTE_SALDOINSOL		= (Desconocido)
*!*	DTE_PERIODODESDE	= (Desconocido)
*!*	DTE_PERIODOHASTA	= (Desconocido)
*!*	MEDIOPAGO			= (No necesario)
*!*	TIPOCTAPAGO			= (Desconocido)
*!*	DTE_BCOCTAPAGO		= (Desconocido)
*!*	DTE_TERMPAGOCDG		= (Desconocido)
*!*	DTE_TERMPAGOGLOSA	= (Desconocido)
*!*	DTE_TERMPAGODIAS	= (Desconocido)
*!*	DTE_FCHVENC			= Fecha de Vencimiento del Documento
*!*	DTE_CDGVENDEDOR		= Codigo Vendedor con los 4 digitos							C(60)
*!*	DTE_RUTMANDANTE		= (Desconocido)
*!*	DTE_RUTSOLICITA		= (Desconocido)
*!*	DTE_FECHA			= Fecha del Documento


***** Tabla de Detalles

*!*	DETA_DTE_ID				= (Desconocido)
*!*	DTE_ID					= Llave Primaria que identifica el Documento
*!*	NROLINDET				= Numero de Linea
*!*	IND_EXE_ID				= (Desconocido)
*!*	NMBITEM					= Detalle del Producto
*!*	DSCITEM					= (Desconocido)
*!*	QTYREF					= (Desconocido)
*!*	UNMDREF					= (No es Necesario)
*!*	PRCREF					= (No es Necesario)
*!*	QTYITEM					= Cantida del ITEM (En decimales las fracciones)
*!*	FCHELABOR				= Fecha de Elaboracion
*!*	FCHVENCIM				= Fecha de Vencimiento
*!*	UNDMITEM				= Unidad de Medida del Item
*!*	PRCITEM					= Precio Neto del Item
*!*	DESCUENTOPCT			= Descuento en Porcentaje
*!*	DESCUENTOMONTO			= Descuento en Monto
*!*	RECARGO PCT				= Recargos en Porcentaje
*!*	RECARGOMONTO			= Recargo en Monto
*!*	MONTOITEM				= Monto total de Venta del Item


****** Tabla de Descuentos y Recargos

*!*	DESC_RECA_ID			= (Desconocido)
*!*	DTE_ID					= Llave Primaria que identifica el Documento
*!*	NROLINDR				= Numero de Linea del Recargo/descuento
*!*	TPOMOV					= Tipo de Movimiento 							
*!*	GLOSADR					= Glosa del Recargo
*!*	TPOVALOR				= Valor del Recargo
*!*	VALORDR					= Valor descuento
*!*	VALORDTOTRMNDA			= (Desconocido)
*!*	INDEXEDR				= (Desconocido)

***** Tabla de Receptores (Clientes de Documentos)

*!*	RECE_ID						= Identificador unico del Receptor
*!*	DTE_ID						= IDentificador del Documento
*!*	RECE_RUTRECEP				= Rut del Cliente
*!*	RECE_CDGINTERNO				= (Desconocido)
*!*	RECE_RZNSOCRECEP			= Nombre o razon social
*!*	RECE_NUMID					= (Desconocido)
*!*	RECE_NACIONALIDAD			= "(No es necesario)"
*!*	RECE_IDADICRECEP			= (Desconocido)
*!*	RECE_GIRORECEP				= Giro Comercial de Cliente
*!*	RECE_CONTACTO				= Contacto del Cliente
*!*	RECE_CORREPRECEP			= eMAIL del Cliente
*!*	RECE_DIRRECEP				= Direccion del Cliente
*!*	RECE_CMNARECEP				= Comuna del Cliente
*!*	RECE_CIUDADRECEP			= Ciudad del Cliente
*!*	RECE_DIRPOSTAL				=(Desconocido)
*!*	RECE_CMNAPOSTAL				=(Desconocido)
*!*	RECE_CIUDADPOSTAL			=(Desconocido)

***** Tabla de Codificacion de Productos

*!*	CODI_ID						= Codigo de Producto
*!*	DETA_DTE_ID					= Detalle del Producto
*!*	TPOCODIGO					= (Desconocido)
*!*	VLRCODIGO					= Precio del Producto


***** Tabla ITEMCUR (ERP)

*!*	Codigo							= Codigo del Producto
*!*	Cantidad						= Cantidad de Producto
*!*	Fraccion						= Fraccion del Producto
*!*	Precio							= PRecio de Venta Original* Cantidad de Venta
*!*	Linea							= Id de Linea de Detalle
*!*	PrecioOrig						= Precio Original del PRoducto
*!*	SubTot							= Monto Venta Neta Original
*!*	Afecto							= Monto de Venta NetaOriginal-Descuentos


***** Cursor Descuentos

*!*	Linea							= ID de Linea
*!*	TipDsc							= (1: Dscto. PreciosEspeciales)
*!*									  (2: Dscto. Reglas Comerciales)
*!*									  (3: Dscto. Linea)
*!*									  (4: Recargo Flete)
*!*									  (5: Recargos Adicionales)
*!*									  (6: IVA)
*!*									  (7: Dscto. Cabecera)
*!*	PorDsc							= Porcentaje de Descuento/Recargo
*!*	MonDsc							= Monto de Descuento/Recargo
*!*	CodPro							= Codigo del Producto
*!*	Fecha							= Fecha del Dscto/Recargo
*!*	ModDsc							= (1: Descuento 2: Recargo)

*!*	DTE_ID 				= Llave primaria que identifica el Documento
*!*	TIPO_DTE_ID			= Codigo IDentificador del Documento ante SNII
*!*	DTE_FOLIO			= Numero correlativo del Documento
*!*	DTE_FCHEMS			= Fecha de Emision
*!*	DTE_TIPOIMPRESION	= "N"
*!*	DTE_MNTNETO			= Monto Neto Original del Documento
*!*	DTE_MNTEXE			= Monto Exento
*!*	DTE_MNTBASE			= Monto Imponible (Neto + Flete-Descuentos)
*!*	DTE_TASAIVA			= Porcentaje IVA
*!*	DTE_IVA				= Monto Iva
*!*	DTE_MNTTOTAL		= Monto Total del Documento
*!*	FMAPAGO				= Forma de Pago	(1: Contado, 2: Credito)						INT(11)
*!*	DTE_FCHVENC			= Fecha de Vencimiento del Documento
*!*	DTE_CDGVENDEDOR		= Codigo Vendedor con los 4 digitos							C(60)
*!*	DTE_FECHA			= Fecha del Documento

GO TOP IN prPrm

IF SEEK(vgTipDoc+vpFolio, "tACTUAL", 1) THEN
	vCamposDTE='(DTE_ID, TIPO_DTE_ID, DTE_FOLIO, DTE_FCHEMS, DTE_TIPOIMPRESION, ;
 			     DTE_MNTNETO, DTE_MNTEXE, DTE_MNTBASE, DTE_TASAIVA, DTE_IVA, ;
				 DTE_MNTTOTAL, FMAPAGO, DTE_FCHVENC, DTE_CDGVENDEDOR, DTE_FECHA)'
	vCamposERP='(IDCorrel, vpCodigoDoc, vpFolio, tActual.faFecha, "N", ;
				 tActual.faSubTot, tActual.faExento, tActual.faAfecto, ;
				 prPrm.paIva, tActual.faIVA, tActual.faTotal, ;
				 2, tActual.faFecVen, tActual.faCodVend, tActual.faFecha)'
	vOrdenSQL="INSERT INTO DTE "+vCamposDTE+" VALUES "+vCamposERP
	
	vResultadoOrden=SQLEXEC(bIDConexion, vOrdenSQL)
ENDIF
ENDPROC
PROCEDURE mgeneravectordscreccab
LPARAMETERS vpTipoDscCab, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab, vpTipoRecCab

IF VARTYPE(aDscRecCab)!="U" THEN
	RELEASE aDscRecCab
ENDIF

PUBLIC ARRAY aDscRecCab(1,6)
aDscRecCab(1,1)=.f.

vFilaArreglos=0

vBndDscRecCabecera =.t.
CALCULATE CNT() TO vCantidadProductosSinDsctos FOR ItemCur.noApliDes="S" IN ItemCur
CALCULATE CNT() TO vCantidadProductosRegistrados FOR !DELETED("ITEMCUR")  IN ItemCur

DO CASE
	CASE (vCantidadProductosRegistrados+vCantidadProductosSinDsctos)=0
		vBndDscRecCabecera=.f.
	CASE vCantidadProductosRegistrados=vCantidadProductosSinDsctos
		vBndDscRecCabecera=.f.
ENDCASE

IF !vBndDscRecCabecera THEN
	IF vCantidadProductosRegistrados>0 THEN
		=MESSAGEBOX("Todos los Productos Asignados al Documento, estan en la Categoria de No Aplica Descuento"+CHR(13)+;
					"Por tanto el Descuento de Cabecera no tendra efecto")
	ENDIF
	RETURN
ENDIF

IF vCantidadProductosSinDsctos>0 THEN
	CALCULATE SUM(MonDsc) TO vpMonDscCab FOR INLIST(TipDsc, 7,12) IN DscCur
	CALCULATE SUM(MonDsc) TO vpMonRecCab FOR INLIST(TipDsc, 10,13) IN DscCur
	STORE 0 TO vpPorDscCab, vpPorRecCab
ENDIF
	
GO TOP IN prprm
IF prPrm.Modalidad!=0 THEN
	IF vpPorDscCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vpPorDscCab
		aDscRecCab(vFilaArreglos,3)="%"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA (%)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=1
	ENDIF 	

	IF vpMonDscCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vpMonDscCab
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF

	IF vpPorRecCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vpPorRecCab
		aDscRecCab(vFilaArreglos,3)="%"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA (%)"
		aDscRecCab(vFilaArreglos,5)=vpTipoRecCab-1
		aDscRecCab(vFilaArreglos,6)=1
	ENDIF 	

	IF vpMonRecCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vpMonRecCab
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoRecCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
ELSE
	CALCULATE SUM(MonDsc) FOR INLIST(TipDsc,1,2,3,7,12) TO vSumaMontoDscCabecera IN DscCur
	CALCULATE SUM(MonDsc) FOR INLIST(TipDsc,4,10,13) TO vSumaMontoRecCabecera IN DscCur
	
	IF (vpPorDscCab+vpMonDscCab)>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vSumaMontoDscCabecera
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
	IF (vpMonRecCab+vpPorRecCab)>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vSumaMontoRecCabecera
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoRecCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
ENDIF 	

RETURN vFilaArreglos

ENDPROC
PROCEDURE mredondeo
LPARAMETERS vpValor

IF (vpValor-INT(vpValor))=0 THEN
	RETURN vpValor
ENDIF

IF ((vpValor-INT(vpValor))*100)>45 THEN
	RETURN INT(vpValor)+1
ELSE
	RETURN INT(vpValor)
ENDIF


ENDPROC
PROCEDURE mredondeo2
LPARAMETERS vpValor

IF (vpValor-INT(vpValor))=0 THEN
	RETURN vpValor
ENDIF

IF ((vpValor-INT(vpValor))*100)>=45 THEN
	RETURN INT(vpValor)+1
ELSE
	RETURN INT(vpValor)
ENDIF

ENDPROC
PROCEDURE msetpropiedades
IF SET("DATE")!="DMY" THEN
	SET DATE TO Dmy
ENDIF

IF SET("CENTURY")!="ON" THEN
	SET Century ON
ENDIF

IF SET("ECHO")!="OFF" THEN
	SET Echo OFF
ENDIF

IF SET("TALK")!="OFF" THEN
	SET Talk OFF
ENDIF

IF SET("STRICTDATE")!=0 THEN
	SET STRICTDATE to 0
ENDIF

IF SET("DELETED")!="ON" THEN
	SET DELETED ON
ENDIF

IF SET("CONFIRM")!="ON" THEN
	SET CONFIRM ON
ENDIF

IF SET("SAFETY")!="OFF" THEN
	SET SAFETY OFF
ENDIF

IF SET("EXCLUSIVE")!="OFF" THEN
	SET EXCLUSIVE OFF
ENDIF

IF SET("CONFIRM")!="ON" THEN
	SET CONFIRM ON
ENDIF

*ON ERROR
*ON KEY

SET DECIMALS TO 2
SET ENGINEBEHAVIOR 70

SET OPTIMIZE ON

ENDPROC
PROCEDURE muestraform
*LPARAMETERS
DO FORM FormularioPrueba

RETURN 5

ENDPROC
PROCEDURE paccededatosarreglo
LPARAMETERS vpArreglo, vpDato1, vpDato2, vpDato3, vpDato4, vpDato5, vpDato6, vpBandera
	
	*!*		PUBLIC ARRAY aGuiaDespacho (4)
	*!*		aGuiaDesPacho(1)=""
	*!*		aGuiaDesPacho(2)=""
	*!*		aGuiaDesPacho(3)=""
	*!*		aGuiaDesPacho(4)=""


											
IF vpArreglo=1 THEN
	&&&& Arreglo Guia de Despacho
	aGuiaDesPacho(1)=vpDato1
	aGuiaDesPacho(2)=vpDato2
	aGuiaDesPacho(3)=vpDato3
	IF VAL(vpDato4)=0 THEN
		aGuiaDesPacho(4)=""
	ELSE
		aGuiaDesPacho(4)=vpDato4
	ENDIF
*!*	ELSE
*!*		&&& Arreglo Documentos de Referencia
*!*		IF vpBandera THEN
*!*			IF SEEK(vpDato1,"TIPODOC",1) THEN
*!*				aDocRef(1)=TipoDoc.id_snii
*!*			ENDIF
*!*		ELSE
*!*			IF SEEK(vpDato1,"TIPODOC",2) THEN
*!*				aDocRef(1)=TipoDoc.id_snii
*!*			ENDIF
*!*		ENDIF
*!*		aDocRef(2)=vpDato2
*!*		aDocRef(3)=vpDato3
*!*		aDocRef(4)=vpDato4
*!*		
*!*		IF !EMPTY(ALLTRIM(aCasoRef(2))) THEN
*!*			aDocRef(5)=ALLTRIM(aCasoRef(2))
*!*		ELSE
*!*			aDocRef(5)=vpDato5
*!*		ENDIF

*!*		aDocRef(6)=vpDato6
ENDIF
ENDPROC
PROCEDURE paceptarecorrido
LPARAMETERS vpRec, vPuntero

vBndLiquidacion=.t.

IF SEEK(vpRec,  "RESPAGRU",4) THEN
	RETURN .f.
ENDIF

IF prPrm.Modalidad=0 then
	RETURN vBndLiquidacion
ENDIF

SELECT DesDoc+PreFactura as Llave FROM PlanRuta WHERE Recorrido=vpRec INTO CURSOR cDocRec

IF _Tally>0 THEN
	STORE "" TO vPeriodoActual, vPeriodoDoc

	GO TOP IN cDocRec	
	DO WHILE !EOF("cDOCREC")
		IF SEEK(cDocRec.Llave, "CLIDOCTO",1) THEN
			vPeriodoActual=PADL(ALLTRIM(STR(MONTH(CliDocto.FecFac))),2,"0")+;
						   PADL(ALLTRIM(STR(YEAR(CliDocto.FecFac))),4,"0")

			IF vPeriodoDoc!=vPeriodoActual THEN
				IF !Thisform.Facturador.mActivaTablas(.f., CliDocto.FecFac,.t.) THEN
					aRecorrido[vPuntero,9]="Periodo no existe para Documento : "+cDocRec.Llave
					vBndLiquidacion=.f.
					EXIT
				ELSE
					vPeriodoDoc=vPeriodoActual
				ENDIF
			ENDIF
			
			IF SEEK(cDocRec.Llave, "tACTUAL",1) THEN
				aRecorrido(vPuntero,7)=aRecorrido(vPuntero,7)+tActual.faTotal
				
				IF prPrm.validaSII THEN
					IF !("ACEPTADO" $ UPPER(ALLTRIM(tActual.edoRes))) THEN
						aRecorrido[vPuntero,9]="Existen Documentos que no han sido Verificados x el Sevicio de Impuestos"
						vBndLiquidacion=.f.
						EXIT
					ENDIF
				ENDIF
			ELSE
				aRecorrido[vPuntero,9]="Documento no existe en Tabla de Periodo: "+cDocRec.Llave
				vBndLiquidacion=.f.
				EXIT
			ENDIF
		ELSE
			aRecorrido[vPuntero,9]="Documento no existe en Historico de Ventas: "+cDocRec.Llave
			vBndLiquidacion=.f.
			EXIT
		ENDIF 			
		
		SKIP IN cDocRec
	ENDDO

	IF USED("tACTUAL") THEN
		USE IN tActual
	ENDIF 			
ELSE
	aRecorrido[vPuntero,9]="No existen Docuymentos Validos para el Recorrido"
	vBndLiquidacion=.f.
ENDIF

*!*	IF !vBndLiquidacion THEN
*!*		aRecorrido[vPuntero,9]="Existen Documentos que no han sido Verificados x el Sevicio de Impuestos"
*!*	ENDIF

RETURN vBndLiquidacion


ENDPROC
PROCEDURE pactivaimpresion
IF !USED("prPRM") THEN
	RETURN .f.
ENDIF

*!*	GO TOP IN prPrm
*!*	IF prPrm.Modalidad=0 THEN
*!*		RETURN .t.
*!*	*	Thisform.Check5.Value=.t.
*!*	*	Thisform.Check5.Enabled=.f.
*!*	ELSE
*!*		RETURN .f.
*!*	*	Thisform.Check5.Value=.t.
*!*	*	Thisform.Check5.Enabled=.t.
*!*	ENDIF

RETURN prPrm.Modalidad=0
ENDPROC
PROCEDURE pactivainicialescompra
LPARAMETERS vpTamañoArray
PUBLIC ARRAY aDatosProveedor(vpTamañoArray),  aImptoAdi(1,2)
FOR vI=1 TO ALEN(aDatosProveedor,1)
	aDatosProveedor(vI)=""
ENDFOR


ENDPROC
PROCEDURE pactivaparametrosiniciales
LPARAMETERS vpBndCompra
PUBLIC vNumeroCajas
vNumeroCajas=0

PUBLIC ARRAY aVendedor (1,2), aCondipag (1,2), aListaPrecios (3), aBodega (1,2), aSucursales (1,15),;
			 aDocumentoRef (1,43), aEdoRes (1,1), aImptoAdi(1,2)

This.pCanSumaTotales=16

PUBLIC ARRAY aGuiaDespacho (4)
	aGuiaDesPacho(1)=""
	aGuiaDesPacho(2)=""
	aGuiaDesPacho(3)=""
	aGuiaDesPacho(4)=""

*!* PUBLIC ARRAY aDocumentoRef(1,41)	
*!*				aDocumentoRef(1,1)= ** Comuna En Doc.Ref.
*!*				aDocumentoRef(1,2)= ** Ciudad en Doc.Ref.
*!*				aDocumentoRef(1,3)= ** Fecha en Doc.Ref.
*!*				aDocumentoRef(1,4)= ** Fecha de Vencimiento
*!*				aDocumentoRef(1,5)= ** Monto Afecto
*!*				aDocumentoRef(1,6)= ** Monto IVa
*!*				aDocumentoRef(1,7)= ** Codigo Vendedor
*!*				aDocumentoRef(1,8)= ** Bodega
*!*				aDocumentoRef(1,9)= ** Giro en Documento
*!*				aDocumentoRef(1,10)= ** Contacto de Cliente en Doc.Ref.
*!*				aDocumentoRef(1,11)= ** Correo Electronico en Doc.Ref.
*!*				aDocumentoRef(1,12)= ** Tipo de Anulacion (1=Anulacion de Doc, 3=Correccion de Montos)
*!*				aDocumentoRef(1,13)= ** Porcentaje de Descuento Global
*!*				aDocumentoRef(1,14)= ** Codigo de SNII para Doc.Ref
*!*				aDocumentoRef(1,15)= ** Tipo de Dscto de Cabecera
*!*				aDocumentoRef(1,16)= ** Motivo
*!*				aDocumentoRef(1,17)= ** FolioRef
*!*				aDocumentoRef(1,18)= ** Telefono del Documento
*!*				aDocumentoRef(1,19)= ** Direccion del Documento
*!*				aDocumentoRef(1,20)= ** Nombre del Vendedor
*!*				aDocumentoRef(1,21)= ** Codigo de la Sucursal
*!*				aDocumentoRef(1,22)= ** Direccion de la Sucursal
*!*				aDocumentoRef(1,23)= ** Rut del Cliente
*!*				aDocumentoRef(1,24)= ** Nombre del Cliente
*!*				aDocumentoRef(1,25)= ** Recorrido del Documento
*!*				aDocumentoRef(1,26)= ** Nota de Venta
*!*				aDocumentoRef(1,27)= ** Lista de Precios
*!*				aDocumentoRef(1,28)= ** Total del Documento
*!*				aDocumentoRef(1,29)= ** Codigo Ruta
*!*				aDocumentoRef(1,30)= ** Detalle Ruta
*!*				aDocumentoRef(1,31)= ** Ciudad Sucursal
*!*				aDocumentoRef(1,32)= ** Tasa del IVA originalmente
*!*				aDocumentoRef(1,33)= ** Codigo Repartidor
*!*				aDocumentoRef(1,34)= ** Detalle Repartidor

*!*				aDocumentoRef(1,35)= ** Monto Exento	
*!*				aDocumentoRef(1,36)= ** Monto ToTal
*!*				aDocumentoRef(1,37)= ** Monto Descuentos
*!*				aDocumentoRef(1,38)= ** Monto SubTotal
*!*				aDocumentoRef(1,39)= ** Monto Flete
*!*				aDocumentoRef(1,40)= ** Monto ILA
*!*				aDocumentoRef(1,41)= ** Direccion de Despacho
*!*				aDocumentoRef(1,42)= ** Motivo de Devolucion
*!*				aDocumentoRef(1,43)= ** Monto de Descuento Global


	aDocumentoRef(1,1)= ""
	aDocumentoRef(1,2)= ""
	aDocumentoRef(1,3)= {//}
	aDocumentoRef(1,4)= {//}
	aDocumentoRef(1,5)= 0
	aDocumentoRef(1,6)= 0
	aDocumentoRef(1,7)= ""
	aDocumentoRef(1,8)= ""
	aDocumentoRef(1,9)= ""
	aDocumentoRef(1,10)= ""
	aDocumentoRef(1,11)= ""
	aDocumentoRef(1,12)= ""
	aDocumentoRef(1,13)= ""
	aDocumentoRef(1,14)= ""
	aDocumentoRef(1,15)= 0
	aDocumentoRef(1,16)= ""
	aDocumentoRef(1,17)= ""
	aDocumentoRef(1,18)= ""
	aDocumentoRef(1,19)= ""
	aDocumentoRef(1,20)= ""
	aDocumentoRef(1,21)= ""
	aDocumentoRef(1,22)= ""
	aDocumentoRef(1,23)= ""
	aDocumentoRef(1,24)= ""
	aDocumentoRef(1,25)= ""
	aDocumentoRef(1,26)= ""
	aDocumentoRef(1,27)= ""
	aDocumentoRef(1,28)= 0
	aDocumentoRef(1,29)=""
	aDocumentoRef(1,30)=""
	aDocumentoRef(1,31)=""	
	aDocumentoRef(1,32)=0
	aDocumentoRef(1,33)=""
	aDocumentoRef(1,34)=""
	aDocumentoRef(1,35)=0
	aDocumentoRef(1,36)=0
	aDocumentoRef(1,37)=0
	aDocumentoRef(1,38)=0
	aDocumentoRef(1,39)=0
	aDocumentoRef(1,40)=0
	aDocumentoRef(1,41)=""
	aDocumentoRef(1,42)=""
	aDocumentoRef(1,43)=0
		
PUBLIC ARRAY aDocRef(1,6)
	aDocRef(1,1)=""
	aDocRef(1,2)=""
	aDocRef(1,3)={//}
	aDocRef(1,4)=0
	aDocRef(1,5)=""
	aDocRef(1,6)=""
	

PUBLIC ARRAY aCasoRef(2)

aCasoRef(1)=""
aCasoRef(2)=""

PUBLIC ARRAY aAdjuntos(13)

FOR vI=1 TO ALEN(aAdjuntos,1)
	aAdjuntos(vI)=""
ENDFOR

PUBLIC ARRAY aSumaTotales(This.pCanSumaTotales)
FOR vI=1 TO ALEN(aSumaTotales,1)
	aSumaTotales(vI)=0
ENDFOR
ENDPROC
PROCEDURE pactualizaedosii
LPARAMETERS vpPeriodo, vpGestion, vpTodos

IF vpPeriodo=0 .or. vpGestion=0 THEN
	RETURN .f.
ENDIF

vFechaProceso=CTOD("01/"+PADL(ALLTRIM(STR(vpPeriodo)),2,"0")+"/"+;
				   PADL(ALLTRIM(STR(vpGestion)),4,"0"))

IF !This.mActivaTablas(.f., vFechaProceso, .t.) THEN
	RETURN .f.
ENDIF

WAIT WINDOW "Actualizando Estados" NOWAIT

IF vpTodos THEN
	SELECT * FROM tActual ;
		WHERE fatDocTo in (SELECT IdDoc FROM TipoDoc WHERE BndElec) .and. ;
			  FolioInt>0 .and. (!BndRec .or. !BndRes);
		INTO CURSOR cDocumentos
ELSE
	SELECT * FROM tActual ;
		WHERE fatDocTo in (SELECT IdDoc FROM TipoDoc WHERE BndElec) ;
		INTO CURSOR cDocumentos	
ENDIF

GO TOP IN cDocumentos
DO WHILE !EOF("cDOCUMENTOS")
	TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetEstadoSIIDTE>
         <lsof:idDTE><<cDocumentos.FolioInt>></lsof:idDTE>
      </lsof:GetEstadoSIIDTE>
   </soapenv:Body>
</soapenv:Envelope>
	ENDTEXT 		
	
	PUBLIC vRespuestaWebService
	vRespuestaWebService=0

	bRespuesta=Thisform.Facturador1.pEnviaDTE(vVarXML)

	IF vRespuestaWebService<0 THEN
		UNLOCK ALL
		=MESSAGEBOX("Error enviando DTE")
		RETURN .f.
	ELSE
		IF SEEK(cDocumentos.fatDocTo+cDocumentos.faNumero, "tACTUAL",1) THEN 		
			Replace tActual.BndRec 		WITH (UPPER(ALLTRIM(STREXTRACT(bRespuesta,'<ExisteRecepcion>','</ExisteRecepcion>')))="TRUE"), ;
					tActual.EdoRec 		WITH VAL(STREXTRACT(bRespuesta,'<EstadoEnvio>','</EstadoEnvio>')), ;
					tActual.EdoRecGlo 	WITH ALLTRIM(STREXTRACT(bRespuesta,'<EstadoEnvioGlosa>','</EstadoEnvioGlosa>')), ;
					tActual.TrackID 	WITH VAL(STREXTRACT(bRespuesta,'<TrackID>','</TrackID>')), ;
					tActual.BndRes 		WITH (UPPER(ALLTRIM(STREXTRACT(bRespuesta,'<ExisteResultado>','</ExisteResultado>')))="TRUE"), ;
					tActual.EdoRes 		WITH IIF(ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultado>','</EstadoResultado>'))="DOK", "ACEPTADO",;
											 ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultado>','</EstadoResultado>'))), ;
					tActual.EdoResGlo 	WITH IIF(ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultado>','</EstadoResultado>'))="DOK",;
												"Resultado consultado al SII en: "+TTOC(DATETIME()), ;
											  	ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultadoGlosa>','</EstadoResultadoGlosa>'))), ;
					tActual.FecEnv 		WITH ALLTRIM(STREXTRACT(bRespuesta,'<FechaEnvioSII>','</FechaEnvioSII>')), ;
					tActual.FecRes 		WITH ALLTRIM(STREXTRACT(bRespuesta,'<FechaResultadoSII>','</FechaResultadoSII>')) IN tActual
		ENDIF
	ENDIF
	
	RELEASE vRespuestaWebService
	
	SKIP IN cDocumentos
ENDDO 		

USE IN tActual

ENDPROC
PROCEDURE pactualizaedosiic
LPARAMETERS vpPeriodo, vpGestion, vpTodos

IF vpPeriodo=0 .or. vpGestion=0 THEN
	RETURN .f.
ENDIF

vFechaProceso=CTOD("01/"+PADL(ALLTRIM(STR(vpPeriodo)),2,"0")+"/"+;
				   PADL(ALLTRIM(STR(vpGestion)),4,"0"))
				
IF !This.mActivaTablas(.f., vFechaProceso,,,,,,,,,,,,,,,,,,,.t.,,) THEN
	RETURN .f.
ENDIF

IF vpTodos THEN
	SELECT * FROM tCompra ;
		WHERE fatDocTo in (SELECT IdDoc FROM TipoDoc WHERE BndElec) .and. FolioInt>0 .and. (!BndRec .or. !BndRes);
		INTO CURSOR cDocumentos
ELSE
	SELECT * FROM tCompra ;
		WHERE fatDocTo in (SELECT IdDoc FROM TipoDoc WHERE BndElec) .and. FolioInt>0 ;
		INTO CURSOR cDocumentos
ENDIF

GO TOP IN cDocumentos
DO WHILE !EOF("cDOCUMENTOS")
	TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetEstadoSIIDTE>
         <lsof:idDTE><<cDocumentos.FolioInt>></lsof:idDTE>
      </lsof:GetEstadoSIIDTE>
   </soapenv:Body>
</soapenv:Envelope>
	ENDTEXT 		
	
	PUBLIC vRespuestaWebService
	vRespuestaWebService=0

	bRespuesta=Thisform.Facturador1.pEnviaDTE(vVarXML)

	IF vRespuestaWebService<0 THEN
		UNLOCK ALL
		=MESSAGEBOX("Error enviando DTE")
		RETURN .f.
	ELSE
		IF SEEK(cDocumentos.fatDocTo+cDocumentos.fanFolio, "tCompra",1) THEN
			Replace BndRec 		WITH (UPPER(ALLTRIM(STREXTRACT(bRespuesta,'<ExisteRecepcion>','</ExisteRecepcion>')))="TRUE"), ;
					EdoRec 		WITH VAL(STREXTRACT(bRespuesta,'<EstadoEnvio>','</EstadoEnvio>')), ;
					EdoRecGlo 	WITH ALLTRIM(STREXTRACT(bRespuesta,'<EstadoEnvioGlosa>','</EstadoEnvioGlosa>')), ;
					TrackID 	WITH VAL(STREXTRACT(bRespuesta,'<TrackID>','</TrackID>')), ;
					BndRes 		WITH (UPPER(ALLTRIM(STREXTRACT(bRespuesta,'<ExisteResultado>','</ExisteResultado>')))="TRUE"), ;
					EdoRes 		WITH ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultado>','</EstadoResultado>')), ;
					EdoResGlo 	WITH ALLTRIM(STREXTRACT(bRespuesta,'<EstadoResultadoGlosa>','</EstadoResultadoGlosa>')), ;
					FecEnv 		WITH ALLTRIM(STREXTRACT(bRespuesta,'<FechaEnvioSII>','</FechaEnvioSII>')), ;
					FecRes 		WITH ALLTRIM(STREXTRACT(bRespuesta,'<FechaResultadoSII>','</FechaResultadoSII>')) IN tCompra
		ENDIF
	ENDIF
	
	RELEASE vRespuestaWebService
	
	SKIP IN cDocumentos
ENDDO 		
USE IN tCompra


ENDPROC
PROCEDURE padicionalibro
LPARAMETERS vpModoLibro, vpTipoLibro, vpPeriodo, vpGestion

*!*	vpModoLibro 1=Ventas
*!*				2=Compras
*!*		vpTipoLibro 1=Total
*!*					2=Parcial
*!*					3=Final
*!*					4=Rectificacion
*!*					5=Reemplazo

IF !USED("LIBVENTAS") THEN
	=MESSAGEBOX("Tabla de Registro de LibrosElectronicos no esta en uso")
	RETURN .f.
ENDIF

IF !USED("cDOCUMENTOS") THEN
	=MESSAGEBOX("Cursor de Documentos no existe")
	RETURN .f.
ENDIF

IF !USED("RESCUR") THEN
	=MESSAGEBOX("Cursor de Resumen no existe")
	RETURN .f.
ENDIF

STORE "Libro Electronico de " TO vMensajePregunta

IF vpModoLibro=1 THEN
	vMensajePregunta=vMensajePregunta+"VENTAS "
ELSE
	vMensajePregunta=vMensajePregunta+"COMPRAS "
ENDIF

DO CASE
	CASE vpTipoLibro=1
		vTipoEnvio=" (TOTAL) "
	CASE vpTipoLibro=2
		vTipoEnvio=" (PARCIAL) "
	CASE vpTipoLibro=3
		vTipoEnvio=" (FINAL) "
	CASE vpTipoLibro=4
		vTipoEnvio=" (AJUSTE) "
	CASE vpTipoLibro=5
		vTipoEnvio=" (REEMPLAZO) "
OTHERWISE
	vTipoEnvio="(Envio Desconocido)"
ENDCASE 			

IF MESSAGEBOX("Enviar el "+vMensajePregunta+vTipoEnvio,1+32+128, "Mensaje del Sistema")!=1 THEN
	RETURN .f.
ENDIF

IF !FLOCK("LIBVENTAS") THEN
	=MESSAGEBOX("Existen algunas Tablas que se encuentran ocupadas, intentelo mas tarde")
	RETURN .f.
ENDIF

*!*	IF !Thisform.VerificaLibrosIva.pValidarPeriodo(vgPeriodo, vgGestion, vgOpcion,.t.) THEN
*!*		UNLOCK ALL
*!*		RETURN .f.
*!*	ENDIF

************ Seccion en la que se envia el XML a la Aplicacion Roberto

IF vpModoLibro=1 THEN
	vVariableXML=This.pArmaXMLVentas()
ELSE
	vVariableXML=This.pArmaXMLCompras()
ENDIF

IF VARTYPE(vVariableXML)="L" THEN
	=MESSAGEBOX("No se Recibio el XML correspondiente")
	RETURN .f.
ELSE 	
	IF !EMPTY(ALLTRIM(vVariableXML)) THEN
		vRespuesta=This.pEnviaDTE(vVariableXML)
	ELSE
		=MESSAGEBOX("Variable Vacia, No se Recibio el XML correspondiente")
		RETURN .f.
	ENDIF
ENDIF

vRetornaIDlsoft=VAL(STREXTRACT(vRespuesta,'<Id>','</Id>'))

************ Fin de Envio de XML

IF vRetornaIDlsoft>0 THEN
	vFechaProceso=CTOD("01/"+PADL(ALLTRIM(STR(vgPeriodo)),2,"0")+"/"+PADL(ALLTRIM(STR(vgGestion)),4,"0"))

	INSERT INTO LibVentas (IdlSoft, MesPer, AnoPer, FecEnv, tipoLib, Hora, Equipo, usernom, ModoLIB) ;
		VALUES (vRetornaIDlsoft, vpPeriodo, vpGestion, DATE(), vpTipoLibro, TIME(DATETIME()), ;
				SYS(0), usuario,vpModoLibro)
	UNLOCK ALL
	
	IF vpModoLibro=1 THEN
		IF !This.mActivaTablas(.f., vFechaProceso,.t.) THEN
			WAIT WINDOW "Error ubicando tabla periodica"
			RETURN .f.
		ENDIF
	ELSE
		IF !This.mActivaTablas(.f., vFechaProceso,.f.,.f.,.f.,.f.,.f.,.f.,;
											  .f.,.f.,.f.,.f.,.f.,.f.,.f.,.f.,.f.,.f.,.f.,.f.,.t.) THEN
			WAIT WINDOW "Error ubicando tabla periodica"
			RETURN .f.
		ENDIF
	ENDIF

	GO TOP IN cDocumentos
	DO WHILE !EOF("cDOCUMENTOS")
		IF vpModoLibro=1 THEN
			IF SEEK(cDocumentos.Tipo+cDocumentos.Numero, "tACTUAL",1) THEN
				Replace IDenvLV WITH LibVentas.IDenvio, ;
						TipEnvLV WITH ALLTRIM(STR(vpTipoLibro)) IN tActual
			ENDIF
		ELSE
			IF SEEK(cDocumentos.Tipo+cDocumentos.Folio, "tCOMPRA",1) THEN
				Replace IDenvLC WITH LibVentas.IDenvio, ;
						TipEnvLC WITH ALLTRIM(STR(vpTipoLibro)) IN tCompra
			ENDIF
		ENDIF
		SKIP IN cDocumentos
	ENDDO
	
	IF vpModoLibro=1 THEN
		IF USED("tACTUAL") THEN
			USE IN tActual
		ENDIF
	ELSE
		IF USED("tCOMPRA") THEN
			USE IN tCompra
		ENDIF
	ENDIF
	
	=MESSAGEBOX(vMensajePregunta+" ... Enviado exitosamente:"+CHR(13)+;
				" - ID lSOFT: "+ALLTRIM(STR(vRetornaIDlsoft))+CHR(13)+;
				" - Hora de Envio: "+ALLTRIM(LibVentas.Hora)+CHR(13)+;
				" - Periodo : "+aMeses(vpPeriodo,1)+"-"+ALLTRIM(STR(vpGestion))+CHR(13)+;
				" - Tipo de Envio : "+vTipoEnvio)
					
	Thisform.Release 	
ELSE
	UNLOCK ALL
	=MESSAGEBOX("Error al enviar Libro a Aplicacion Secundaria")
	RETURN .f.
ENDIF

RETURN .t.

ENDPROC
PROCEDURE parmaxmlcompras
PUBLIC vArchivo, vXML, vXMLLV

STORE "" TO vXMLLV, vArchivo
vArchivo="c:\Erp7.0\TablasTemporales\TMPLibroCompras.XML"

DELETE FILE &vArchivo

GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador

vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR

vClienteEmisor=PADL(ALLTRIM(vRutCliente+"-"+vDigitoVerificador),12," ")

STORE vClienteEmisor TO vRutEmisor, vRutEnvia

STORE "" TO vComunaOrigen, vCiudadOrigen, vDireccionOrigen

IF !EMPTY(ALLTRIM(vClienteEmisor)) THEN
	IF SEEK(vClienteEmisor, "CLIENTES",1) THEN
		vComunaOrigen		=This.pFiltraEspeciales(Clientes.clComuna)
		vCiudadOrigen		=This.pFiltraEspeciales(Clientes.clCiudad)
		vDireccionOrigen	=This.pFiltraEspeciales(Clientes.clDirec)
	ELSE
		=MESSAGEBOX("Error intentando localizar al Emisor en Maestra de Clientes")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("Rut de Emisor no valido")
	RETURN .f.
ENDIF

IF This.pExtraeDatosEmisor(vRutCliente, vDigitoVerificador)=0 THEN
	=MESSAGEBOX("No existen Datos del Emisor")
	RETURN .f.
ENDIF

*!*	aRespuesta(1)=STREXTRACT(RespuestaWs,'<Id>','</Id>')
*!*	aRespuesta(2)=STREXTRACT(RespuestaWs,'<Rut>','</Rut>')
*!*	aRespuesta(3)=STREXTRACT(RespuestaWs,'<Dv>','</Dv>')
*!*	aRespuesta(4)=STREXTRACT(RespuestaWs,'<Nombre>','</Nombre>')
*!*	aRespuesta(5)=STREXTRACT(RespuestaWs,'<RazonSocial>','</RazonSocial>')
*!*	aRespuesta(6)=STREXTRACT(RespuestaWs,'<Giro>','</Giro>')
*!*	aRespuesta(7)=STREXTRACT(RespuestaWs,'<Acteco>','</Acteco>')
*!*	aRespuesta(8)=STREXTRACT(RespuestaWs,'<CodigoSucursalSII>','</CodigoSucursalSII>')
*!*	aRespuesta(9)=STREXTRACT(RespuestaWs,'<TelefonoContacto>','</TelefonoContacto>')
*!*	aRespuesta(10)=STREXTRACT(RespuestaWs,'<Email>','</Email>')
*!*	aRespuesta(11)=STREXTRACT(RespuestaWs,'<FechaResolucion>','</FechaResolucion>')
*!*	aRespuesta(12)=STREXTRACT(RespuestaWs,'<NroResolucion>','</NroResolucion>')
*!*	aRespuesta(13)=STREXTRACT(RespuestaWs,'<RutEnvia>','</RutEnvia>')

STORE "" TO vXMLLV

vRutEnvia="9244396-5"

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutLibroCompraVenta>
         <lsof:libroCompraVenta>
            <lsof:EnvioLibro>
               <lsof:Caratula>
                  <lsof:RutEmisorLibro><<ALLTRIM(vRutCliente)>></lsof:RutEmisorLibro>
                  <lsof:DvEmisorLibro><<vDigitoVerificador>></lsof:DvEmisorLibro>
                  <lsof:RutEnvia><<ALLTRIM(aRespuesta(13))>></lsof:RutEnvia>
                  <lsof:PeriodoTributario><<PADL(ALLTRIM(STR(vgGestion)),4,"0")+"-"+PADL(ALLTRIM(STR(vgPeriodo)),2,"0")>></lsof:PeriodoTributario>
                  <lsof:FchResol><<aRespuesta(11)>></lsof:FchResol>
                  <lsof:NroResol><<aRespuesta(12)>></lsof:NroResol>
                  <lsof:TipoOperacion>COMPRA</lsof:TipoOperacion>
                  <lsof:TipoLibro>ESPECIAL</lsof:TipoLibro>
                  <lsof:TipoEnvio>TOTAL</lsof:TipoEnvio>
                  <lsof:NroSegmento/>
                  <lsof:FolioNotificacion>2</lsof:FolioNotificacion>
                  <lsof:CodAutRec/>
               </lsof:Caratula>
               <lsof:ResumenPeriodo>
                  <lsof:TotalesPeriodo>
ENDTEXT

vXMLLV=vXMLLV+CHR(10)

GO TOP IN ResCur
DO WHILE !EOF("RESCUR")
	IF ResCur.Total<=0 THEN
		SKIP IN ResCur
		LOOP
	ENDIF
	
	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:TotalesPeriodo>
                        <lsof:TpoDoc><<ALLTRIM(STR(ResCur.IDsii))>></lsof:TpoDoc>
                        <lsof:TpoImp>1</lsof:TpoImp>
                        <lsof:TotDoc><<ALLTRIM(STR(ResCur.Cantidad))>></lsof:TotDoc>
                        <lsof:TotAnulado/>
    ENDTEXT

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.Exento>0 THEN
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpExe><<ALLTRIM(STR(ResCur.NumOPExento))>></lsof:TotOpExe>
                        <lsof:TotMntExe><<ALLTRIM(STR(ResCur.Exento))>></lsof:TotMntExe>
        ENDTEXT
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpExe/>
    					<lsof:TotMntExe/>
    	ENDTEXT
    ENDIF

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.Afecto>0 THEN
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
    					<lsof:TotMntNeto><<ALLTRIM(STR(ResCur.Afecto))>></lsof:TotMntNeto>
    	ENDTEXT
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotMntNeto/>
        ENDTEXT
    ENDIF

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.NumOPIvaRec=0 THEN
		IF ResCur.NumOpRetenido=0 THEN
		    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVARec/>
                        <lsof:TotMntIVA/>
	    	ENDTEXT
	    ELSE
		    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVARec><<ALLTRIM(STR(ResCur.NumOPIVARec))>></lsof:TotOpIVARec>
	    				<lsof:TotMntIVA><<ALLTRIM(STR(ResCur.IVARecupera ))>></lsof:TotMntIVA>
		   	ENDTEXT
	    ENDIF
	ELSE
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVARec><<ALLTRIM(STR(ResCur.NumOPIVARec))>></lsof:TotOpIVARec>
	    				<lsof:TotMntIVA><<ALLTRIM(STR(ResCur.IVARecupera ))>></lsof:TotMntIVA>
	   	ENDTEXT
	ENDIF 	
    vXMLLV=vXMLLV+CHR(10)

	IF ResCur.NumOpActFijo=0 THEN 	
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpActivoFijo/>
                        <lsof:TotMntActivoFijo/>
                        <lsof:TotMntIVAActivoFijo/>
	    ENDTEXT
	ELSE
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpActivoFijo><<ALLTRIM(STR(ResCur.NumOPActFijo))>></lsof:TotOpActivoFijo>
                        <lsof:TotMntActivoFijo><<ALLTRIM(STR(ResCur.NetoActivoFijo))>></lsof:TotMntActivoFijo>
                        <lsof:TotMntIVAActivoFijo><<ALLTRIM(STR(ResCur.IVAActivoFijo))>></lsof:TotMntIVAActivoFijo>
	    ENDTEXT
	ENDIF

    vXMLLV=vXMLLV+CHR(10)

	IF ResCur.NumOpNoRec=0 THEN 	
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotIVANoRec/>
	    ENDTEXT
	ELSE
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotIVANoRec>
                            <lsof:TotIVANoRec>
                               <lsof:CodIVANoRec>4</lsof:CodIVANoRec>
                               <lsof:TotOpIVANoRec><<ALLTRIM(STR(ResCur.NumOpNoRec))>></lsof:TotOpIVANoRec>
                               <lsof:TotMntIVANoRec><<ALLTRIM(STR(ResCur.IVANoRec))>></lsof:TotMntIVANoRec>
                            </lsof:TotIVANoRec>
                         </lsof:TotIVANoRec>
	    ENDTEXT 		
	ENDIF

    vXMLLV=vXMLLV+CHR(10)

	IF ResCur.NumOPUsoCom=0 THEN
		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVAUsoComun/>
                        <lsof:TotIVAUsoComun/>
                        <lsof:FctProp/>
                        <lsof:TotCredIVAUsoComun/>
		ENDTEXT
	ELSE
		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVAUsoComun><<ALLTRIM(STR(ResCur.NumOPUsoCom))>></lsof:TotOpIVAUsoComun>
                        <lsof:TotIVAUsoComun><<ALLTRIM(STR(ResCur.IVAUsoComun))>></lsof:TotIVAUsoComun>
                        <lsof:FctProp>0.6</lsof:FctProp>
                        <lsof:TotCredIVAUsoComun><<ALLTRIM(STR(ROUND(ResCur.IVAUsoComun*0.6,0)))>></lsof:TotCredIVAUsoComun>
		ENDTEXT
	ENDIF

    vXMLLV=vXMLLV+CHR(10)

    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotIVAFueraPlazo/>
                        <lsof:TotIVAPropio/>
                        <lsof:TotIVATerceros/>
                        <lsof:TotLey18211/>
    ENDTEXT

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.OtrImp=0 THEN
    	IF ResCur.IVARetenido>0 THEN
	    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOtrosImp>
                           <lsof:TotOtrosImp>
                              <lsof:CodImp>15</lsof:CodImp>
                              <lsof:TotMntImp><<ALLTRIM(STR(ResCur.IVARetenido))>></lsof:TotMntImp>
                              <lsof:FctImpAdic/>
                              <lsof:TotCredImp/>
                           </lsof:TotOtrosImp>
                        </lsof:TotOtrosImp>    	
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

    	ELSE
	    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	    					<lsof:TotOtrosImp/>
	    	ENDTEXT
	   	ENDIF
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOtrosImp>
        ENDTEXT

		vXMLLV=vXMLLV+CHR(10)

		FOR vI=1 TO 9
			vClave="RESCUR.ILA"+ALLTRIM(STR(vI))
			vCodigo=vI
			vMontoImpto=&vClave
			
			IF vMontoImpto>0 THEN
				IF SEEK(vCodigo, "IMPTOADIC",1) THEN
					vCodigoImpuesto=ImptoAdic.ID_snii
				ELSE
					LOOP
				ENDIF
			ELSE
				LOOP
			ENDIF
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE 						
                           <lsof:TotOtrosImp>
                              <lsof:CodImp><<vCodigoImpuesto>></lsof:CodImp>
                              <lsof:TotMntImp><<ALLTRIM(STR(vMontoImpto))>></lsof:TotMntImp>
                              <lsof:FctImpAdic/>
                              <lsof:TotCredImp/>
                           </lsof:TotOtrosImp>
		    ENDTEXT
		    vXMLLV=vXMLLV+CHR(10)
		ENDFOR 					

		IF ResCur.IVARetenido>0 THEN
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE 						
                           <lsof:TotOtrosImp>
                              <lsof:CodImp>15</lsof:CodImp>
                              <lsof:TotMntImp><<ALLTRIM(STR(ResCur.IVARetenido))>></lsof:TotMntImp>
                              <lsof:FctImpAdic/>
                              <lsof:TotCredImp/>
                           </lsof:TotOtrosImp>
		
			ENDTEXT
			vXMLLV=vXMLLV+CHR(10)	
		ENDIF
		
		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	                     </lsof:TotOtrosImp>
	    ENDTEXT
	ENDIF
	
	vXMLLV=vXMLLV+CHR(10)	

	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotImpSinCredito/>
	ENDTEXT

	vXMLLV=vXMLLV+CHR(10)
	
*!*		IF ResCur.NumOpRetenido=0 THEN
*!*			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                        <lsof:TotOpIVARetTotal/>
*!*	                        <lsof:TotIVARetTotal/>
*!*	        ENDTEXT
*!*	    ELSE
*!*			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                        <lsof:TotOpIVARetTotal><<ALLTRIM(STR(ResCur.NumOpRetenido))>></lsof:TotOpIVARetTotal>
*!*	                        <lsof:TotIVARetTotal><<ALLTRIM(STR(ResCur.IVARetenido))>></lsof:TotIVARetTotal>
*!*	        ENDTEXT
*!*	    ENDIF

*!*		vXMLLV=vXMLLV+CHR(10)

	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVARetParcial/>
                        <lsof:TotIVARetParcial/>
                        <lsof:TotCredEC/>
                        <lsof:TotDepEnvase/>
                        <lsof:TotLiquidaciones/>
                        <lsof:TotMntTotal><<ALLTRIM(STR(Rescur.Total))>></lsof:TotMntTotal>
                        <lsof:TotOpIVANoRetenido/>
                        <lsof:TotIVANoRetenido/>
                        <lsof:TotMntNoFact/>
                        <lsof:TotMntPeriodo/>
                        <lsof:TotPsjNac/>
                        <lsof:TotPsjInt/>
                        <lsof:TotTabPuros/>
                        <lsof:TotTabCigarrillos/>
                        <lsof:TotTabElaborado/>
                        <lsof:TotImpVehiculo/>
                     </lsof:TotalesPeriodo>
	ENDTEXT
	
	vXMLLV=vXMLLV+CHR(10)
	
	SKIP IN ResCur
ENDDO

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	              </lsof:TotalesPeriodo>
                  <lsof:TotFolAnulado/>
                  <lsof:TotGuiaAnulada/>
                  <lsof:TotGuiaVenta/>
                  <lsof:TotMntGuiaVta/>
                  <lsof:TotMntModificado/>
               </lsof:ResumenPeriodo>
               <lsof:Detalle>
ENDTEXT


vXMLLV=vXMLLV+CHR(10)

SELECT ResCur
SET ORDER TO


GO TOP IN ResCur
DO WHILE !EOF("RESCUR")
	IF resCur.Total<=0 THEN
		SKIP IN ResCur
		LOOP
	ENDIF
	
	vContadorDocumento=0
	
	IF SEEK(ResCur.IDerp, "cDOCUMENTOS",1) THEN
		DO WHILE !EOF("cDOCUMENTOS") .and. cDocumentos.Tipo=ResCur.IDerp
			vFechaDoc=PADL(ALLTRIM(STR(YEAR(cDocumentos.Fecha))),4,"0")+"-"+;
					  PADL(ALLTRIM(STR(MONTH(cDocumentos.Fecha))),2,"0")+"-"+;
					  PADL(ALLTRIM(STR(DAY(cDocumentos.Fecha))),2,"0")
			STORE "" TO vNumeroReferencia, vTipoReferencia, vFechaReferencia

			vContadorDocumento=vContadorDocumento+1
			
			WAIT WINDOW "Documento: "+ResCur.IDERP+", "+ALLTRIM(STR(vContadorDocumento))+" de "+ALLTRIM(STR(ResCur.Cantidad)) NOWAIT
			
			IF !EMPTY(ALLTRIM(cDocumentos.tioCnp)) .and. !EMPTY(ALLTRIM(cDocumentos.faoCnp)) THEN
				IF SEEK(cDocumentos.tioCnp, "TIPODOC",1) THEN
					vNumeroReferencia=ALLTRIM(STR(VAL(cDocumentos.faoCnp)))
					vTipoReferencia=ALLTRIM(TipoDoc.ID_snii)
					IF SEEK(cDocumentos.tioCNP+cDocumentos.faoCNP, "PRODOCTO",1) THEN
						vFechaReferencia=PADL(ALLTRIM(STR(YEAR(ProDocto.FecFac))),4,"0")+"-"+;
					  					 PADL(ALLTRIM(STR(MONTH(ProDocto.FecFac))),2,"0")+"-"+;
					  					 PADL(ALLTRIM(STR(DAY(ProDocto.FecFac))),2,"0")
					ENDIF
				ENDIF
			ENDIF
			
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                  <lsof:DetalleLibro>
                     <lsof:TpoDoc><<ResCur.IDsii>></lsof:TpoDoc>
                     <lsof:Emisor/>
                     <lsof:IndFactCompra/>
                     <lsof:NroDoc><<ALLTRIM(STR(VAL(cDocumentos.Numero)))>></lsof:NroDoc>
                     <lsof:Anulado/>
                     <lsof:Operacion>1</lsof:Operacion>
                     <lsof:TpoImp>1</lsof:TpoImp>
             ENDTEXT

             vXMLLV=vXMLLV+CHR(10)

             IF cDocumentos.Afecto>0 THEN
             	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:TasaImp>19</lsof:TasaImp>
                ENDTEXT
             ELSE
             	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
             		<lsof:TasaImp/>
             	ENDTEXT
             ENDIF

             vXMLLV=vXMLLV+CHR(10)

             TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:NumInt/>
                     <lsof:IndServicio/>
                     <lsof:IndSinCosto/>
                     <lsof:FchDoc><<vFechaDoc>></lsof:FchDoc>
                     <lsof:CdgSIISucur/>
                     <lsof:RUTDoc><<ALLTRIM(cDocumentos.RutPro)>></lsof:RUTDoc>
                     <lsof:RznSoc><<ALLTRIM(This.pFiltraEspeciales(cDocumentos.NomPro))>></lsof:RznSoc>
                     <lsof:Extranjero/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

            IF VAL(vNumeroReferencia)>0 THEN
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:TpoDocRef><<vTipoReferencia>></lsof:TpoDocRef>
                     <lsof:FolioDocRef><<vNumeroReferencia>></lsof:FolioDocRef>
            	ENDTEXT
            ELSE
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:TpoDocRef/>
                     <lsof:FolioDocRef/>
            	ENDTEXT
            ENDIF

            vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.Exento>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntExe><<ALLTRIM(STR(cDocumentos.Exento))>></lsof:MntExe>
                ENDTEXT
            ELSE
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntExe/>
                ENDTEXT
			ENDIF

			vXMLLV=vXMLLV+CHR(10)
			
			IF cDocumentos.Afecto=0 THEN
				TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntNeto/>
	            ENDTEXT
            ELSE
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntNeto><<ALLTRIM(STR(cDocumentos.Afecto))>></lsof:MntNeto>
				ENDTEXT
			ENDIF

			vXMLLV=vXMLLV+CHR(10)

			IF cDocumentos.IVAUsoComun>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntIVA/>
                ENDTEXT
            ELSE
            	IF cDocumentos.IVARetenido>0 THEN
		            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
	                 	<lsof:MntIVA><<ALLTRIM(STR(cDocumentos.IVARetenido))>></lsof:MntIVA>
	                ENDTEXT
*!*			            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*		                 	<lsof:MntIVA>0</lsof:MntIVA>
*!*		                ENDTEXT
            	ELSE
		            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
	                 	<lsof:MntIVA><<ALLTRIM(STR(cDocumentos.IVARecupera))>></lsof:MntIVA>
	                ENDTEXT
	            ENDIF
            ENDIF

			vXMLLV=vXMLLV+CHR(10)

			IF cDocumentos.NetoActivoFijo>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntActivoFijo><<ALLTRIM(STR(cDocumentos.NetoActivoFijo))>></lsof:MntActivoFijo>
                     <lsof:MntIVAActivoFijo><<ALLTRIM(STR(cDocumentos.IVAActivoFijo))>></lsof:MntIVAActivoFijo>
                ENDTEXT
            ELSE
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntActivoFijo/>
                     <lsof:MntIVAActivoFijo/>
                ENDTEXT
			ENDIF 							

			vXMLLV=vXMLLV+CHR(10)

			IF cDocumentos.NetoNoRec>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:IVANoRec>
                        <lsof:IVANoRec>
                           <lsof:CodIVANoRec>4</lsof:CodIVANoRec>
                           <lsof:MntIVANoRec><<ALLTRIM(STR(cDocumentos.IVANoRec))>></lsof:MntIVANoRec>
                        </lsof:IVANoRec>
                     </lsof:IVANoRec>
                ENDTEXT
            ELSE
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:IVANoRec/>
                ENDTEXT
			ENDIF

			vXMLLV=vXMLLV+CHR(10)
			
			IF cDocumentos.IVAUsoComun=0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:IVAUsoComun/>
				ENDTEXT
			ELSE
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:IVAUsoComun><<ALLTRIM(STR(cDocumentos.IVAUsoComun))>></lsof:IVAUsoComun>
				ENDTEXT
			ENDIF

			vXMLLV=vXMLLV+CHR(10)
								
            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:IVAFueraPlazo/>
                     <lsof:IVAPropio/>
                     <lsof:IVATerceros/>
                     <lsof:Ley18211/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.OtrImp=0 THEN
            	IF cDocumentos.IVARetenido>0 THEN
	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:OtrosImp>
                        <lsof:OtrosImp>
                           <lsof:CodImp>15</lsof:CodImp>
                           <lsof:TasaImp>19</lsof:TasaImp>
                           <lsof:MntImp><<ALLTRIM(STR(cDocumentos.IVARetenido))>></lsof:MntImp>
                        </lsof:OtrosImp>
                     </lsof:OtrosImp>
                     ENDTEXT
                ELSE
	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:OtrosImp/>
    	            ENDTEXT
    	        ENDIF
			ELSE
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:OtrosImp>
                ENDTEXT

			
				vXMLLV=vXMLLV+CHR(10)
				
				FOR vI=1 TO 9
					vClave="cDOCUMENTOS.ILA"+ALLTRIM(STR(vI))
					vCodigo=vI
					vMontoImpto=&vClave
					
					IF vMontoImpto>0 THEN
						IF SEEK(vCodigo, "IMPTOADIC",1) THEN
							vCodigoImpuesto=ImptoAdic.ID_snii
							vTasaImp=ImptoAdic.Monto
						ELSE
							LOOP
						ENDIF
					ELSE
						LOOP
					ENDIF
					
					TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	                        <lsof:OtrosImp>
	                           <lsof:CodImp>vCodigoImp>></lsof:CodImp>
	                           <lsof:TasaImp><<vTasaImp>></lsof:TasaImp>
	                           <lsof:MntImp><<vMontoImpto>></lsof:MntImp>
	                        </lsof:OtrosImp>
	                ENDTEXT
	            	
	            	vXMLLV=vXMLLV+CHR(10)
	            ENDFOR

            	IF cDocumentos.IVARetenido>0 THEN
	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                        <lsof:OtrosImp>
                           <lsof:CodImp>15</lsof:CodImp>
                           <lsof:TasaImp>19</lsof:TasaImp>
                           <lsof:MntImp><<ALLTRIM(STR(cDocumentos.IVARetenido))>></lsof:MntImp>
                        </lsof:OtrosImp>
                     ENDTEXT
                     vXMLLV=vXMLLV+CHR(10)
				ENDIF
						
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     </lsof:OtrosImp>
                ENDTEXT
			ENDIF
			
			vXMLLV=vXMLLV+CHR(10)
			
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:MntSinCred/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:IVARetParcial/>
                     <lsof:CredEC/>
                     <lsof:DepEnvase/>
                     <lsof:Liquidaciones/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.IVaRetenido>0 THEN
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:MntTotal><<ALLTRIM(STR(cDocumentos.Total))>></lsof:MntTotal>
                ENDTEXT
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                     <lsof:MntTotal><<ALLTRIM(STR(cDocumentos.Total-cDocumentos.IVARetenido))>></lsof:MntTotal>
*!*	                ENDTEXT
            ELSE
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:MntTotal><<ALLTRIM(STR(cDocumentos.Total))>></lsof:MntTotal>
                ENDTEXT
            ENDIF

            vXMLLV=vXMLLV+CHR(10)

            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:IVANoRetenido/>
                     <lsof:MntNoFact/>
                     <lsof:MntPeriodo/>
                     <lsof:PsjNac/>
                     <lsof:PsjInt/>
                     <lsof:TabPuros/>
                     <lsof:TabCigarrillos/>
                     <lsof:TabElaborado/>
                     <lsof:ImpVehiculo/>
                     <lsof:TpoOper/>
                     <lsof:MntModificado/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

            IF !EMPTY(ALLTRIM(vFechaReferencia)) THEN
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:FchDocRef><<vFechaReferencia>></lsof:FchDocRef>
				ENDTEXT
			ELSE 	
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:FchDocRef/>
				ENDTEXT
			ENDIF 				
			
			vXMLLV=vXMLLV+CHR(10)
			
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                  </lsof:DetalleLibro>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

			SKIP IN cDocumentos
		ENDDO
	ENDIF
	
	SKIP IN ResCur
ENDDO

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
               </lsof:Detalle>
            </lsof:EnvioLibro>
         </lsof:libroCompraVenta>
      </lsof:PutLibroCompraVenta>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

*!*	IF !Thisform.pGrabaEnDisco() THEN
*!*		RETURN .f.
*!*	ENDIF

RETURN vXMLLV


ENDPROC
PROCEDURE parmaxmlventas
PUBLIC vArchivo, vXML, vXMLLV

GO TOP IN prPrm

STORE "" TO vXMLLV, vArchivo
vArchivo="c:\Erp7.0\TablasTemporales\TMPLibroVentas.XML"

DELETE FILE &vArchivo

GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador

vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR

vClienteEmisor=PADL(ALLTRIM(vRutCliente+"-"+vDigitoVerificador),12," ")

STORE vClienteEmisor TO vRutEmisor, vRutEnvia

STORE "" TO vComunaOrigen, vCiudadOrigen, vDireccionOrigen

IF !EMPTY(ALLTRIM(vClienteEmisor)) THEN
	IF SEEK(vClienteEmisor, "CLIENTES",1) THEN
		vComunaOrigen		=This.pFiltraEspeciales(Clientes.clComuna)
		vCiudadOrigen		=This.pFiltraEspeciales(Clientes.clCiudad)
		vDireccionOrigen	=This.pFiltraEspeciales(Clientes.clDirec)
	ELSE
		=MESSAGEBOX("Error intentando localizar al Emisor en Maestra de Clientes")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("Rut de Emisor no valido")
	RETURN .f.
ENDIF

IF This.pExtraeDatosEmisor(vRutCliente, vDigitoVerificador)=0 THEN
	=MESSAGEBOX("No existen Datos del Emisor")
	RETURN .f.
ENDIF

*!*	aRespuesta(1)=STREXTRACT(RespuestaWs,'<Id>','</Id>')
*!*	aRespuesta(2)=STREXTRACT(RespuestaWs,'<Rut>','</Rut>')
*!*	aRespuesta(3)=STREXTRACT(RespuestaWs,'<Dv>','</Dv>')
*!*	aRespuesta(4)=STREXTRACT(RespuestaWs,'<Nombre>','</Nombre>')
*!*	aRespuesta(5)=STREXTRACT(RespuestaWs,'<RazonSocial>','</RazonSocial>')
*!*	aRespuesta(6)=STREXTRACT(RespuestaWs,'<Giro>','</Giro>')
*!*	aRespuesta(7)=STREXTRACT(RespuestaWs,'<Acteco>','</Acteco>')
*!*	aRespuesta(8)=STREXTRACT(RespuestaWs,'<CodigoSucursalSII>','</CodigoSucursalSII>')
*!*	aRespuesta(9)=STREXTRACT(RespuestaWs,'<TelefonoContacto>','</TelefonoContacto>')
*!*	aRespuesta(10)=STREXTRACT(RespuestaWs,'<Email>','</Email>')
*!*	aRespuesta(11)=STREXTRACT(RespuestaWs,'<FechaResolucion>','</FechaResolucion>')
*!*	aRespuesta(12)=STREXTRACT(RespuestaWs,'<NroResolucion>','</NroResolucion>')

STORE "" TO vXMLLV

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutLibroCompraVenta>
         <lsof:libroCompraVenta>
            <lsof:EnvioLibro>
               <lsof:Caratula>
                  <lsof:RutEmisorLibro><<ALLTRIM(vRutCliente)>></lsof:RutEmisorLibro>
                  <lsof:DvEmisorLibro><<vDigitoVerificador>></lsof:DvEmisorLibro>
                  <lsof:RutEnvia><<ALLTRIM(aRespuesta(13))>></lsof:RutEnvia>
                  <lsof:PeriodoTributario><<PADL(ALLTRIM(STR(vgGestion)),4,"0")+"-"+PADL(ALLTRIM(STR(vgPeriodo)),2,"0")>></lsof:PeriodoTributario>
                  <lsof:FchResol><<aRespuesta(11)>></lsof:FchResol>
                  <lsof:NroResol><<aRespuesta(12)>></lsof:NroResol>
                  <lsof:TipoOperacion>VENTA</lsof:TipoOperacion>
                  <lsof:TipoLibro>ESPECIAL</lsof:TipoLibro>
                  <lsof:TipoEnvio>TOTAL</lsof:TipoEnvio>
                  <lsof:NroSegmento/>
                  <lsof:FolioNotificacion>1</lsof:FolioNotificacion>
                  <lsof:CodAutRec/>
               </lsof:Caratula>
               <lsof:ResumenPeriodo>
                  <lsof:TotalesPeriodo>
ENDTEXT

vXMLLV=vXMLLV+CHR(10)
					
GO TOP IN ResCur
DO WHILE !EOF("RESCUR")
	IF ResCur.Cantidad=0 THEN
		SKIP IN ResCur
		LOOP
	ENDIF
	
*!*		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                     <lsof:TotalesPeriodo>
*!*	                        <lsof:TpoDoc><<ALLTRIM(STR(ResCur.IDsii))>></lsof:TpoDoc>
*!*	                        <lsof:TpoImp>1</lsof:TpoImp>
*!*	                        <lsof:TotDoc><<ALLTRIM(STR(ResCur.Cantidad))>></lsof:TotDoc>
*!*	                        <lsof:TotAnulado/>
*!*	                        <lsof:TotOpExe/>
*!*	    ENDTEXT

	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:TotalesPeriodo>
                        <lsof:TpoDoc><<ALLTRIM(STR(ResCur.IDsii))>></lsof:TpoDoc>
                        <lsof:TpoImp/>
                        <lsof:TotDoc><<ALLTRIM(STR(ResCur.Cantidad))>></lsof:TotDoc>
                        <lsof:TotAnulado/>
                        <lsof:TotOpExe/>
    ENDTEXT

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.Exento>0 THEN
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotMntExe><<ALLTRIM(STR(ResCur.Exento))>></lsof:TotMntExe>
        ENDTEXT
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
    					<lsof:TotMntExe>0</lsof:TotMntExe>
    	ENDTEXT
    ENDIF

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.Afecto>0 THEN
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
    					<lsof:TotMntNeto><<ALLTRIM(STR(ResCur.Afecto))>></lsof:TotMntNeto>
    	ENDTEXT
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotMntNeto>0</lsof:TotMntNeto>
        ENDTEXT
    ENDIF

    vXMLLV=vXMLLV+CHR(10)

    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpIVARec/>
    ENDTEXT

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.Afecto>0 THEN
	    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	    				<lsof:TotMntIVA><<ALLTRIM(STR(ResCur.IVA))>></lsof:TotMntIVA>
	   	ENDTEXT
*!*		    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*		    				<lsof:TotMntIVA><<ALLTRIM(STR(ROUND(ResCur.Afecto*0.19,0)))>></lsof:TotMntIVA>
*!*		   	ENDTEXT 	   	
	ELSE
		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotMntIVA>0</lsof:TotMntIVA>
        ENDTEXT
    ENDIF

	vXMLLV=vXMLLV+CHR(10)
	
    TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOpActivoFijo/>
                        <lsof:TotMntActivoFijo/>
                        <lsof:TotMntIVAActivoFijo/>
                        <lsof:TotIVANoRec/>
                        <lsof:TotOpIVAUsoComun/>
                        <lsof:TotIVAUsoComun/>
                        <lsof:FctProp/>
                        <lsof:TotCredIVAUsoComun/>
                        <lsof:TotIVAFueraPlazo/>
                        <lsof:TotIVAPropio/>
                        <lsof:TotIVATerceros/>
                        <lsof:TotLey18211/>
    ENDTEXT

    vXMLLV=vXMLLV+CHR(10)

    IF ResCur.OtrImp=0 THEN
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
    					<lsof:TotOtrosImp/>
    	ENDTEXT
    ELSE
    	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotOtrosImp>
        ENDTEXT

		vXMLLV=vXMLLV+CHR(10)

		FOR vI=1 TO 9
			vClave="RESCUR.ILA"+ALLTRIM(STR(vI))
			vCodigo=vI
			vMontoImpto=&vClave
			
			IF vMontoImpto>0 THEN
				IF SEEK(vCodigo, "IMPTOADIC",1) THEN
					vCodigoImpuesto=ImptoAdic.ID_snii
				ELSE
					LOOP
				ENDIF
			ELSE
				LOOP
			ENDIF
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE 						
	                           <lsof:TotOtrosImp>
	                              <lsof:CodImp><<vCodigoImpuesto>></lsof:CodImp>
	                              <lsof:TotMntImp><<ALLTRIM(STR(vMontoImpto))>></lsof:TotMntImp>
	                              <lsof:FctImpAdic/>
	                              <lsof:TotCredImp/>
	                           </lsof:TotOtrosImp>
		    ENDTEXT
		    vXMLLV=vXMLLV+CHR(10)
		ENDFOR 					

		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	                     </lsof:TotOtrosImp>
	    ENDTEXT
	ENDIF
	
	vXMLLV=vXMLLV+CHR(10)
	
	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                        <lsof:TotImpSinCredito/>
                        <lsof:TotOpIVARetTotal/>
                        <lsof:TotIVARetTotal/>
                        <lsof:TotOpIVARetParcial/>
                        <lsof:TotIVARetParcial/>
                        <lsof:TotCredEC/>
                        <lsof:TotDepEnvase/>
                        <lsof:TotLiquidaciones/>
                        <lsof:TotMntTotal><<ALLTRIM(STR(Rescur.Total))>></lsof:TotMntTotal>
                        <lsof:TotOpIVANoRetenido/>
                        <lsof:TotIVANoRetenido/>
                        <lsof:TotMntNoFact/>
                        <lsof:TotMntPeriodo/>
                        <lsof:TotPsjNac/>
                        <lsof:TotPsjInt/>
                        <lsof:TotTabPuros/>
                        <lsof:TotTabCigarrillos/>
                        <lsof:TotTabElaborado/>
                        <lsof:TotImpVehiculo/>
                     </lsof:TotalesPeriodo>
	ENDTEXT

*!*		TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                        <lsof:TotImpSinCredito/>
*!*	                        <lsof:TotOpIVARetTotal/>
*!*	                        <lsof:TotIVARetTotal/>
*!*	                        <lsof:TotOpIVARetParcial/>
*!*	                        <lsof:TotIVARetParcial/>
*!*	                        <lsof:TotCredEC/>
*!*	                        <lsof:TotDepEnvase/>
*!*	                        <lsof:TotLiquidaciones/>
*!*	                        <lsof:TotMntTotal><<ALLTRIM(STR(Rescur.Afecto+ResCur.Exento+ROUND(ResCur.Afecto*0.19,0)+ResCur.OtrImp))>></lsof:TotMntTotal>
*!*	                        <lsof:TotOpIVANoRetenido/>
*!*	                        <lsof:TotIVANoRetenido/>
*!*	                        <lsof:TotMntNoFact/>
*!*	                        <lsof:TotMntPeriodo/>
*!*	                        <lsof:TotPsjNac/>
*!*	                        <lsof:TotPsjInt/>
*!*	                        <lsof:TotTabPuros/>
*!*	                        <lsof:TotTabCigarrillos/>
*!*	                        <lsof:TotTabElaborado/>
*!*	                        <lsof:TotImpVehiculo/>
*!*	                     </lsof:TotalesPeriodo>
*!*		ENDTEXT
	
	vXMLLV=vXMLLV+CHR(10)
	
	SKIP IN ResCur
ENDDO

*vXMLLV=vXMLLV+CHR(10)

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	              </lsof:TotalesPeriodo>
                  <lsof:TotFolAnulado/>
                  <lsof:TotGuiaAnulada/>
                  <lsof:TotGuiaVenta/>
                  <lsof:TotMntGuiaVta/>
                  <lsof:TotMntModificado/>
               </lsof:ResumenPeriodo>
               <lsof:Detalle>
ENDTEXT


vXMLLV=vXMLLV+CHR(10)

GO TOP IN ResCur
DO WHILE !EOF("RESCUR")
	IF resCur.Cantidad<=0 THEN
		SKIP IN ResCur
		LOOP
	ENDIF
	
	vContadorDocumento=0
	
	IF SEEK(ResCur.IDerp, "cDOCUMENTOS",1) THEN
		DO WHILE !EOF("cDOCUMENTOS") .and. cDocumentos.fatDocTo=ResCur.IDerp
			vFechaDoc=PADL(ALLTRIM(STR(YEAR(cDocumentos.faFecha))),4,"0")+"-"+;
					  PADL(ALLTRIM(STR(MONTH(cDocumentos.faFecha))),2,"0")+"-"+;
					  PADL(ALLTRIM(STR(DAY(cDocumentos.faFecha))),2,"0")
			STORE "" TO vNumeroReferencia, vTipoReferencia, vFechaReferencia

			vContadorDocumento=vContadorDocumento+1
			
			WAIT WINDOW "Documento: "+ResCur.IDERP+", "+ALLTRIM(STR(vContadorDocumento))+" de "+ALLTRIM(STR(ResCur.Cantidad)) NOWAIT
			
			IF !EMPTY(ALLTRIM(cDocumentos.tioCnp)) .and. !EMPTY(ALLTRIM(cDocumentos.faoCnp)) THEN
				IF SEEK(cDocumentos.tioCnp, "TIPODOC",1) THEN
					vNumeroReferencia=ALLTRIM(STR(VAL(cDocumentos.faoCnp)))
					vTipoReferencia=ALLTRIM(TipoDoc.ID_snii)
					IF SEEK(cDocumentos.tioCNP+cDocumentos.faoCNP, "CLIDOCTO",1) THEN
						vFechaReferencia=PADL(ALLTRIM(STR(YEAR(CliDocto.FecFac))),4,"0")+"-"+;
					  					 PADL(ALLTRIM(STR(MONTH(CliDocto.FecFac))),2,"0")+"-"+;
					  					 PADL(ALLTRIM(STR(DAY(CliDocto.FecFac))),2,"0")
					ENDIF
				ENDIF
			ENDIF
			
*!*				TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                  <lsof:DetalleLibro>
*!*	                     <lsof:TpoDoc><<ResCur.IDsii>></lsof:TpoDoc>
*!*	                     <lsof:Emisor/>
*!*	                     <lsof:IndFactCompra/>
*!*	                     <lsof:NroDoc><<ALLTRIM(STR(VAL(cDocumentos.faNumero)))>></lsof:NroDoc>
*!*	                     <lsof:Anulado/>
*!*	                     <lsof:Operacion>1</lsof:Operacion>
*!*	                     <lsof:TpoImp>1</lsof:TpoImp>
*!*	             ENDTEXT

*!*				TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                  <lsof:DetalleLibro>
*!*	                     <lsof:TpoDoc><<ResCur.IDsii>></lsof:TpoDoc>
*!*	                     <lsof:Emisor/>
*!*	                     <lsof:IndFactCompra/>
*!*	                     <lsof:NroDoc><<ALLTRIM(STR(VAL(cDocumentos.faNumero)))>></lsof:NroDoc>
*!*	                     <lsof:Anulado/>
*!*	                     <lsof:Operacion>1</lsof:Operacion>
*!*	                     <lsof:TpoImp/>
*!*	             ENDTEXT

 			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                  <lsof:DetalleLibro>
                     <lsof:TpoDoc><<ResCur.IDsii>></lsof:TpoDoc>
                     <lsof:Emisor/>
                     <lsof:IndFactCompra/>
                     <lsof:NroDoc><<ALLTRIM(STR(VAL(cDocumentos.faNumero)))>></lsof:NroDoc>
                     <lsof:Anulado/>
             ENDTEXT
             vXMLLV=vXMLLV+CHR(10)

             IF cDocumentos.faAfecto>0 THEN
             	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:TasaImp><<ALLTRIM(STR(INT(ROUND((cDocumentos.faIVA*100)/cDocumentos.faAfecto,0))))>></lsof:TasaImp>
                ENDTEXT
             ELSE
             	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
             		<lsof:TasaImp><<ALLTRIM(STR(INT(prPrm.paIva)))>></lsof:TasaImp>
             	ENDTEXT
             ENDIF

             vXMLLV=vXMLLV+CHR(10)

             TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:NumInt/>
                     <lsof:IndServicio/>
                     <lsof:IndSinCosto/>
                     <lsof:FchDoc><<vFechaDoc>></lsof:FchDoc>
                     <lsof:CdgSIISucur/>
                     <lsof:RUTDoc><<ALLTRIM(cDocumentos.faRutCli)>></lsof:RUTDoc>
                     <lsof:RznSoc><<ALLTRIM(This.pFiltraEspeciales(cDocumentos.faNomCli))>></lsof:RznSoc>
                     <lsof:Extranjero/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

*!*	            IF VAL(vNumeroReferencia)>0 THEN
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                     <lsof:TpoDocRef><<vTipoReferencia>></lsof:TpoDocRef>
*!*	                     <lsof:FolioDocRef><<vNumeroReferencia>></lsof:FolioDocRef>
*!*	            	ENDTEXT
*!*	            ELSE
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                     <lsof:TpoDocRef/>
*!*	                     <lsof:FolioDocRef/>
*!*	            	ENDTEXT
*!*	            ENDIF

*!*	            vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.faExento>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntExe><<ALLTRIM(STR(cDocumentos.faExento))>></lsof:MntExe>
                ENDTEXT
            ELSE
*!*		            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                     <lsof:MntExe/>
*!*	                ENDTEXT
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntExe>0</lsof:MntExe>
                ENDTEXT
            ENDIF

			vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.faAfecto>0 THEN
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntNeto><<ALLTRIM(STR(cDocumentos.faAfecto))>></lsof:MntNeto>
                     <lsof:MntIVA><<ALLTRIM(STR(cDocumentos.faIVA))>></lsof:MntIVA>
				ENDTEXT
            ELSE
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
*!*	                     <lsof:MntNeto/>
*!*	                     <lsof:MntIVA/>
*!*		            ENDTEXT
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntNeto>0</lsof:MntNeto>
                     <lsof:MntIVA>0</lsof:MntIVA>
	            ENDTEXT
			ENDIF
			
			vXMLLV=vXMLLV+CHR(10)
			
            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:MntActivoFijo/>
                     <lsof:MntIVAActivoFijo/>
                     <lsof:IVANoRec/>
                     <lsof:IVAUsoComun/>
                     <lsof:IVAFueraPlazo/>
                     <lsof:IVAPropio/>
                     <lsof:IVATerceros/>
                     <lsof:Ley18211/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

            IF cDocumentos.OtrImp=0 THEN
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:OtrosImp/>
                ENDTEXT
			ELSE
            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE			
                     <lsof:OtrosImp>
                ENDTEXT
			
				vXMLLV=vXMLLV+CHR(10)
				
				FOR vI=1 TO 9
					vClave="cDOCUMENTOS.ILA"+ALLTRIM(STR(vI))
					vCodigo=vI
					vMontoImpto=&vClave
					
					IF vMontoImpto>0 THEN
						IF SEEK(vCodigo, "IMPTOADIC",1) THEN
							vCodigoImpuesto=ImptoAdic.ID_snii
							vTasaImp=ImptoAdic.Monto
						ELSE
							LOOP
						ENDIF
					ELSE
						LOOP
					ENDIF
					
					TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
	                        <lsof:OtrosImp>
	                           <lsof:CodImp>vCodigoImp>></lsof:CodImp>
	                           <lsof:TasaImp><<vTasaImp>></lsof:TasaImp>
	                           <lsof:MntImp><<vMontoImpto>></lsof:MntImp>
	                        </lsof:OtrosImp>
	                ENDTEXT
	            	
	            	vXMLLV=vXMLLV+CHR(10)
	            ENDFOR
		
	            TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     </lsof:OtrosImp>
                ENDTEXT
			ENDIF
			
			vXMLLV=vXMLLV+CHR(10)
			
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                     <lsof:MntSinCred/>
                     <lsof:IVARetTotal/>
                     <lsof:IVARetParcial/>
                     <lsof:CredEC/>
                     <lsof:DepEnvase/>
                     <lsof:Liquidaciones/>
                     <lsof:MntTotal><<ALLTRIM(STR(cDocumentos.faTotal))>></lsof:MntTotal>
                     <lsof:IVANoRetenido/>
                     <lsof:MntNoFact/>
                     <lsof:MntPeriodo/>
                     <lsof:PsjNac/>
                     <lsof:PsjInt/>
                     <lsof:TabPuros/>
                     <lsof:TabCigarrillos/>
                     <lsof:TabElaborado/>
                     <lsof:ImpVehiculo/>
                     <lsof:TpoOper/>
                     <lsof:MntModificado/>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

*!*	            IF !EMPTY(ALLTRIM(vFechaReferencia)) THEN
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                     <lsof:FchDocRef><<vFechaReferencia>></lsof:FchDocRef>
*!*					ENDTEXT
*!*				ELSE 	
*!*	            	TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
*!*	                     <lsof:FchDocRef/>
*!*					ENDTEXT
*!*				ENDIF 				
			
*!*				vXMLLV=vXMLLV+CHR(10)
			
			TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
                  </lsof:DetalleLibro>
            ENDTEXT

            vXMLLV=vXMLLV+CHR(10)

			SKIP IN cDocumentos
		ENDDO
	ENDIF
	
	SKIP IN ResCur
ENDDO

*!*	STORE "" TO vXMLLV

TEXT TO vXMLLV TEXTMERGE NOSHOW ADDITIVE
               </lsof:Detalle>
            </lsof:EnvioLibro>
         </lsof:libroCompraVenta>
      </lsof:PutLibroCompraVenta>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

IF !Thisform.pGrabaEnDisco() THEN
	RETURN .f.
ENDIF

RETURN vXMLLV


ENDPROC
PROCEDURE pcalculadscreccab
LPARAMETERS vpTipoDscRecCab, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab, ;
			vpBndDocExento, vpFechaDoc, vpRetieneIVA, vpTasaIVA

DELETE FROM DscCur WHERE INLIST(TipDsc,6,7,8,10,11)

CALCULATE SUM(Afecto) TO vSumaAfectos		 IN ItemCur FOR ItemCur.Exento=0
CALCULATE SUM(Exento) TO vSumaAfectosExentos IN ItemCur FOR ItemCur.Exento>0

GO TOP IN ItemCur

DO WHILE !EOF("ITEMCUR")
	vBndProdExento=(ItemCur.Exento>0)

	vContinuaDscRecCab=.f.
	IF vpTipoDscRecCab=1 THEN
		IF !vBndProdExento .and. !vpBndDocExento  THEN
			vContinuaDscRecCab =.t.
		ENDIF
	ELSE
		IF vBndProdExento .or. vpBndDocExento  THEN
			vContinuaDscRecCab =.t.
		ENDIF
	ENDIF
	
	STORE 0 TO vMontoDsctoCabecera, vMontoRecCabecera
	
	IF vContinuaDscRecCab THEN   	
		IF (vpPorDscCab>0 .or. vpMonDscCab>0) THEN
			IF vpMonDscCab>0 THEN
				IF vpBndDocExento .or. vBndProdExento  THEN
					vDsctoCab=ROUND((vpMonDscCab*100)/vSumaAfectosExentos,0)
				ELSE
					vDsctoCab=ROUND((vpMonDscCab*100)/vSumaAfectos,0)
				ENDIF
			ELSE
				vDsctoCab=vpPorDscCab
			ENDIF
			
			vMontoDsctoCabecera=ROUND(ItemCur.NetoDetalle*(vDsctoCab/100),0)

			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 7, vDsctoCab, vMontoDsctoCabecera, ItemCur.Codigo, vpFechaDoc,1)
		ENDIF

		IF (vpPorRecCab>0 .or. vpMonRecCab>0) THEN
			IF vpMonRecCab>0 THEN
				IF vpBndDocExento .or. vBndProdExento  THEN
					vRecCab=ROUND((vpMonRecCab*100)/vSumaAfectos,0)
				ELSE
					vRecCab=Round((vpMonRecCab*100)/vSumaAfectosExentos,0)
				ENDIF
			ELSE
				vRecCab=vpPorRecCab
			ENDIF
			
			vMontoRecCabecera=ROUND(ItemCur.NetoDetalle*(vRecCab/100),0)

			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 10, vRecCab, vMontoRecCabecera, ItemCur.Codigo, vpFechaDoc, 2)
		ENDIF
	ENDIF 	
	
	IF ItemCur.Exento=0 THEN
		Replace ItemCur.Afecto WITH ItemCur.NetoDetalle-vMontoDsctoCabecera+vMontoRecCabecera IN ItemCur
	ELSE
		Replace ItemCur.Exento WITH ItemCur.NetoDetalle IN ItemCur
	ENDIF
	
	IF vpBndDocExento .or. vBndProdExento THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (ItemCur.Linea, 8, 0, ItemCur.Exento, ItemCur.Codigo, vpFechaDoc, 2)
	ELSE
		IF vpRetieneIVA THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 11, vpTasaIVA,;
								ROUND(ItemCur.Afecto*(vpTasaIVA/100),0), ;
								ItemCur.Codigo, vpFechaDoc, 2)		
		ELSE 	
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 6, vpTasaIVA,;
								ROUND(ItemCur.Afecto*(vpTasaIVA/100),0), ;
								ItemCur.Codigo, vpFechaDoc, 2)		
		ENDIF
	ENDIF 	

	IF ItemCur.Cod_IAD>0 THEN
		IF SEEK(ItemCur.Cod_IAD, "IMPTOADIC",1) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
						VALUES (ItemCur.Linea, 9, ImptoAdic.Monto,;
								ROUND(ItemCur.Afecto*(ImptoAdic.Monto/100),0), ;
								ItemCur.Codigo, vpFechaDoc, 2, ItemCur.Cod_IAD)		
		ENDIF
	ENDIF

	SKIP IN ItemCur
ENDDO


					
					
					
					
					
					
					
					
ENDPROC
PROCEDURE pcalculadscreccabdev
LPARAMETERS vpLinea, vpAfectoDscRecCab, vpFechaDoc, vpTipoDev

LOCAL vAcumPorDscCab, vAcumMonDscCab, vAcumPorRecCab, vAcumMonRecCab, ;
	  vDsctoCab, vMontoCab, vTipoDscRec

DELETE FROM DscCur WHERE INLIST(TipDsc,6,7,8,10,11,12,13) .and. DscCur.Linea=vpLinea

IF vpTipoDev=1 THEN
	IF !SEEK(vpLinea, "ITEMCUR",1) THEN
		RETURN .f.
	ENDIF

	IF !SEEK(vpLinea, "ORICUR",1) THEN
		RETURN .f.
	ENDIF
ENDIF

SET ORDER TO 1 IN OriDscCur

STORE 0 TO vAcumPorDscCab, vAcumMonDscCab, vAcumPorRecCab, vAcumMonRecCab

IF SEEK(vpLinea, "ORIDSCCUR",1) THEN
	DO WHILE !EOF("ORIDSCCUR") .and. OriDscCur.Linea=vpLinea
		IF !INLIST(OriDscCur.TipDsc,6,7,8,10,11,12,13) THEN
			SKIP IN OriDscCur
			LOOP
		ENDIF

		STORE 0 TO vPorCab, vMontoCab, vTipoDscRec
		
		DO CASE
			CASE INLIST(OriDscCur.TipDsc, 7, 12)
				vPorCab=OriDscCur.PorDsc
				vMontoCab=ROUND(ItemCur.NetoDetalle*(vPorCab/100),0)
				vTipoDscRec=IIF(OriDscCur.TipDsc=7,1,2)

				IF OriDscCur.TipDsc=7 THEN
					vAcumPorDscCab=vAcumPorDscCab+vPorCab
				ELSE
					vAcumMonDscCab=vAcumMonDscCab+vMontoCab
				ENDIF
				
			CASE INLIST(OriDscCur.TipDsc, 10, 13)
				vMontoCab=(OriDscCur.monDsc*ItemCur.NetoDetalle)/OriCur.NetoDetalle
				vPorCab=(OriDscCur.PorDsc*ItemCur.NetoDetalle)/OriCur.NetoDetalle
				vTipoDscRec=IIF(OriDscCur.TipDsc=11,1,2)

				IF OriDscCur.TipDsc=10 THEN
					vAcumPorDscCab=vAcumPorRecCab+vPorCab
				ELSE
					vAcumMonDscCab=vAcumMonRecCab+vMontoCab
				ENDIF
			CASE OriDscCur.TipDsc=8
				vMontoCab=ItemCur.Exento
				vPorCab=0
				vTipoDscRec=1
			CASE INLIST(OriDscCur.TipDsc,6,11)
				vMontoCab=ROUND(ItemCur.NetoDetalle*(aDocumentoRef(1,32)/100),0)
				vPorCab=aDocumentoRef(1,32)
				vTipoDscRec=2
		ENDCASE

		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (ItemCur.Linea, OriDscCur.tipDsc, vPorCab, vMontoCab, ;
							ItemCur.Codigo, vpFechaDoc,vTipoDscRec)
		
		SKIP IN OriDscCur
	ENDDO
ELSE
	RETURN .f.
ENDIF

IF RECCOUNT("DSCCUR")>0 THEN
	vCreaVectorDscRecCab= ;
		Thisform.Facturador1.pGeneraVectorDscRecCab(vpAfectoDscRecCab, ;
													vAcumPorDscCab, ;
													vAcumMonDscCab, ;
													vAcumPorRecCab, ;
													vAcumMonRecCab)	
ELSE
	RELEASE aDscRecCab
ENDIF

RETURN .t.

ENDPROC
PROCEDURE pcalculadscreccabv
LPARAMETERS vpTipoDscRecCab, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab, ;
			vpBndDocExento, vpFechaDoc, vpRetieneIVA, vpTasaIVA, vpNoApliDes

LOCAL vDevuelveafectos
******** Devuelve los montos que se restaron a los Afectos/Exentos por Descuentos o Recargos
vDevuelveAfectos=.t.
IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
	IF vpNoAplides THEN
		vDevuelveAfectos=.f.
	ENDIF
ENDIF

SET ORDER TO 2 IN DscCur

IF vDevuelveAfectos THEN
	GO TOP IN ItemCur
	DO WHILE !EOF("ITEMCUR")
		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF vpTipoDscRecCab=1 THEN
					DO CASE
						CASE INLIST(DscCur.TipDsc,7,12)
							Replace ItemCur.Afecto WITH (ItemCur.Afecto+DscCur.MonDsc) IN DscCur
						CASE INLIST(DscCur.TipDsc,10,13)
							Replace ItemCur.Afecto WITH (ItemCur.Afecto-DscCur.MonDsc) IN DscCur
					ENDCASE
				ELSE
					DO CASE
						CASE INLIST(DscCur.TipDsc,7,12)
							Replace ItemCur.Exento WITH (ItemCur.Exento+DscCur.MonDsc) IN DscCur
						CASE INLIST(DscCur.TipDsc,10,13)
							Replace ItemCur.Exento WITH (ItemCur.Exento-DscCur.MonDsc) IN DscCur
					ENDCASE
				ENDIF 	
				
				SKIP IN DscCur
			ENDDO
		ENDIF
		
		SKIP IN ItemCur
	ENDDO
ENDIF

DELETE FROM DscCur WHERE INLIST(TipDsc,6,7,8,10,11,12,13)

CALCULATE SUM(Afecto) TO vSumaAfectos		 IN ItemCur FOR ItemCur.Exento=0
CALCULATE SUM(Exento) TO vSumaAfectosExentos IN ItemCur FOR ItemCur.Exento>0

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")			
	vBndProdExento=(ItemCur.Exento>0)

	vContinuaDscRecCab=.f.
	IF vpTipoDscRecCab=1 THEN
		IF !vBndProdExento .and. !vpBndDocExento  THEN
			vContinuaDscRecCab =.t.
		ENDIF
	ELSE
		IF vBndProdExento .or. vpBndDocExento  THEN
			vContinuaDscRecCab =.t.
		ENDIF
	ENDIF
	
	STORE 0 TO vMontoDsctoCabecera, vMontoRecCabecera, vTipo
	IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
		IF ItemCur.noApliDes="S" THEN
			vContinuaDscRecCab=.f.
		ENDIF
*!*			IF vpNoAplides THEN
*!*				vContinuaDscRecCab=.f.
*!*			ENDIF
	ENDIF
	
	IF vContinuaDscRecCab THEN   	
		IF (vpPorDscCab>0 .or. vpMonDscCab>0) THEN
			IF vpMonDscCab>0 THEN
				IF vpBndDocExento .or. vBndProdExento  THEN
					vDsctoCab=(ItemCur.Exento*100)/vSumaAfectosExentos
				ELSE
					vDsctoCab=(ItemCur.Afecto*100)/vSumaAfectos
				ENDIF
				
				vMontoDsctoCabecera=vMontoDsctoCabecera+This.mRedondeo(vpMonDscCab*(vDsctoCab/100))
				
				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
							VALUES (ItemCur.Linea, 12, vDsctoCab, ROUND(vpMonDscCab*(vDsctoCab/100),0),;
								    ItemCur.Codigo, vpFechaDoc,1)				
			ENDIF
			IF vpPorDscCab>0 THEN
				vDsctoCab=vpPorDscCab
				
				vMontoDsctoCabecera=vMontoDsctoCabecera+This.mRedondeo(ItemCur.NetoDetalle*(vDsctoCab/100))
				
				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
							VALUES (ItemCur.Linea, 7, vDsctoCab, ROUND(ItemCur.NetoDetalle*(vDsctoCab/100),0), ;
									ItemCur.Codigo, vpFechaDoc,1)				
			ENDIF 			
		ENDIF

		IF (vpPorRecCab>0 .or. vpMonRecCab>0) THEN
			IF vpMonRecCab>0 THEN
				IF vpBndDocExento .or. vBndProdExento  THEN
					vRecCab=(ItemCur.Exento*100)/vSumaAfectosExentos
				ELSE
					vRecCab=(ItemCur.Afecto*100)/vSumaAfectos
				ENDIF
				
				vMontoRecCabecera=vMontoRecCabecera+This.mRedondeo(vpMonRecCab*(vRecCab/100))
				
				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
							VALUES (ItemCur.Linea, 13, vRecCab, ROUND(vpMonRecCab*(vRecCab/100),0), ;
									ItemCur.Codigo, vpFechaDoc, 2)
			ENDIF
			IF vpPorRecCab>0 THEN
				vRecCab=vpPorRecCab
				
				vMontoRecCabecera=vMontoRecCabecera+(vpMonRecCab*(vRecCab/100))
				
				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
							VALUES (ItemCur.Linea, 10, vRecCab, vpMonRecCab*(vRecCab/100), ;
									ItemCur.Codigo, vpFechaDoc, 2)
			ENDIF 			
		ENDIF
	ENDIF 	
	
	IF ItemCur.Exento=0 THEN
		Replace ItemCur.Afecto WITH ItemCur.NetoDetalle-vMontoDsctoCabecera+vMontoRecCabecera IN ItemCur
	ELSE
		Replace ItemCur.Exento WITH ItemCur.NetoDetalle IN ItemCur
	ENDIF
	
	IF vpBndDocExento .or. vBndProdExento THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (ItemCur.Linea, 8, 0, ItemCur.Exento, ItemCur.Codigo, vpFechaDoc, 2)
	ELSE
		IF vpRetieneIVA THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 11, vpTasaIVA,;
								ROUND(ItemCur.Afecto*(vpTasaIVA/100),0), ;
								ItemCur.Codigo, vpFechaDoc, 2)		
		ELSE 	
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 6, vpTasaIVA,;
								ROUND(ItemCur.Afecto*(vpTasaIVA/100),0), ;
								ItemCur.Codigo, vpFechaDoc, 2)		
		ENDIF
	ENDIF 	

	SKIP IN ItemCur
ENDDO
ENDPROC
PROCEDURE pcalculaiad
LPARAMETERS vpFechaDoc
DELETE FROM DscCur WHERE TipDsc=9

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF ItemCur.Cod_IAD>0 THEN
		IF SEEK(ItemCur.Cod_IAD, "IMPTOADIC",1) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
						VALUES (ItemCur.Linea, 9, ImptoAdic.Monto, ;
								This.mRedondeo(ItemCur.Afecto *(ImptoAdic.Monto/100)), ;
								ItemCur.Codigo, vpFechaDoc, 2, ImptoAdic.Codigo)
		ENDIF
	ENDIF
	
	SKIP IN ItemCur
ENDDO


ENDPROC
PROCEDURE pcalculatotalescompra
LPARAMETERS VPTASAIVA, VPSINSUMA, VPRETIVA, VPRETIAD, VPTIPODSCRECCAB, P_VAL1, P_VAL2, P_VAL3, P_VAL4, P_VAL5, P_IMPADI, P_IMPESP

P_VAL1 = IIF(EMPTY(P_VAL1),0,P_VAL1)
P_VAL2 = IIF(EMPTY(P_VAL2),0,P_VAL2)
P_VAL3 = IIF(EMPTY(P_VAL3),0,P_VAL3)
P_VAL4 = IIF(EMPTY(P_VAL4),0,P_VAL4)
P_VAL5 = IIF(EMPTY(P_VAL5),0,P_VAL5)
P_IMPADI = IIF(EMPTY(P_IMPADI),0,P_IMPADI)
P_IMPESP = IIF(EMPTY(P_IMPESP),0,P_IMPESP)

LOCAL VSUMADSCTOS, VSUMARECARGO, ;
	VSUMAAFECTO, VSUMAADICIONALES, VSUMATOTAL, VSUBTOTAL, VSUMAIVA,;
	VSUMAEXENTO, VSUMAADIC, ;
	VSUMARECCAB, VSUMADSCCAB, ;
	VSUMARECCABEXENTO, VSUMADSCCABEXENTO, VSUMAACTFIJ

FOR VI=1 TO ALEN(ASUMATOTALES,1)
	ASUMATOTALES(VI)=0
ENDFOR

STORE 0 TO 	VSUMADSCTOS, VSUMARECARGO, ;
	VSUMAAFECTO, VSUMAADICIONALES, VSUMATOTAL, VSUBTOTAL, VSUMAIVA,;
	VSUMAEXENTO, VSUMAADIC, ;
	VSUMARECCAB, VSUMADSCCAB, ;
	VSUMARECCABEXENTO, VSUMADSCCABEXENTO, VSUMAACTFIJ

SELECT ITEMCUR
SUM SUBTOT, AFECTO TO VSUBTOTAL, VSUMAAFECTO FOR !DELETED("ITEMCUR") .AND. ITEMCUR.EXENTO=0

DIMENSION ARRCAMPOSACT(1)
=AFIELDS(ARRCAMPOSACT,'ITEMCUR')
VSUMAACTFIJ = 0.00
FOR I=1 TO ALEN(ARRCAMPOSACT,1)
	IF ARRCAMPOSACT(I,1) == 'ACTFIJO'
		SUM AFECTO TO VSUMAACTFIJ FOR !DELETED("ITEMCUR") AND !EMPTY(ITEMCUR.ACTFIJO)
	ELSE
	ENDIF
ENDFOR

CALCULATE SUM(cImptoAdi.monto) TO vSumaAdicionales IN cImptoAdi

GO TOP IN DSCCUR
DO WHILE !EOF("DSCCUR")
	DO CASE
		CASE INLIST(DSCCUR.TIPDSC,1,2,3)
			IF SEEK(DSCCUR.LINEA, "ITEMCUR",1) THEN
				IF ITEMCUR.EXENTO=0 THEN
					VSUMADSCTOS=VSUMADSCTOS+DSCCUR.MONDSC
				ENDIF
			ENDIF
		CASE INLIST(DSCCUR.TIPDSC,7,12)
			IF VPTIPODSCRECCAB THEN
				VSUMADSCCABEXENTO=VSUMADSCCABEXENTO+DSCCUR.MONDSC
			ELSE
				VSUMADSCTOS=VSUMADSCTOS+DSCCUR.MONDSC
				VSUMADSCCAB=VSUMADSCCAB+DSCCUR.MONDSC
			ENDIF
		CASE INLIST(DSCCUR.TIPDSC,4,5)
			IF SEEK(DSCCUR.LINEA, "ITEMCUR",1) THEN
				IF ITEMCUR.EXENTO=0 THEN
					VSUMARECARGO=VSUMARECARGO+DSCCUR.MONDSC
				ENDIF
			ENDIF
	*!*		CASE INLIST(DSCCUR.TIPDSC,5,9)
	*!*			VSUMAADICIONALES=VSUMAADICIONALES+DSCCUR.MONDSC
		CASE INLIST(DSCCUR.TIPDSC,6,11)
			VSUMAIVA=VSUMAIVA+DSCCUR.MONDSC
		CASE DSCCUR.TIPDSC=8
			VSUMAEXENTO=VSUMAEXENTO+DSCCUR.MONDSC
	*!*		CASE DSCCUR.TIPDSC=9
	*!*			VSUMAADIC=VSUMAADIC+DSCCUR.MONDSC
		CASE INLIST(DSCCUR.TIPDSC,10,13)
			IF VPTIPODSCRECCAB THEN
				VSUMARECCABEXENTO=VSUMARECCABEXENTO+DSCCUR.MONDSC
			ELSE
				VSUMARECARGO=VSUMARECARGO+DSCCUR.MONDSC
				VSUMARECCAB=VSUMARECCAB+DSCCUR.MONDSC
			ENDIF
	ENDCASE

	SKIP IN DSCCUR
ENDDO

VBNDCOMPRA=(ALEN(ASUMATOTALES,1)=13)

VSUMADSCTOS		=THIS.MREDONDEO(VSUMADSCTOS)
ASUMATOTALES(9)	=THIS.MREDONDEO(VSUMADSCCAB)											&&& Suma Descuentos Cabecera
VSUMARECARGO	=THIS.MREDONDEO(VSUMARECARGO)
ASUMATOTALES(10)=THIS.MREDONDEO(VSUMARECCAB)

IF VBNDCOMPRA THEN
	ASUMATOTALES(11)=THIS.MREDONDEO(VSUMARECCABEXENTO)										&&& Suma Recargos Cabecera Exentos
	ASUMATOTALES(12)=THIS.MREDONDEO(VSUMADSCCABEXENTO)										&&& Suma Descuentos Cabecera Exentos
	ASUMATOTALES(13)=VSUMAEXENTO-ASUMATOTALES(12)+ASUMATOTALES(11)
ENDIF

IF VPSINSUMA THEN
	ASUMATOTALES(1)=ADOCUMENTOREF(1,38)												&&& Montos Netos Originales
	ASUMATOTALES(2)=ADOCUMENTOREF(1,39)												&&& Suma de los Cargos al NETO
	ASUMATOTALES(3)=ADOCUMENTOREF(1,37)												&&& Suma de Descuentos al NETO
	ASUMATOTALES(4)=ADOCUMENTOREF(1,35)												&&& Suma de los Montos de Items Exento
	ASUMATOTALES(5)=ADOCUMENTOREF(1,5)												&&& Monto Afecto
	ASUMATOTALES(6)=ADOCUMENTOREF(1,40)												&&& Suma de Impuestos Adicionales
	ASUMATOTALES(7)=ADOCUMENTOREF(1,6)												&&& Monto de IVA generado
	ASUMATOTALES(8)=ADOCUMENTOREF(1,36)												&&& Total del Documento

*!*		IF vbndCompra THEN
*!*			aSumaTotales(11)=This.mRedondeo(vSumaDSCCabExento)						&&& Suma Descuentos Cabecera Exentos
*!*			aSumaTotales(12)=This.mRedondeo(vSumaRecCabExento)						&&& Suma Recargos Cabecera Exentos
*!*		ENDIF
ELSE
	ASUMATOTALES(1)=VSUBTOTAL+P_VAL1												&&& Montos Netos Originales
	ASUMATOTALES(2)=VSUMARECARGO+P_VAL2												&&& Suma de los Cargos al NETO
	ASUMATOTALES(3)=VSUMADSCTOS+P_VAL3												&&& Suma de Descuentos al NETO
	ASUMATOTALES(4)=VSUMAEXENTO														&&& Suma de los Montos de Items Exento
	*ASUMATOTALES(5)=THIS.MREDONDEO(VSUBTOTAL+VSUMARECARGO-VSUMADSCTOS)				&&& Calculo de Monto Afecto
	ASUMATOTALES(5)=THIS.MREDONDEO(ASUMATOTALES(1)+ASUMATOTALES(2)-ASUMATOTALES(3))	&&& Calculo de Monto Afecto
	ASUMATOTALES(6)=VSUMAADICIONALES												&&& Suma de Impuestos Adicionales
	ASUMATOTALES(14)=0
	ASUMATOTALES(15)=ASUMATOTALES(5)+ASUMATOTALES(13)
	ASUMATOTALES(16)=VSUMAACTFIJ

	IF VPTASAIVA!=0 THEN
		ASUMATOTALES(7)=THIS.MREDONDEO(ASUMATOTALES(5)*(VPTASAIVA/100))+P_VAL4		&&& Monto de IVA generado
	ELSE
		ASUMATOTALES(7)=0
	ENDIF

	IF !VPRETIVA
		ASUMATOTALES(8)=(VSUMAEXENTO+VSUMARECCABEXENTO-VSUMADSCCABEXENTO)+ASUMATOTALES(5)+ASUMATOTALES(6)+ASUMATOTALES(7)+P_VAL5	&&& Total del Documento
	ELSE
		ASUMATOTALES(8)=(VSUMAEXENTO+VSUMARECCABEXENTO-VSUMADSCCABEXENTO)+ASUMATOTALES(5)+ASUMATOTALES(6)+P_VAL5	&&& Total del Documento
	ENDIF
ENDIF




ENDPROC
PROCEDURE pcmbpmc
LPARAMETERS Par_T, Par_N

LOCAL Var_Rcp
STORE 0 TO Var_Rcp

GO TOP IN prprm

IF !('S' $ prprm.nocampre)
	SELECT		p.prcodigo,;
				p.prdescrip,;
				p.precom,;
				ic.precio AS precom1,;
				ABS(((((p.prec1 - ic.precio) / ic.precio)) * 100)) AS mg1,;
				(ic.precio + (ic.precio * (p.margen1 / 100))) AS pv1,;
				ABS(((((p.prec2 - ic.precio) / ic.precio)) * 100)) AS mg2,;
				(ic.precio + (ic.precio * (p.margen2 / 100))) AS pv2,;
				ABS(((((p.prec3 - ic.precio) / ic.precio)) * 100)) AS mg3,;
				(ic.precio + (ic.precio * (p.margen3 / 100))) AS pv3,;
				.F. AS sel,;
				p.feccom;				
	FROM		producto AS p;
	LEFT JOIN	ItemCur AS ic;
	ON			(ic.codigo = p.prcodigo) AND;
				!EMPTY(ic.codigo);
	WHERE		p.precom # ic.precio;
	INTO CURSOR Tab_CPC;	
	READWRITE
	
	UPDATE Tab_CPC SET mg1 = 0 WHERE mg1 = 100
	UPDATE Tab_CPC SET mg2 = 0 WHERE mg2 = 100
	UPDATE Tab_CPC SET mg3 = 0 WHERE mg3 = 100
	
	IF ('S' $ prprm.redondea)
		UPDATE Tab_CPC SET pv1 = ROUND(pv1, 0), pv2 = ROUND(pv2, 0), pv3 = ROUND(pv3, 0)
	ENDIF
	
	IF !EMPTY(RECCOUNT('Tab_CPC'))		
		&& Histórico PRECIO COMPRA &&	
		GO TOP IN Tab_CPC
		DO WHILE !EOF('Tab_CPC')
			IF SEEK(Tab_CPC.PrCodigo, "PRODUCTO", 1) THEN
				IF !SEEK((Par_T + Par_N + Tab_CPC.PrCodigo), "H_PRECOM",1) THEN
					IF FLOCK("H_PRECOM")
						INSERT INTO h_Precom (Tipo, Numero, prCodigo, Fecha, PreAct,;
											  PreCom, PreCom1, PreCom2, Usr,  Eqp) ;
							VALUES (Par_T, Par_N, Producto.prCodigo, DATETIME(),;
									Tab_CPC.Precom1, Producto.PreCom, Producto.Precom1,;
									Producto.PreCom2, Usuario, SYS(0))
						UNLOCK IN h_precom
														
						IF RLOCK("PRODUCTO")
							REPLACE PreCom2	WITH Producto.PreCom1 IN Producto
							REPLACE PreCom1	WITH Producto.PreCom IN Producto
							REPLACE PreCom	WITH Tab_CPC.Precom1 IN Producto
							UNLOCK IN producto
						ENDIF
					ENDIF
				ELSE
					DO WHILE !EOF("H_PRECOM") AND ((h_precom.Tipo = Par_T) AND (h_precom.Numero = Par_N) AND (h_precom.PrCodigo = Producto.PrCodigo))
						SKIP IN h_PreCom
					ENDDO
					IF !EOF("H_PRECOM")
						SKIP (-1) IN h_PRECOM
					ELSE
						GO BOTTOM in h_PRECOM						
					ENDIF	
					
					IF RLOCK("H_PRECOM")
						REPLACE PreAct	WITH Tab_CPC.Precom1 IN h_Precom
						UNLOCK IN h_precom
					ENDIF	
																		
					IF RLOCK("PRODUCTO")
						REPLACE PreCom2	WITH h_precom.PreCom1 IN Producto
						Replace PreCom1	WITH h_precom.PreCom IN Producto
						Replace PreCom	WITH Tab_CPC.Precom1 IN Producto								
						UNLOCK IN producto
					ENDIF							
				ENDIF
			ENDIF
			SKIP IN Tab_CPC
		ENDDO	
		&& Histórico PRECIO COMPRA &&			
	
		DO CASE
			CASE (('S' $ prprm.autoprec) AND ('S' $ prprm.NuevoPre)) && Formulario para cambios			
				DO FORM wcmbpmc.scx WITH (Par_T + '-' + Par_N) TO Var_Rcp
				RETURN Var_Rcp
			CASE ('S' $ prprm.autopvta) && Automático PRECIOS				
				IF FLOCK('PRODUCTO')				
					UPDATE Producto SET		Producto.prec1 = Tab_CPC.pv1,;
											Producto.prec2 = Tab_CPC.pv2,;
											Producto.prec3 = Tab_CPC.pv3;
									FROM	Tab_CPC;
									WHERE	Producto.PrCodigo = Tab_CPC.PrCodigo
					
					UNLOCK ALL IN Producto
					STORE 1 TO Var_Rcp
				ELSE
					STORE 0 TO Var_Rcp
				ENDIF				
			CASE ('S' $ prprm.NombEnv) && Automático MÁRGENES			
				IF FLOCK('PRODUCTO')				
					UPDATE Producto SET		Producto.margen1 = Tab_CPC.mg1,;
											Producto.margen2 = Tab_CPC.mg2,;
											Producto.margen3 = Tab_CPC.mg3;
									FROM	Tab_CPC;
									WHERE	Producto.PrCodigo = Tab_CPC.PrCodigo
					
					UNLOCK ALL IN Producto
					STORE 1 TO Var_Rcp
				ELSE
					STORE 0 TO Var_Rcp
				ENDIF
		ENDCASE
	ELSE
		STORE 0 TO Var_Rcp
	ENDIF
	
	USE IN Tab_CPC
ELSE
	RETURN 0
ENDIF
RETURN Var_Rcp




ENDPROC
PROCEDURE pconexionsql
LPARAMETERS vpTipoConexion, vpNumeroConexion
LOCAL bHandlerConexion, vNombreConexion, vUserID, vPassID

STORE .f. TO vTablaInicialSinUso, vTablaUsuarioSinUso
STORE 0 TO bHandlerConexion

IF !USED("PRMUSU") THEN
	vTablaSelec=StdVia+"prmUsu.Dbf"
	
	IF !FILE(vTablaSelec) THEN
		=MESSAGEBOX("No existe El registro de Usuarios")
		bHandlerConexion=-1
	ELSE
		USE &vTablaSelec IN 0 ALIAS prmUsu
		vTablaUsuarioSinUso=.t.
	ENDIF 	
ENDIF

IF !USED("ARCVIA") THEN
	vTablaSelec="ARCVIA.DBF"
	
	IF !FILE(vTablaSelec) THEN
		=MESSAGEBOX("No existe Archivo de Configuracion")
		bHandlerConexion=-1
	ELSE
		USE ArcVia IN 0
		vTablaInicialSinUso=.t.
		GO TOP IN ArcVia
	ENDIF
ENDIF

IF bHandlerConexion!=-1 THEN
	IF SEEK(usuario, "PRMUSU", 1) THEN
		vNombreConexion	=ALLTRIM(ArcVia.drvElec)
		vUserID			=ALLTRIM(prmUsu.usuNom)
		vPassID			=ALLTRIM(prmUsu.usuCla)
	ELSE
		WAIT WINDOW "el Usuario no esta autorizado para acceder a conexion electronica"
		bHandlerConexion=-1
	ENDIF
ENDIF

IF bHandlerConexion!=-1 THEN
	IF vpTipoConexion THEN
		WAIT WINDOW "Estableciendo conexccion con Servidor MYSQL" NOWAIT
		bHandlerConexion=SQLCONNECT(vNombreConexion, vUserID, vPassID)

		IF bHandlerConexion=-1 THEN
			WAIT WINDOW "No se ha podido establecer conexion"
		ELSE
			WAIT WINDOW "Conexion Establecida : "+ALLTRIM(STR(bHandlerConexion)) NOWAIT	
		ENDIF 	
	ELSE
		bHandlerConexion=SQLDISCONNECT(vpNumeroConexion)
		IF bHandlerConexion!=-1 THEN
			WAIT WINDOW "Conexion Cerrada correctamente"
		ENDIF
	ENDIF
ENDIF

IF vTablaUsuarioSinUso THEN
	USE IN prmUsu
ENDIF

IF vTablaInicialSinUso THEN
	USE IN ArcVia
ENDIF

WAIT CLEAR
RETURN bHAndlerConexion

ENDPROC
PROCEDURE pcreacursores
LPARAMETERS vpItemCur, vpDscCur, vpCopiaCur, vpOriCur, vpOriDscCur, vpVisualCur, vpVisualCurNc, vpVisualCurDeb, vpItemCurIni, ;
			vpVisualCurFinal

IF vpItemCur THEN
	IF USED("ITEMCUR") THEN
		USE IN ItemCur
	ENDIF

	CREATE CURSOR ItemCur (Codigo c(15), Cantidad n(15,2), Fraccion n(4), Precio n(10,2), ;
						   Linea n(4), PrecioOrig n(15,2), SubTot n(15,2), Afecto n(15), ;
						   Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
						   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), ;
						   Cod_Iad n(5), defraccion n(9), IndExe n(1), IVaRet l(1), noFactu n(15))
	INDEX on Linea TAG Linea
	INDEX on Codigo TAG Codigo
	SELECT ItemCur
	SET ORDER TO 	
ENDIF

IF vpOriCur THEN
	IF USED("ORICUR") THEN
		USE IN OriCur
	ENDIF

	CREATE CURSOR OriCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
						   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
						   Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
						   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), ;
						   defraccion n(9, 2))
	INDEX on Linea TAG Linea
ENDIF

IF vpCopiaCur THEN
	IF USED("COPIACUR") THEN
		USE IN CopiaCur
	ENDIF

	CREATE CURSOR CopiaCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
						    Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
						    Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
						    Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), defraccion n(9, 2))
	INDEX on Linea TAG Linea
ENDIF

IF vpDscCur THEN
	IF USED("DSCCUR") THEN
		USE IN DscCur
	ENDIF

	CREATE CURSOR DscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
						  Fecha d(8), ModDsc n(1), Cod_Iad n(5))
	INDEX on CodPro TAG CodPro
	INDEX on Linea TAG Linea
	INDEX on STR(Linea,4)+STR(TipDsc,1) TAG TipDsc
ENDIF

IF vpOriDscCur THEN
	IF USED("ORIDSCCUR") THEN
		USE IN OriDscCur
	ENDIF

	CREATE CURSOR OriDscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
						  Fecha d(8), ModDsc n(1), Cod_Iad n(5))
						
	INDEX on Linea TAG Linea
ENDIF

IF vpVisualCur THEN
	IF vpVisualCurNC THEN
		=MESSAGEBOX("Error, no se pueden crear los dos cursores Visuales a la vez")
		RETURN .f.
	ENDIF
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(10), Fraccion n(5), ;
							 Precio n(10,2), Dscto n(12,4), monDscto n(15,2), Recargo n(8,3), monRec n(15,2), ;
							 Total n(15), Linea n(4), Nivel c(2), Cod_Iad c(2), Exento l(1))
*!*		CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(10), Fraccion n(5), ;
*!*								 Precio n(10,2), Dscto n(15), Recargo n(15), ;
*!*								 Total n(15), Anexos n(15), Linea n(4), Nivel c(2), Cod_Iad n(5), Exento l(1))

	INDEX on STR(Linea,4)+Nivel TAG Enlace01
ENDIF

IF vpVisualCurNC THEN
	IF vpVisualCur THEN
		=MESSAGEBOX("No pueden abrirse los dos cursores de visualcur seguidos")
		RETURN .f.
	ENDIF
	
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(10), Fraccion n(5), ;
							 CanDev n(10), FraDev n(10), Precio n(10,2), Dscto n(8,4), ;
							 MonDscto n(15,2), Total n(15), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad n(5), Exento l(1))
							
	INDEX on STR(Linea,4)+Nivel TAG Enlace01
	INDEX on Linea TAG Enlace02
	SET ORDER TO 1 IN VisualCur
ENDIF

IF vpVisualCurDeb THEN
	IF vpVisualCur .or. vpVisualcurNC THEN
		=MESSAGEBOX("No pueden abrirse los dos cursores de visualcur seguidos")
		RETURN .f.
	ENDIF
	
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Detalle c(60), Cantidad n(10), ;
							    Precio n(10,2), Total n(15), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad n(5), Exento l(1))
							
	INDEX on STR(Linea,4)+Nivel TAG Enlace01
	INDEX on Linea TAG Enlace02
	SET ORDER TO 1 IN VisualCur
ENDIF

IF vpItemCurIni THEN
	IF USED("ITEMCURINI") THEN
		USE IN ItemCurIni
	ENDIF

	CREATE CURSOR ItemCurIni (Codigo c(15), Detalle c(80), Cantidad n(15,2), Fraccion n(4), Lista n(1),;
						   	  Linea n(4), PrecioLista n(15,2), PrecioIng n(15,2), IndExe n(1), ;
						   	  DscLin n(10,2), RecLin n(10,2), RutCli c(12), CodSuc c(4), Fecha d(8),;
						   	  Bodega c(3), BodegaIn c(3))
	INDEX on Linea TAG Linea
ENDIF
	

IF vpVisualCurFinal THEN
	IF vpVisualCurNC THEN
		=MESSAGEBOX("Error, no se pueden crear los dos cursores Visuales a la vez")
		RETURN .f.
	ENDIF
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF
	CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(15,2), Fraccion n(5), ;
							 Precio n(15,2), Dscto n(15), Recargo n(15), ;
							 Total n(15), Anexos n(15), Linea n(4), Nivel c(2), Cod_Iad n(5), Exento l(1))
	INDEX on STR(Linea,4)+Nivel TAG Enlace01
ENDIF

ENDPROC
PROCEDURE pcreacursoresc
LPARAMETERS vpItemCur, vpDscCur, vpCopiaCur, vpOriCur, vpOriDscCur, vpVisualCur, vpVisualCurNc, vpVisualCurDeb

IF vpItemCur THEN
	IF USED("ITEMCUR") THEN
		USE IN ItemCur
	ENDIF

	CREATE CURSOR ItemCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
						   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
						   Detalle c(60), UniMed c(4), CodIla c(2), noApliDes c(1), Exento n(15),;
						   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5),;
						   defraccion n(9, 2), CodGto c(10), ActFijo L)
	INDEX on Linea TAG Linea
	INDEX on Codigo TAG Codigo
	SELECT ItemCur
	SET ORDER TO 	
ENDIF

IF vpOriCur THEN
	IF USED("ORICUR") THEN
		USE IN OriCur
	ENDIF

	CREATE CURSOR OriCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
						   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
						   Detalle c(60), UniMed c(4), CodIla c(2), noApliDes c(1), Exento n(15),;
						   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), defraccion n(9, 2), CodGto c(10), ActFijo L)
	INDEX on Linea TAG Linea
ENDIF

IF vpCopiaCur THEN
	IF USED("COPIACUR") THEN
		USE IN CopiaCur
	ENDIF

	CREATE CURSOR CopiaCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
						    Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
						    Detalle c(60), UniMed c(4), CodIla c(2), noApliDes c(1), Exento n(15),;
						    Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), defraccion n(9, 2), CodGto c(10), ActFijo L)
	INDEX on Linea TAG Linea
ENDIF

IF vpDscCur THEN
	IF USED("DSCCUR") THEN
		USE IN DscCur
	ENDIF

	CREATE CURSOR DscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
						  Fecha d(8), ModDsc n(1), Cod_Iad n(5))
	INDEX on CodPro TAG CodPro
	INDEX on Linea TAG Linea
	INDEX on STR(Linea,4)+STR(TipDsc,1) TAG TipDsc
ENDIF

IF vpOriDscCur THEN
	IF USED("ORIDSCCUR") THEN
		USE IN OriDscCur
	ENDIF

	CREATE CURSOR OriDscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
						  Fecha d(8), ModDsc n(1), Cod_Iad n(5))
						
	INDEX on Linea TAG Linea
ENDIF

IF vpVisualCur THEN
	IF vpVisualCurNC THEN
		=MESSAGEBOX("Error, no se pueden crear los dos cursores Visuales a la vez")
		RETURN .f.
	ENDIF
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(10), Fraccion n(5), ;
							 Precio n(10,2), Dscto n(8,3), monDscto n(15,2), Recargo n(8,3), monRecargo n(15,2), ;
							 Total n(15), DetGto c(30), Linea n(4), Nivel c(2), Cod_Iad n(5), Exento l(1))

	INDEX on STR(Linea,4)+Nivel TAG Enlace01
ENDIF

IF vpVisualCurNC THEN
	IF vpVisualCur THEN
		=MESSAGEBOX("No pueden abrirse los dos cursores de visualcur seguidos")
		RETURN .f.
	ENDIF
	
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(60), Cantidad n(10), Fraccion n(5), ;
							 CanDev n(10), FraDev n(10), Precio n(10,2), ;
							 Dscto n(8,3), MonDscto n(15,2), ;
							 Recargo n(8,3), MonRecargo n(15,2), ;
							 Total n(15), DetGto c(30), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad n(5), Exento l(1))
							
	INDEX on STR(Linea,4)+Nivel TAG Enlace01
	INDEX on Linea TAG Enlace02
	SET ORDER TO 1 IN VisualCur
ENDIF

IF vpVisualCurDeb THEN
	IF vpVisualCur .or. vpVisualcurNC THEN
		=MESSAGEBOX("No pueden abrirse los dos cursores de visualcur seguidos")
		RETURN .f.
	ENDIF
	
	IF USED("VISUALCUR") THEN
		USE IN VisualCur
	ENDIF

	CREATE CURSOR VisualCur (StrLinea c(3), Detalle c(60), Cantidad n(10), ;
							    Precio n(10,2), Total n(15), DetGto c(30), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad n(5), Exento l(1))
							
	INDEX on STR(Linea,4)+Nivel TAG Enlace01
	INDEX on Linea TAG Enlace02
	SET ORDER TO 1 IN VisualCur
ENDIF
ENDPROC
PROCEDURE pdetalledescuento
LPARAMETERS vpTipoDescuento, vpCodIAD

STORE "" TO vCadenaDscto
DO CASE
	CASE vpTipoDescuento=1
		vCadenaDscto=" - DSCTO. PREC-ESP."
	CASE vpTipoDescuento=2
		vCadenaDscto=" - DSCTO. REGLAS COMERCIALES"
	CASE vpTipoDescuento=3
		vCadenaDscto=" - DSCTO. LINEA"
	CASE vpTipoDescuento=4
		vCadenaDscto=" - RECARGO LINEA"
	CASE vpTipoDescuento=5
		vCadenaDscto=" - RECARGO ADICIONAL"
	CASE vpTipoDescuento=6
		vCadenaDscto=" - IMPUESTO IVA"
	CASE vpTipoDescuento=7
		vCadenaDscto=" - DSCTO. CABECERA"
	CASE vpTipoDescuento=8
		vCadenaDscto=" - EXENTO"
	CASE vpTipoDescuento=9
		IF SEEK(vpCodIAD,"IMPTOADIC",1) THEN
			vCadenaDscto=(" - Impto.Adic. " +ALLTRIM(ImptoAdic.Detalle))
		ELSE
			vCadenaDscto=(" - Impuesto Desconocido")
		ENDIF
	CASE vpTipoDescuento=10
		vCadenaDscto=" - RECARGO CABECERA"
	CASE vpTipoDescuento=11
		vCadenaDscto=" - IMPUESTO IVA RETENIDO"
	CASE vpTipoDescuento=12
		vCadenaDscto=" - DSCTO. CABECERA ($)"
	CASE vpTipoDescuento=13
		vCadenaDscto=" - RECARGO CABECERA ($)"
ENDCASE 		

RETURN vCadenaDscto

ENDPROC
PROCEDURE pdocrefc
LPARAMETERS vpRutPrv, vpTipoDocRef, vpNumeroDocRef, vpEstructura

IF !SEEK(vpRutPrv+vpTipoDocRef+vpNumeroDocRef, "PRODOCTO", 9) THEN
	=MESSAGEBOX("No se encontro el Documento en el Historico de Documentos")
	RETURN .f.
ELSE
	IF vpEstructura THEN
		IF ProDocto.Monto!=0 THEN
			=MESSAGEBOX("Este Documento no es de Tipo Administrativo, para ser Anulado")
			RETURN .f.
		ENDIF
	ENDIF
ENDIF

m.fecrec = CTOD('01/'+ALLTRIM(STR(ProDocto.mesrec))+'/'+ALLTRIM(STR(ProDocto.anorec)))

IF !Thisform.Facturador1.mactivatablas(.f., m.fecrec,,,,,,,,,,,,,,,,,,,.t.,,)
*CGUTO 21/06/2016
*IF !Thisform.Facturador1.mactivatablas(.f., ProDocto.FecRec,,,,,,,,,,,,,,,,,,,.t.,,)
	=MESSAGEBOX("Periodo de Factura Seleccionada no existe")
	RETURN .f.
ENDIF

IF SEEK(Prodocto.tDocTo+Prodocto.NumFac, "tCOMPRA",1) THEN
	IF tCompra.faEstado=1 THEN
		=MESSAGEBOX("Documento se encuentra Anulado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No se puede Encontrar Documento en Cabeceras")
	RETURN .f.
ENDIF

IF !SEEK(tCompra.fatDocTo, "TIPODOC",1) THEN
	=MESSAGEBOX("No se pudo encontrar el Tipo de Documento de Referencia: "+tCompra.fatDocTo)
	RETURN .f.
ENDIF

***** Datos del Proovedor
PUBLIC ARRAY aDocumentoRef (1,33)

aDocumentoRef(1,1)= tCompra.faRutPrv
IF SEEK(tCompra.FaRUTPrv, "PROVEEDO", 1) THEN		
	aDocumentoRef(1,2)= Proveedo.pvNombre
	aDocumentoRef(1,3)= Proveedo.pvDirec
	aDocumentoRef(1,4)= Proveedo.pvComuna
	aDocumentoRef(1,5)= Proveedo.pvCiudad
	aDocumentoRef(1,6)= Proveedo.pvGiro
	aDocumentoRef(1,7)= Proveedo.pvFono1
	aDocumentoRef(1,8)= Proveedo.pvContacto
	aDocumentoRef(1,9)= Proveedo.pvInternet
ENDIF

******* Datos Documento
aDocumentoRef(1,10)  = tCompra.fatDocTo
aDocumentoRef(1,11) = TipoDoc.Id_Snii
aDocumentoRef(1,12) = tCompra.fanFolio
aDocumentoRef(1,13) = tCompra.faNumero
aDocumentoRef(1,14) = tCompra.faFecEmi
aDocumentoRef(1,15) = tCompra.faFecVen
aDocumentoRef(1,16) = Prodocto.FecRec
aDocumentoRef(1,17) = tCompra.cCosto
aDocumentoRef(1,18) = tCompra.faAfecto
aDocumentoRef(1,19) = tCompra.faExento
aDocumentoRef(1,20) = tCompra.faDescto
aDocumentoRef(1,21) = tCompra.famDscto
aDocumentoRef(1,22) = tCompra.porRec
aDocumentoRef(1,23) = tCompra.monRec
aDocumentoRef(1,24) = tCompra.TipoDSC
aDocumentoRef(1,25) = tCompra.TipoRef
aDocumentoRef(1,26) = tCompra.Bodega
aDocumentoRef(1,27) = tCompra.RetIva+1

IF SEEK(tCompra.FatDocTo, "TIPODOC",1) THEN
	aDocumentoRef(1,28)=IIF(TipoDoc.Emitido,2,1)
ENDIF

aDocumentoRef(1,29) = ROUND((tCompra.faMonIVA*100)/tCompra.faAfecto,0)
aDocumentoRef(1,30) = tCompra.ConPago
aDocumentoRef(1,33) = tCompra.Rebaja
*** aDocumentoRef(1,31) = Aqui se coloca el Codigo de Referencia
*** aDocumentoRef(1,32) = Aqui se coloca el motivo de Devolucion


*CGUTO 21/06/2016
*This.mActivaTablas(.t., ProDocto.FecRec)
This.mActivaTablas(.t., m.FecRec)
RETURN .t.

ENDPROC
PROCEDURE pdocumentoreferencia
LPARAMETERS vpLlaveDocRef

IF !SEEK(vpLlaveDocRef, "CLIDOCTO", 1) THEN
	=MESSAGEBOX("No se encontro el Documento en el Historico de Documentos")
	RETURN .f.
ENDIF

IF !This.mActivatablas(.f., CliDocto.FecFac,.t.) THEN
	=MESSAGEBOX("Periodo de Factura Seleccionada no existe")
	RETURN .f.
ENDIF

IF SEEK(vpLlaveDocRef, "tACTUAL",1) THEN
	IF tActual.faEstado=1 THEN
		=MESSAGEBOX("Documento se encuentra Anulado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No se puede Encontrar Documento en Cabeceras")
	RETURN .f.
ENDIF

aDocumentoRef(1,1)= tActual.faComCli
aDocumentoRef(1,2)= tActual.faCiuCli
aDocumentoRef(1,3)= tActual.faFecha
aDocumentoRef(1,4)= tActual.faFecVen
aDocumentoRef(1,5)= tActual.faAfecto
aDocumentoRef(1,6)= tActual.faIVA
aDocumentoRef(1,7)= tActual.faCodVend
aDocumentoRef(1,8)= tActual.Bodega
aDocumentoRef(1,9)= tActual.faGirCli

IF SEEK(tActual.faRutCli, "CLIENTES",1) THEN
	aDocumentoRef(1,10)= ALLTRIM(Clientes.Contacto)
	aDocumentoRef(1,11)= ALLTRIM(Clientes.clInternet)
	aDocumentoRef(1,18)= ALLTRIM(Clientes.clFono)
	aDocumentoRef(1,29)= ALLTRIM(Clientes.Ruta)
ENDIF


aDocumentoRef(1,12)= ""
aDocumentoRef(1,13)= tActual.faDscto
aDocumentoRef(1,43)= tActual.faDsctoPes

aDocumentoRef(1,35)= tActual.faExento
aDocumentoRef(1,36)= tActual.faTotal
aDocumentoRef(1,37)= tActual.faValDscto
aDocumentoRef(1,38)= tActual.faSubTot
aDocumentoRef(1,39)= tActual.faFlete
aDocumentoRef(1,40)= tActual.faILA
aDocumentoRef(1,41)= tActual.DirDespa


IF SEEK(SUBSTR(vpLlaveDocRef,1,2), "TIPODOC", 1) THEN
	aDocumentoRef(1,14)= TipoDoc.id_SNII
ENDIF
	
aDocumentoRef(1,15)= IIF(tActual.tipDscCab=0,1,tActual.tipDscCab)
aDocumentoRef(1,16)= ""
aDocumentoRef(1,17)= tActual.faNumero

aDocumentoRef(1,19)= tActual.faDirCli

IF SEEK(tActual.faCodVend, "VENDEDOR",1) THEN
	aDocumentoRef(1,20)= ALLTRIM(UPPER(Vendedor.veNombre))
ENDIF

aDocumentoRef(1,21)= tActual.CodSuc
aDocumentoRef(1,22)= tActual.DirSuc
aDocumentoRef(1,23)= tActual.faRutCli
aDocumentoRef(1,24)= tActual.faNomCli
aDocumentoRef(1,25)= tActual.idRuteo

IF tActual.idRuteo>0 THEN
	IF SEEK(tActual.idRuteo, "RECORRIDOS", 1) THEN
		aDocumentoRef(1,33)=Recorridos.CodCho
		aDocumentoRef(1,34)=Recorridos.DetCho
	ENDIF
ENDIF

aDocumentoRef(1,26)= tActual.faNotaVen
aDocumentoRef(1,27)= tActual.faPrecio
aDocumentoRef(1,28)= tActual.faTotal

aDocumentoRef(1,30)= tActual.DetRuta
aDocumentoRef(1,31)= tActual.CiuSuc

IF (tActual.faIva+tActual.faAfecto>0) THEN
	aDocumentoRef(1,32)= INT(This.mredondeo((tActual.faIVA*100)/tActual.faAfecto))
ELSE
	aDocumentoRef(1,32)= 0
ENDIF
	
*!*				aDocumentoRef(1,1)= ** Comuna En Doc.Ref.
*!*				aDocumentoRef(1,2)= ** Ciudad en Doc.Ref.
*!*				aDocumentoRef(1,3)= ** Fecha en Doc.Ref.
*!*				aDocumentoRef(1,4)= ** Fecha de Vencimiento
*!*				aDocumentoRef(1,5)= ** Monto Afecto
*!*				aDocumentoRef(1,6)= ** Monto IVa
*!*				aDocumentoRef(1,7)= ** Codigo Vendedor
*!*				aDocumentoRef(1,8)= ** Bodega
*!*				aDocumentoRef(1,9)= ** Giro en Documento
*!*				aDocumentoRef(1,10)= ** Contacto de Cliente en Doc.Ref.
*!*				aDocumentoRef(1,11)= ** Correo Electronico en Doc.Ref.
*!*				aDocumentoRef(1,12)= ** Tipo de Anulacion (1=Anulacion de Doc, 3=Correccion de Montos)
*!*				aDocumentoRef(1,13)= ** Porcentaje Descuento Cabecera
*!*				aDocumentoRef(1,14)= ** Codigo de SNII para Doc.Ref
*!*				aDocumentoRef(1,15)= ** Tipo de Dscto de Cabecera
*!*				aDocumentoRef(1,16)= ** Motivo
*!*				aDocumentoRef(1,17)= ** FolioRef
*!*				aDocumentoRef(1,18)= ** Telefono del Documento
*!*				aDocumentoRef(1,19)= ** Direccion del Documento
*!*				aDocumentoRef(1,20)= ** Nombre del Vendedor
*!*				aDocumentoRef(1,21)= ** Codigo de la Sucursal
*!*				aDocumentoRef(1,22)= ** Direccion de la Sucursal
*!*				aDocumentoRef(1,23)= ** Rut del Cliente
*!*				aDocumentoRef(1,24)= ** Nombre del Cliente
*!*				aDocumentoRef(1,25)= ** Recorrido del Documento
*!*				aDocumentoRef(1,26)= ** Nota de Venta
*!*				aDocumentoRef(1,27)= ** Lista de Precios
*!*				aDocumentoRef(1,28)= ** Total del Documento
*!*				aDocumentoRef(1,29)= ** Codigo Ruta
*!*				aDocumentoRef(1,30)= ** Detalle Ruta
*!*				aDocumentoRef(1,31)= ** Ciudad Sucursal
*!*				aDocumentoRef(1,32)= ** Tasa del IVA originalmente
*!*				aDocumentoRef(1,33)= ** Codigo Repartidor
*!*				aDocumentoRef(1,34)= ** Detalle Repartidor

*!*				aDocumentoRef(1,35)= ** Monto Exento	
*!*				aDocumentoRef(1,36)= ** Monto ToTal
*!*				aDocumentoRef(1,37)= ** Monto Descuentos
*!*				aDocumentoRef(1,38)= ** Monto SubTotal
*!*				aDocumentoRef(1,39)= ** Monto Flete
*!*				aDocumentoRef(1,40)= ** Monto ILA
*!*				aDocumentoRef(1,41)= ** Direccion Despacho
*!*				aDocumentoRef(1,42)= ** String de Motivo de Devolucion
*!*				aDocumentoRef(1,43)= ** Monto de Descuento Cabecera


This.mActivaTablas(.t., CliDocto.FecFac)
RETURN .t.

ENDPROC
PROCEDURE penviadte
LPARAMETERS vpVariableXML

USE arcvia IN 0
GO TOP IN ArcVia
	vDirWebService=ALLTRIM(UPPER(ArcVia.Ruta1))
USE IN ArcVia

cXML_Request = vpVariableXML

*oHTTP = CREATEOBJECT('MSXML2.XMLHTTP.6.0')
oHTTP.OPEN("POST", vDirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)
RespuestaWS = oHTTP.responseText

IF oHTTP.STATUS = 200
*	=MESSAGEBOX(RespuestaWS)

*vFolioInternoDoc=STREXTRACT(bRespuesta,'<Id>','</Id>')
	IF VAL(STREXTRACT(RespuestaWS ,'<Id>','</Id>'))<0 THEN
		vRespuestaWebService=-1
	ELSE
		vRespuestaWebService=0
	ENDIF
ELSE
	MESSAGEBOX("Error: (" + TRANSFORM(oHTTP.STATUS) + ") " +oHTTP.statusText,16,"Web Service Reportó")
	vRespuestaWebService=-1
	RETURN RespuestaWS
ENDIF

*RELEASE oHTTP

RETURN RespuestaWS
ENDPROC
PROCEDURE penviadte_emitidasterceros
LPARAMETERS vpVariableXML


vNoUsoArcVia=.f.
IF !USED("ARCVIA") THEN
	vNoUsoArcVia=.t.
	USE arcvia IN 0
ENDIF

GO TOP IN ArcVia
	vDirWebService=ALLTRIM(UPPER(ArcVia.Ruta1))

IF vNoUsoArcVia THEN
	USE IN ArcVia
ENDIF

cXML_Request = vpVariableXML

*oHTTP = CREATEOBJECT('MSXML2.XMLHTTP.6.0')
oHTTP.OPEN("POST", vDirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)
RespuestaWS = oHTTP.responseText

IF oHTTP.STATUS = 200
	IF STREXTRACT(RespuestaWS ,'<IsProcesoOK>','</IsProcesoOK>')="true" THEN
		TEXT TO vRespuestaSecundario TEXTMERGE NOSHOW FLAGS 2
			<Respuesta>true</Respuesta>
			<FolioInterno><<STREXTRACT(RespuestaWS ,'<Id>','</Id>')>></FolioInterno>
		ENDTEXT
	ELSE
		vGlosaError="El WebService ha encontrado Errores en Ingreso de DTE, "+STREXTRACT(RespuestaWS ,'<Message>','</Message>')
		TEXT TO vRespuestaSecundario TEXTMERGE NOSHOW FLAGS 2
			<Respuesta>false</Respuesta>
			<GlosaError><<vGlosaError>></GlosaError>
		ENDTEXT
	ENDIF
ELSE
	TEXT TO vRespuestaSecundario TEXTMERGE NOSHOW FLAGS 2
		<Respuesta>false</Respuesta>
		<GlosaError>Error: (<<TRANSFORM(oHTTP.STATUS)>>)<<oHTTP.statusText>>Web Service Reporto</GlosaError>
	ENDTEXT
ENDIF

RETURN vRespuestaSecundario
ENDPROC
PROCEDURE penviadteimpresoras
LPARAMETERS vpVariableXML

USE arcvia IN 0
GO TOP IN ArcVia
	vDirWebService=ALLTRIM(UPPER(ArcVia.Ruta1))
USE IN ArcVia

cXML_Request = vpVariableXML

*oHTTP = CREATEOBJECT('MSXML2.XMLHTTP.6.0')
oHTTP.OPEN("POST", vDirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)
RespuestaWS = oHTTP.responseText

IF oHTTP.STATUS = 200
*	=MESSAGEBOX(RespuestaWS)

	IF VAL(STREXTRACT(RespuestaWS ,'<Id>','</Id>',1))<0 THEN
		vRespuestaWebService=-1
	ELSE
		vRespuestaWebService=0
	ENDIF
ELSE
	MESSAGEBOX("Error: (" + TRANSFORM(oHTTP.STATUS) + ") " +oHTTP.statusText,16,"Web Service Reportó")
	vRespuestaWebService=-1
	RETURN RespuestaWS
ENDIF

*RELEASE oHTTP

RETURN RespuestaWS
ENDPROC
PROCEDURE penviaxmlreceptorelec
LPARAMETERS vpRutReceptor, vpFolioInterno, vpCompra

LOCAL vVariableCadenaXMLEnvio, vEnvioPDF, vEnvioXML, veMailReceptor

PUBLIC ARRAY aRespuestaEnvio(5)
aRespuestaEnvio(1)= .f.
aRespuestaEnvio(2)= ""
aRespuestaEnvio(3)= .f.
aRespuestaEnvio(4)= .f.
aRespuestaEnvio(5)= ""

IF VARTYPE(vpRutReceptor)="L" THEN
	aRespuestaEnvio(5)="Rut de Receptor no especificado (Variable no existe), Envio NO realizado"
	RETURN @aRespuestaEnvio
ELSE
	IF EMPTY(ALLTRIM(vpRutReceptor)) THEN
		aRespuestaEnvio(5)="Rut de Receptor no especificado (Variable no existe), Envio NO realizado"
		RETURN @aRespuestaEnvio
	ENDIF 		
ENDIF

IF VARTYPE(vpFolioInterno)="L" THEN
	aRespuestaEnvio(5)="Folio Interno invalido (Variable no existe), Envio NO realizado"
	RETURN @aRespuestaEnvio
ELSE
	IF vpFolioInterno=0 THEN
		aRespuestaEnvio(5)="Folio Interno invalido (Folio en 0), Envio NO realizado"
		RETURN @aRespuestaEnvio
	ENDIF 		
ENDIF

STORE .f. TO vEnvioPDF, vEnvioXML
STORE "" TO veMailReceptor

IF vpCompra THEN
	IF SEEK(vpRutReceptor, "PROVEEDO",1) THEN 	
		IF !EMPTY(ALLTRIM(Proveedo.pvInternet)) THEN
			vEnvioPDF=.t.
			veMailReceptor=ALLTRIM(Proveedo.pvInternet)
		ELSE
			aRespuestaEnvio(5)="Receptor : "+vpRutReceptor+", no tiene ningun Correo Registrado, Envio NO realizado"
			RETURN @aRespuestaEnvio				
		ENDIF
	ELSE
		aRespuestaEnvio(5)="Receptor : "+vpRutReceptor+", no se encuentra en Maestro de Proveedores, Envio NO realizado"
		RETURN @aRespuestaEnvio	
	ENDIF
	aRespuestaEnvio(1)=.f.
ELSE
	STORE .f. TO vEnvioXML, vEnvioPDF
	IF SEEK(vpRutReceptor, "CLIENTES",1) THEN
		vEnvioXML=Clientes.Electron .and. !EMPTY(ALLTRIM(Clientes.MailElec))
		vEnvioPDF=Clientes.DTEMail .and. !EMPTY(ALLTRIM(Clientes.CorreoPDF))

	ELSE
		aRespuestaEnvio(5)="Receptor"+vpRutReceptor+", no se encuentra en Maestro de Clientes, Envio NO realizado"
		RETURN @aRespuestaEnvio	
	ENDIF
	aRespuestaEnvio(1)=Clientes.Electron .or. Clientes.DteMail
ENDIF

aRespuestaEnvio(2)=veMailReceptor
aRespuestaEnvio(3)=vEnvioPDF
aRespuestaEnvio(4)=vEnvioXML

IF 	!(vEnvioPDF .or. vEnvioXML) THEN
	aRespuestaEnvio(5)="Receptor no Valido para ningun envio, Envio NO realizado"
	RETURN @aRespuestaEnvio
ENDIF

vLimiteTimeout=prPrm.TimeoutImp

***************** Verificar si el XML Final esta disponible *************
WAIT WINDOW "Verificando Validez de DTE, (Envio x Correo)" NOWAIT

vImprimeOK=.f.
vResultadoConsulta=""
vNumeroReintento=0

DO WHILE vNumeroReintento<=vLimiteTimeout
	TEXT TO vVarXML TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetXmlFinalOK>
         <lsof:idDTE><<ALLTRIM(STR(vpFolioInterno))>></lsof:idDTE>
      </lsof:GetXmlFinalOK>
   </soapenv:Body>
</soapenv:Envelope>		
	ENDTEXT

	oHTTP.OPEN("POST", This.dirWebService , .F.)
	oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
	oHTTP.SEND(vVarXML)
	RespuestaWS = oHTTP.responseText

	IF !INLIST(oHTTP.STATUS, 200, 202) THEN
		aRespuestaEnvio(1)=.f.
		aRespuestaEnvio(5)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE"+CHR(13)+;
							   "Status de Error: "+ALLTRIM(STR(oHTTP.STATUS))				
		EXIT
	ENDIF
	
	vResultadoConsulta=STREXTRACT(RespuestaWS, '<GetXmlFinalOKResult>', '</GetXmlFinalOKResult>')
	IF vResultadoConsulta="true" THEN
		vImprimeOK=.t.
		EXIT
	ENDIF
	
	vNumeroReintento=vNumeroReintento+1
ENDDO

IF !vImprimeOK THEN
	aRespuestaEnvio(1)=.f.
	aRespuestaEnvio(5)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE, Impresion no es posible"+CHR(13)+;
						   "Debe intentarlo por el Modulo de Impresion Seriada"
	RETURN @aRespuestaEnvio
ENDIF

*****************Fin Verificacion

STORE "" TO vVariableCadenaXMLEnvio

TEXT TO vVariableCadenaXMLEnvio TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutEnviarDTEAlReceptor>
         <lsof:idDTE><<ALLTRIM(STR(vpFolioInterno))>></lsof:idDTE>
         <lsof:enviarPDF><<IIF(vEnvioPDF,"true", "false")>></lsof:enviarPDF>
         <lsof:enviarSobreXml><<IIF(vEnvioXML, "true", "false")>></lsof:enviarSobreXml>
         <lsof:emailDestino><<ALLTRIM(veMailReceptor)>></lsof:emailDestino>
      </lsof:PutEnviarDTEAlReceptor>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

oHTTP.OPEN("POST", This.DirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(vVariableCadenaXMLEnvio)
RespuestaWS = oHTTP.responseText

IF INLIST(oHTTP.Status, 200, 202) THEN
	aRespuestaEnvio(5)="Envio realizado correctamente.."
ELSE
	aRespuestaEnvio(5)="Error: (" + TRANSFORM(oHTTP.STATUS) + ") " +oHTTP.statusText+", Web Service Reportó, Envio no realizado"
ENDIF

RETURN @aRespuestaEnvio

ENDPROC
PROCEDURE pextraedatosemisor
LPARAMETERS vpRutCliente, vpDigitoVerificador

IF !USED("ARCVIA") THEN
	USE arcvia IN 0
ENDIF

GO TOP IN ArcVia
	vDirWebService=ALLTRIM(UPPER(ArcVia.Ruta1))
USE IN ArcVia

*!*	TEXT TO cXML_Request TEXTMERGE NOSHOW
*!*	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl">
*!*	   <soapenv:Header/>
*!*	   <soapenv:Body>
*!*	      <lsof:GetEmisorByRut>
*!*	         <lsof:rutEmisor><<vpRutCliente>></lsof:rutEmisor>
*!*	         <lsof:dvEmisor><<vpDigitoVerificador>></lsof:dvEmisor>
*!*	      </lsof:GetEmisorByRut>
*!*	   </soapenv:Body>
*!*	</soapenv:Envelope>
*!*	ENDTEXT

TEXT TO cXML_Request TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetEmisorByRut>
         <lsof:rutEmisor><<vpRutCliente>></lsof:rutEmisor>
         <lsof:dvEmisor><<vpDigitoVerificador>></lsof:dvEmisor>
      </lsof:GetEmisorByRut>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

*oHTTP = CREATEOBJECT('MSXML2.XMLHTTP.6.0')
oHTTP.OPEN("POST", vDirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)

IF oHTTP.STATUS = 200
	RespuestaWS = oHTTP.responseText
ELSE
	MESSAGEBOX("Error: (" + TRANSFORM(oHTTP.STATUS) + ") " +oHTTP.statusText,16,"Web Service Reportó")
	RETURN -1
ENDIF
*=MESSAGEBOX(RespuestaWs)

PUBLIC ARRAY aRespuesta(13)


aRespuesta(1)=ALLTRIM(STREXTRACT(RespuestaWs,'<Id>','</Id>'))
aRespuesta(2)=ALLTRIM(STREXTRACT(RespuestaWs,'<Rut>','</Rut>'))
aRespuesta(3)=STREXTRACT(RespuestaWs,'<Dv>','</Dv>')
aRespuesta(4)=This.pFiltraEspeciales(ALLTRIM(STREXTRACT(RespuestaWs,'<Nombre>','</Nombre>')))
aRespuesta(5)=This.pFiltraEspeciales(ALLTRIM(STREXTRACT(RespuestaWs,'<RazonSocial>','</RazonSocial>')))
aRespuesta(6)=This.pFiltraEspeciales(ALLTRIM(STREXTRACT(RespuestaWs,'<Giro>','</Giro>')))
aRespuesta(7)=STREXTRACT(RespuestaWs,'<Acteco>','</Acteco>')
aRespuesta(8)=STREXTRACT(RespuestaWs,'<CodigoSucursalSII>','</CodigoSucursalSII>')
aRespuesta(9)=ALLTRIM(STREXTRACT(RespuestaWs,'<TelefonoContacto>','</TelefonoContacto>'))
aRespuesta(10)=This.pFiltraEspeciales(ALLTRIM(STREXTRACT(RespuestaWs,'<Email>','</Email>')))
aRespuesta(11)=ALLTRIM(STREXTRACT(RespuestaWs,'<FechaResolucion>','</FechaResolucion>'))
aRespuesta(12)=ALLTRIM(STREXTRACT(RespuestaWs,'<NroResolucion>','</NroResolucion>'))
aRespuesta(13)=ALLTRIM(STREXTRACT(RespuestaWs,'<RutEnvia>','</RutEnvia>'))

vContadorLineasDatos=0
FOR vI=1 TO ALEN(aRespuesta,1)
	IF !Empty(ALLTRIM(aRespuesta(vI))) THEN
		vContadorLineasDatos=vContadorLineasDatos+1
	ENDIF
ENDFOR

*RELEASE oHTTP

RETURN vContadorLineasDatos


ENDPROC
PROCEDURE pextraeimpresorasservidor
IF USED("IMPSERCUR") THEN
	USE IN ImpSerCur
ENDIF

TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetAllImpresoras/>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT


PUBLIC vRespuestaWebService
vRespuestaWebService=0

WAIT WINDOW "Extrayendo Impresoras Autorizadas" NOWAIT


bRespuesta=This.pEnviaDTEImpresoras(vVarXML)

WAIT CLEAR

IF vRespuestaWebService<0 THEN
	UNLOCK ALL
	=MESSAGEBOX("Error enviando DTE")
	RETURN .f.
ELSE	
	CREATE CURSOR ImpSerCur (ID n(5), Nombre c(50), NombreLocal c(150), NombreServer c(150))
	
	vContadorImpresoras=1
	DO WHILE .t.
		vCadenaExtraida=STREXTRACT(bRespuesta, "<Impresora>", "</Impresora>", vContadorImpresoras)
		
		IF !EMPTY(ALLTRIM(vCadenaExtraida)) THEN
			vID				=VAL(STREXTRACT(vCadenaExtraida, "<Id>", "</Id>"))
			vNombre			=STREXTRACT(vCadenaExtraida, "<Nombre>", "</Nombre>")
			vNombreLocal	=STREXTRACT(vCadenaExtraida, "<NombreLocal>", "</NombreLocal>")
			vNombreServer	=STREXTRACT(vCadenaExtraida, "<NombreServer>", "</NombreServer>")
			
			INSERT INTO ImpSerCur (ID, Nombre, NombreLocal, NombreServer) ;
				VALUES (vID, vNombre, vNombreLocal, vNombreServer)
			
			RELEASE vID, vNombre, vNombreLocal, vNombreServer
			vContadorImpresoras=vContadorImpresoras+1
		ELSE
			EXIT
		ENDIF
	ENDDO
ENDIF

RELEASE vRespuestaWebService
ENDPROC
PROCEDURE pfiltradocedo
LPARAMETERS vpPeriodo, vpGestion
STORE 0 TO vNumeroRegistrosValidos

IF vpPeriodo=0 .or. vpGestion=0 THEN
	RETURN vNumeroRegistrosValidos
ENDIF

vFechaProceso=CTOD("01/"+PADL(ALLTRIM(STR(vpPeriodo)),2,"0")+"/"+;
				   PADL(ALLTRIM(STR(vpGestion)),4,"0"))

IF !This.mActivaTablas(.f., vFechaProceso, .t.) THEN
	WAIT CLEAR
	RETURN vNumeroRegistrosValidos
ENDIF

SELECT fatDocTo, faNumero, faTotal, ;
	   BndRec, IIF(BndRec, PADR(ALLTRIM(EdoRecGlo),55," "), "Error, NO ENVIADO AL SII") as EdoEnv, ;
	   			IIF(bndRes, PADR(ALLTRIM(EdoRes),55," "),"(Verificacion Pendiente)") as EdoSii, ;
	   Id_SNII, DetDoc, TrackID, folioInt, faRutCli, faNomCli, faFecha, bndRes;
	FROM tActual ;
	LEFT JOIN TipoDoc ON TipoDoc.IdDoc=fatDocTo ;
	WHERE BndElec .and. LibVen ;
	INTO CURSOR cDocumentosPer

vNumeroRegistrosValidos=_Tally

******* Orden que resume los Documentos que aparecen como activos en el Periodo
SELECT ID_SNII, FatDocTo, ALLTRIM(UPPER(DetDoc))+" ELECTRONICA" as Detalle ;
	FROM cDocumentosPer ;
	GROUP BY fatDocTo ;
	INTO CURSOR cTipoDoc

****** Orden que selecciona los posibles estados disponibles entre todos los documentos
GO TOP IN cTipoDoc

RETURN vNumeroRegistrosValidos



ENDPROC
PROCEDURE pfiltradocedoc
LPARAMETERS vpPeriodo, vpGestion
STORE 0 TO vNumeroRegistrosValidos
IF vpPeriodo=0 .or. vpGestion=0 THEN
	RETURN vNumeroRegistrosValidos
ENDIF

*WAIT WINDOW "Recolectando Documentos y Estados" NOWAIT

vFechaProceso=CTOD("01/"+PADL(ALLTRIM(STR(vpPeriodo)),2,"0")+"/"+;
				   PADL(ALLTRIM(STR(vpGestion)),4,"0"))

*IF !This.mActivaTablas(.f., vFechaProceso, .t.) THEN
IF !This.mActivaTablas(.f., vFechaProceso,,,,,,,,,,,,,,,,,,,.t.,,) THEN
	WAIT CLEAR
	RETURN vNumeroRegistrosValidos
ENDIF

SELECT tc.fatDocTo, tc.fanFolio, tc.famTotal, tc.EdoRes, td.Id_SNII, td.DetDoc ;
	FROM tCompra as tc;
	LEFT JOIN TipoDoc as td ON td.IdDoc=tc.fatDocTo ;
	WHERE td.BndElec AND td.iddoc = 'EC';
	INTO CURSOR cDocumentosPer

vNumeroRegistrosValidos=_Tally

IF vNumeroRegistrosValidos=0 THEN
	WAIT CLEAR
	RETURN vNumeroRegistrosValidos
ENDIF

******* Orden que resume los Documentos que aparecen como activos en el Periodo

SELECT Id_SNII, FatDocTo, ALLTRIM(UPPER(DetDoc))+" ELECTRONICA" as Detalle ;
	FROM cDocumentosPer ;
	GROUP BY fatDocTo ;
	INTO CURSOR cTipoDoc

****** Orden que selecciona los posibles estados disponibles entre todos los documentos

GO TOP IN cTipoDoc

*WAIT CLEAR
RETURN vNumeroRegistrosValidos



ENDPROC
PROCEDURE pfiltraespeciales
LPARAMETERS vpCadena

IF EMPTY(ALLTRIM(vpCadena)) THEN
	RETURN ""
ENDIF

vCadenaResultante=""

IF !USED("TABCHRESP") THEN
	vTablaSelec=StdVia+"TABCHRESP.DBF"
	
	IF !FILE(vTablaSelec) THEN
		=MESSAGEBOX("Error no se encontro tabla de Caracteres Especiales")
		RETURN ""
	ENDIF
	
	USE &vTablaSelec ALIAS TabEsp IN 0
ENDIF

FOR vI=1 TO LEN(UPPER(vpCadena))
	vCaracterLeido=SUBSTR(vpCadena,vI,1)
	IF SEEK(ASC(vCaracterLeido), "TABESP",1) THEN
		vCadenaResultante=vCadenaResultante+ALLTRIM(TabEsp.Cambia)
	ELSE
		vCadenaResultante=vCadenaResultante+vCaracterLeido
	ENDIF
ENDFOR

USE IN TabEsp

RETURN vCadenaResultante
ENDPROC
PROCEDURE pfoliosrestantes
LPARAMETERS vpTipoDoc
PUBLIC  vRutCliente, vDigitoVerificador

IF !This.pRutEmpresa() THEN
	RETURN .f.
ENDIF

IF !SEEK(vpTipoDoc, "TIPODOC",1) then
	RETURN .f.
ENDIF

TEXT TO vXMLRequest ADDITIVE TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetFoliosDisponibles>
         <lsof:codigoDTE><<ALLTRIM(TipoDoc.id_SNII)>></lsof:codigoDTE>
         <lsof:rutEmisor><<vRutCliente>></lsof:rutEmisor>
         <lsof:dvEmisor><<vDigitoVerificador>></lsof:dvEmisor>
      </lsof:GetFoliosDisponibles>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

PUBLIC vRespuestaWebService

bResultado=This.pEnviaDTE(vXMLRequest)

IF vRespuestaWebService=0 THEN
	vFoliosDisponibles=VAL(STREXTRACT(bResultado,"<GetFoliosDisponiblesResult>","</GetFoliosDisponiblesResult>"))
ELSE
	vFoliosDisponibles=0
ENDIF

RETURN vFoliosDisponibles
ENDPROC
PROCEDURE pgenerasabana
LPARAMETERS vpFecIni, vpFecFin, vpTipoSab, ;
			avpCodVen, avpCodFam, avpCodRub, avpCliente, avpCodTerr,;
			avpCodZon, avpComuna, avpCiudad, avpLocalidad, avpCodSuc, ;
			avpTipoDoc, avpCodPag, avpCodRuta,  avpProducto, vpBodega

RELEASE aTablasReq

PUBLIC ARRAY aTablasReq(13,2)

aTablasReq(1,1)="faPRODUC"
aTablasReq(1,2)=.F.
aTablasReq(2,1)="VENDEDOR"
aTablasReq(2,2)=.F.
aTablasReq(3,1)="RUPRODUC"
aTablasReq(3,2)=.F.
aTablasReq(4,1)="PRODUCTO"
aTablasReq(4,2)=.F.
aTablasReq(5,1)="CLIENTES"
aTablasReq(5,2)=.F.
aTablasReq(6,1)="TERRITORIO"
aTablasReq(6,2)=.F.
aTablasReq(7,1)="CLIRUTAS"
aTablasReq(7,2)=.F.
aTablasReq(8,1)="DIRECCLI"
aTablasReq(8,2)=.F.
aTablasReq(9,1)="RECORRIDOS"
aTablasReq(9,2)=.F.
aTablasReq(10,1)="CLIZONAS"
aTablasReq(10,2)=.F.
aTablasReq(11,1)="TIPODOC"
aTablasReq(11,2)=.F.
aTablasReq(12,1)="CONDIPAG"
aTablasReq(12,2)=.F.
aTablasReq(13,1)="CTRLPER"
aTablasReq(13,2)=.F.

FOR vI=1 TO ALEN(aTablasReq,1)
	vTablaSelec=ADDBS(ALLTRIM(UPPER(StdVia)))+aTablasReq(vI,1)+".DBF"
	vNombreTabla=ALLTRIM(aTablasReq(vI,1))
	
	IF !USED(vNombreTabla) THEN
		USE &vTablaSelec IN 0
		aTablasReq(vI,2)=.T.
	ENDIF
ENDFOR

This.mArregloMeses()

SELECT MesPer, AnoPer ;
	FROM CtrlPer WHERE BETWEEN((AnoPer*12)+MesPer, (YEAR(vpFecIni)*12)+MONTH(vpFecIni), ;
							    (YEAR(vpFecFin)*12)+MONTH(vpFecFin)) ;
	INTO CURSOR cPeriodos

IF _Tally=0 THEN
	RETURN .F.
ENDIF

IF USED("cSABANACUR") THEN
	USE IN cSabanaCur
ENDIF

CREATE CURSOR cSabanaCur (Tipo c(2), Numero c(9), Fecha d(8), Recorrido n(10), ;
						  RutCli c(12), DetCli c(50), ;
						  DirCli c(80), TelCli c(25),;
						  CodSuc c(4), DirSuc c(50), ;
						  CodPro c(15), DetPro c(50), ;
						  Cantidad n(10), Fraccion n(5), ;
						  SubTot n(15), Afecto n(15), ;
						  DscLin n(10), DscCab n(10), ;
						  RecLin n(10), RecCab n(10), ;
						  Comuna c(25), Ciudad c(25), Localidad c(25), ;
						  CodRut c(3), DetRut c(50), ;
						  CodTerr c(4), DetTerr c(25), ;
						  CodVen c(4), DetVen c(50), ;
						  CodFam  c(10), DetFam c(50), ;
						  CodRub c(6), DetRub c(25), ;
						  CodZon c(10), DetZon c(25), ;
						  ConPag c(2), DetPag c(25), ;
						  UnixEnv n(5), Direccion n(2))

GO TOP IN cPeriodos
DO WHILE !EOF("cPERIODOS")
	vFechaRef=CTOD("01/"+PADL(ALLTRIM(STR(cPeriodos.MesPer)),2,"0")+"/"+;
			  PADL(ALLTRIM(STR(cPeriodos.AnoPer)),4,"0"))	
	IF !This.mActivaTablas(.F., vFechaRef, .T.,.T.,,,,,,,,,,,,,.T.) THEN
		SKIP IN cPeriodos
		LOOP
	ENDIF
	
	WAIT WINDOW "Generando Sabana ...... "+CHR(13)+SPACE(5)+"Periodo : "+aMeses(cPeriodos.MesPer,1)+"-"+ALLTRIM(STR(cPeriodos.AnoPer)) NOWAIT
	
	SET ORDER TO 1 IN tDetalle
	SET ORDER TO 9 IN tActual
	SET ORDER TO 3 IN tLimDes	

	IF USED('tab_cab')
		SELECT		SUM(IIF(td.DirMov, t1.faSubTot, ((-1) * t1.faSubTot))) AS subtot,;
					SUM(IIF(td.DirMov, t1.faValDscto, ((-1) * t1.faValDscto))) AS dscto,;
					SUM(IIF(td.DirMov, t1.faAfecto, ((-1) * t1.faAfecto))) AS neto;
		FROM		tActual AS t1 ;
		LEFT JOIN	TipoDoc AS td ON td.idDoc = t1.fatDocTo;
		WHERE		td.LibVen AND;
					(t1.fafecha between vpFecIni AND vpFecFin);
		INTO CURSOR Tab_X
		
		IF !EMPTY(RECCOUNT('Tab_X'))
			GO TOP IN tab_x
			
			INSERT INTO tab_cab (periodo, subtot, dscto, neto);
			VALUES (STRTRAN(STR(cPeriodos.MesPer, 2), SPACE(1), '0') + STR(cPeriodos.AnoPer, 4), Tab_X.subtot, Tab_X.dscto, Tab_X.neto)
		ENDIF
				
		USE IN Tab_X		
	ENDIF	
	
	SELECT tActual
	SET NEAR ON
	SEEK(STR(YEAR(vpFecIni),4)+STR(MONTH(vpFecIni),2)+STR(DAY(vpFecIni),2))
	SET NEAR OFF
	DO WHILE !EOF("tACTUAL") .and. tActual.faFecha<=vpFecFin
		IF !BETWEEN(tActual.faFecha, vpFecIni, vpFecFin) THEN
			SKIP IN tActual
			LOOP
		ENDIF
		
		IF VARTYPE(vpBodega)!="L" THEN
			IF tActual.Bodega!=vpBodega THEN
				SKIP IN tActual
				LOOP
			ENDIF
		ENDIF
					
		STORE "" TO vCodRuta, vDetRuta, ;
					vCodTerr, vDetTerr, ;
					vCodZon, vDetZon, ;
					vCodVen, vDetVen, ;
					vCodRub, vDetRub, ;
					vComuna, vCiudad, vLocalidad, ;
					vCodPag, vDetPag, ;
					vRutCli, vCodPro
		
		STORE 0 TO Direccion
		
		
		IF SEEK(tActual.fatDocTo, "TIPODOC",1) THEN
			IF TipoDoc.LibVen .and. TipoDoc.TipDoc=1 .and. (TipoDoc.bndNC .or. TipoDoc.bndND) THEN
				vDireccion=IIF(TipoDoc.DirMov,1,-1)
			ELSE
				SKIP IN tActual
				LOOP
			ENDIF
		ENDIF
		
		vRutCli=tActual.faRutCli
		vCodPag=tActual.conPago
		vCodVen=tActual.faCodVend
		vCodRuta=tActual.Ruta

		****** Validacion de RUT de Cliente y Generacion de Detalle de Cliente
		IF VARTYPE(avpCliente)!="L" THEN
			IF TYPE("avpCliente",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCliente,1)
					IF vRutCli==avpCliente(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vRutCli!=avpCliente THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		
		
		************************************ Clientes ******************

		****** Validacion de Codigo de Zona y Generacion de Detalle de Condicion de Pago
		IF VARTYPE(avpCodPag)!="L" THEN
			IF TYPE("avpCodPag",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCodPag,1)
					IF vCodPag==avpCodPag(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vCodPag!=avpCodPag THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		
		
		IF !EMPTY(ALLTRIM(vCodPag)) THEN
			IF SEEK(vCodPag, "CONDIPAG",1) THEN
				vDetPag=CondiPag.coDescri
			ENDIF
		ENDIF

		************************************ Codigos de Pago ******************

		****** Validacion de Codigo de Zona y Generacion de Detalle de Ruta
		IF VARTYPE(avpCodRuta)!="L" THEN
			IF TYPE("avpCodRuta",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCodRuta,1)
					IF vCodRuta==avpCodRuta(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vCodRuta!=avpCodRuta THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		
		
		IF !EMPTY(ALLTRIM(vCodRuta)) THEN
			IF SEEK(vCodRuta, "CLIRUTAS",1) THEN
				vDetRuta=CliRutas.Descri
			ENDIF
		ENDIF
		************************************ RUTA ******************

				
		IF VAL(tActual.CodSuc)>0 THEN
			vComuna=tActual.ComSuc
			vCiudad=tActual.CiuSuc			
			IF SEEK(tActual.faRutCli+tActual.CodSuc, "DIRECCLI",1) THEN 					
				vCodTerr=Direccli.Territorio
				vLocalidad=Direccli.Localidad
				vCodZon=Direccli.Zona
			ENDIF
		ELSE
			vComuna=tActual.faComCli
			vCiudad=tActual.faCiuCli
			IF SEEK(tActual.faRutCli, "CLIENTES",1) THEN
				vCodTerr=Clientes.Territorio
				vLocalidad=Clientes.Localidad
				vCodZon=Clientes.Zona
			ENDIF
		ENDIF 		


		****** Validacion de Codigo de Zona y Generacion de Detalle de Territorio
		IF VARTYPE(avpCodTerr)!="L" THEN
			IF TYPE("avpCodTerr",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCodTerr,1)
					IF vCodTerr==avpCodTerr(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vCodTerr!=avpCodTerr THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		
		
		IF !EMPTY(ALLTRIM(vCodTerr)) THEN
			IF SEEK(vCodTerr, "TERRITORIO",1) THEN
				vDetTerr=ALLTRIM(Territorio.Descri)
			ENDIF
		ENDIF
		************************************ Territorio ******************


		****** Validacion de Codigo de Zona y Generacion de Detalle de Zona
		IF VARTYPE(avpCodZon)!="L" THEN
			IF TYPE("avpCodZon",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCodZon,1)
					IF vCodZon==avpCodZon(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vCodZon!=avpCodZon THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		

		
		IF !EMPTY(ALLTRIM(vCodZon)) THEN
			IF SEEK(vCodZon, "CLIZONAS",1) THEN
				vDetZon=ALLTRIM(CliZonas.zoDescri)
			ENDIF
		ENDIF
		************************************ Zona ******************
		

		****** Validacion de Codigo de Vendedor y Generacion de Detalle
		IF VARTYPE(avpCodVen)!="L" THEN
			IF TYPE("avpCodVen",1)="A" THEN
				vExisteSel=.F.
				FOR vI=1 TO ALEN(avpCodVen,1)
					IF vCodVen==avpCodVen(vI) THEN
						vExisteSel=.T.
						EXIT
					ENDIF
				ENDFOR
				
				IF !vExisteSel THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ELSE
				IF vCodVen!=avpCodVen THEN
					SKIP IN tActual
					LOOP
				ENDIF
			ENDIF
		ENDIF 		

		IF !EMPTY(ALLTRIM(vCodVen)) THEN
			IF SEEK(vCodVen, "VENDEDOR",1) THEN
				vDetVen=ALLTRIM(Vendedor.veNombre)
			ENDIF
		ENDIF
		************************************ Vendedor ******************
		
		IF SEEK(tActual.fatDocto+tActual.faNumero, "tDETALLE",1) THEN
			DO WHILE !EOF("tDETALLE") .and. (tDetalle.detDocTo+tDetalle.deNumFac)=;
											(tActual.fatDocto+tActual.faNumero)
				STORE 0 TO vSumaDSCLin, vSumaDSCCab, vSumaRecLin, vSumaRecCab, vMontoAfecto, vSubTotal
				STORE "" TO vCodRub, vDetRub, vCodFam, vDetFam, vCodPro

				IF !EMPTY(ALLTRIM(tDetalle.deCodPro)) then
					IF SEEK(tDetalle.deCodPro, "PRODUCTO", 1) THEN
						vCodPro=Producto.prCodigo
						vCodRub=Producto.Rubro
						vCodFam=Producto.prFamilia
					ENDIF
				ENDIF

				
				**************************** Validacion de Codigo Producto
				IF VARTYPE(avpProducto)!="L" THEN
					IF EMPTY(ALLTRIM(vCodPro)) THEN
						SKIP IN tDetalle
						LOOP
					ENDIF
					
					IF TYPE("avpProducto",1)="A" THEN
						vExisteSel=.F.
						FOR vI=1 TO ALEN(avpProducto,1)
							IF vCodPro==avpProducto(vI) THEN
								vExisteSel=.T.
								EXIT
							ENDIF
						ENDFOR
						
						IF !vExisteSel THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ELSE
						IF vCodPro!=avpProducto THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ENDIF
				ENDIF 		
				
				****** Validacion de Codigo de Rubro y Generacion de Detalle de Rubro
				IF VARTYPE(avpCodRub)!="L" THEN
					IF TYPE("avpCodRub",1)="A" THEN
						vExisteSel=.F.
						FOR vI=1 TO ALEN(avpCodRub,1)
							IF vCodRub==avpCodRub(vI) THEN
								vExisteSel=.T.
								EXIT
							ENDIF
						ENDFOR
						
						IF !vExisteSel THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ELSE
						IF vCodRub!=avpCodRub THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ENDIF
				ENDIF
						
				IF !EMPTY(ALLTRIM(vCodRub)) THEN
					IF SEEK(vCodRub, "RUPRODUC",1) THEN
						vDetRub=ALLTRIM(ruProduc.ruDescri)
					ENDIF
				ELSE
					IF VARTYPE(avpCodRub)!="L" THEN
						SKIP IN tDetalle
						LOOP
					ENDIF
				ENDIF
				
				************************************ Rubros ******************


				****** Validacion de Codigo de Familia y Generacion de Detalle de Familia
				IF VARTYPE(avpCodFam)!="L" THEN
					IF TYPE("avpCodFam",1)="A" THEN
						vExisteSel=.F.
						FOR vI=1 TO ALEN(avpCodFam,1)
							IF vCodFam==avpCodFam(vI) THEN
								vExisteSel=.T.
								EXIT
							ENDIF
						ENDFOR
						
						IF !vExisteSel THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ELSE
						IF vCodFam!=avpCodFam THEN
							SKIP IN tDetalle
							LOOP
						ENDIF
					ENDIF
				ENDIF
				
				IF !EMPTY(ALLTRIM(vCodFam)) THEN
					IF SEEK(vCodFam, "FAPRODUC",1) THEN
						vDetFam=ALLTRIM(faProduc.faDescrip)
					ENDIF
				ELSE
					IF VARTYPE(avpCodFam)!="L" THEN
						SKIP IN tDetalle
						LOOP
					ENDIF
				ENDIF
				************************************ Familias ******************
					
				vSubTotal=tDetalle.deTotal
				
				IF SEEK(tActual.fatDocto+tActual.faNumero+STR(tDetalle.Linea,4), "tLIMDES",3) THEN
					DO WHILE !EOF("tDETALLE") .and. (tLimDes.Tipo+tLimDes.Numero)=;
													(tActual.fatDocto+tActual.faNumero) .and. ;
													tLimDes.Linea=tDetalle.Linea
						&&&& Acumula Descuentos de Linea y Cabecera
						IF INLIST(tLimDes.TipoDsc, 1,2,3) THEN
							vSumaDSCLin=vSumaDSCLin+tLimDes.MonDSC
						ENDIF
						IF INLIST(tLimDes.TipoDsc, 7,12) THEN
							vSumaDSCCab=vSumaDSCCab+tLimDes.MonDSC
						ENDIF
						
						&&&& Acumula Recargos de Linea y Cabecera
						IF INLIST(tLimDes.TipoDsc, 4) THEN
							vSumaRecLin=vSumaRecLin+tLimDes.MonDSC
						ENDIF
						IF INLIST(tLimDes.TipoDsc, 10,13) THEN
							vSumaRecCab=vSumaRecCab+tLimDes.MonDSC
						ENDIF
						
						SKIP IN tLimDes
					ENDDO
				ENDIF
				
				vMontoAfecto=vSubTotal-(vSumaDscLin+vSumaDscCab)+(vSumaRecLin+vSumaRecCab)
				

				INSERT INTO cSabanaCur (Tipo, Numero, Fecha, Recorrido, ;
										RutCli , DetCli, ;
										CodSuc , DirSuc, ;
										CodPro, DetPro, ;
										Cantidad, Fraccion, ;
										SubTot, Afecto, ;
										DscLin, DscCab, ;
										RecLin, RecCab, ;
										Comuna, Ciudad, Localidad, ;
										CodRut, DetRut, ;
										CodTerr, DetTerr, ;
										CodVen, DetVen, ;
										CodFam, DetFam, ;
										CodRub, DetRub, ;
										CodZon, DetZon, ;
										ConPag, DetPag, ;
										UnixEnv, DirCli, TelCli, Direccion) ;
					VALUES (tActual.fatDocTo, tActual.faNumero, tActual.faFecha, tActual.idRuteo,;
							tActual.faRutCli, tActual.faNomCli, ;
							tActual.CodSuc, tActual.DirSuc, ;
							tDetalle.deCodPro, tDetalle.deDesPro, ;
							tDetalle.deCantidad, tDetalle.deFraccion, ;
							tDetalle.deTotal, vMontoAfecto, ;
							vSumaDSCLin, vSumaDSCCab, ;
							vSumaRecLin, vSumaRecCab, ;
							vComuna, vCiudad, vLocalidad, ;
							vCodRuta, vDetRuta, ;
							vCodTerr, vDetTerr, ;
							vCodVen, vDetVen, ;
							vCodFam, vDetFam, ;
							vCodRub, vDetRub, ;
							vCodZon, vDetZon, ;
							vCodPag, vDetPag, ;
							tDetalle.Envase, ;
							tActual.faDirCli, tActual.faFonCli, vDireccion)

				
				SKIP IN tDetalle
			ENDDO
		ENDIF
		
		SKIP IN tActual
	ENDDO
	
	SKIP IN cPeriodos
ENDDO

This.mActivatablas(.T., vpFecIni)

FOR vI=1 TO ALEN(aTablasReq,1)
	vNombreTabla=ALLTRIM(aTablasReq(vI,1))
	
	IF USED(vNombreTabla) THEN
		IF aTablasReq(vI,2) THEN
			USE IN &vNombreTabla
		ENDIF
	ENDIF
ENDFOR

IF RECCOUNT("cSABANACUR")>0 THEN
	RETURN .T.
ELSE
	RETURN .F.
ENDIF
					

ENDPROC
PROCEDURE pgeneravectordscreccab
LPARAMETERS vpTipoDscCab, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab, vpTipoRecCab

IF VARTYPE(aDscRecCab)!="U" THEN
	RELEASE aDscRecCab
ENDIF

vFilaArreglos=0

vBndDscRecCabecera =.t.
CALCULATE CNT() TO vCantidadProductosSinDsctos FOR ItemCur.noApliDes="S" IN ItemCur
CALCULATE CNT() TO vCantidadProductosRegistrados FOR !DELETED("ITEMCUR")  IN ItemCur

DO CASE
	CASE (vCantidadProductosRegistrados+vCantidadProductosSinDsctos)=0
		vBndDscRecCabecera=.f.
	CASE vCantidadProductosRegistrados=vCantidadProductosSinDsctos
		vBndDscRecCabecera=.f.
ENDCASE

IF !vBndDscRecCabecera THEN
	IF vCantidadProductosRegistrados>0 THEN
		=MESSAGEBOX("Todos los Productos Asignados al Documento, estan en la Categoria de No Aplica Descuento"+CHR(13)+;
					"Por tanto el Descuento de Cabecera no tendra efecto")
	ENDIF
	RETURN
ENDIF

IF vCantidadProductosSinDsctos>0 THEN
	CALCULATE SUM(MonDsc) TO vpMonDscCab FOR INLIST(TipDsc, 7,12) IN DscCur
	CALCULATE SUM(MonDsc) TO vpMonRecCab FOR INLIST(TipDsc, 10,13) IN DscCur
	STORE 0 TO vpPorDscCab, vpPorRecCab
ENDIF

GO TOP IN prprm
IF prPrm.Modalidad!=0 THEN
	IF vpPorDscCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vpPorDscCab
		aDscRecCab(vFilaArreglos,3)="%"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA (%)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=1
	ENDIF 	

	IF vpMonDscCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vpMonDscCab
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA ($)"
*		aDscRecCab(vFilaArreglos,5)=vpTipoDscRecCab-1
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF

	IF vpPorRecCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vpPorRecCab
		aDscRecCab(vFilaArreglos,3)="%"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA (%)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=1
	ENDIF 	

	IF vpMonRecCab>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vpMonRecCab
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
ELSE
	CALCULATE SUM(MonDsc) FOR INLIST(TipDsc,1,2,3,7,12) TO vSumaMontoDscCabecera IN DscCur
	CALCULATE SUM(MonDsc) FOR INLIST(TipDsc,4,10,13) TO vSumaMontoRecCabecera IN DscCur
	
	IF (vpPorDscCab+vpMonDscCab)>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="D"
		aDscRecCab(vFilaArreglos,2)=vSumaMontoDscCabecera
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" DESCUENTO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscRecCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
	IF (vpMonRecCab+vpPorRecCab)>0 THEN
		vFilaArreglos=vFilaArreglos+1
		
		PUBLIC ARRAY aDscRecCab(vFilaArreglos,6)	
		aDscRecCab(vFilaArreglos,1)="R"
		aDscRecCab(vFilaArreglos,2)=vSumaMontoRecCabecera
		aDscRecCab(vFilaArreglos,3)="$"
		aDscRecCab(vFilaArreglos,4)=" RECARGO CABECERA ($)"
		aDscRecCab(vFilaArreglos,5)=vpTipoDscRecCab-1
		aDscRecCab(vFilaArreglos,6)=2
	ENDIF
ENDIF 	

RETURN vFilaArreglos

ENDPROC
PROCEDURE pgrabalogerror
LPARAMETERS vpTipoError, vpMensajeError


DO CASE
	CASE vTipoError=1
		******* Cuando se genera un error en proceso de Generacion de Libros de Venta
		IF !USED("ARCVIA") THEN
			USE Arcvia
		ENDIF
		
		GO TOP IN ArcVia
		vLogError=ADBS(ALLTRIM(UPPER(ArcVia.RutaLogs)))+"LogLibroVentas.txt"
		
		IF !FILE(vLogError) THEN
			vPunteroLog=FCREATE(vLogError)
		ELSE
			vPunteroLog=FOPEN(vLogError)
		ENDIF
		
		IF vPunteroLog<=0 THEN
			=MESSAGEBOX("No se pudo Grabar en el Log")
			RETURN .f.
		ENDIF
		
		=FSEEK(vPunteroLog,0,2)   &&&& Moviendo
		
		vResultadoGrabar=FPUTS(vPunteroLog, TTOC(DATETIME())+vpMensajeError)
		= FCLOSE(vPunteroLogs)
ENDCASE

ENDPROC
PROCEDURE pidefolio
LPARAMETERS vpTipoDoc, vpRutEmpresa, vpDigitoVerificador
******* Empieza el armado del XML

LOCAL vResultado
vResultado=0

TEXT TO cXML_Request TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetFolio>
         <lsof:codigoDTE><<vpTipoDoc>></lsof:codigoDTE>
         <lsof:rutEmisor><<vpRutEmpresa>></lsof:rutEmisor>
         <lsof:dvEmisor><<vpDigitoVerificador>></lsof:dvEmisor>	
      </lsof:GetFolio>
   </soapenv:Body>
</soapenv:Envelope>	
ENDTEXT

****** Fin del Armado del XML
oHTTP.OPEN("POST", This.DirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)

IF oHTTP.STATUS = 200
	RespuestaWS = oHTTP.responseText
ELSE
	MESSAGEBOX("Error: (" + TRANSFORM(oHTTP.STATUS) + ") " +oHTTP.statusText,16,"Web Service Reportó")
	RETURN 0
ENDIF

vResultado=VAL(STREXTRACT(RespuestaWs,'<GetFolioResult>','</GetFolioResult>'))

RETURN vResultado


ENDPROC
PROCEDURE pidefolioc
LPARAMETERS vpTipoDoc, vpRutEmpresa, vpDigitoVerificador
******* Empieza el armado del XML

LOCAL RespuestaWS

TEXT TO cXML_Request TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetFolio>
         <lsof:codigoDTE><<vpTipoDoc>></lsof:codigoDTE>
         <lsof:rutEmisor><<vpRutEmpresa>></lsof:rutEmisor>
         <lsof:dvEmisor><<vpDigitoVerificador>></lsof:dvEmisor>	
      </lsof:GetFolio>
   </soapenv:Body>
</soapenv:Envelope>	
ENDTEXT

****** Fin del Armado del XML
oHTTP.OPEN("POST", This.DirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(cXML_Request)

IF oHTTP.STATUS = 200
	RespuestaWS = oHTTP.responseText
	IF VAL(STREXTRACT(RespuestaWs,'<GetFolioResult>','</GetFolioResult>'))>0 THEN
		TEXT TO vRespuesta TEXTMERGE NOSHOW FLAGS 2
<Resultado>true</Resultado>
<Numero><<STREXTRACT(RespuestaWs,'<GetFolioResult>','</GetFolioResult>')>></Numero>
		ENDTEXT
	ELSE
		TEXT TO vRespuesta TEXTMERGE NOSHOW FLAGS 2
<Resultado>false</Resultado>
		ENDTEXT
	ENDIF
ELSE
	TEXT TO vRespuesta TEXTMERGE NOSHOW FLAGS 2
<Resultado>false</Resultado>
	ENDTEXT
ENDIF

RETURN vRespuesta


ENDPROC
PROCEDURE pimpresionelec
LPARAMETERS vpCedible, vpFolioInterno, vpAvanzaImpresion, vpModoImpresora

GO TOP IN prPrm

IF VARTYPE(aImpresion)!="U" THEN
	RELEASE aResultadoImpresion
ENDIF

PUBLIC ARRAY aResultadoImpresion(2)

**** Si esta en modo ACEPTA inhabilita la Impresion
IF prPrm.Modalidad!=1 THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="La Opcion de Impresion es controlada x ACEPTA"		

	RETURN @aResultadoImpresion
ENDIF

**** Si esta en modo certificacion, inhabilita la Impresion
IF prPrm.Certifica THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Se encuentra en Modo Certificacion, La Opcion de Impresion esta deshabilitada"		

	RETURN @aResultadoImpresion
ENDIF

vLimiteTimeout=prPrm.TimeoutImp
vNumeroCopias=1
vImprimeCedible=.f.


IF !vpAvanzaImpresion THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="La Opcion de Impresion ha Sido Deshabilitada"		

	RETURN @aResultadoImpresion
ENDIF

***** Proceso de Impresion en solitario
IF !SEEK(vgTipoDoc, "IMPELEC",1) THEN
	WAIT CLEAR
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Tipo de Documento NO Tiene Impresora Definida"

	RETURN @aResultadoImpresion
ENDIF

IF EMPTY(ALLTRIM(ImpElec.NomImpServ)) THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="No existe Impresora Definida para este Tipo de Documento"		

	RETURN @aResultadoImpresion
ENDIF

IF ImpElec.Copias>1 THEN
	vNumeroCopias=ImpElec.Copias
ENDIF

IF ImpElec.Cedible THEN
	IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
		vImprimeCedible=TipoDoc.Cedible
	ENDIF
ENDIF

***************** Verificar si el XML Final esta disponible *************
WAIT WINDOW "Verificando Validez de DTE (Impresion)" NOWAIT

vImprimeOK=.f.
vResultadoConsulta=""
vNumeroReintento=0
		
DO WHILE vNumeroReintento<=vLimiteTimeout
	TEXT TO vVarXML TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetXmlFinalOK>
         <lsof:idDTE><<ALLTRIM(vpFolioInterno)>></lsof:idDTE>
      </lsof:GetXmlFinalOK>
   </soapenv:Body>
</soapenv:Envelope>		
	ENDTEXT

	oHTTP.OPEN("POST", This.dirWebService , .F.)
	oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
	oHTTP.SEND(vVarXML)
	RespuestaWS = oHTTP.responseText

	IF !INLIST(oHTTP.STATUS, 200, 202) THEN
		aResultadoImpresion(1)=.f.
		aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE"+CHR(13)+;
							   "Status de Error: "+ALLTRIM(STR(oHTTP.STATUS))				
		EXIT
	ENDIF
			
	vResultadoConsulta=STREXTRACT(RespuestaWS, '<GetXmlFinalOKResult>', '</GetXmlFinalOKResult>')
	IF vResultadoConsulta="true" THEN
		vImprimeOK=.t.
		EXIT
	ENDIF
			
	vNumeroReintento=vNumeroReintento+1
ENDDO

IF !vImprimeOK THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE, Impresion no es posible"+CHR(13)+;
						   "Debe intentarlo por el Modulo de Impresion Seriada"
	RETURN @aResultadoImpresion
ENDIF 			

WAIT WINDOW "Verificacion Finalizada... Documento OK" NOWAIT
		
WAIT WINDOW "Impresion Iniciada" NOWAIT

TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetImpresionPDF>
         <lsof:IdsDTE>
ENDTEXT

vVarXML=vVarXML+CHR(10)

TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(vpFolioInterno)>></lsof:idDTE>
               <lsof:CopiaCedible>false</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(ImpElec.NomImpServ)>></lsof:Impresora>
               <lsof:Copias><<ALLTRIM(STR(vNumeroCopias))>></lsof:Copias>
               <lsof:ModalidadTicket><<IIF(vpModoImpresora,"true","false")>></lsof:ModalidadTicket>
            </lsof:ImpresionDTE>
ENDTEXT

vVarXML=vVarXML+CHR(10)

IF vImprimeCedible THEN
	TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(vpFolioInterno)>></lsof:idDTE>
               <lsof:CopiaCedible>true</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(ImpElec.NomImpServ)>></lsof:Impresora>
               <lsof:Copias>1</lsof:Copias>
            </lsof:ImpresionDTE>
	ENDTEXT
ENDIF

vVarXML=vVarXML+CHR(10)

TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
         </lsof:IdsDTE>
      </lsof:GetImpresionPDF>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

WAIT CLEAR

oHTTP.OPEN("POST", This.DirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(vVarXML)
RespuestaWS = oHTTP.responseText
RespuestaXML= oHTTP.responseXML


IF !INLIST(oHTTP.STATUS, 200,202) THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Impresion"+CHR(13)+;
						   "Status de Error: "+ALLTRIM(STR(oHTTP.STATUS))
ELSE
	aResultadoImpresion(1)=.t.
	aResultadoImpresion(2)="El Envio al Spool de Impresion ha sido un exito"	
ENDIF

RETURN @aResultadoImpresion	

ENDPROC
PROCEDURE pimpresionelec_compras
LPARAMETERS vpCedible, vpTipoDocumento, vpFolioInterno, vpAvanzaImpresion, vpModoImpresora

GO TOP IN prPrm

IF VARTYPE(aImpresion)!="U" THEN
	RELEASE aResultadoImpresion
ENDIF

PUBLIC ARRAY aResultadoImpresion(2)

**** Si esta en modo ACEPTA inhabilita la Impresion
IF prPrm.Modalidad!=1 THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="La Opcion de Impresion es controlada x ACEPTA"		

	RETURN @aResultadoImpresion
ENDIF

**** Si esta en modo certificacion, inhabilita la Impresion
IF prPrm.Certifica THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Se encuentra en Modo Certificacion, La Opcion de Impresion esta deshabilitada"		

	RETURN @aResultadoImpresion
ENDIF

vLimiteTimeout=prPrm.TimeoutImp
vNumeroCopias=1
vImprimeCedible=.f.


IF !vpAvanzaImpresion THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="La Opcion de Impresion ha Sido Deshabilitada"		

	RETURN @aResultadoImpresion
ENDIF

***** Proceso de Impresion en solitario
IF !SEEK(vpTipoDocumento, "IMPELEC",1) THEN
	WAIT CLEAR
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Tipo de Documento NO Tiene Impresora Definida"

	RETURN @aResultadoImpresion
ENDIF

IF EMPTY(ALLTRIM(ImpElec.NomImpServ)) THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="No existe Impresora Definida para este Tipo de Documento"		

	RETURN @aResultadoImpresion
ENDIF

IF ImpElec.Copias>1 THEN
	vNumeroCopias=ImpElec.Copias
ENDIF

IF ImpElec.Cedible THEN
	IF SEEK(vpTipoDocumento, "TIPODOC",1) THEN
		vImprimeCedible=TipoDoc.Cedible
	ENDIF
ENDIF

***************** Verificar si el XML Final esta disponible *************
WAIT WINDOW "Verificando Validez de DTE (Impresion)" NOWAIT

vImprimeOK=.f.
vResultadoConsulta=""
vNumeroReintento=0
		
DO WHILE vNumeroReintento<=vLimiteTimeout
	TEXT TO vVarXML TEXTMERGE NOSHOW
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetXmlFinalOK>
         <lsof:idDTE><<ALLTRIM(STR(vpFolioInterno))>></lsof:idDTE>
      </lsof:GetXmlFinalOK>
   </soapenv:Body>
</soapenv:Envelope>		
	ENDTEXT

	oHTTP.OPEN("POST", This.dirWebService , .F.)
	oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
	oHTTP.SEND(vVarXML)
	RespuestaWS = oHTTP.responseText

	IF !INLIST(oHTTP.STATUS, 200, 202) THEN
		aResultadoImpresion(1)=.f.
		aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE"+CHR(13)+;
							   "Status de Error: "+ALLTRIM(STR(oHTTP.STATUS))				
		EXIT
	ENDIF
			
	vResultadoConsulta=STREXTRACT(RespuestaWS, '<GetXmlFinalOKResult>', '</GetXmlFinalOKResult>')
	IF vResultadoConsulta="true" THEN
		vImprimeOK=.t.
		EXIT
	ENDIF
			
	vNumeroReintento=vNumeroReintento+1
ENDDO

IF !vImprimeOK THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Status del DTE, Impresion no es posible"+CHR(13)+;
						   "Debe intentarlo por el Modulo de Impresion Seriada"
	RETURN @aResultadoImpresion
ENDIF 			

WAIT WINDOW "Verificacion Finalizada... Documento OK" NOWAIT
		
WAIT WINDOW "Impresion Iniciada" NOWAIT

TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetImpresionPDF>
         <lsof:IdsDTE>
ENDTEXT

vVarXML=vVarXML+CHR(10)

TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(STR(vpFolioInterno))>></lsof:idDTE>
               <lsof:CopiaCedible>false</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(ImpElec.NomImpServ)>></lsof:Impresora>
               <lsof:Copias><<ALLTRIM(STR(vNumeroCopias))>></lsof:Copias>
               <lsof:ModalidadTicket><<IIF(vpModoImpresora,"true","false")>></lsof:ModalidadTicket>
            </lsof:ImpresionDTE>
ENDTEXT

vVarXML=vVarXML+CHR(10)

IF vImprimeCedible THEN
	TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(STR(vpFolioInterno))>></lsof:idDTE>
               <lsof:CopiaCedible>true</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(ImpElec.NomImpServ)>></lsof:Impresora>
               <lsof:Copias>1</lsof:Copias>
            </lsof:ImpresionDTE>
	ENDTEXT
ENDIF

vVarXML=vVarXML+CHR(10)

TEXT TO vVarXML NOSHOW TEXTMERGE ADDITIVE
         </lsof:IdsDTE>
      </lsof:GetImpresionPDF>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

WAIT CLEAR

oHTTP.OPEN("POST", This.DirWebService , .F.)
oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
oHTTP.SEND(vVarXML)
RespuestaWS = oHTTP.responseText
RespuestaXML= oHTTP.responseXML


IF !INLIST(oHTTP.STATUS, 200,202) THEN
	aResultadoImpresion(1)=.f.
	aResultadoImpresion(2)="Ha Ocurrido un error al ingresar el requerimiento de Impresion"+CHR(13)+;
						   "Status de Error: "+ALLTRIM(STR(oHTTP.STATUS))
ELSE
	aResultadoImpresion(1)=.t.
	aResultadoImpresion(2)="El Envio al Spool de Impresion ha sido un exito"	
ENDIF

RETURN @aResultadoImpresion	

ENDPROC
PROCEDURE pimpresioseriadaelectronica
LPARAMETERS vpCedible, vpDocumento, vpEnvioPDF , vpEnvioXML, vpVerificaExistencia, vpModoImpresora

IF !vpCedible .and. !vpDocumento .and. !vpEnvioPDF .and. !vpEnvioXML THEN
	Return .f.
ENDIF

GO TOP IN prPrm
IF prPrm.Modalidad!=1 THEN
	RETURN .f.
ENDIF

vLimiteTimeout=prPrm.TimeoutImp
vNumeroCopias=1

STORE 0 TO vNumeroReintento

SET ORDER TO 1 IN DocEnvio
					
***************** Verificar si documentos enviados a Impresion tienen XML Final disponible *************

IF vpVerificaExistencia THEN
	WAIT WINDOW "Verificando existencia de XML Final de DTE's" NOWAIT
	GO TOP IN DocEnvio
	DO WHILE !EOF("DOCENVIO")
		DO WHILE vNumeroReintento<=vLimiteTimeout
			TEXT TO vVarXML TEXTMERGE NOSHOW
	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
	   <soapenv:Header/>
	   <soapenv:Body>
	      <lsof:GetXmlFinalOK>
	         <lsof:idDTE><<ALLTRIM(STR(DocEnvio.FolioInt))>></lsof:idDTE>
	      </lsof:GetXmlFinalOK>
	   </soapenv:Body>
	</soapenv:Envelope>		
			ENDTEXT

			oHTTP.OPEN("POST", This.dirWebService , .F.)
			oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
			oHTTP.SEND(vVarXML)
			RespuestaWS = oHTTP.responseText

			IF INLIST(oHTTP.STATUS, 200, 202) THEN
				Replace DocEnvio.ExisteDTE ;
					WITH STREXTRACT(RespuestaWS, '<GetXmlFinalOKResult>', '</GetXmlFinalOKResult>')="true" IN DocEnvio
			ENDIF

			IF DocEnvio.ExisteDTE THEN
				EXIT
			ENDIF
						
			vNumeroReintento=vNumeroReintento+1
		ENDDO
		
		SKIP IN DocEnvio
	ENDDO
ELSE
	UPDATE DocEnvio SET ExisteDTE=.t.
ENDIF

WAIT WINDOW "Evaluando estado de Documentos y asignando Tareas...." NOWAIT

GO TOP IN DocEnvio
DO WHILE !EOF("DOCENVIO")
	IF vpDocumento THEN
		IF SEEK(DocEnvio.Tipo, "IMPELEC",1) THEN
			IF !EMPTY(ALLTRIM(ImpElec.NomImpServ)) THEN
				Replace DocEnvio.ImpOri WITH .t., ;
						DocEnvio.NomImp WITH ALLTRIM(ImpElec.NomImpServ), ;
						DocEnvio.Copias WITH ImpElec.Copias IN DocEnvio
			ELSE
				Replace DocEnvio.ImpOri WITH .f., ;
						DocEnvio.NomImp WITH "", ;
						DocEnvio.Copias WITH 0, ;
						DocEnvio.ObsImpOri WITH "No existe Impresora Definida para Este Tipo de Documento" IN DocEnvio
			ENDIF
		ELSE
			Replace DocEnvio.ImpOri WITH .f., ;
					DocEnvio.NomImp WITH "", ;
					DocEnvio.Copias WITH 0, ;
					DocEnvio.ObsImpOri WITH "Este Tipo de Documento no esta definido para Impresion Electronica" IN DocEnvio
		ENDIF
	ENDIF
			
	IF vpCedible THEN
		IF SEEK(DocEnvio.Tipo, "IMPELEC",1) THEN
			IF Impelec.Cedible THEN
				IF !EMPTY(ALLTRIM(ImpElec.NomImpServ)) THEN
					Replace DocEnvio.ImpCed WITH .t., ;
							DocEnvio.NomImp WITH ALLTRIM(ImpElec.NomImpServ) IN DocEnvio
				ELSE
					Replace DocEnvio.ImpCed WITH .f., ;
							DocEnvio.ObsImpCed WITH "No existe Impresora Definida para Este Tipo de Documento" IN DocEnvio
				ENDIF
			ELSE
				Replace DocEnvio.ImpCed WITH .f., ;
						DocEnvio.ObsImpCed WITH "Este Documento no admite Impresion Cedible" IN DocEnvio
			ENDIF 				
		ELSE
			Replace DocEnvio.ImpCed WITH .f., ;
					DocEnvio.ObsImpCed WITH "Este Tipo de Documento no esta definido para Impresion Electronica" IN DocEnvio
		ENDIF
	ENDIF

	IF vpEnvioPDF THEN
		IF SEEK(DocEnvio.RutCli, "CLIENTES",1) THEN
			Replace DocEnvio.EnviaPDF WITH Clientes.DTEMail, ;
					DocEnvio.CorreoPDF WITH ALLTRIM(Clientes.CorreoPDF) IN DocEnvio
		ELSE
			Replace DocEnvio.EnviaPDF WITH .f. IN DocEnvio
		ENDIF
	ENDIF 			

	IF vpEnvioXML THEN
		IF SEEK(DocEnvio.RutCli, "CLIENTES",1) THEN
			Replace DocEnvio.EnviaXML WITH Clientes.Electron , ;
					DocEnvio.CorreoXML WITH ALLTRIM(Clientes.MailElec) IN DocEnvio
		ELSE
			Replace DocEnvio.EnviaXML WITH .f. IN DocEnvio
		ENDIF
	ENDIF 			
	
	SKIP IN DocEnvio
ENDDO

CALCULATE CNT() TO vNumeroImpresos FOR DocEnvio.ImpOri .or. DocEnvio.ImpCed IN DocEnvio

STORE "" TO vXMLImpresion

IF vNumeroImpresos>0 THEN
	WAIT WINDOW "Iniciando Construccion de Sentencia de Envio de Documentos... (Impresion de Documentos)" NOWAIT
	
	TEXT TO vXMLImpresion NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetImpresionPDF>
         <lsof:IdsDTE>
	ENDTEXT
	
	vXMLImpresion =vXMLImpresion +CHR(10)
	
	SELECT ALLTRIM(STR(FolioInt)) as FolioInt, ImpOri, ImpCed, ALLTRIM(STR(Copias)) as Copias, NomImp, Tipo, Numero ;
		FROM DocEnvio ;
		WHERE (ImpOri .or.ImpCed) .and. ExisteDTE;
		INTO CURSOR cDocImp
	
	GO TOP IN cDocImp
	DO WHILE !EOF("cDOCIMP")
		IF cDocImp.ImpOri THEN
			WAIT WINDOW "Adicionando Documento: "+cDocImp.Tipo+"-"+cDocImp.Numero+", Categoria: Impresion Original" NOWAIT
			TEXT TO vXMLImpresion NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(cDocImp.FolioInt)>></lsof:idDTE>
               <lsof:CopiaCedible>false</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(cDocImp.NomImp)>></lsof:Impresora>
               <lsof:Copias><<ALLTRIM(cDocImp.Copias)>></lsof:Copias>
               <lsof:ModalidadTicket>0</lsof:ModalidadTicket>
            </lsof:ImpresionDTE>
	        ENDTEXT
	        vXMLImpresion =vXMLImpresion +CHR(10)
	    ENDIF
		
		IF cDocImp.ImpCed THEN
			WAIT WINDOW "Adicionando Documento: "+cDocImp.Tipo+"-"+cDocImp.Numero+", Categoria: Impresion Cedible" NOWAIT

			TEXT TO vXMLImpresion NOSHOW TEXTMERGE ADDITIVE
            <lsof:ImpresionDTE>
               <lsof:idDTE><<ALLTRIM(cDocImp.FolioInt)>></lsof:idDTE>
               <lsof:CopiaCedible>true</lsof:CopiaCedible>
               <lsof:Impresora><<ALLTRIM(cDocImp.NomImp)>></lsof:Impresora>
               <lsof:Copias>1</lsof:Copias>
               <lsof:ModalidadTicket>0</lsof:ModalidadTicket>
            </lsof:ImpresionDTE>
	        ENDTEXT
	        vXMLImpresion =vXMLImpresion +CHR(10)
	    ENDIF
		
		SKIP IN cDocImp
	ENDDO
	
	USE IN cDocImp
	
 	TEXT TO vXMLImpresion NOSHOW TEXTMERGE ADDITIVE
         </lsof:IdsDTE>
      </lsof:GetImpresionPDF>
   </soapenv:Body>
</soapenv:Envelope>
	ENDTEXT
ENDIF

IF !EMPTY(ALLTRIM(vXMLImpresion)) THEN
	WAIT WINDOW "Iniciando Envio de Sentencia.... (Impresion de Documentos)" NOWAIT

	oHTTP.OPEN("POST", This.DirWebService , .F.)
	oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
	oHTTP.SEND(vXMLImpresion)
*!*		RespuestaWS = oHTTP.responseText
*!*		RespuestaXML= oHTTP.responseXML
	IF !INLIST(oHTTP.STATUS, 200,202) THEN
		WAIT WINDOW "Error en Envio de Sentencia"
	ENDIF
	
	Replace DocEnvio.ResImpOri WITH INLIST(oHTTP.STATUS, 200,202), ;
			DocEnvio.ObsImpOri WITH IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService") FOR DocEnvio.ImpOri IN DocEnvio
	Replace DocEnvio.ResImpCed WITH INLIST(oHTTP.STATUS, 200,202), ;
			DocEnvio.ObsImpCed WITH IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService") FOR DocEnvio.ImpCed IN DocEnvio
ENDIF

IF vpEnvioPDF .or. vpEnvioXML THEN
	
	WAIT WINDOW "Iniciando construccion de Sentencia para Envio x Correo..." NOWAIT
	
	SELECT ALLTRIM(STR(FolioInt)) as FolioInt, CorreoPDF, CorreoXML, EnviaPDF, EnviaXML, Tipo, Numero ;
		FROM DocEnvio ;
		WHERE (EnviaPDF .or. EnviaXML) .and. ;
			   IIF(EMPTY(ALLTRIM(CorreoPDF)),"NINGUNO001",ALLTRIM(LOWER(CorreoPDF)))!=;
			   IIF(EMPTY(ALLTRIM(CorreoXML)),"NINGUNO002",ALLTRIM(LOWER(CorreoXML))) .and. ;
			  !EMPTY(CorreoPDF+CorreoXML) .and. ExisteDTE ;		
		INTO CURSOR cEnvDistinto

	GO TOP IN cEnvDistinto
	DO WHILE !EOF("cENVDISTINTO")
		IF cEnvDistinto.EnviaPDF THEN
			WAIT WINDOW "Adicionando Documento: "+cEnvDistinto.Tipo+"-"+cEnvDistinto.Numero+", Categoria: Envio PDF" NOWAIT
			
			TEXT TO vXMLEnvioElectronico NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutEnviarDTEAlReceptor>
         <lsof:idDTE><<ALLTRIM(cEnvDistinto.folioInt)>></lsof:idDTE>
         <lsof:enviarPDF>true</lsof:enviarPDF>
         <lsof:enviarSobreXml>false</lsof:enviarSobreXml>
         <lsof:emailDestino><<ALLTRIM(cEnvDistinto.CorreoPDF)>></lsof:emailDestino>
      </lsof:PutEnviarDTEAlReceptor>
   </soapenv:Body>
</soapenv:Envelope>
			ENDTEXT

			WAIT WINDOW "Iniciando envio de Sentencia para Envio x Correo (distintos)...(Fase PDF)" NOWAIT
			
			oHTTP.OPEN("POST", This.DirWebService , .F.)
			oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
			oHTTP.SEND(vXMLEnvioElectronico)
*!*				RespuestaWS = oHTTP.responseText
*!*				RespuestaXML= oHTTP.responseXML

			IF !INLIST(oHTTP.STATUS, 200,202) THEN
				WAIT WINDOW "Error en Envio de Sentencia... Envio de Correos Distintos (Fase PDF)"
			ENDIF
			
			IF SEEK(cEnvDistinto.FolioInt, "DOCENVIO",2) THEN
				Replace DocEnvio.ResEnvPDF WITH INLIST(oHTTP.STATUS, 200,202), ;
						DocEnvio.ObsEnvPDF WITH IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService") IN DocEnvio
			ENDIF
		ENDIF

		IF cEnvDistinto.EnviaXML THEN
			WAIT WINDOW "Adicionando Documento: "+cEnvDistinto.Tipo+"-"+cEnvDistinto.Numero+", Categoria: Envio XML" NOWAIT
		
			TEXT TO vXMLEnvioElectronico NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutEnviarDTEAlReceptor>
         <lsof:idDTE><<ALLTRIM(cEnvDistinto.folioInt)>></lsof:idDTE>
         <lsof:enviarPDF>false</lsof:enviarPDF>
         <lsof:enviarSobreXml>true</lsof:enviarSobreXml>
         <lsof:emailDestino><<ALLTRIM(cEnvDistinto.CorreoXML)>></lsof:emailDestino>
      </lsof:PutEnviarDTEAlReceptor>
   </soapenv:Body>
</soapenv:Envelope>
			ENDTEXT
			
			WAIT WINDOW "Iniciando envio de Sentencia para Envio x Correo... (fase XML)" NOWAIT

			oHTTP.OPEN("POST", This.DirWebService , .F.)
			oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
			oHTTP.SEND(vXMLEnvioElectronico)
*!*				RespuestaWS = oHTTP.responseText
*!*				RespuestaXML= oHTTP.responseXML

			IF !INLIST(oHTTP.STATUS, 200,202) THEN
				WAIT WINDOW "Error en Envio de Sentencia... Envio de Correos Distintos (fase XML)"
			ENDIF

			IF SEEK(cEnvDistinto.FolioInt, "DOCENVIO",2) THEN
				Replace DocEnvio.ResEnvXML WITH INLIST(oHTTP.STATUS, 200,202), ;
						DocEnvio.ObsEnvXML WITH IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService") IN DocEnvio
			ENDIF
		ENDIF
		
		SKIP IN cEnvDistinto
	ENDDO

	USE IN cEnvDistinto
					
	SELECT ALLTRIM(STR(FolioInt)) as FolioInt, CorreoPDF, CorreoXML, enviaPDF, enviaXML, Tipo, Numero ;
		FROM DocEnvio ;
		WHERE (EnviaPDF .or. EnviaXML) .and. ALLTRIM(LOWER(CorreoPDF))==ALLTRIM(LOWER(CorreoXML)) .and. ;
			  !EMPTY(CorreoPDF+CorreoXML) ;
		INTO CURSOR cEnvIgual
	
	GO TOP IN cEnvIgual
	DO WHILE !EOF("cENVIGUAL")	
		WAIT WINDOW "Adicionando Documento: "+cEnvIgual.Tipo+"-"+cEnvIgual.Numero+", Categoria: Envio XML ..correos iguales" NOWAIT
	
		TEXT TO vXMLEnvioElectronico NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:PutEnviarDTEAlReceptor>
         <lsof:idDTE><<ALLTRIM(cEnvIgual.folioInt)>></lsof:idDTE>
         <lsof:enviarPDF><<IIF(cEnvIgual.EnviaPDF,"true","false")>></lsof:enviarPDF>
         <lsof:enviarSobreXml><<IIF(cEnvIgual.EnviaXML,"true","false")>></lsof:enviarSobreXml>
         <lsof:emailDestino><<ALLTRIM(cEnvIgual.CorreoXML)>></lsof:emailDestino>
      </lsof:PutEnviarDTEAlReceptor>
   </soapenv:Body>
</soapenv:Envelope>
		ENDTEXT

		WAIT WINDOW "Iniciando envio de Sentencia para Envio x Correo (Iguales)..." NOWAIT
		
		oHTTP.OPEN("POST", This.DirWebService , .F.)
		oHTTP.setRequestHeader("Content-Type", "text/xml;charset=utf-8")
		oHTTP.SEND(vXMLEnvioElectronico)
*!*			RespuestaWS = oHTTP.responseText
*!*			RespuestaXML= oHTTP.responseXML

		IF !INLIST(oHTTP.STATUS, 200,202) THEN
			WAIT WINDOW "Error en Envio de Sentencia... Envio de Correos Distintos"
		ENDIF

		IF SEEK(cEnvIgual.FolioInt, "DOCENVIO",2) THEN
			Replace DocEnvio.ResEnvPDF WITH IIF(cEnvIgual.EnviaPDF,INLIST(oHTTP.STATUS, 200,202), .f.), ;
					DocEnvio.ResEnvXML WITH IIF(cEnvIgual.EnviaXML, INLIST(oHTTP.STATUS, 200,202), .f.),;
					DocEnvio.ObsEnvPDF WITH IIF(cEnvIgual.EnviaPDF,IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService"),"Servicio no solicitado"),  ;
					DocEnvio.ObsEnvXML WITH IIF(cEnvIgual.EnviaXML, IIF(INLIST(oHTTP.STATUS, 200,202),"","Error en WebService"), "Servicio no solicitado") IN DocEnvio
		ENDIF
		SKIP IN cEnvIgual
	ENDDO
	
	USE IN cEnvIgual
ENDIF

DO FORM g:\Desarrollo\IsstecErp\Form\wResultadoEnvioMasivo

USE IN DocEnvio
ENDPROC
PROCEDURE precuperaivapordefecto
GO TOP IN prPrm
IF EOF("prPRM") THEN
	=MESSAGEBOX("No existen Parametros Iniciales")
	RETURN 0
ENDIF

RETURN prPrm.paIva
ENDPROC
PROCEDURE prutempresa
GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador

***** Verifica si el documento es exento o no; y si es Guia de Despacho o no
vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR


ENDPROC
PROCEDURE pseldocedo
LPARAMETERS vpTipoDoc

RELEASE aEdoRes
PUBLIC ARRAY aEdoRes (1,2)


SELECT EdoEnv, EdoSii, CNT(*) ;
	FROM cDocumentosPer;
	WHERE fatDocTo=vpTipoDoc ;
	GROUP BY EdoEnv, edoSII ;
	INTO ARRAY aEdoRes
	
RETURN .t.



ENDPROC
PROCEDURE pseldocedoc
LPARAMETERS vpTipoDoc

IF !USED("cDOCUMENTOSPER") THEN
	RETURN .f.
ENDIF

SELECT IIF(EMPTY(ALLTRIM(EdoRes)), PADR("(ENVIO PENDIENTE)", 150, " "), PADR(ALLTRIM(EdoRes),150, " ")) ;
	FROM cDocumentosPer ;
	WHERE fatDocTo=vpTipoDoc ;
	GROUP BY EdoRes ;
	INTO ARRAY aEdoRes

RETURN .t.

ENDPROC
PROCEDURE pseleccionaorden
*!*	LPARAMETERS vpFechaInicial, vpFechaFinal, vpBndCliente, vpBndVendedor, vpBndFamilia, ;
*!*			    vpRutCliente, vpCodigoVendedor, vpCodigoFamilia

*!*	DO CASE
*!*		CASE
*!*	SELECT detDocTo as Tipo, deNumFac as Numero, deCodPro as CodPro, deDesPro as Detalle, ;
*!*		   deCantidad as Cantidad, deFraccion as Fraccion, ;
*!*		   deValor as Precio, deTotal as total, deDscto as DsctoLin, 0 as MonDscLin,;
*!*		   0 as NuevoNeto, IIF(ISNULL(faDscto+faDscto2+faDscto3) ,0,faDscto+faDscto2+faDscto3) as DsctoCab, ;
*!*		   0 as MonDsctoCab, 0 as TotalNeto, ;
*!*		   faCodVend as CodVen, IIF(ISNULL(veNombre),"",veNombre) as DetVen,  ;
*!*		   IIF(ISNULL(prFamilia),"",prFamilia) as CodFam, IIF(ISNULL(faDescrip),"", faDescrip) as DetFam, ;
*!*		   faRutCli as RutCli, faNomCli as NomCli, ;
*!*		   tActual.CodSuc as CodSuc, tActual.faFecha as Fecha, tActual.idRuteo as Recorrido, ;
*!*		   (detDocTo+deNumFac) as LlaveDoc, Envase, (deCantidad+(deFraccion/Envase)) as Cajas, ;
*!*		   faComCli as Comuna ;
*!*		   FROM tDetalle ;
*!*		   LEFT JOIN tActual ON (tDetalle.detDocTo+tDetalle.deNumFac)=(tActual.fatDocTo+tActual.faNumero) ;
*!*		   LEFT JOIN Producto ON tDetalle.deCodPro=Producto.prCodigo ;
*!*		   LEFT JOIN faProduc ON Producto.prFamilia=faProduc.faCodigo ;
*!*		   LEFT JOIN Vendedor ON tActual.faCodVend=Vendedor.veCodigo ;
*!*		   WHERE !DELETED("tDETALLE") .and. BETWEEN(tActual.faFecha, vFechaInicial, vFechaFinal) .and. ;
*!*		   		 faCodVend in (SELECT Codigo FROM VenCur WHERE Sel) ;
*!*		   		 .and. DetDocTo in (SELECT idDoc FROM TipoDoc WHERE TipDoc=1) ;
*!*		   ORDER BY FecDocu ;
*!*		   INTO CURSOR cSabana READWRITE
ENDPROC
PROCEDURE pseleccionasignumero
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	aCorrelativo(3)=ALLTRIM(TipoDoc.id_Snii)
	
	IF TipoDoc.bndElec THEN
		PUBLIC vRutCliente, vDigitoVerificador, vNumeroRetorno
		
		STORE 0 TO vNumeroRetorno

		STORE "" TO vRutCliente, vDigitoVerificador
		
		IF !This.pRutEmpresa() THEN
			RETURN
		ENDIF

		DO WHILE .t.		
			vNumeroRetorno=This.PideFolio(aCorrelativo(3), vRutCliente, vDigitoVerificador)			
			IF vNumeroRetorno<=0 THEN
				vNumeroRetorno=0
				UNLOCK ALL
				EXIT
			ELSE
				vCadenaArmada=PADL(ALLTRIM(STR(vNumeroRetorno)),9,"0")

				IF SEEK(vgTipoDoc+vCadenaArmada, "CLIDOCTO",1) THEN
					IF MESSAGEBOX("El Numero "+vCadenaArmada+", Existe, Solicitar otro? ",1+32+128, "Mensaje del Sistema")!=1 THEN
						vNumeroRetorno=0
					 	EXIT
					 ELSE
					 	LOOP
					 ENDIF
				ELSE
					EXIT
				ENDIF
			ENDIF
		ENDDO
		aCorrelativo(1)=vNumeroRetorno
		
		RETURN vNumeroRetorno
		**** Fin Proceso de llamada a WebService para Solicitud de Numeracion
	ELSE
		GO TOP IN Correlat
		vCampoCorrelativo="Correlat."+ALLTRIM(TipoDoc.CampCorr)
		vNumeroRetorno=&vCampoCorrelativo

		vNumeroRetorno=PADL(ALLTRIM(STR(VAL(vNumeroRetorno))),9, "0")
		vNumeroEncontrado=.f.
		DO WHILE VAL(vNumeroRetorno)<999999999
			IF !SEEK(vgTipoDoc+vNumeroRetorno, "CLIDOCTO",1) THEN
				vNumeroEncontrado=.t.
				EXIT
			ELSE
				vNumeroRetorno=PADL(ALLTRIM(STR(VAL(vNumeroRetorno)+1)),9,"0")
				LOOP
			ENDIF
		ENDDO 	
		IF !vNumeroEncontrado THEN
			RETURN "-1"
		ELSE
			aCorrelativo(1)=VAL(vNumeroRetorno)
			RETURN VAL(vNumeroRetorno)
		ENDIF
	ENDIF
ENDIF


ENDPROC
PROCEDURE pselsignumc
LPARAMETERS vpModoDocumento, vpNumeroAsignado, vpRutCompletoProveedor

LOCAL vContadorReintentos, vNumeroRetorno, vCampoCorrelativo

vNumeroRetorno=""

GO TOP IN Empres

IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
	=MESSAGEBOX("Datos de la Empresa Incompletos")
	RETURN .f.
ENDIF

IF EMPTY(ALLTRIM(Empres.Dv)) THEN
	=MESSAGEBOX("Datos de la Empresa Incompletos")
	RETURN .f.
ENDIF

IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	IF vpModoDocumento=2 THEN
		IF TipoDoc.bndElec THEN
			PUBLIC vRutProveedor, vDigitoVerificador
			STORE "" TO vRutProveedor, vDigitoVerificador

			PUBLIC vRutCliente
			STORE "" TO vRutCliente
			
*!*				IF !This.pRutEmpresa() THEN
*!*					RETURN .f.
*!*				ENDIF
*!*				vRutProveedor=vRutCliente
*!*				vRutCompletoProveedor=PADL(ALLTRIM(vRutProveedor)+"-"+vDigitoVerificador,12, " ")
			
			DO WHILE .t.		
*				vNumeroRetorno=This.PideFolio(ALLTRIM(TipoDoc.id_SNII), vRutProveedor, vDigitoVerificador)
				vNumeroRetorno=This.PideFolio(ALLTRIM(TipoDoc.id_SNII), Empres.Rut, Empres.Dv)
								
				IF VARTYPE(vNumeroRetorno)="C" THEN
					IF VAL(vNumeroRetorno)<=0 THEN
						UNLOCK ALL
						RETURN .f.
					ENDIF
					vNumeroRetorno=ALLTRIM(STR(VAL(vNumeroRetorno)))
				ELSE
					IF vNumeroRetorno<=0 THEN
						UNLOCK ALL
						RETURN .f.
					ELSE
						vNumeroRetorno=ALLTRIM(STR(vNumeroRetorno))
					ENDIF
				ENDIF
				IF SEEK(Empres.Emprut+vgTipoDoc+vNumeroRetorno, "PRODOCTO",8) THEN
					IF MESSAGEBOX("El Numero Existe, Solicitar otro? ",1+32+128, "Mensaje del Sistema")!=1 THEN
					 	vNumeroRetorno="-1"
					 	EXIT
					 ENDIF
				ELSE
					EXIT
				ENDIF
			ENDDO
			
			aCorrelativo(1)=vNumeroRetorno
			aCorrelativo(3)=TipoDoc.Id_SNII
		ELSE
			IF SEEK(Empres.EmpRut+vgTipoDoc+vpNumeroAsignado, "PRODOCTO",8) THEN 				
				IF MESSAGEBOX("El Numero Asignado ya existe, debe asignar otro") THEN
					RETURN .f.
				ENDIF
			ENDIF
			aCorrelativo(1)=vpNumeroAsignado			
			aCorrelativo(3)=TipoDoc.Id_SNII
		ENDIF
	ELSE
		IF SEEK(Empres.EmpRut+vgTipoDoc+vpNumeroAsignado, "PRODOCTO",8) THEN 				
			IF MESSAGEBOX("El Numero Asignado ya existe, debe asignar otro") THEN
				RETURN .f.
			ENDIF
		ENDIF
	
		aCorrelativo(1)=vpNumeroAsignado
		aCorrelativo(3)=TipoDoc.Id_SNII
	ENDIF 					
ELSE
	=MESSAGEBOX("Tipo de Documento no existe")
	RETURN .f.
ENDIF

vNumeroRetorno=""
	
GO TOP IN Correlat
vCampoCorrelativo="Correlat."+ALLTRIM(TipoDoc.CampCorr)
vNumeroRetorno=&vCampoCorrelativo

vNumeroRetorno=PADL(ALLTRIM(STR(VAL(vNumeroRetorno))),9, "0")
LOCAL vContadorReintentos

vContadorReintentos=0
DO WHILE VAL(vNumeroRetorno)<999999999 .and. vContadorReintentos<1500
	IF !SEEK(vgTipoDoc+vNumeroRetorno, "PRODOCTO",1) THEN
		EXIT
	ELSE
		vContadorReintentos=vContadorReintentos+1	
		vNumeroRetorno=PADL(ALLTRIM(STR(VAL(vNumeroRetorno)+1)),9,"0")
		LOOP
	ENDIF
ENDDO 	

aCorrelativo(2)=vNumeroRetorno

RETURN .t.
ENDPROC
PROCEDURE pselsignumc_neo
LPARAMETERS vpTipoDocumento

LOCAL vContadorReintentos, vNumeroRetorno, vCampoCorrelativo

vNumeroRetorno=""

GO TOP IN Empres

IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
	=MESSAGEBOX("Datos de la Empresa Incompletos")
	RETURN .f.
ENDIF

IF EMPTY(ALLTRIM(Empres.Dv)) THEN
	=MESSAGEBOX("Datos de la Empresa Incompletos")
	RETURN .f.
ENDIF

IF SEEK(vpTipoDocumento, "TIPODOC",1) THEN 			
	DO WHILE .t.		
		vPedidoFolio=This.PideFolioC(ALLTRIM(TipoDoc.id_SNII), ALLTRIM(Empres.Rut), ALLTRIM(Empres.Dv))
		
		IF STREXTRACT(vPedidoFolio, "<Resultado>", "</Resultado>")="true" THEN
			vNumeroRetorno=PADR(STREXTRACT(vPedidoFolio, "<Numero>", "</Numero>"),15," ")
		ELSE
			RETURN .f.
		ENDIF
		
		IF SEEK(Empres.Emprut+vpTipoDocumento+vNumeroRetorno, "PRODOCTO",9) THEN
			IF MESSAGEBOX("El Numero Existe, Solicitar otro? ",1+32+128, "Mensaje del Sistema")!=1 THEN
			 	vNumeroRetorno=-1
			 	EXIT
			 ELSE
			 	LOOP
			 ENDIF
		ELSE
			EXIT
		ENDIF
	ENDDO

	IF VAL(vNumeroRetorno)>0 THEN 			
		RETURN vNumeroRetorno
	ELSE
		RETURN .f.
	ENDIF
ELSE
	RETURN .f.
ENDIF
ENDPROC
PROCEDURE psumacabecera
LPARAMETERS VPTASAIVA, VPSINSUMA, VPRETIVA, VPRETIAD, VPTIPODSCRECCAB, P_VAL1, P_VAL2, P_VAL3, P_VAL4, P_VAL5, P_IMPADI, P_IMPESP

P_VAL1 = IIF(EMPTY(P_VAL1),0,P_VAL1)
P_VAL2 = IIF(EMPTY(P_VAL2),0,P_VAL2)
P_VAL3 = IIF(EMPTY(P_VAL3),0,P_VAL3)
P_VAL4 = IIF(EMPTY(P_VAL4),0,P_VAL4)
P_VAL5 = IIF(EMPTY(P_VAL5),0,P_VAL5)
P_IMPADI = IIF(EMPTY(P_IMPADI),0,P_IMPADI)
P_IMPESP = IIF(EMPTY(P_IMPESP),0,P_IMPESP)

LOCAL VSUMADSCTOS, VSUMARECARGO, ;
	VSUMAAFECTO, VSUMAADICIONALES, VSUMATOTAL, VSUBTOTAL, VSUMAIVA,;
	VSUMAEXENTO, VSUMAADIC, ;
	VSUMARECCAB, VSUMADSCCAB, ;
	VSUMARECCABEXENTO, VSUMADSCCABEXENTO, VSUMAACTFIJ

FOR VI=1 TO ALEN(ASUMATOTALES,1)
	ASUMATOTALES(VI)=0
ENDFOR

STORE 0 TO 	VSUMADSCTOS, VSUMARECARGO, ;
	VSUMAAFECTO, VSUMAADICIONALES, VSUMATOTAL, VSUBTOTAL, VSUMAIVA,;
	VSUMAEXENTO, VSUMAADIC, ;
	VSUMARECCAB, VSUMADSCCAB, ;
	VSUMARECCABEXENTO, VSUMADSCCABEXENTO, VSUMAACTFIJ

SELECT ITEMCUR
SUM SUBTOT, AFECTO TO VSUBTOTAL, VSUMAAFECTO FOR !DELETED("ITEMCUR") .AND. ITEMCUR.EXENTO=0

DIMENSION ARRCAMPOSACT(1)
=AFIELDS(ARRCAMPOSACT,'ITEMCUR')
VSUMAACTFIJ = 0.00
FOR I=1 TO ALEN(ARRCAMPOSACT,1)
	IF ARRCAMPOSACT(I,1) == 'ACTFIJO'
		SUM AFECTO TO VSUMAACTFIJ FOR !DELETED("ITEMCUR") AND !EMPTY(ITEMCUR.ACTFIJO)
	ELSE
	ENDIF
ENDFOR

GO TOP IN DSCCUR
DO WHILE !EOF("DSCCUR")
	IF DELETED("DSCCUR") THEN
		SKIP IN DSCCUR
		LOOP
	ENDIF

	DO CASE CUR
	CASE INLIST(DSCCUR.TIPDSC,1,2,3)
		IF SEEK(DSCCUR.LINEA, "ITEMCUR",1) THEN
			IF ITEMCUR.EXENTO=0 THEN
				VSUMADSCTOS=VSUMADSCTOS+DSCCUR.MONDSC
			ENDIF
		ENDIF
	CASE INLIST(DSCCUR.TIPDSC,7,12)
		IF VPTIPODSCRECCAB THEN
			VSUMADSCCABEXENTO=VSUMADSCCABEXENTO+DSCCUR.MONDSC
		ELSE
			VSUMADSCTOS=VSUMADSCTOS+DSCCUR.MONDSC
			VSUMADSCCAB=VSUMADSCCAB+DSCCUR.MONDSC
		ENDIF
	CASE INLIST(DSCCUR.TIPDSC,4,5)
		IF SEEK(DSCCUR.LINEA, "ITEMCUR",1) THEN
			IF ITEMCUR.EXENTO=0 THEN
				VSUMARECARGO=VSUMARECARGO+DSCCUR.MONDSC
			ENDIF
		ENDIF
*!*		CASE INLIST(DSCCUR.TIPDSC,5,9)
*!*			VSUMAADICIONALES=VSUMAADICIONALES+DSCCUR.MONDSC
	CASE INLIST(DSCCUR.TIPDSC,6,11)
		VSUMAIVA=VSUMAIVA+DSCCUR.MONDSC
	CASE DSCCUR.TIPDSC=8
		VSUMAEXENTO=VSUMAEXENTO+DSCCUR.MONDSC
*!*		CASE DSCCUR.TIPDSC=9
*!*			VSUMAADIC=VSUMAADIC+DSCCUR.MONDSC
	CASE INLIST(DSCCUR.TIPDSC,10,13)
		IF VPTIPODSCRECCAB THEN
			VSUMARECCABEXENTO=VSUMARECCABEXENTO+DSCCUR.MONDSC
		ELSE
			VSUMARECARGO=VSUMARECARGO+DSCCUR.MONDSC
			VSUMARECCAB=VSUMARECCAB+DSCCUR.MONDSC
		ENDIF
	ENDCASE

	SKIP IN DSCCUR
ENDDO

VBNDCOMPRA=(ALEN(ASUMATOTALES,1)=13)

VSUMADSCTOS		=THIS.MREDONDEO(VSUMADSCTOS)
ASUMATOTALES(9)	=THIS.MREDONDEO(VSUMADSCCAB)											&&& Suma Descuentos Cabecera
VSUMARECARGO	=THIS.MREDONDEO(VSUMARECARGO)
ASUMATOTALES(10)=THIS.MREDONDEO(VSUMARECCAB)

IF VBNDCOMPRA THEN
	ASUMATOTALES(11)=THIS.MREDONDEO(VSUMARECCABEXENTO)										&&& Suma Recargos Cabecera Exentos
	ASUMATOTALES(12)=THIS.MREDONDEO(VSUMADSCCABEXENTO)										&&& Suma Descuentos Cabecera Exentos
	ASUMATOTALES(13)=VSUMAEXENTO-ASUMATOTALES(12)+ASUMATOTALES(11)
ENDIF

IF VPSINSUMA THEN
	ASUMATOTALES(1)=ADOCUMENTOREF(1,38)												&&& Montos Netos Originales
	ASUMATOTALES(2)=ADOCUMENTOREF(1,39)												&&& Suma de los Cargos al NETO
	ASUMATOTALES(3)=ADOCUMENTOREF(1,37)												&&& Suma de Descuentos al NETO
	ASUMATOTALES(4)=ADOCUMENTOREF(1,35)												&&& Suma de los Montos de Items Exento
	ASUMATOTALES(5)=ADOCUMENTOREF(1,5)												&&& Monto Afecto
	ASUMATOTALES(6)=ADOCUMENTOREF(1,40)												&&& Suma de Impuestos Adicionales
	ASUMATOTALES(7)=ADOCUMENTOREF(1,6)												&&& Monto de IVA generado
	ASUMATOTALES(8)=ADOCUMENTOREF(1,36)												&&& Total del Documento

*!*		IF vbndCompra THEN
*!*			aSumaTotales(11)=This.mRedondeo(vSumaDSCCabExento)						&&& Suma Descuentos Cabecera Exentos
*!*			aSumaTotales(12)=This.mRedondeo(vSumaRecCabExento)						&&& Suma Recargos Cabecera Exentos
*!*		ENDIF
ELSE
	ASUMATOTALES(1)=VSUBTOTAL+P_VAL1												&&& Montos Netos Originales
	ASUMATOTALES(2)=VSUMARECARGO+P_VAL2												&&& Suma de los Cargos al NETO
	ASUMATOTALES(3)=VSUMADSCTOS+P_VAL3												&&& Suma de Descuentos al NETO
	ASUMATOTALES(4)=VSUMAEXENTO														&&& Suma de los Montos de Items Exento
	*ASUMATOTALES(5)=THIS.MREDONDEO(VSUBTOTAL+VSUMARECARGO-VSUMADSCTOS)				&&& Calculo de Monto Afecto
	ASUMATOTALES(5)=THIS.MREDONDEO(ASUMATOTALES(1)+ASUMATOTALES(2)-ASUMATOTALES(3))	&&& Calculo de Monto Afecto


*!*		ASUMATOTALES(6)=VSUMAADIC													&&& Suma de Impuestos Adicionales
	ASUMATOTALES(6)=VSUMAADICIONALES+P_IMPADI										&&& Suma de Impuestos Adicionales
	ASUMATOTALES(14)=P_IMPESP
	ASUMATOTALES(15)=ASUMATOTALES(5)+ASUMATOTALES(13)
	ASUMATOTALES(16)=VSUMAACTFIJ

	IF VPTASAIVA!=0 THEN
		ASUMATOTALES(7)=THIS.MREDONDEO(ASUMATOTALES(5)*(VPTASAIVA/100))+P_VAL4		&&& Monto de IVA generado
	ELSE
		ASUMATOTALES(7)=0
	ENDIF

	IF !VPRETIVA
		ASUMATOTALES(8)=(VSUMAEXENTO+VSUMARECCABEXENTO-VSUMADSCCABEXENTO)+ASUMATOTALES(5)+ASUMATOTALES(6)+ASUMATOTALES(7)+P_VAL5+ASUMATOTALES(14)	&&& Total del Documento
	ELSE
		ASUMATOTALES(8)=(VSUMAEXENTO+VSUMARECCABEXENTO-VSUMADSCCABEXENTO)+ASUMATOTALES(5)+ASUMATOTALES(6)+P_VAL5+ASUMATOTALES(14)	&&& Total del Documento
	ENDIF
ENDIF




ENDPROC
PROCEDURE pvalidarut
PARAMETERS TCNUMERO
*!*	LPARAMETERS vCadenaRut
*!*	vCadenaRut=CHRTRAN(vCadenaRut,",.","")
TCNUMERO = ALLTRIM(CHRTRAN(CHRTRAN(TCNUMERO,".",""),",",""))
TCNUMEROAUX = SUBSTR(TCNUMERO,1,AT('-',TCNUMERO)-1)

*!*	vCadenaPrimaria=""
*!*	vFinCadenaPrimaria=.f.
*!*	vAcumulaMonto=0
*!*	vFactor=1
*!*	vDigitoVerificador=""

*!*	FOR vI=1 TO LEN(vCadenaRut)
*!*		vCaracter=SUBSTR(vCadenaRut,vI,1)
*!*		IF vCaracter!="-" THEN
*!*			IF !vFinCadenaPrimaria THEN
*!*				vCadenaPrimaria=vCadenaPrimaria+vCaracter
*!*			ELSE
*!*				vDigitoVerificador=SUBSTR(vCadenaRut,vI,1)
*!*			ENDIF
*!*		ELSE
*!*			vFinCadenaPrimaria=.t.
*!*		ENDIF
*!*	ENDFOR

*!*	IF EMPTY(ALLTRIM(vDigitoVerificador)) THEN
*!*		RETURN .f.
*!*	ENDIF

*!*	FOR vString=LEN(vCadenaPrimaria) TO 1 STEP -1
*!*		vCaracter=SUBSTR(vCadenaPrimaria,vString,1)
*!*
*!*		IF vFactor=7 THEN
*!*			vFactor=2
*!*		ELSE
*!*			vFactor=vFactor+1
*!*		ENDIF
*!*		vAcumulaMonto=vAcumulaMonto+(VAL(vCaracter)*vFactor)
*!*	ENDFOR

*!*	vResultado=11-MOD(vAcumulaMonto,11)

*!*	DO CASE
*!*		CASE vResultado<10
*!*			IF vResultado!=VAL(vDigitoVerificador) THEN
*!*				RETURN .f.
*!*			ELSE
*!*				RETURN .t.
*!*			ENDIF
*!*		CASE vResultado=11
*!*			IF 	VAL(vDigitoVerificador)!=0 THEN
*!*				RETURN .f.
*!*			ELSE
*!*				RETURN .t.
*!*			ENDIF
*!*		CASE vResultado=10
*!*			IF vDigitoVerificador!="K" THEN
*!*				RETURN .f.
*!*			ELSE
*!*				RETURN .t.
*!*			ENDIF
*!*	ENDCASE

TNBASEMAX = 7

LOCAL LCNUMEROAL, I, LCCARACTER, K, LNTOTAL, LNNUMEROAUX, LNRESTO, LNDIGITO

LCNUMEROAL = ""
SEGUIR = .T.
FOR I = 1 TO LEN(TCNUMEROAUX)
	LCCARACTER = UPPER(SUBSTR(TCNUMEROAUX, I, 1))

	IF !BETWEEN(ASC(LCCARACTER), 48, 57) THEN   && de 0 a 9
		*!*	         lcNumeroAl = lcNumeroAl + ALLTRIM(STR(ASC(lcCaracter)))
		SEGUIR = .F.
		EXIT
	ELSE
		LCNUMEROAL = LCNUMEROAL + LCCARACTER
	ENDIF
ENDFOR

IF !EMPTY(SEGUIR)
	K = 2
	LNTOTAL = 0

	FOR I = LEN(LCNUMEROAL) TO 1 STEP -1
		IF K > TNBASEMAX THEN
			K = 2
		ENDIF

		LNNUMEROAUX = VAL(SUBSTR(LCNUMEROAL, I, 1))
		LNTOTAL = LNTOTAL + (LNNUMEROAUX * K)
		K = K + 1
	ENDFOR

	LNRESTO = MOD(LNTOTAL, 11)

	*!*	   IF lnResto > 1 THEN
	*!*	      lnDigito = 11 - lnResto
	*!*	   ELSE
	*!*	      lnDigito = 0
	*!*	   ENDIF
	LNDIGITO = 11 - LNRESTO

	DO CASE
		CASE LNDIGITO = 10
			LNDIGITO = 'K'
		CASE LNDIGITO = 11
			LNDIGITO = '0'
		OTHERWISE
			LNDIGITO = ALLTRIM(STR(LNDIGITO))
	ENDCASE


	LNDIGITO = TCNUMEROAUX + '-'+ LNDIGITO
	IF ALLTRIM(LNDIGITO) <> ALLTRIM(TCNUMERO)
		RETURN .F.
	ELSE
		RETURN .T.
	ENDIF
ELSE
	LNDIGITO = '-1'
	RETURN .F.
ENDIF


ENDPROC
PROCEDURE pverificaestructurasenviodte
LPARAMETERS vpTipoEstructura, vpDevParcial

*!*	TipoEstructura, Esta variable puede contener dos valores:
*!*		0=Cuando la Validacion se hace para una estructura de Tipo Administrativo
*!*		1=Cuando la validacion se hace para una Estructura de Facturacion, devolucion o Anulacion.

CALCULATE CNT() FOR !DELETED("ITEMCUR") IN ItemCur TO vNumeroRegistrosValidos

CALCULATE CNT() FOR !DELETED("ITEMCUR") .and. (ItemCur.Cantidad+ItemCur.Fraccion)>0 .and. ItemCur.indexe=0 IN ItemCur TO vRegCantidades

CALCULATE CNT() FOR !DELETED("DSCCUR") IN DscCur TO vNumeroDscValidos

IF vNumeroRegistrosValidos=0 THEN
	UNLOCK ALL
	=MESSAGEBOX("No existen Registros Validos en el Area de Detalle")
	RETURN .f.
ENDIF

IF vpTipoEstructura=0 THEN
	IF vNumeroDscValidos>0 THEN
		UNLOCK ALL
		=MESSAGEBOX("No deberian Existir Registros de Descuentos o Recargos para Este Tipo de Documentos")
		RETURN .f.
	ENDIF
	
	vErroresEstructura=0
	
	GO TOP IN ItemCur
	DO WHILE !EOF("ITEMCUR")
		IF (ItemCur.Cantidad+ItemCur.Fraccion)>0 THEN 	
			=MESSAGEBOX("Existen Cantidades o Fracciones Declaradas, Este Tipo de Documento no debe tener Valores en esta Area")
			vErroresEstructura=vErroresEstructura+1
		ENDIF
		
		IF (ItemCur.Precio+ItemCur.SubTot+ItemCur.Afecto+ItemCur.Exento+ItemCur.NetoDetalle)>0 THEN
			=MESSAGEBOX("Existen Valores en Precio o Subtotales, Este tipo de Documento no debe tener Valores en estos Campos")
			vErroresEstructura=vErroresEstructura+1		
		ENDIF
				
		SKIP IN ItemCur
	ENDDO 	
	
	IF vErroresEstructura>0 THEN
		UNLOCK ALL
		=MESSAGEBOX("Existen Errores de Estructura Graves que no permitiran la grabacion de el Documento")
		RETURN .f.
	ENDIF
ELSE

*!*	CREATE CURSOR ItemCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
*!*						   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
*!*						   Detalle c(50), UniMed c(4), CodIla c(2), noApliDes c(1), Exento n(15),;
*!*						   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15))
*!*	INDEX on Linea TAG Linea
*!*	INDEX on Codigo TAG Codigo

*!*	CREATE CURSOR DscCur (Linea n(4), TipDsc n(1), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
*!*						  Fecha d(8), ModDsc n(1))
*!*	INDEX on CodPro TAG CodPro
*!*	INDEX on Linea TAG Linea
*!*	INDEX on STR(Linea,4)+STR(TipDsc,1) TAG TipDsc
	IF USED("ERRORDTECUR") THEN
		USE IN ErrorDTECur
	ENDIF
	
	CREATE CURSOR ErrorDTECur (NroLin n(4), Codigo c(15), Detalle c(50), Error c(50))
	
	vErroresEstructura=0

	
	IF vRegCantidades=0 THEN
		vErroresEstructura=vErroresEstructura+1
		INSERT INTO ErrorDTECur VALUES (0, "", "", "No existen Cantidades Definidas en las Lineas")		
	ELSE
		GO TOP IN ItemCur
		DO WHILE !EOF("ITEMCUR")
			IF ItemCur.indExe=2 THEN
				SKIP IN ItemCur
				LOOP
			ENDIF
			
			IF vpDevParcial THEN 				
				IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
					SKIP IN ItemCur
					LOOP
				ENDIF
			ELSE
				IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
					vErroresEstructura=vErroresEstructura+1
					INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "Cantidades+Fracciones suman 0")
				ENDIF
			ENDIF
			
			IF ItemCur.Linea=0 THEN
				vErroresEstructura=vErroresEstructura+1
				INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "Indicador de Linea es 0")
			ENDIF 			
			
			IF EMPTY(ALLTRIM(ItemCur.Detalle)) THEN
				vErroresEstructura=vErroresEstructura+1
				INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "Detalle de Linea esta vacio")
			ENDIF

			IF vgTipoDoc!="GE" THEN
				IF ItemCur.Precio=0 THEN
					vErroresEstructura=vErroresEstructura+1
					INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "Precio de Producto es 0")
				ENDIF
							
				IF (ItemCur.SubTot+ItemCur.Afecto+ItemCur.Exento)<=0 THEN
					vErroresEstructura=vErroresEstructura+1
					INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "Subtotales estan en 0")
				ENDIF
			ENDIF
						
			IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
				IF EMPTY(ALLTRIM(ItemCur.Bodega)) THEN
					vErroresEstructura=vErroresEstructura+1
					INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "No existen Bodega Definida")
				ENDIF
					
				IF ItemCur.Envase<=0 THEN
					vErroresEstructura=vErroresEstructura+1
					INSERT INTO ErrorDTECur VALUES (ItemCur.Linea, ItemCur.Codigo, ItemCur.Detalle, "No existen Unidades x Envase Definidas")
				ENDIF
			ENDIF
			
			SKIP IN ItemCur
		ENDDO
	ENDIF 	
	IF vErroresEstructura>0 THEN
		UNLOCK ALL
		=MESSAGEBOX("Existen Errores de Estructura que no permitiran la generacion del DTE")
*		SELECT ErrorDTECur
*		BROWSE
		
		USE IN ErrorDTECur
		RETURN .f.
	ENDIF
ENDIF
		

		
		
		
		
		
		
ENDPROC
PROCEDURE pverificasaldosreales
LPARAMETERS vpTipoPed, vpNumeroPed

vComentario=""
vProsigue=0

IF USED("ERRORSALDOSREALES") THEN
	USE IN ErrorSaldosReales
ENDIF

CREATE CURSOR ErrorSaldosReales (Tipo c(2), Numero c(9), Producto c(80), Cantidad n(10), Fraccion n(5),;
								 CanRea n(10), FraRea n(5), Motivo c(100))
GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
	
	IF (ItemCur.Cantidad+ItemCur.Fraccion)=0 THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
	
	IF SEEK(ItemCur.Bodega+ItemCur.Codigo, "tSALDOS",1) THEN
		vCantidadPedida		=(ItemCur.Cantidad*ItemCur.Envase)+ItemCur.Fraccion
		vCantidadExistente	=(tSaldos.SaldoFin*ItemCur.Envase)+tSaldos.SalFraFin
		
		IF vCantidadExistente>=vCantidadPedida THEN
			SKIP IN ItemCur
			LOOP
		ELSE
			vComentario="  SALDO INSUFICIENTE  "
			vProsigue=1
			EXIT
		ENDIF
	ELSE
		vComentario=" Producto no encontrado en Maestro de Saldos"
		&&&&& Si no existe el Producto en el Maestro de Saldos entonces tambien se toma como Falla de Saldo
		vProsigue=2
		EXIT
	ENDIF 		

	IF vProsigue!=0 then
		vComentario=UPPER(ALLTRIM(vComentario))
		DO CASE
			CASE vProsigue=1
				INSERT INTO ErrorSaldosReales VALUES (vpTipoPed, vpNumeroPed, ItemCur.Codigo+ItemCur.Detalle,;
													  ItemCur.Cantidad, ItemCur.Fraccion,;
													  tSaldos.SaldoFin, tSaldos.SalFraFin, vComentario)
			CASE vProsigue=2
				INSERT INTO ErrorSaldosReales VALUES (vpTipoPed, vpNumeroPed, ItemCur.Codigo+ItemCur.Detalle,;
													  ItemCur.Cantidad, ItemCur.Fraccion,;
													  0, 0, vComentario)
		ENDCASE
	ENDIF
			
	SKIP IN ItemCur
ENDDO

IF RECCOUNT("ERRORSALDOSREALES")>0 THEN
	DO FORM wMuestraSinStockReal WITH vpTipoPed, vpNumeroPed, vpCodigoVendedor
	Replace EdoNVE WITH .f. IN tPedido
	Thisform.Facturador.pDevuelveSaldosTemporales()
	
	RETURN .f.
ELSE
	RETURN .t.
ENDIF

ENDPROC
PROCEDURE pverificavalidezdocsii
LPARAMETERS vpLlave

GO TOP IN prPrm
IF prPrm.Modalidad=0 THEN
	RETURN .t.
ENDIF

IF !USED("CLIDOCTO") .or. !USED("EMPRES") THEN
	=MESSAGEBOX("Faltan Tablas en uso para verificar el Doc. Requerido")
	RETURN .f.
ENDIF
IF SEEK(vpLlave,"CLIDOCTO",1) THEN
	IF Thisform.Facturador1.mActivaTablas(.f., CliDocto.FecFac,.t.) THEN
		IF !SEEK(vpLlave, "tACTUAL",1) THEN
			=MESSAGEBOX("No existe el Documento en el Encabezado de Ventas")
			RETURN .f.
		ENDIF
	ELSE
		=MESSAGEBOX("No existe el Periodo especifico del Documento")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existe El Documento en el Historico de Ventas")
	RETURN .f.
ENDIF 	

GO TOP IN Empres
IF EOF("EMPRES") THEN
	=MESSAGEBOX("No existen Datos en Datos Empresa")
	RETURN .f.
ENDIF

	
vDireccionMovimiento=.f.

WAIT WINDOW "Verificando Validez en SII...." NOWAIT

vRutOriginal=ALLTRIM(Empres.EmpRut)
vRutDocEnv=""
vDigitoDocEnv=""
vDigitoExtraido=""
vBndExtraccion=.f.

FOR vI=1 TO LEN(vRutOriginal)
	vDigitoExtraido=SUBSTR(vRutOriginal, vI,1)
	
	IF vDigitoExtraido="-" THEN
		vBndExtraccion=!vBndExtraccion
		LOOP
	ENDIF
	
	IF vBndExtraccion THEN
		vDigitoDocEnv=vDigitoDocEnv+vDigitoExtraido	
	ELSE
		vRutDocEnv=vRutDocEnv+vDigitoExtraido
	ENDIF
ENDFOR

TEXT TO vVarXML NOSHOW TEXTMERGE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl">
   <soapenv:Header/>
   <soapenv:Body>
      <lsof:GetEstadoOnSIIDTE>
         <lsof:idDTE><<ALLTRIM(STR(tActual.FolioInt))>></lsof:idDTE>
         <lsof:origen>Emitido</lsof:origen>
         <lsof:rutEmisorLOCAL><<vRutDocEnv>></lsof:rutEmisorLOCAL>
         <lsof:dvEmisorLOCAL><<vDigitoDocEnv>></lsof:dvEmisorLOCAL>
      </lsof:GetEstadoOnSIIDTE>
   </soapenv:Body>
</soapenv:Envelope>
ENDTEXT

vRespuestaWebService=0
bRespuesta=Thisform.Facturador1.pEnviaDTE(vVarXML)

USE IN tActual

WAIT CLEAR

IF vRespuestaWebService<0 THEN
	UNLOCK ALL
	=MESSAGEBOX("Error Consultadno Validez de Documento")
	RETURN .f.
ENDIF

bRespuesta=STRTRAN(bRespuesta,"&lt;","<")
bRespuesta=STRTRAN(bRespuesta, "&gt;",">")

vRespuestaDocRec=STREXTRACT(bRespuesta, "<Estado>", "</Estado>")

IF EMPTY(ALLTRIM(vRespuestaDocRec)) THEN
	=MESSAGEBOX("No existe recepcion del estado del Doc. en SII")
	RETURN .f.
ENDIF

IF !INLIST(STREXTRACT(bRespuesta, "<Estado>", "</Estado>"), "TMD", "TMC", "MMD", "MMC", "DOK", "DNK") THEN
	=MESSAGEBOX("El Documento no ha sido aceptado en el SII, no puede generarse ningun documento de Afecto")
	RETURN .f.
ENDIF

RETURN .t.
ENDPROC
PROCEDURE rutina1
LPARAMETERS vpCodigo, vpFecha, vpCantidad, vpFraccion, vpDscto, vpPrecio, ;
			vpCliente, vpSucursal, vpTipo, vpListaPrecios, vpLinea, vpDsctoCab, vpDsctoMonCab, vpDetalle,;
			vpBodega, vpBodegaIN, vpTipoGuia, vpTipoDsctoCabecera


SET ENGINEBEHAVIOR 70
IF !USED("ITEMCUR") .and. !USED("DSCCUR") THEN
	RETURN "No se encuentran Los Cursores Auxiliares en uso"
ENDIF

vPrecioOriginal=vpPrecio

IF vpLinea=0 THEN
	CALCULATE MAX(Linea) TO vMaximaLinea IN ItemCur
	vSiguienteLinea=vMaximaLinea+1
ELSE
	vSiguienteLinea=vpLinea
ENDIF

STORE "" TO vUnidadMedida
STORE 0 TO vUnidadesXenvase
STORE 0 TO vPorcentajeListaEspecial, vPorcentajeRegla
STORE 0 TO vCodigoIla
STORE 0 TO vMontoDscto, vMontoFlete, vMontoExento, ;
		   vMontoAfecto, vPrecioNeto, vPrecioNetoDetalle, ;
		   vMontoDsctoCabecera

STORE .f. TO vProductoExento, vNoApliDes

vDocGuia=.f.
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vDocExento=TipoDoc.Exento	
	vDocGuia=TipoDoc.Traslado
	vProductoExento=vDocExento
ELSE
	RETURN "El Tipo de Documento no es valido"
ENDIF

vProsigueDescuentos=.f.

IF vDocGuia THEN
	IF !vpTipoGuia THEN
		vProsigueDescuentos=.t.
	ENDIF
ELSE
	vProsigueDescuentos=.t.
ENDIF

STORE 0 TO vPrecioEspecialCliente, vPrecioOriginalEspecial

IF !EMPTY(ALLTRIM(vpCodigo)) THEN
	IF !SEEK(vpCodigo, "PRODUCTO", 1) THEN
		RETURN "Error Registrando Linea, Codigo no se encuentra en Maestra de Productos"
	ENDIF

	vUnidadMedida	=Producto.prUnimed
	vCodigoIla		=Producto.TipoIla
	vProductoExento	=(Producto.Exento="E" .or. vDocExento)
	
	IF Producto.UnixEnv<=0 THEN
		vUnidadesXenvase=1
	ELSE
		vUnidadesXenvase=Producto.UnixEnv
	ENDIF

	vPrecioOriginal=vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)) &&&& Cambio para verificar si sirve

	********** Localiza Impuesto Adicionales que se puedan cargar
	vBndIla=.f.
*!*		IF vpTipo!=0 THEN
*!*			IF vgTipoDoc="BO" THEN
*!*				IF prPrm.BolIla THEN
*!*					vBndIla=.t.
*!*				ENDIF
*!*			ELSE
*!*				vBndIla=.t.
*!*			ENDIF
*!*		ENDIF

	IF vBndIla THEN
		IF vProductoIla!=0 THEN
			IF SEEK(vProductoIla,"IMPTOADIC",1) THEN
				IF ImptoAdic.EdoImpto .and. !ImptoAdic.Sistema THEN 	
					vPorcentajeIla=ImptoAdic.Monto
				ENDIF
			ENDIF
		ENDIF
	ENDIF

	IF Producto.TipoFlete>0 THEN
		IF Producto.TipoFlete=1 THEN
			vMontoFlete=This.mRedondeo(vPrecioOriginal*(Producto.Flete2/100))
		ELSE
			vMontoFlete=Producto.Flete
		ENDIF
	ENDIF

	vPrecioNeto=vPrecioOriginal+vMontoFlete
	vNoApliDes=(Producto.noApliDes="S")
			
	IF vNoApliDes THEN
		DELETE FROM DscCur WHERE CodPro=vpCodigo .and. INLIST(DscCur.TipDsc, 1,2,3,7,12)
	ELSE
		IF vProsigueDescuentos THEN

			********* Inicia Busqueda de Descuento x Precio Especial.
			IF !EMPTY(ALLTRIM(vpCliente)) .and. VAL(vpListaPrecios)!=0 THEN 	
				IF SEEK(vpCliente, "CLIENTES",1) THEN
					SELECT NumCon, Descto, fdeIni, fdeFin, valPro ;
						FROM mPrecios ;
						LEFT JOIN mContrat ON mPrecios.NumCon=mContrat.Numero ;
						WHERE mPrecios.RutCli=vpCliente .and. mPrecios.CodPro=vpCodigo .and. ;
							  mPrecios.CodSuc=vpSucursal .and. ;
							  vpFecha>=mPrecios.fdeIni .and. vpFecha<=mPrecios.fdeFin .and. ;
							  mContrat.tiPrec=vpListaPrecios ;
						ORDER BY NumCon ;
						INTO CURSOR cListaEspecial READWRITE

					SELECT cListaEspecial
					INDEX on NumCon TAG Enlace001
						
					vCantidadPreciosEspeciales=_Tally
					
					IF vCantidadPreciosEspeciales>0 THEN
						IF vCantidadPreciosEspeciales>1 THEN
							RETURN "Existen mas de un Precio Especial que afecta al Producto"
						ENDIF

						GO TOP IN cListaEspecial
						vPorcentajeListaEspecial=cListaEspecial.Descto
						vPrecioEspecialCliente=cListaEspecial.ValPro
					ENDIF
					
					************** Verificacion de Dscto x Reglas Comerciales					
					IF Clientes.afRegla THEN
						IF Producto.afRegla THEN
							vUnixEnv=Producto.UnixEnv
							SELECT R02CodReg as IDRegla, R02FecIni as FecIni, R02FecFin as FecFin,;
								   R01PorDes as Descuento ;
								FROM Reglas02 ;
								LEFT JOIN Reglas01 ON Reglas01.R01CodReg=Reglas02.r02CodReg ;
								WHERE BETWEEN(vpFecha,Reglas02.R02FecIni,Reglas02.R02FecFin) .and. ;
									  Reglas02.R02CodPro=vpCodigo .and. ;
									  ((vpCantidad*vUnixEnv)+vpFraccion)>=((Reglas01.R01CanPro*vUnixEnv)+Reglas01.R01CanFra) ;
								ORDER BY R02CodReg ;
								INTO CURSOR cPorcentajeRegla
									
							IF _Tally>0 THEN
								GO BOTTOM in cPorcentajeRegla
								vPorcentajeRegla=cPorcentajeRegla.Descuento
							ENDIF
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ELSE
	vUnidadMedida	="UN"
	vUnidadesXenvase=1
	vCodigoIla		=0
	vPrecioNeto		=vpPrecio*vpCantidad
	vPrecioOriginal	=vpPrecio*vpCantidad
	vPrecioNetoDetalle=vPrecioNeto
	vPrecioEspecialCliente=0
ENDIF

IF vProsigueDescuentos THEN
	IF vPorcentajeListaEspecial>0 .and. !vNoApliDes THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (vSiguienteLinea, 1, vPorcentajeListaEspecial, ;
							This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100)), ;
							vpCodigo, vpFecha, 1)

		vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100))
	ENDIF

	IF vPorcentajeRegla>0 .and. !vNoApliDes THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (vSiguienteLinea, 2, vPorcentajeRegla, ;
							This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100)), ;
							vpCodigo, vpFecha,1)

		vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100))
	ENDIF

	IF vpDscto>0 .and. !vNoApliDes THEN
		IF !SEEK(STR(vSiguienteLinea,4)+"3","DSCCUR",3) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vSiguienteLinea, 3, vpDscto, ;
								This.mRedondeo(vPrecioNeto*(vpDscto/100)), ;
								vpCodigo, vpFecha,1)
		ENDIF
		vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vpDscto/100))
	ENDIF
ELSE
	vPrecioNetoFinal=vPrecioNeto
ENDIF

STORE vPrecioNeto-This.mRedondeo(vMontoDscto) TO vPrecioNetoFinal, vPrecioNetoDetalle

vMontoAfecto=IIF(!vProductoExento, vPrecioNetoFinal,0)
vMontoExento=IIF(vProductoExento, vPrecioNetoFinal,0)

INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
					 Subtot, Afecto, Detalle, Unimed, Exento, Bodega, ;
					 BodegaIN, noApliDes, Envase, NetoDetalle) ;
			VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioNeto, ;
					 vSiguienteLinea, vpPrecio, IIF(vMontoExento=0,vPrecioOriginal,0), ;
					 vMontoAfecto, ALLTRIM(vpDetalle), ;
					 vUnidadMedida, vMontoExento, ;
					 vpBodega, vpBodegaIN, IIF(vNoApliDes,"S","N"), vUnidadesXenvase, vPrecioNetoDetalle)

This.pCalculaDscRecCabV(vpTipoDsctoCabecera, vpDsctoCab, vpDsctoMonCab, 0, 0, ;
					   vDocExento, vpFecha, .f., vgTasaIVA, vNoApliDes)
				
IF vCodigoILA>0 THEN
	IF SEEK(vSiguienteLinea, "ITEMCUR",1) THEN
		IF SEEK(vCodigoILA, "IMPTOADIC",1) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
						VALUES (vSiguienteLinea, 9, ImptoAdic.Monto, ;
								ROUND(ItemCur.Afecto*(ImptoAdic.Monto/100),0), ;
								vpCodigo, vpFecha,2, vCodigoILA)
			Replace ItemCur.CodIla WITH vCodigoILA, ;
					ItemCur.Cod_IAD WITH vCodigoILA IN ItemCur
		ENDIF
	ENDIF
ENDIF 	


RETURN .t.















ENDPROC
PROCEDURE rutina10
SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
		IF !SEEK(ItemCur.Codigo, "PRODUCTO",1) THEN
			=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(ItemCur.Codigo)+")")
			SKIP IN ItemCur
		ENDIF
	ENDIF
		
	STORE 0 TO vMontoDscto, vPorcentajeDscto, vCargosAdicionales, vImpuestoIVA, vTotalDscto
	
	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
			IF DscCur.ModDsc=1 THEN
				IF DscCur.TipDsc!=7 THEN
					vMontoDscto		=vMontoDscto+DscCur.MonDsc
					vPorcentajeDscto=vPorcentajeDscto+DscCur.PorDsc
				ENDIF
				vTotalDscto=vTotalDscto+DscCur.MonDsc
			ENDIF
			
			vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)

			IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
				INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
							VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea,"01")
			ENDIF
			
			SKIP IN DscCur
		ENDDO
	ENDIF
	
	vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.SubTot)
	
	IF INLIST(vgTipoDoc,"NC", "NE","DE", "ND") THEN
		IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
			vTotalLinea=0
		ENDIF
	ENDIF
		
	INSERT INTO VisualCur (StrLinea, Codigo, Detalle, Cantidad, Fraccion, Precio, Dscto, ;
						   MonDscto, Total, Linea, Nivel) ;
				   VALUES (ALLTRIM(STR(ItemCur.Linea)), ItemCur.Codigo, ItemCur.Detalle, ;
						   ItemCur.Cantidad, ItemCur.Fraccion, ItemCur.PrecioOrig, ;
						   vPorcentajeDscto, vMontoDscto, vTotalLinea, ItemCur.Linea, "00")
	SKIP IN ItemCur
ENDDO
ENDPROC
PROCEDURE rutina12
LPARAMETERS vpFecha, vpCantidad, vpPrecio, vpCliente, vpTipo, vpListaPrecios, vpLinea, vpDetalle, ;
			vpTasaIva, vpBodega, vpDocOri, vNumDocOri

STORE 0 TO vMontoAfecto, vMontoExento, vPrecioNetoDetalle

STORE vpLinea TO vSiguienteLinea

vPrecioOriginal=vpPrecio*vpCantidad

STORE vPrecioOriginal TO vPrecioNeto,vPrecioNetoDetalle, vPrecioNetoFinal

vUnidadMedida="UN"
vProductoILA=""
vUnixEnv=1

********** Localiza Impuesto Adicionales que se puedan cargar

IF SEEK(vpDocOri, "TIPODOC",1) THEN
	IF TipoDoc.Exento THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, Fecha, ModDsc) ;
					VALUES (vSiguienteLinea, 8, 0, vPrecioNetoFinal, vpFecha, 2)
		vMontoExento=vPrecioNetoFinal
	ELSE
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, Fecha, ModDsc) ;
					VALUES (vSiguienteLinea, 6, vgTasaIVA,;
							This.mRedondeo(vPrecioNetoFinal*(vgTasaIva/100)), ;
							vpFecha,2)	
		vMontoAfecto=vPrecioNetoFinal
	ENDIF
ENDIF

INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
					 Subtot, Afecto, Detalle, Unimed, Envase, CodIla, Exento, ;
					 Bodega, BodegaIN, NetoDetalle) ;
			VALUES  ("", vpCantidad, 0, vPrecioNeto, ;
					 vpLinea, vpPrecio, IIF(vMontoExento=0,vPrecioOriginal,0), ;
					 vMontoAfecto, ALLTRIM(UPPER(vpDetalle)), vUnidadMedida,vUnixEnv, vProductoILA, vMontoExento, ;
					 vpBodega, "", vPrecioNetoDetalle)



ENDPROC
PROCEDURE rutina13
SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur


GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
		
	STORE 0 TO vImpuestoIVA
	
	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
			IF DscCur.ModDsc=1 THEN
				IF DscCur.TipDsc!=7 THEN
					vMontoDscto		=vMontoDscto+DscCur.MonDsc
					vPorcentajeDscto=vPorcentajeDscto+DscCur.PorDsc
				ENDIF
				vTotalDscto=vTotalDscto+DscCur.MonDsc
			ENDIF
			
			vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)

			IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
				INSERT INTO VisualCur (Detalle, Linea, Nivel) ;
							VALUES (vDetalleDescuento, ItemCur.Linea,"01")
			ENDIF
			
			SKIP IN DscCur
		ENDDO
	ENDIF
	
	STORE 0 TO vCantidadOriginal, vFraccionOriginal
	
	vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)

	INSERT INTO VisualCur  (StrLinea, Detalle, Cantidad, Precio, ;
						       Total, Linea, Nivel) ;
					   VALUES (ALLTRIM(STR(ItemCur.Linea)), ItemCur.Detalle, ;
							   ItemCur.Cantidad, ItemCur.PrecioOrig, vTotalLinea, ItemCur.Linea, "00")

	SKIP IN ItemCur
ENDDO
ENDPROC
PROCEDURE rutina14
LPARAMETERS vpCodigo, vpFecha, vpCantidad, vpFraccion, vpDscto, vpPrecio, ;
			vpProveedor, vpSucursal, vpTipo, vpListaPrecios, vpLinea, vpDsctoCab, vpDsctoMonCab, vpDetalle,;
			vpBodega, vpBodegaIN, vpTipoGuia, vpTipoDsctoCabecera, vCodIad

* rutina14

IF !USED("ITEMCUR") .and. !USED("DSCCUR") THEN
	=MESSAGEBOX("No se encuentran uno o mas cursores")
	RETURN .f.
ENDIF

vPrecioOriginal=vpPrecio

CALCULATE SUM(Afecto) TO vSumaAfectosExistente IN ItemCur FOR ItemCur.Exento=0

IF vpLinea=0 THEN
	CALCULATE MAX(Linea) TO vMaximaLinea IN ItemCur

	vSiguienteLinea=vMaximaLinea+1
ELSE
	vSiguienteLinea=vpLinea
ENDIF

STORE "" TO vProductoIla, vUnidadMedida
STORE 0 TO vUnidadesXenvase
STORE 0 TO vPorcentajeListaEspecial, vPorcentajeRegla
STORE 0 TO vMontoILA, vPorcentajeILA
STORE 0 TO vMontoDscto, vMontoFlete, vMontoExento, ;
		   vMontoAfecto, vPrecioNeto, vPrecioNetoDetalle, ;
		   vMontoDsctoCabecera
STORE "N" TO vProductoExento, vNoApliDes
vDocGuia=.f.
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vDocExento=TipoDoc.Exento	
	vDocGuia=TipoDoc.Traslado
ELSE
	=MESSAGEBOX("El Tipo de Documento no es valido")
	RETURN .f.
ENDIF

vProsigueDescuentos=.f.

IF vDocGuia THEN
	IF !vpTipoGuia THEN
		vProsigueDescuentos=.t.
	ENDIF
ELSE
	vProsigueDescuentos=.t.
ENDIF

vPrecioEspecialCliente =0
vPrecioOriginalEspecial=0

IF !EMPTY(ALLTRIM(vpCodigo)) THEN
	IF !SEEK(vpCodigo, "PRODUCTO", 1) THEN
		=MESSAGEBOX("Producto no se encuentra en Maestra de Productos")
		RETURN .f.
	ENDIF

	vUnidadMedida	=Producto.prUnimed
	vProductoIla	=Producto.TipoIla
	vProductoExento	=Producto.Exento
	
	IF Producto.UnixEnv<=0 THEN
		vUnidadesXenvase=1
	ELSE
		vUnidadesXenvase=Producto.UnixEnv
	ENDIF

*	vPrecioOriginal=vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)) &&&& Cambio para verificar si sirve
	vPrecioOriginal=This.mRedondeo(vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)))

	********** Localiza Impuesto Adicionales que se puedan cargar
	vBndIla=.f.
	IF !EMPTY(ALLTRIM(vpTipo)) THEN
		IF vgTipoDoc="BO" THEN
			IF prPrm.BolIla THEN
				vBndIla=.t.
			ENDIF
		ELSE
			vBndIla=.t.
		ENDIF
	ENDIF

	IF vBndIla THEN
		IF VAL(vProductoIla)!=0 THEN
			IF SEEK(VAL(vProductoIla),"IMPTOADIC",1) THEN
				IF ImptoAdic.EdoImpto THEN
					vPorcentajeIla=ImptoAdic.Monto
				ENDIF
			ENDIF
		ENDIF
	ENDIF

	IF Producto.TipoFlete>0 THEN
		IF Producto.TipoFlete=1 THEN
			vMontoFlete=This.mRedondeo(vPrecioOriginal*(Producto.Flete2/100))
		ELSE
			vMontoFlete=Producto.Flete
		ENDIF
	ENDIF

	vPrecioNeto=vPrecioOriginal+vMontoFlete
	vNoApliDes=Producto.noApliDes
	
	
	IF Producto.noApliDes="S" THEN
		DELETE FROM DscCur WHERE CodPro=vpCodigo
*!*		ELSE
*!*			IF vProsigueDescuentos THEN

*!*				********* Inicia Busqueda de Descuento x Precio Especial.
*!*				IF !EMPTY(ALLTRIM(vpProveedor)) .and. VAL(vpListaPrecios)!=0 THEN 	
*!*					IF SEEK(vpProveedor, "PROVEEDO",1) THEN
*!*						SELECT NumCon, Descto, fdeIni, fdeFin, valPro ;
*!*							FROM mPrecios ;
*!*							LEFT JOIN mContrat ON mPrecios.NumCon=mContrat.Numero ;
*!*							WHERE mPrecios.RutCli=vpProveedor .and. mPrecios.CodPro=vpCodigo .and. ;
*!*								  mPrecios.CodSuc=vpSucursal .and. ;
*!*								  vpFecha>=mPrecios.fdeIni .and. vpFecha<=mPrecios.fdeFin .and. ;
*!*								  mContrat.tiPrec=vpListaPrecios ;
*!*							ORDER BY NumCon ;
*!*							INTO CURSOR cListaEspecial READWRITE

*!*						SELECT cListaEspecial
*!*						INDEX on NumCon TAG NumCon
*!*							
*!*						vCantidadPreciosEspeciales=_Tally
*!*						
*!*						IF vCantidadPreciosEspeciales>0 THEN
*!*							IF vCantidadPreciosEspeciales>1 THEN
*!*								bResultadoPreciosEspeciales=""
*!*								DO FORM wSelPrecioEspecial TO bResultadoPreciosEspeciales
*!*								
*!*								IF !EMPTY(ALLTRIM(bResultadoPreciosEspeciales)) THEN
*!*									IF SEEK(bResultadoPreciosEspeciales, "cLISTAESPECIAL",1) THEN
*!*										vPorcentajeListaEspecial=cListaEspecial.Descto
*!*										vPrecioEspecialCliente=cListaEspecial.ValPro
*!*									ELSE
*!*										vPorcentajeListaEspecial=0
*!*									ENDIF
*!*								ELSE
*!*									vPorcentajeListaEspecial=0
*!*								ENDIF
*!*							ELSE
*!*								GO TOP IN cListaEspecial
*!*								vPorcentajeListaEspecial=cListaEspecial.Descto
*!*								vPrecioEspecialCliente=cListaEspecial.ValPro
*!*							ENDIF
*!*						ENDIF
*!*						
*!*						************** Verificacion de Dscto x Reglas Comerciales					
*!*						IF Clientes.afRegla THEN
*!*							IF Producto.afRegla THEN
*!*								vUnixEnv=Producto.UnixEnv
*!*								SELECT R02CodReg as IDRegla, R02FecIni as FecIni, R02FecFin as FecFin,;
*!*									   R01PorDes as Descuento ;
*!*									FROM Reglas02 ;
*!*									LEFT JOIN Reglas01 ON Reglas02.r02CodReg=ReglasR01.R01CodReg ;
*!*									WHERE vpFechaDoc>=Reglas02.R02FecIni .and. ;
*!*										  vpFechaDoc<=Reglas02.R02FecFin .and. ;
*!*										  Reglas02.R02CodPro=vpCodPro .and. ;
*!*										  ((vpCantidad*vUnixEnv)+vpFraccion)>=((Reglas01.R01CanPro*vUnixEnv)+Reglas01.R01FraPro) ;
*!*									ORDER BY VAL(IdRegla) ;
*!*									INTO CURSOR cPorcentajeRegla
*!*										
*!*								IF _Tally>0 THEN
*!*									GO BOTTOM in cPorcentajeRegla
*!*									vPorcentajeRegla=cPorcentajeReglas.Descuento
*!*								ENDIF
*!*							ENDIF
*!*						ENDIF
*!*					ENDIF
*!*				ENDIF
*!*			ENDIF
	ENDIF
ELSE
	vUnidadMedida="UN"
	vUnidadesXenvase=1
	vProductoIla=""
	vPrecioNeto=vpPrecio*vpCantidad
	vPrecioOriginal=vpPrecio*vpCantidad
	vPrecioNetoDetalle=vPrecioNeto
	vPrecioEspecialCliente=0
ENDIF

*!*	IF vPrecioEspecialCliente!=0 THEN
*!*		vPrecioOriginal=This.mRedondeo(vPrecioEspecialCliente*(vpCantidad+(vpFraccion/vUnidadesXenvase)))
*!*		vPrecioNeto=vPrecioOriginal+vMontoFlete
*!*		vPrecioOriginalEspecial=vPrecioEspecialCliente
*!*	ENDIF
	
*!*	IF vProsigueDescuentos THEN
*!*		IF (vpDscto+vPorcentajeListaEspecial+vPorcentajeRegla)>100 THEN
*!*			=MESSAGEBOX("(000002). Descuentos son Mayores que el 100%"+CHR(13)+;
*!*						" - Descuento x Lista Precios Especiales: "+ALLTRIM(STR(vPorcentajeListaEspecial,7,3))+CHR(13)+;
*!*						" - Descuento x Regla Comercial: "+ALLTRIM(STR(vPorcentajeRegla,7,3))+CHR(13)+;
*!*						" - Descuento x Linea: "+ALLTRIM(STR(vpDscto,7,3)))
*!*			RETURN .f.
*!*		ENDIF

*!*		IF vMontoFlete>0 THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 7, vMontoFlete, vpCodigo, vpFecha, 2)
*!*		ENDIF

*!*		IF vPorcentajeListaEspecial>0 .and. vNoApliDes!="S" THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 1, vPorcentajeListaEspecial, ;
*!*								This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100)), ;
*!*								vpCodigo, vpFecha, 1)
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeListaEspecial/100))
*!*		ENDIF

*!*		IF vPorcentajeRegla>0 .and. vNoApliDes!="S" THEN
*!*			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*						VALUES (vSiguienteLinea, 2, vPorcentajeRegla, ;
*!*								This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100)), ;
*!*								vpCodigo, vpFecha,1)
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vPorcentajeRegla/100))
*!*		ENDIF

*!*		IF vpDscto>0 .and. vNoApliDes!="S" THEN
*!*			IF !SEEK(STR(vSiguienteLinea,4)+"3","DSCCUR",3) THEN
*!*				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*							VALUES (vSiguienteLinea, 3, vpDscto, ;
*!*									This.mRedondeo(vPrecioNeto*(vpDscto/100)), ;
*!*									vpCodigo, vpFecha,1)
*!*			ELSE 	
*!*				Replace PorDsc WITH vpDscto, ;
*!*						MonDsc WITH This.mRedondeo(vPrecioNeto*(vpDscto/100)) IN DscCur
*!*			ENDIF
*!*			vMontoDscto=vMontoDscto+This.mRedondeo(vPrecioNeto*(vpDscto/100))
*!*		ENDIF

*!*	*	vPrecioNetoDetalle=vPrecioNeto-vMontoDscto

*!*		IF (vpDsctoCab>0 .or. vpDsctoMonCab>0) .and. vNoApliDes!="S" THEN
*!*			vContinuaDsctoCab=.f.
*!*			IF vpTipoDsctoCabecera THEN
*!*		*!*			IF vDocExento THEN
*!*		*!*				vContinuaDsctoCab=.t.
*!*		*!*			ENDIF
*!*		*!*		ELSE
*!*				IF vProductoExento!="E" THEN
*!*					vContinuaDsctoCab=.t.
*!*				ENDIF
*!*			ELSE
*!*				IF vDocExento THEN
*!*					vContinuaDsctoCab=.t.
*!*				ELSE
*!*					IF vProductoExento="E" THEN
*!*						vContinuaDsctoCab=.t.
*!*					ENDIF 		
*!*				ENDIF
*!*			ENDIF
*!*			
*!*			IF vContinuaDsctoCab THEN
*!*				IF vpDsctoMonCab>0 THEN
*!*					vDsctoCab=This.mRedondeo((vpDsctoMonCab*100)/(vSumaAfectosExistente+vPrecioNeto))
*!*				ELSE
*!*					vDsctoCab=vpDsctoCab
*!*				ENDIF
*!*				
*!*				vMontoDsctoCabecera=This.mRedondeo((vPrecioNeto-vMontoDscto)*(vpDsctoCab/100))

*!*				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
*!*							VALUES (vSiguienteLinea, 7, vDsctoCab, vMontoDsctoCabecera, vpCodigo, vpFecha,1)
*!*			ENDIF
*!*			
*!*			vPrecioNetoFinal=(vPrecioNeto-vMontoDscto)-vMontoDsctoCabecera
*!*		ELSE
*!*			vPrecioNetoFinal=vPrecioNeto-vMontoDscto
*!*		ENDIF
*!*	ELSE
	vPrecioNetoFinal=vPrecioNeto	
*!*	ENDIF

vPrecioNetoDetalle=vPrecioNeto-vMontoDscto

**** Variable que indica si el documento admite o no, la asignacion de los valores Exento o IVA
*!*	vVarExentoIVA=.t.
*!*	IF vDocGuia .and. vpTipoGuia THEN
*!*		vVarExentoIVA=.f.
*!*	ENDIF

IF !(EMPTY(vCodIad) OR EMPTY(ImptoAdic.Monto))
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 9, ImptoAdic.Monto, ;
						This.mRedondeo(vPrecioNetoFinal*(ImptoAdic.Monto/100)), ;
						vpCodigo, vpFecha, 2, VCodIad)
ELSE
	STORE '' TO	VCodIad
ENDIF
	
IF vPorcentajeILA>0 THEN
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 5, vPorcentajeIla, ;
						This.mRedondeo(vPrecioNetoFinal*(vPorcentajeIla/100)), ;
						vpCodigo, vpFecha, 2, VCodIad)
ENDIF 	

IF vDocExento THEN
	INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
				VALUES (vSiguienteLinea, 8, 0, vPrecioNetoFinal, vpCodigo, vpFecha, 2, VCodIad)
	vMontoExento=vPrecioNetoFinal
ELSE
	IF vProductoExento="E" THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
					VALUES (vSiguienteLinea, 8, 0, vPrecioNetoFinal, vpCodigo, vpFecha, 2, VCodIad)
		vMontoExento=vPrecioNetoFinal
	ELSE
*		IF vVarExentoIVA THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_Iad) ;
						VALUES (vSiguienteLinea, 6, vgTasaIVA,;
								This.mRedondeo(vPrecioNetoFinal*(vgTasaIva/100)), ;
								vpCodigo, vpFecha, 2, VCodIad)		
*		ENDIF
	ENDIF 	
ENDIF

*!*	vPrecioOriginal	= El Precio Inicial de 1 producto (s/g Maestra de Productos) por las Cantidades a Vender
*!*	vPrecioNeto		= vPrecioOriginal + Monto Flete (Cargo)
*!*	vpPrecio		= Precio individual de 1 producto como esta en la MAestra de Precios a nivel NETO
*!*	vPrecioNetoFinal= vPrecioOriginal - DescuentosLinea - DescuentosCabecera

IF vMontoExento=0 THEN
	vMontoAfecto=vPrecioNetoFinal
ENDIF


*vPrecioOriginalEspecial=vPrecioEspecialCliente

*!*	IF vPrecioEspecialCliente!=0 THEN
*!*		INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
*!*							 Subtot, Afecto, Detalle, Unimed, CodIla, Exento, Bodega, ;
*!*							 BodegaIN, noApliDes, Envase, NetoDetalle) ;
*!*					VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioNeto, ;
*!*							 vSiguienteLinea, vPrecioOriginalEspecial, IIF(vMontoExento=0,vPrecioOriginal,0), ;
*!*							 vMontoAfecto, ALLTRIM(vpDetalle), ;
*!*							 vUnidadMedida, vProductoIla, vMontoExento, ;
*!*							 vpBodega, vpBodegaIN, vNoApliDes, vUnidadesXenvase, vPrecioNetoDetalle)
*!*	ELSE
	INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						 Subtot, Afecto, Detalle, Unimed, CodIla, Exento, Bodega, ;
						 BodegaIN, noApliDes, Envase, NetoDetalle, Cod_Iad) ;
				VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioNeto, ;
						 vSiguienteLinea, vpPrecio, IIF(vMontoExento=0,vPrecioOriginal,0), ;
						 vMontoAfecto, ALLTRIM(vpDetalle), ;
						 vUnidadMedida, vProductoIla, vMontoExento, ;
						 vpBodega, vpBodegaIN, vNoApliDes, vUnidadesXenvase, vPrecioNetoDetalle, VCodIad)
*!*	ENDIF
ENDPROC
PROCEDURE rutina1_1rafase
LPARAMETERS vpCodigo, vpFecha, vpCantidad, vpFraccion, vpDscto, vpRecargo, ;
			vpRutCli, vpCodSuc, vpListaPrecios, vpDsctoCab, vpDsctoMonCab, vpDetalle,;
			vpBodega, vpBodegaIN, vpTipoDsctoCabecera, vpTipoRecCabecera, vpRecCab, vpRecMonCab, vpPrecioIng, ;
			vpTipoItem, vpLinea
			

STORE 0 TO vPrecioLista

IF EMPTY(ALLTRIM(vpCodigo)) .and. EMPTY(ALLTRIM(vpDetalle)) THEN
	=MESSAGEBOX("No existen ni codigo ni detalle")
	RETURN .f.
ENDIF

vIndicadorExencion=vpTipoItem

IF !EMPTY(ALLTRIM(vpCodigo)) THEN
	IF !SEEK(vpCodigo, "PRODUCTO",1) THEN
		=MESSAGEBOX("Producto no encontrado en Maestra de Productos")
		RETURN .f.
	ENDIF
	
	DO CASE
		CASE vIndicadorExencion=0
			IF Producto.Exento="E" THEN
				=MESSAGEBOX("El Producto no debe de ser Exento")
				RETURN .f.
			ENDIF
			IF Producto.noFactu THEN
				=MESSAGEBOX("El Producto no debe estar clasificado como No Facturable")
				RETURN .f.
			ENDIF
		CASE vIndicadorExencion=1
			IF Producto.Exento!="E" THEN
				=MESSAGEBOX("El Producto debe tener clasificacion de Exento")
				RETURN .f.
			ENDIF
			IF Producto.noFactu THEN
				=MESSAGEBOX("El Producto no debe estar clasificado como Noacturable")
				RETURN .f.
			ENDIF
		CASE vIndicadorExencion=2
			IF Producto.Exento="E" THEN
				=MESSAGEBOX("El Producto no debe de ser Exento")
				RETURN .f.
			ENDIF
			IF !Producto.noFactu THEN
				=MESSAGEBOX("El Producto debe estar clasificado como No Facturable")
				RETURN .f.
			ENDIF
	ENDCASE

	DO CASE
		CASE vpListaPrecios=1
			vPrecioLista=Producto.Prec1
		CASE vpListaPrecios=2
			vPrecioLista=Producto.Prec1
		CASE vpListaPrecios=3
			vPrecioLista=Producto.Prec1
	ENDCASE
	
ELSE
	vPrecioLista=vpPrecioIng
ENDIF

IF vpLinea>0 THEN
	UPDATE ItemCurIni ;
		SET Codigo		=vpCodigo ,;
			Detalle		=vpDetalle  ,;
			Cantidad	=vpCantidad ,;
			Fraccion	=vpFraccion ,;
			Lista		=vpListaPrecios ,;
			PrecioLista	=vPrecioLista ,;
			PrecioIng	=vpPrecioIng ,;
			IndExe		=vIndicadorExencion ,;
			DscLin		=vpDscto ,;
			RecLin		=vpRecargo ,;
			RutCli		=vpRutCli ,;
			CodSuc		=vpCodSuc ,;
			Fecha		=vpFecha ,;
			Bodega		=vpBodega ,;
			BodegaIn	=vpBodegaIn ;
		WHERE Linea=vpLinea
ELSE 			
	INSERT INTO ItemCurIni (Codigo, Detalle, Cantidad, Fraccion, ;
							Lista, PrecioLista, PrecioIng, ;
							IndExe, ;
							DscLin, RecLin, RutCli, CodSuc, ;
							Fecha, Bodega, BodegaIn) ;
		VALUES (vpCodigo, vpDetalle, vpCantidad, vpFraccion, ;
				vpListaPrecios, vPrecioLista, vpPrecioIng, ;
				vIndicadorExencion, ;
				vpDscto, vpRecargo, vpRutCli, vpCodSuc, ;
				vpFecha, vpBodega, vpBodegaIn)
ENDIF

RETURN .t.













ENDPROC
PROCEDURE rutina1_2dafase
LPARAMETERS vpTipoDscCab, vpTipoRecCab, vpFechaEmision, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab

IF !USED("ITEMCURINI") then
	RETURN .f.
ENDIF

This.pCreaCursores(.t.,.t.)

GO TOP IN prPrm


vContadorLinea=0
SELECT ItemCurIni
SET ORDER TO


GO TOP IN ItemCurIni
DO WHILE !EOF("ITEMCURINI")
	vContadorLinea=vContadorLinea+1
	
	STORE "" TO vUnidadMedida
	STORE 0  TO vUnidadesXenvase, vCodigoIla, vProductoFlete, vCanDscLisEsp
	STORE 0  TO vMontoDscto, vMontoRecargo, vMontoFlete, ;
				vMontoExento, vMontoAfecto, vMontoNoFacturable
	STORE .f. TO vNoApliDes, vIVaRet
	
	STORE 0 TO vPrecioEspecialCliente, vPrecioOriginalEspecial

	IF !EMPTY(ALLTRIM(ItemCurIni.Codigo)) THEN
		IF !SEEK(ItemCurIni.Codigo, "PRODUCTO", 1) THEN
			RETURN "Error Registrando Linea, Codigo no se encuentra en Maestra de Productos"
		ENDIF

		vUnidadMedida			= Producto.prUnimed
		vCodigoIla				= Producto.TipoIla
		vProductoFlete			= Producto.TipoFlete
		vNoApliDes				= (Producto.noApliDes="S")
		vIVaRet					= Producto.IVARet

		IF Producto.UnixEnv<=0 THEN
			vUnidadesXenvase=1
		ELSE
			vUnidadesXenvase=Producto.UnixEnv
		ENDIF
	ELSE
		vUnidadMedida	= "UN"
		vCodigoIla		= 0
		vUnidadesXenvase= 1
		vNoApliDes		= .f.
	ENDIF

*!*		CREATE CURSOR ItemCurIni (Codigo c(15), Detalle c(80), Cantidad n(10,2), Fraccion n(4), Lista n(1),;
*!*							   	  Linea n(4), PrecioLista n(15,2), PrecioIng n(15,2), IndExe n(1), ;
*!*							   	  DscLin n(10,2), RecLin n(10,2), RutCli c(12), CodSuc c(4), Exento l(1), Fecha d(8),;
*!*							   	  Bodega c(3), BodegaIn c(3))
						   	
	IF !SEEK(ItemCurIni.RutCli, "CLIENTES",1) THEN
		SKIP IN ItemCurIni
		LOOP
	ENDIF
	
	vPrecioSubTot=ItemCurIni.PrecioIng*(ItemCurIni.Cantidad+(ItemCurIni.Fraccion/vUnidadesXenvase)) &&&& Cambio para verificar si sirve
	STORE 0 TO vMontoDscto, vMontoRecargo, vMontoFlete
	
	IF ItemCurIni.IndExe=0 THEN
		SELECT NumCon, Descto, fdeIni, fdeFin, valPro ;
		FROM mPrecios ;
		LEFT JOIN mContrat ON mPrecios.NumCon=mContrat.Numero ;
		WHERE mPrecios.RutCli=ItemCurIni.RutCli .and. mPrecios.CodPro=ItemCurIni.Codigo .and. ;
			  mPrecios.CodSuc=ItemCurIni.CodSuc .and. ;
			  BETWEEN(ItemCurIni.Fecha,mPrecios.fdeIni, mPrecios.fdeFin) .and. ;
			  VAL(mContrat.tiPrec)=ItemCurIni.Lista ;
		ORDER BY NumCon ;
		INTO CURSOR cListaEspecial READWRITE

		vCanDscLisEsp=_Tally

		IF vCanDscLisEsp>0 THEN
			IF INLIST(VAL(Clientes.clCoordX),2,3) THEN
				CALCULATE MAX(ValPro) TO vNuevoPrecioIngMax IN cListaEspecial
				Replace ItemCurIni.PrecioIng WITH vNuevoPrecioIngMax IN ItemCurIni
			ENDIF
		ENDIF
			
	ENDIF
		
	IF !vNoApliDes THEN 	
		IF vProductoFlete>0 THEN
			IF Producto.TipoFlete=1 THEN
				vMontoFlete=ROUND(vPrecioSubTot*(Producto.Flete2/100),0)
			ELSE
				vMontoFlete=Producto.Flete
			ENDIF

			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vContadorLinea, 5, ItemCurIni.RecLin, ;
								vMontoFlete, ItemCurIni.Codigo, ItemCurIni.Fecha,2)
			vMontoRecargo=vMontoRecargo+vMontoFlete
		ENDIF
	
		IF vCanDscLisEsp>0 THEN
			GO TOP IN cListaEspecial
			STORE 0 TO vSumaDscLisEsp, vMontoDsctoLisEsp
			
			DO WHILE !EOF("cLISTAESPECIAL")
				vMontoDsctoLisEsp=ROUND(vPrecioSubTot*(cListaEspecial.Descto/100),0)
				
				INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
							VALUES (vContadorLinea, 1, cListaEspecial.Descto, ;
									vMontoDsctoLisEsp, ItemCurIni.Codigo, ItemCurIni.Fecha, 1)
									
				vMontoDscto=vMontoDscto+vMontoDsctoLisEsp
				
				SKIP IN cListaEspecial
			ENDDO
		ENDIF

		IF ItemCurIni.DscLin>0
			vMontoDsctoLin=ROUND(vPrecioSubTot*(ItemCurIni.DscLin/100),0)
			
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vContadorLinea, 3, ItemCurIni.DscLin, ;
								vMontoDsctoLin, ItemCurIni.Codigo, ItemCurIni.Fecha,1)
								
			vMontoDscto=vMontoDscto+vMontoDsctoLin
		ENDIF

		IF ItemCurIni.RecLin>0
			vMontoRecLin=ROUND(vPrecioSubTot*(ItemCurIni.RecLin/100),0)
			
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vContadorLinea, 4, ItemCurIni.RecLin, ;
								vMontoRecLin, ItemCurIni.Codigo, ItemCurIni.Fecha,2)
			vMontoRecargo=vMontoRecargo+vMontoRecLin
		ENDIF 		
	ENDIF 	
	
	DO CASE
		CASE ItemCurIni.IndExe=0
			vMontoAfecto=vPrecioSubTot-vMontoDscto+vMontoRecargo
		CASE ItemCurIni.IndExe=1
			vMontoExento=vPrecioSubTot-vMontoDscto+vMontoRecargo
	OTHERWISE
		vMontoNoFacturable=vMontoRecargo-vMontoDscto
	ENDCASE

	INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						 Subtot, Afecto, Detalle, Unimed, Exento, Bodega, ;
						 BodegaIN, noApliDes, Envase, NetoDetalle, CodIla, indExe, noFactu, IVARet) ;
				VALUES  (ItemCurIni.Codigo, ItemCurIni.Cantidad, ItemCurIni.Fraccion, ItemCurIni.PrecioIng, ;
						 vContadorLinea, ItemCurIni.PrecioLista, vPrecioSubTot, ;
						 vMontoAfecto, ALLTRIM(ItemCurIni.Detalle), ;
						 vUnidadMedida, vMontoExento, ItemCurIni.Bodega, ItemCurIni.BodegaIn, IIF(vNoApliDes,"S","N"), ;
						 vUnidadesXenvase, ;
						 ICASE(ItemCurIni.indExe=0, vMontoAfecto, ItemCurIni.indExe=1,vMontoExento, vMontoNoFacturable), ;
						 vCodigoILA, ItemCurIni.indExe, vMontoNoFacturable, vIVARet)
	
	Replace ItemCurIni.Linea WITH vContadorLinea IN ItemCurIni
	
	SKIP IN ItemCurIni
ENDDO

******* Fin de Ingreso de Items al Cursor Temporal ITEMCUR con todos sus Datos


****** Inicia Secuencia de Carga de los Descuentos/Recargos de Cabecera a partir del Cursor Auxiliar ITEMCUR
vBndDscRecCabecera=.t.
CALCULATE CNT() TO vCantidadProductosSinDsctos FOR ItemCur.noApliDes="S" IN ItemCur
CALCULATE CNT() TO vCantidadProductosRegistrados FOR !DELETED("ITEMCUR")  IN ItemCur



CALCULATE SUM(Afecto) TO vSumaAfectosNormales FOR ItemCur.IndExe=0 .and. ItemCur.noApliDes!="S" IN ItemCur
CALCULATE CNT() TO vCanItemNoFacturables FOR ItemCur.IndExe=2 .and. ItemCur.noApliDes!="S" IN ItemCur
CALCULATE SUM(Exento) TO vSumaExentos FOR ItemCur.IndExe=1 .and. ItemCur.noApliDes!="S" IN ItemCur

DO CASE
	CASE (vCantidadProductosRegistrados+vCantidadProductosSinDsctos)=0
		vBndDscRecCabecera=.f.
	CASE vCantidadProductosRegistrados=vCantidadProductosSinDsctos
		vBndDscRecCabecera=.f.
ENDCASE

*LPARAMETERS vpTipoDscCab, vpTipoRecCab, vpFechaEmision, vpPorDscCab, vpMonDscCab, vpPorRecCab, vpMonRecCab

IF vBndDscRecCabecera THEN 	
	IF vCantidadProductosSinDsctos>0 THEN
		DO CASE
			CASE vpTipoDscCab=1
				vpMonDscCab=vpMonDscCab+ROUND((vpPorDscCab/100)*vSumaAfectosNormales ,0)
			CASE vpTipoDscCab=2
				vpMonDscCab=vpMonDscCab+ROUND((vpPorDscCab/100)*vSumaExentos,0)
		ENDCASE 			
		vpPorDscCab=0
		DO CASE
			CASE vpTipoRecCab=1
				vpMonRecCab=vpMonRecCab+ROUND((vpPorRecCab/100)*vSumaAfectosNormales ,0)
			CASE vpTipoRecCab=2
				vpMonRecCab=vpMonRecCab+ROUND((vpPorRecCab/100)*vSumaExentos,0)
		ENDCASE 			
		vpPorRecCab=0
	ENDIF
	
	GO TOP IN ItemCur
	DO WHILE !EOF("ITEMCUR")	
		IF ItemCur.noApliDes="S" THEN
			SKIP IN ItemCur
			LOOP
		ENDIF
		
		vContinuaDscCab=.f.
		DO CASE
			CASE vpTipoDscCab=1
				IF ItemCur.indExe=0  THEN
					vContinuaDscCab=.t.
				ENDIF
			CASE vpTipoDscCab=2
				IF ItemCur.indExe=1 THEN
					vContinuaDscCab=.t.
				ENDIF
			CASE vpTipoDscCab=3
				IF ItemCur.indExe=2  THEN
					vContinuaDscCab=.t.
				ENDIF
		ENDCASE 	
		
		STORE 0 TO vSumaDscCab, vSumaRecCab, vMontoDsctoCabecera, vMontoRecCabecera, vTipo

		IF vContinuaDscCab THEN   	
			vMontoBase=0
			DO CASE
				CASE vpTipoDscCab=1
					vMontoBase=ItemCur.Afecto
				CASE vpTipoDscCab=2
					vMontoBase=ItemCur.Exento
				CASE vpTipoDscCab=3
					vMontoBase=0
			OTHERWISE
				SKIP IN ItemCur
				LOOP
			ENDCASE
			
			IF (vpPorDscCab>0 .or. vpMonDscCab>0) THEN
				IF vpMonDscCab>0 THEN
					DO CASE
						CASE vpTipoDscCab=1
							vDsctoCab=(vMontoBase*100)/vSumaAfectosNormales
						CASE vpTipoDscCab=2
							vDsctoCab=(vMontoBase*100)/vSumaExentos
						CASE vpTipoDscCab=3
							vDsctoCab=(100/vCanItemNoFacturables)
					OTHERWISE
						SKIP IN ItemCur
						LOOP
					ENDCASE
					
					vMontoDsctoCabecera=ROUND(vpMonDscCab*(vDsctoCab/100),0)		
					vSumaDscCab=vSumaDscCab+vMontoDsctoCabecera

					IF vMontoDsctoCabecera!=0 THEN
						INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
									VALUES (ItemCur.Linea, 12, vDsctoCab, vMontoDsctoCabecera,;
										    ItemCur.Codigo, vpFechaEmision,1)				
					ENDIF
				ENDIF
				IF vpPorDscCab>0 THEN
					
					vMontoDsctoCabecera=ROUND(vMontoBase*(vpPorDscCab/100),0)
					vSumaDscCab=vSumaDscCab+vMontoDsctoCabecera
					
					IF vMontoDsctoCabecera!=0 THEN
						INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
									VALUES (ItemCur.Linea, 7, vpPorDscCab, vMontoDsctoCabecera, ;
											ItemCur.Codigo, vpFechaEmision,1)				
					ENDIF
				ENDIF 			
			ENDIF
		ENDIF


		DO CASE
			CASE ItemCur.IndExe=0
				Replace ItemCur.Afecto WITH ItemCur.Afecto-vMontoDsctoCabecera IN ItemCur
			CASE ItemCur.IndExe=1
				Replace ItemCur.Exento WITH ItemCur.Exento-vMontoDsctoCabecera IN ItemCur
		OTHERWISE
			Replace ItemCur.Afecto WITH vMontoRecCabecera-vMontoDsctoCabecera IN ItemCur
		ENDCASE


		vContinuaRecCab=.f.
		DO CASE
			CASE vpTipoRecCab=1
				IF ItemCur.indExe=0  THEN
					vContinuaRecCab=.t.
				ENDIF
			CASE vpTipoRecCab=2
				IF ItemCur.indExe=1 THEN
					vContinuaRecCab=.t.
				ENDIF
			CASE vpTipoRecCab=3
				IF ItemCur.indExe=2  THEN
					vContinuaRecCab=.t.
				ENDIF
		ENDCASE

		IF vContinuaRecCab THEN
			vMontoBase=0
			DO CASE
				CASE vpTipoRecCab=1
					vMontoBase=ItemCur.Afecto
				CASE vpTipoRecCab=2
					vMontoBase=ItemCur.Exento
				CASE vpTipoRecCab=3
					vMontoBase=0
			OTHERWISE
				SKIP IN ItemCur
				LOOP
			ENDCASE 	
			IF (vpPorRecCab>0 .or. vpMonRecCab>0) THEN
				IF vpMonRecCab>0 THEN
					DO CASE
						CASE vpTipoRecCab=1
							vRecCab=(vMontoBase*100)/vSumaAfectosNormales
						CASE vpTipoRecCab=2
							vRecCab=(vMontoBase*100)/vSumaExentos
						CASE vpTipoRecCab=3
							vRecCab=(100/vCanItemNoFacturables)
					OTHERWISE
						SKIP IN ItemCur
						LOOP
					ENDCASE
					
					vMontoRecCabecera=vMontoRecCabecera+ROUND(vpMonRecCab*(vRecCab/100),0)
					vSumaRecCab=vSumaRecCab+vMontoRecCabecera
					
					INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
								VALUES (ItemCur.Linea, 13, vRecCab, vMontoRecCabecera, ;
										ItemCur.Codigo, vpFechaEmision, 2)
				ENDIF
				IF vpPorRecCab>0 THEN
					
					vMontoRecCabecera=ROUND((vMontoBase*(vpPorRecCab/100)),0)
					vSumaRecCab=vSumaRecCab+vMontoRecCabecera
					
					INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
								VALUES (ItemCur.Linea, 10, vpPorRecCab, vMontoRecCabecera, ;
										ItemCur.Codigo, vpFechaEmision, 2)
				ENDIF 			
			ENDIF
		ENDIF 	
		
		DO CASE
			CASE ItemCur.IndExe=0
				Replace ItemCur.Afecto WITH ItemCur.Afecto+vMontoRecCabecera IN ItemCur
			CASE ItemCur.IndExe=1
				Replace ItemCur.Exento WITH ItemCur.Exento+vMontoRecCabecera IN ItemCur
		OTHERWISE
			Replace ItemCur.Afecto WITH vMontoRecCabecera-vMontoDsctoCabecera IN ItemCur
		ENDCASE

		SKIP IN ItemCur
	ENDDO
ENDIF
******** Fin de Asignacion de Descuentos de Cabecera


******* Inicio de Secuencia de Asignacion de Exentos, Retenidos, NoFacturables, IVA, ImpAdi

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF ItemCur.indExe=1 THEN 	
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
					VALUES (ItemCur.Linea, 8, 0, ItemCur.Exento, ItemCur.Codigo, vpFechaEmision, 2)
	ENDIF
	
	vMontoIVA=0
	IF ItemCur.IndExe=0 THEN
		vMontoIVA=ROUND(ItemCur.Afecto*(vgTasaIVA/100),0)
	
		IF ItemCur.IVARet THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 11, prPrm.paIVA,;
								vMontoIVA,ItemCur.Codigo, vpFechaEmision, 2)		
		ELSE 	
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (ItemCur.Linea, 6, prPrm.paIVA,;
								vMontoIVA, ItemCur.Codigo, vpFechaEmision, 2)		
		ENDIF
	ENDIF 	

	IF ItemCur.CodILA>0 THEN
		IF SEEK(ItemCur.CodILA, "IMPTOADIC",1) THEN
			vMontoBase=ICASE(ItemCur.indExe=0, ItemCur.Afecto, ItemCur.indExe=1, ItemCur.Exento,0)
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
						VALUES (ItemCur.Linea, 9, ImptoAdic.Monto, ;
								ROUND(vMontoBase*(ImptoAdic.Monto/100),0), ;
								ItemCur.Codigo, vpFechaEmision,2, ItemCur.CodILA)
		ENDIF
	ENDIF 	

	SKIP IN ItemCur
ENDDO


RETURN .t.















ENDPROC
PROCEDURE rutina1_4tafase
LPARAMETERS vpTasaIVA

LOCAL vpTasaIVA

GO TOP IN prPrm

vpTasaIVA=prPrm.paIVA

RELEASE aSumaTotales


*!*		CREATE CURSOR ItemCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
*!*							   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
*!*							   Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
*!*							   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), ;
*!*							   Cod_Iad n(5), defraccion n(9, 2), IndExe n(1), IVaRet l(1), noFactu n(15))
*!*		INDEX on Linea TAG Linea
*!*		INDEX on Codigo TAG Codigo
*!*		SELECT ItemCur
*!*		SET ORDER TO 	
*!*	ENDIF

*!*	IF vpOriCur THEN
*!*		IF USED("ORICUR") THEN
*!*			USE IN OriCur
*!*		ENDIF

*!*		CREATE CURSOR OriCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
*!*							   Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
*!*							   Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
*!*							   Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), ;
*!*							   defraccion n(9, 2))
*!*		INDEX on Linea TAG Linea
*!*	ENDIF

*!*	IF vpCopiaCur THEN
*!*		IF USED("COPIACUR") THEN
*!*			USE IN CopiaCur
*!*		ENDIF

*!*		CREATE CURSOR CopiaCur (Codigo c(15), Cantidad n(10), Fraccion n(4), Precio n(10,2), ;
*!*							    Linea n(4), PrecioOrig n(10,2), SubTot n(15,2), Afecto n(15), ;
*!*							    Detalle c(60), UniMed c(4), CodIla n(5), noApliDes c(1), Exento n(15),;
*!*							    Bodega c(3), BodegaIN c(3), Envase n(5), NetoDetalle n(15), Cod_Iad n(5), defraccion n(9, 2))
*!*		INDEX on Linea TAG Linea
*!*	ENDIF

*!*	IF vpDscCur THEN
*!*		IF USED("DSCCUR") THEN
*!*			USE IN DscCur
*!*		ENDIF

*!*		CREATE CURSOR DscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
*!*							  Fecha d(8), ModDsc n(1), Cod_Iad n(5))
						
PUBLIC ARRAY aSumaTotales (8)

aSumaTotales(1)=0
aSumaTotales(2)=0
aSumaTotales(3)=0
aSumaTotales(4)=0
aSumaTotales(5)=0
aSumaTotales(6)=0
aSumaTotales(7)=0
aSumaTotales(8)=0

CALCULATE SUM(SubTot) TO aSumaTotales(1) IN ItemCur

*!*	CALCULATE SUM(MonDsc) TO vSumaDscLineales FOR INLIST(TipDsc,1,2,3) IN DscCur
*!*	CALCULATE SUM(MonDsc) TO vSumaRecLineales FOR INLIST(TipDsc,4,5) IN DscCur

*!*	aSumaTotales(1)=aSumaTotales(1)+vSumaRecLineales-vSumaDscLineales

CALCULATE SUM(MonDsc) TO aSumaTotales(2) IN DscCur FOR INLIST(TipDsc,4,5,10,13)
CALCULATE SUM(MonDsc) TO aSumaTotales(3) IN DscCur FOR INLIST(TipDsc,1,2,3,7,12)
CALCULATE SUM(MonDsc) TO aSumaTotales(4) IN DscCur FOR INLIST(TipDsc,8)
CALCULATE SUM(Afecto) TO aSumaTotales(5) IN ItemCur
CALCULATE SUM(MonDsc) TO aSumaTotales(6) IN DscCur FOR INLIST(TipDsc,9)



aSumaTotales(7)=ROUND(aSumaTotales(5)*(vpTasaIVA/100),0)
aSumaTotales(8)=aSumaTotales(4)+aSumaTotales(5)+aSumaTotales(6)+aSumaTotales(7)






ENDPROC
PROCEDURE rutina1_5tafase
LPARAMETERS vpTipoDoc, vpFolioDoc, vpCodDoc, vpModDoc, vpFechaIni, vpFecVen, aDTCli, vpMontoNeto, ;
			vpMontoExento, vpTasaIVA, vpMontoIVA, vpMontoTotal, DocRef, vpCodVend, GDespacho, ;
			vpCondicionPago, vpCodSuc, vpTipoDocEnvioDTE, vpDevolucionParcial, vpRetenIva, ;
			aDscRecCab, vpNotaVenta, vpDireccionDespacho, vpCoordenadas, vpMedioPago, vpSucursalRecepcion

CALCULATE SUM(monDsc) IN DscCur FOR INLIST(TipDsc,7,12) TO vSumaDscCabecera
CALCULATE SUM(monDsc) IN DscCur FOR INLIST(TipDsc,10,13) TO vSumaRecCabecera
CALCULATE SUM(monDsc) IN DscCur FOR TipDsc=9 TO vSumaDscImpAdi

PUBLIC vpRutCliente, vpNombreCliente, vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad

vpRutCliente	= aDTCli(1)
vpNombreCliente	= aDTCli(2)
vpGiro			= aDTCli(3)
vpContacto		= aDTCli(4)
vpeMail			= aDTCli(5)
vpDireccion		= aDTCli(6)
vpComuna		= aDTCli(7)	
vpCiudad		= aDTCli(8)

IF !This.pVerificaEstructurasEnvioDTE(vpTipoDocEnvioDTE,vpDevolucionParcial) THEN
	=MESSAGEBOX("Existen Problemas en la Estructura necesaria para El Envio del DTE")
	RETURN .f.
ENDIF

STORE "" TO vCadenaObservacionCliente, vCadenaVendedor, vCadenaRuta, ;
			vCadenaCondicionPago, vFormadePago


IF SEEK(PADL(ALLTRIM(vpRutCliente),12," "), "CLIENTES",1) THEN
	vCadenaObservacionCliente=ALLTRIM(Clientes.OBSERV1)+" "+ALLTRIM(Clientes.OBSERV2)+" "+;
							  ALLTRIM(Clientes.OBSERV3)+" "+ALLTRIM(Clientes.OBSERV4)+;
							  ALLTRIM(Clientes.OBSERV5)
	IF !EMPTY(ALLTRIM(Clientes.Ruta)) THEN
		IF SEEK(Clientes.Ruta, "CLIRUTAS",1) THEN
			vCadenaRuta=ALLTRIM(CliRutas.Descri)
		ENDIF
	ENDIF
ENDIF

IF SEEK(vpCodVend, "VENDEDOR",1) THEN
	vCadenavendedor="("+ALLTRIM(Vendedor.veCodigo)+") "+ALLTRIM(Vendedor.veNombre)
ENDIF

IF !EMPTY(vpCondicionPago) THEN
	IF SEEK(vpCondicionPago, "CONDIPAG",1) THEN
		vCadenaCondicionPago=ALLTRIM(CondiPag.coDescri)
		vFormaDePago=ALLTRIM(STR(CondiPag.coTipoSNII))
	ENDIF
ENDIF

vNumeroCajas=0

CALCULATE SUM(Cantidad+(Fraccion/Envase)) TO vNumeroCajas IN ItemCur

***** Verifica si el documento es exento o no; y si es Guia de Despacho o no
STORE .f. TO vDocExento, vDocGuiaDespacho
vNombreDocumento=""
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vNombreDocumento=ALLTRIM(TipoDoc.DetDoc)
	vDocExento		=TipoDoc.Exento
	vDocGuiaDespacho=TipoDoc.Traslado
ENDIF

IF prPrm.IncOBS THEN
	IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN
		IF vDocGuiaDespacho THEN
			vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
					   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
					   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
					   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
		ELSE
*!*				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
*!*						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
*!*						   " - CONDICION DE PAGO: "+ALLTRIM(vCadenaCondicionPago)+IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
*!*						   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
			vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
					   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
					   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
					   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
		ENDIF
	ELSE
		IF VARTYPE(DocRef)!="L" THEN
			IF VAL(DocRef(1,12))=2 THEN
				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
						   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")
			ELSE
				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+" - "+;
						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
						   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
						   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
			ENDIF
		ENDIF
	ENDIF
ELSE
	vCadenaOBS=ALLTRIM(vObservaciones)
ENDIF


GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.Rut)) THEN 	
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

vNumeroDocumento='"'+vpTipodoc+vpFolioDoc+ALLTRIM(TipoDoc.id_SnII)+'"'

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
<soapenv:Header/>
<soapenv:Body>
<lsof:PutDTE>
	<lsof:dte>
		<lsof:Documento ID=<<vNumeroDocumento>>>
			<lsof:Encabezado>
				<lsof:IdDoc>
					<lsof:TipoDTE><<ALLTRIM(vpCodDoc)>></lsof:TipoDTE>
					<lsof:Folio><<ALLTRIM(vpFolioDoc)>></lsof:Folio>
					<lsof:FchEmis><<vpFechaIni>></lsof:FchEmis>
					<lsof:IndNoRebaja />
					<lsof:TipoDespacho />
					<lsof:IndTraslado />
					<lsof:TpoImpresion />
					<lsof:IndServicio />
					<lsof:MntBruto />
					<lsof:FmaPago><<ALLTRIM(vFormaDePago)>></lsof:FmaPago>
					<lsof:FmaPagExp />
					<lsof:FchCancel />
					<lsof:MntCancel />
					<lsof:SaldoInsol />
					<lsof:MntPagos />
					<lsof:PeriodoDesde />
					<lsof:PeriodoHasta />
					<lsof:MedioPago />
					<lsof:TpoCtaPago />
					<lsof:NumCtaPago />
					<lsof:BcoPago />
					<lsof:TermPagoCdg />
					<lsof:TermPagoGlosa />
					<lsof:TermPagoDias />
					<lsof:FchVenc><<vpFecVen>></lsof:FchVenc>
				</lsof:IdDoc>
				<lsof:Emisor>
					<lsof:RUTEmisor><<ALLTRIM(Empres.EmpRut)>></lsof:RUTEmisor>
					<lsof:RznSoc><<This.pFiltraEspeciales(ALLTRIM(Empres.empRaz))>></lsof:RznSoc>
					<lsof:GiroEmis><<This.pFiltraEspeciales(ALLTRIM(Empres.empGir))>></lsof:GiroEmis>
					<lsof:Telefono><<This.pFiltraEspeciales(ALLTRIM(Empres.Telefono))>></lsof:Telefono>
					<lsof:CorreoEmisor><<This.pFiltraEspeciales(ALLTRIM(Empres.Correoe))>></lsof:CorreoEmisor>
					<lsof:Acteco><<ALLTRIM(Empres.ACTECO)>></lsof:Acteco>
					<lsof:GuiaExport />
					<lsof:Sucursal />
					<lsof:CdgSIISucur><<ALLTRIM(Empres.SucSII)>></lsof:CdgSIISucur>
					<lsof:DirOrigen><<ALLTRIM(Empres.EmpDir)>></lsof:DirOrigen>
					<lsof:CmnaOrigen><<ALLTRIM(Empres.Comuna)>></lsof:CmnaOrigen>
					<lsof:CiudadOrigen><<ALLTRIM(Empres.Ciudad)>></lsof:CiudadOrigen>
					<lsof:CdgVendedor><<vpCodVend>></lsof:CdgVendedor>
					<lsof:IdAdicEmisor />
				</lsof:Emisor>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

***** Rutina que Filtra los caracteres especiales

vpNombreCliente		= This.pFiltraEspeciales(vpNombreCliente)
vpGiro				= This.pFiltraEspeciales(vpGiro)
vpContacto			= This.pFiltraEspeciales(vpContacto)
vpeMail				= This.pFiltraEspeciales(vpEmail)
vpDireccion			= This.pFiltraEspeciales(vpDireccion)
vpComuna			= This.pFiltraEspeciales(vpComuna)
vpCiudad			= This.pFiltraEspeciales(vpCiudad)
vpDireccionDespacho = This.pFiltraEspeciales(vpDireccionDespacho)
GO TOP IN prPrm
vpCoordenadas		= IIF(prPrm.ImpExt,ALLTRIM(vpCoordenadas),"")


IF EMPTY(ALLTRIM(vpGiro)) THEN
	vpGiro="PERSONA NATURAL"
ELSE
	IF LEN(ALLTRIM(vpGiro))>40 THEN
		vpGiro=SUBSTR(ALLTRIM(vpGiro),1,40)
	ELSE
		vpGiro=ALLTRIM(vpGiro)
	ENDIF
ENDIF

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
				<lsof:RUTMandante />
				<lsof:Receptor>
					<lsof:RUTRecep><<ALLTRIM(vpRutCliente)>></lsof:RUTRecep>
					<lsof:CdgIntRecep />
					<lsof:RznSocRecep><<ALLTRIM(vpNombreCliente)>></lsof:RznSocRecep>
					<lsof:Extranjero />
					<lsof:GiroRecep><<ALLTRIM(vpGiro)>></lsof:GiroRecep>
					<lsof:Contacto><<ALLTRIM(vpContacto)>></lsof:Contacto>
					<lsof:CorreoRecep><<ALLTRIM(vpeMail)>></lsof:CorreoRecep>
					<lsof:DirRecep><<ALLTRIM(vpDireccion)>></lsof:DirRecep>
					<lsof:CmnaRecep><<ALLTRIM(vpComuna)>></lsof:CmnaRecep>
					<lsof:CiudadRecep><<ALLTRIM(vpCiudad)>></lsof:CiudadRecep>
					<lsof:DirPostal />
					<lsof:CmnaPostal />
					<lsof:CiudadPostal />
				</lsof:Receptor>
				<lsof:RUTSolicita />
				<lsof:Transporte />
				<lsof:Totales>		
					<lsof:MntNeto><<ALLTRIM(STR(vpMontoNeto))>></lsof:MntNeto>
					<lsof:MntExe><<ALLTRIM(STR(vpMontoExento))>></lsof:MntExe>
					<lsof:MntBase />
					<lsof:MntMargenCom />
					<lsof:TasaIVA><<vpTasaIva>></lsof:TasaIVA>
					<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
					<lsof:IVAProp />
					<lsof:IVATerc />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

CALCULATE SUM(DscCur.MonDsc) FOR DscCur.TipDsc=9 TO vSumaImptoAdic IN DscCur

IF vSumaImptoAdic=0 THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:ImptoReten />
	ENDTEXT
	vEncabezado=vEncabezado+CHR(10)
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:ImptoReten>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
	
	SELECT Cod_IAD as Codigo, ImptoAdic.id_SNII as CodSii, ImptoAdic.Monto as Porcentaje, SUM(MonDsc) as Monto ;
		FROM DscCur ;
		LEFT JOIN ImptoAdic ON ImptoAdic.Codigo=Cod_IAD ;
		WHERE TipDsc=9 ;
		GROUP BY Cod_IAD ;
		INTO CURSOR cImptoAdic
		
	IF _Tally>0 THEN 	
		GO TOP IN cImptoAdic
		DO WHILE !EOF("cIMPTOADIC")
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
	                    <lsof:ImptoReten>
                           <lsof:TipoImp><<ALLTRIM(STR(cImptoAdic.CodSII))>></lsof:TipoImp>
                           <lsof:TasaImp><<ALLTRIM(STR(cImptoAdic.Porcentaje,5,2))>></lsof:TasaImp>
                           <lsof:MontoImp><<ALLTRIM(STR(cImptoAdic.Monto))>></lsof:MontoImp>
                        </lsof:ImptoReten>
			ENDTEXT
			
			vEncabezado=vEncabezado+CHR(10)
			
			SKIP IN cImptoAdic
		ENDDO 		
	ENDIF

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					</lsof:ImptoReten>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
ENDIF 	

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IVANoRet />
					<lsof:CredEC />
					<lsof:GrntDep />
					<lsof:Comisiones />
					<lsof:MntTotal><<ALLTRIM(STR(vpMontoTotal))>></lsof:MntTotal>
					<lsof:MontoNF />
					<lsof:MontoPeriodo />
					<lsof:SaldoAnterior />
					<lsof:VlrPagar />
				</lsof:Totales>
				<lsof:OtraMoneda />
			</lsof:Encabezado>
			<lsof:Detalle>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

SET ORDER TO 2 IN DscCur

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF DELETED("ITEMCUR") THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
	
	vCantidadItem=ALLTRIM(STR(ItemCur.Cantidad+(ItemCur.Fraccion/ItemCur.Envase),18,2))
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Detalle>
					<lsof:NroLinDet><<ALLTRIM(STR(ItemCur.Linea))>></lsof:NroLinDet>
					<lsof:CdgItem>
						<lsof:CdgItem>
							<lsof:TpoCodigo><<ALLTRIM(STR(ItemCur.Linea))>></lsof:TpoCodigo>
							<lsof:VlrCodigo><<ALLTRIM(Itemcur.Codigo)>></lsof:VlrCodigo>
						</lsof:CdgItem>
					</lsof:CdgItem>	
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	
	IF Itemcur.IndExe=0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe />
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe><<ALLTRIM(STR(Itemcur.IndExe))>></lsof:IndExe>
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)
		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Retenedor />
					<lsof:NmbItem><<ALLTRIM(ItemCur.Detalle))>></lsof:NmbItem>
					<lsof:DscItem />
					<lsof:QtyRef />
					<lsof:UnmdRef />
					<lsof:PrcRef />
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>	
					<lsof:Subcantidad />
					<lsof:FchElabor />
					<lsof:FchVencim />
					<lsof:UnmdItem><<ALLTRIM(This.pFiltraEspeciales(ItemCur.UniMed))>></lsof:UnmdItem>	
					<lsof:PrcItem><<ALLTRIM(STR(ItemCur.Precio,18,6))>></lsof:PrcItem>
					<lsof:OtrMnda />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)

	CALCULATE SUM(MonDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vMontoDescuentos
	CALCULATE SUM(PorDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vSumaDescuentos

	IF vMontoDescuentos=0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct />
					<lsof:DescuentoMonto />
					<lsof:SubDscto />
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct><<ALLTRIM(STR(vSumaDescuentos))>></lsof:DescuentoPct>
					<lsof:DescuentoMonto><<ALLTRIM(STR(vMontoDescuentos))>></lsof:DescuentoMonto>
					<lsof:SubDscto>
		ENDTEXT 		
		
		vEncabezado=vEncabezado+CHR(10)
	
		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF DELETED("DSCCUR") THEN
					SKIP IN DscCur
					LOOP
				ENDIF
				
				IF !INLIST(DscCur.TipDsc,1,2,3) THEN
					SKIP IN DscCur
					LOOP
				ENDIF
		
				vMonDsc=ALLTRIM(STR(DscCur.MonDsc))		
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:SubDscto>
							<lsof:TipoDscto>$</lsof:TipoDscto>
							<lsof:ValorDscto><<vMonDsc>></lsof:ValorDscto>
						</lsof:SubDscto>
				ENDTEXT
				vEncabezado=vEncabezado+CHR(10)
				SKIP IN DscCur
			ENDDO
		ENDIF 		

		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					</lsof:SubDscto>
		ENDTEXT
	ENDIF 		

	vEncabezado=vEncabezado+CHR(10)	
	
	CALCULATE SUM(MonDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,4,5) TO vMontoRecargos
	CALCULATE SUM(PorDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,4,5) TO vSumaRecargos

	IF vMontoRecargos=0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RecargoPct />
					<lsof:RecargoMonto />
					<lsof:SubRecargo />
		ENDTEXT 		
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RecargoPct><<ALLTRIM(STR(vSumaRecargos))>></lsof:RecargoPct>
					<lsof:RecargoMonto><<ALLTRIM(STR(vMontoRecargos))>></lsof:RecargoMonto>
					<lsof:SubRecargo>
		ENDTEXT 		
		
		vEncabezado=vEncabezado+CHR(10)
	
		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF DELETED("DSCCUR") THEN
					SKIP IN DscCur
					LOOP
				ENDIF
				
				IF !INLIST(DscCur.TipDsc,4,5) THEN
					SKIP IN DscCur
					LOOP
				ENDIF
		
				vMonRec=ALLTRIM(STR(DscCur.MonDsc))		
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:SubRecargo>
							<lsof:TipoRecargo>$</lsof:TipoRecargo>
							<lsof:ValorRecargo><<vMonRec>></lsof:ValorRecargo>>
						</lsof:SubRecargo>
				ENDTEXT
				vEncabezado=vEncabezado+CHR(10)
				SKIP IN DscCur
			ENDDO
		ENDIF 		

		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					</lsof:SubRecargo>
		ENDTEXT
	ENDIF

	vEncabezado=vEncabezado+CHR(10)	

	CALCULATE SUM(MonDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,9) TO vMontoImpAdi
	
	IF vMontoImpAdi>0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CodImpAdic>
		ENDTEXT
			
		GO TOP IN DscCur
		IF SEEK(ItemCur.Linea , "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF DscCur.TipDsc!=9 THEN
					SKIP IN DscCur
					LOOP
				ENDIF

				vEncabezado=vEncabezado+CHR(10)	
				
				IF SEEK(DscCur.Cod_Iad, "IMPTOADIC",1) THEN
					TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:CodImpAdic>
							<lsof:CodTipImp><<ALLTRIM(STR(ImptoAdic.id_Snii))>></lsof:CodTipImp>
						</lsof:CodImpAdic>
					ENDTEXT
					vEncabezado=vEncabezado+CHR(10)	
				ENDIF
				
				SKIP IN DscCur
			ENDDO
		ENDIF
		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
					</lsof:CodImpAdic>					
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
					<lsof:CodImpAdic />					
		ENDTEXT 		
	ENDIF

	vEncabezado=vEncabezado+CHR(10)		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:MontoItem><<ALLTRIM(STR(ItemCur.NetoDetalle))>></lsof:MontoItem>
				</lsof:Detalle>
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	SKIP IN ItemCur
ENDDO 		

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Detalle>	
			<lsof:SubTotInfo />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

IF VARTYPE(aDscRecCab(1,1))="L" THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal />
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal>
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	
	FOR vI=1 TO ALEN(aDscRecCab,1)
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
				<lsof:DscRcgGlobal>
					<lsof:NroLinDR><<ALLTRIM(STR(vI))>></lsof:NroLinDR>
					<lsof:TpoMov><<ALLTRIM(aDscRecCab(vI,1))>></lsof:TpoMov>
					<lsof:GlosaDR><<ALLTRIM(UPPER(aDscRecCab(vI,4)))>></lsof:GlosaDR>
					<lsof:TpoValor><<ALLTRIM(aDscRecCab(vI,3))>></lsof:TpoValor>
					<lsof:ValorDR><<ALLTRIM(STR(aDscRecCab(vI,2)))>></lsof:ValorDR>
					<lsof:ValorDROtrMnda />
		ENDTEXT
		vEncabezado=vEncabezado+CHR(10)
		IF aDscRecCab(vI,5)=0 THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:IndExeDR />
			ENDTEXT
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExeDR><<ALLTRIM(STR(aDscRecCab(vI,5)))>></lsof:IndExeDR>
			ENDTEXT
		ENDIF 		
		vEncabezado=vEncabezado+CHR(10)
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				</lsof:DscRcgGlobal>
		ENDTEXT
		vEncabezado=vEncabezado+CHR(10)
	ENDFOR

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:DscRcgGlobal>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
vNumeroLineaRef=0

IF VARTYPE(aCasoRef)!="U" .or. VARTYPE(DocRef)!="L" .or. VARTYPE(aOrdenCompra)!="U" THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)

	IF VARTYPE(aCasoRef)!="U" THEN
		vNumeroLineaRef=vNumeroLineaRef+1
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef>SET</lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(vpFolioDoc)))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<vpFechaIni>></lsof:FchRef>
					<lsof:CodRef />
					<lsof:RazonRef><<"CASO "+ALLTRIM(aCasoRef(1))>></lsof:RazonRef>
				</lsof:Referencia>					
		ENDTEXT
			
		vEncabezado=vEncabezado+CHR(10)
	ENDIF

	IF VARTYPE(DocRef)!="L" THEN 	
		FOR vI=1 TO ALEN(DocRef,1)
			vNumeroLineaRef=vNumeroLineaRef+1
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef><<ALLTRIM(DocRef(vI,14))>></lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(DocRef(vI,17))))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<ALLTRIM(DTOC(DocRef(vI,3)))>></lsof:FchRef>
					<lsof:CodRef><<ALLTRIM(DocRef(vI,12))>></lsof:CodRef>
			ENDTEXT
			vEncabezado=vEncabezado+CHR(10)
			IF VARTYPE(aCasoRef)!="U" THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RazonRef><<ALLTRIM(aCasoRef(2))>></lsof:RazonRef>
				</lsof:Referencia>
				ENDTEXT
			ELSE
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RazonRef><<ALLTRIM(DocRef(vI,42))>></lsof:RazonRef>
				</lsof:Referencia>
				ENDTEXT
			ENDIF
			
			vEncabezado=vEncabezado+CHR(10)
		ENDFOR
	ENDIF
	
	IF VARTYPE(aOrdenCompra)!="U" THEN
		FOR vI=1 TO ALEN(aOrdenCompra,1)
			vNumeroLineaRef=vNumeroLineaRef+1
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef>801</lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(aOrdenCompra(vI,3))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<ALLTRIM(DTOC(aOrdenCompra(vI,2)))>></lsof:FchRef>
					<lsof:CodRef />
					<lsof:RazonRef><<ALLTRIM(aOrdenCompra(vI,4))>></lsof:RazonRef>
				</lsof:Referencia>
			ENDTEXT
			vEncabezado=vEncabezado+CHR(10)
		ENDFOR 			
	ENDIF
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Referencia>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia />
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)

GO TOP IN prPrm

aAdjuntos(1)	=DTOC(DATE())+"T"+TIME()
aAdjuntos(2)	=""
aAdjuntos(3)	=""
aAdjuntos(4)	=""
aAdjuntos(5)	=""
aAdjuntos(6)	=""
aAdjuntos(7)	=""
aAdjuntos(8)	=vCadenaOBS
aAdjuntos(9)	=vpeMail
*aAdjuntos(10)	=aRespuesta(10)
aAdjuntos(10)	=""
aAdjuntos(11)	=vNombreDocumento+" # "+vpFolioDoc

IF SEEK(vgTipoDoc, "DEFDOC",1) THEN
	aAdjuntos(12)	=ALLTRIM(DefDoc.flPrini)
ELSE
	aAdjuntos(12)	=""
ENDIF
aAdjuntos(13)	="1"

GO TOP IN prPrm
DO CASE
	CASE vgTipoDoc="XE"
		vCopiasDoc=prprm.Copias1
	CASE vgTipoDoc="FE"
		vCopiasDoc=prprm.Copias2
	CASE vgTipoDoc="NE"
		vCopiasDoc=prprm.Copias3
	CASE vgTipoDoc="DE"
		vCopiasDoc=prprm.Copias4
	CASE vgTipoDoc="GE"
		vCopiasDoc=prprm.Copias5
OTHERWISE
	vCopiasDoc=2
ENDCASE

*!*	CALCULATE SUM(monDsc) IN DscCur FOR INLIST(TipoDsc,7,12) TO vSumaDscCabecera
*!*	CALCULATE SUM(monDsc) IN DscCur FOR INLIST(TipoDsc,10,13) TO vSumaRecCabecera
*!*	CALCULATE SUM(monDsc) IN DscCur FOR TipoDsc=9 TO vSumaDscImpAdi

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Comisiones />
            <lsof:Adjuntos>
                  <lsof:TmsFirma><<aAdjuntos(1)>></lsof:TmsFirma>
                  <lsof:DataBase64Archivo1><<Alltrim(aAdjuntos(2))>></lsof:DataBase64Archivo1>
                  <lsof:DataBase64Archivo2><<Alltrim(aAdjuntos(3))>></lsof:DataBase64Archivo2>
                  <lsof:DataBase64Archivo3><<Alltrim(aAdjuntos(4))>></lsof:DataBase64Archivo3>
                  <lsof:DataBase64Archivo4><<Alltrim(aAdjuntos(5))>></lsof:DataBase64Archivo4>
                  <lsof:DataBase64Archivo5><<Alltrim(aAdjuntos(6))>></lsof:DataBase64Archivo5>
                  <lsof:DataBase64Archivo6><<Alltrim(aAdjuntos(7))>></lsof:DataBase64Archivo6>
                  <lsof:Observacion><<Alltrim(aAdjuntos(8))>></lsof:Observacion>
                  <lsof:EmailReceptor><<Alltrim(aAdjuntos(9))>></lsof:EmailReceptor>
                  <lsof:EmailEmisor><<This.pFiltraEspeciales(Alltrim(aAdjuntos(10)))>></lsof:EmailEmisor>
                  <lsof:Subject><<This.pFiltraEspeciales(Alltrim(aAdjuntos(11)))>></lsof:Subject>
                  <lsof:Impresora><<Alltrim(aAdjuntos(12))>></lsof:Impresora>
                  <lsof:Copias><<Alltrim(STR(vCopiasDoc))>></lsof:Copias>
				  <lsof:DireccionDespacho><<IIF(VARTYPE(vpDireccionDespacho)="L", "", ALLTRIM(vpDireccionDespacho))>></lsof:DireccionDespacho>
				  <lsof:NotaDeVenta><<IIF(VARTYPE(vpNotaVenta)="L","", vpNotaVenta)>></lsof:NotaDeVenta>
				  <lsof:CoordenadasDespacho><<IIF(VARTYPE(vpCoordenadas)="L","", ALLTRIM(vpCoordenadas))>></lsof:CoordenadasDespacho>
                  <lsof:SucursalReceptor><<ALLTRIM(vpSucursalRecepcion)>></lsof:SucursalReceptor>
                  <lsof:MedioPago><<ALLTRIM(vpMedioPago)>></lsof:MedioPago>
                  <lsof:MontoDescuentoCabecera><<ALLTRIM(STR(vSumaDscCabecera,15,0))>></lsof:MontoDescuentoCabecera>
                  <lsof:MontoRecargoCabecera><<ALLTRIM(STR(vSumaRecCabecera,15,0))>></lsof:MontoRecargoCabecera>
                  <lsof:TotalImpuestosAdicionales><<ALLTRIM(STR(vSumaDscImpAdi,15,0))>></lsof:TotalImpuestosAdicionales>
               </lsof:Adjuntos>		
		</lsof:Documento>
	</lsof:dte>
</lsof:PutDTE>
</soapenv:Body>
</soapenv:Envelope>	
ENDTEXT


vArchivo=ADDBS(ALLTRIM(StdXML))+"PRUEBA"+vgTipoDoc+vpFolioDoc+"-"+;
		  PADL(ALLTRIM(STR(HOUR(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(MINUTE(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(SEC(DATETIME()))),2,"0")+;
		  ".XML"
		
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Clientes, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
ELSE
	vGrab = FPUT(vXML,vEncabezado)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	ELSE
		IF !FCLOSE(vXML) then
			=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
		ENDIF
	ENDIF
ENDIF

RETURN vEncabezado
ENDPROC
PROCEDURE rutina1c
LPARAMETERS vpCodigo, vpFecha, vpCantidad, vpFraccion, vpDscto, vpRecargo, vpPrecio, ;
			vpLinea, vpDsctoCab, vpDsctoMonCab, vpRecCab, vpRecMonCab, vpDetalle,;
			vpTipoGuia, vpTipoDsctoRecCabecera, vCodIad, vRet, vpExenta, vpUniMed, vpBodega, ;
			vpBodegaIN, vpCodGto, VpActFijo

IF !USED("ITEMCUR") .and. !USED("DSCCUR") THEN
	=MESSAGEBOX("No se encuentran uno o mas cursores")
	RETURN .f.
ENDIF

vPrecioOriginal=vpPrecio
IF vpLinea=0 THEN
	CALCULATE MAX(Linea) TO vMaximaLinea IN ItemCur
	vSiguienteLinea=vMaximaLinea+1
ELSE
	vSiguienteLinea=vpLinea
ENDIF

STORE "" TO vUnidadMedida
STORE 0 TO vUnidadesXenvase

STORE 0 TO vMontoDscto, vMontoRecargo, vMontoExento, vMontoAfecto, vPrecioNeto, vPrecioNetoDetalle
		
STORE "N" TO vProductoExento, vNoApliDes

vDocGuia=.f.

IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vDocExento=TipoDoc.Exento	
	vDocGuia=TipoDoc.Traslado
ELSE
	=MESSAGEBOX("El Tipo de Documento no es valido")
	RETURN .f.
ENDIF

vProsigueDescuentos=.f.

IF vDocGuia THEN
	IF !vpTipoGuia THEN
		vProsigueDescuentos=.t.
	ENDIF
ELSE
	vProsigueDescuentos=.t.
ENDIF

IF !EMPTY(ALLTRIM(vpCodigo)) THEN
	IF !SEEK(vpCodigo, "PRODUCTO", 1) THEN
		=MESSAGEBOX("Producto no se encuentra en Maestra de Productos, no es posible Actualizar")
		RETURN .f.
	ELSE
		vUnidadesxEnvase	=Producto.UnixEnv		
	ENDIF
ELSE
	vUnidadesxEnvase	=1
ENDIF

vUnidadMedida		=vpUniMed
vProductoExento		=vpExenta

vLineaNetoOriginal	=This.mRedondeo(vpPrecio*(vpCantidad+(vpFraccion/vUnidadesXenvase)))

IF vpDscto>100 THEN
	=MESSAGEBOX("(000002). Descuentos son Mayores que el 100%"+CHR(13)+;
				" - Descuento x Linea: "+ALLTRIM(STR(vpDscto,7,3)))
	RETURN .f.
ENDIF
IF vpExenta!="E" THEN
	IF vpDscto>0  THEN
		IF !SEEK(STR(vSiguienteLinea,4)+"3","DSCCUR",3) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vSiguienteLinea, 3, vpDscto, ;
								This.mRedondeo(vLineaNetoOriginal*(vpDscto/100)), ;
								vpCodigo, vpFecha,1)
		ELSE 	
			Replace PorDsc WITH vpDscto, ;
					MonDsc WITH This.mRedondeo(vLineaNetoOriginal*(vpDscto/100)) IN DscCur
		ENDIF
		vMontoDscto=vMontoDscto+This.mRedondeo(vLineaNetoOriginal*(vpDscto/100))
	ENDIF

	IF vpRecargo>0  THEN
		IF !SEEK(STR(vSiguienteLinea,4)+"4","DSCCUR",3) THEN
			INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
						VALUES (vSiguienteLinea, 4, vpRecargo, ;
								This.mRedondeo(vLineaNetoOriginal*(vpRecargo/100)), ;
								vpCodigo, vpFecha,2)
		ELSE 	
			Replace PorDsc WITH vpRecargo, ;
					MonDsc WITH This.mRedondeo(vLineaNetoOriginal*(vpRecargo/100)) IN DscCur
		ENDIF
		vMontoRecargo=vMontoRecargo+This.mRedondeo(vLineaNetoOriginal*(vpRecargo/100))
	ENDIF
ENDIF

vPrecioNetoDetalle=vLineaNetoOriginal-vMontoDscto+vMontoRecargo

*!*	vPrecioOriginal	= El Precio Inicial de 1 producto (s/g Maestra de Productos) por las Cantidades a Vender
*!*	vPrecioNeto		= vPrecioOriginal + Monto Flete (Cargo)
*!*	vpPrecio		= Precio individual de 1 producto como esta en la MAestra de Precios a nivel NETO
*!*	vPrecioNetoFinal= vPrecioOriginal - DescuentosLinea - DescuentosCabecera

STORE 0 TO vMontoAfecto, vMontoExento
IF vpExenta="E" THEN
	vMontoAfecto=0
	vMontoExento=vPrecioNetoDetalle	
ELSE
	vMontoAfecto=vPrecioNetoDetalle
	vMontoExento=0
ENDIF

INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
					 Subtot, Afecto, Detalle, Unimed, Exento, Bodega, ;
					 BodegaIN, noApliDes, Envase, NetoDetalle, Cod_Iad, CodGto, ActFijo) ;
			VALUES  (vpCodigo, vpCantidad, vpFraccion, vPrecioOriginal, ;
					 vSiguienteLinea, vpPrecio, IIF(vMontoExento=0,vLineaNetoOriginal,0), ;
					 vMontoAfecto, ALLTRIM(vpDetalle), ;
					 vUnidadMedida, vMontoExento, ;
					 vpBodega, vpBodegaIN, "", vUnidadesXenvase, vPrecioNetoDetalle, ;
					 IIF(vCodIAD>0, aImptoAdi(vCodIAD,2),0), vpCodGto, VpActFijo)

This.pCalculaDSCRECCab(vpTipoDsctoRecCabecera, vpDsctoCab, vpDsctoMonCab, vpRecCab, vpRecMonCab, vDocExento, vpFecha, vRet, vgTasaIVA)
This.pCalculaIAD(vpFecha)

RETURN vSiguienteLinea






ENDPROC
PROCEDURE rutina2
LPARAMETERS vpTipoNotaCredito

SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur

IF vpTipoNotaCredito=1 THEN
	GO TOP IN CanCur
	DO WHILE !EOF("CANCUR")
		IF !EMPTY(ALLTRIM(CanCur.Codigo)) THEN
			IF !SEEK(CanCur.Codigo, "PRODUCTO",1) THEN
				=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(ItemCur.Codigo)+")")
				SKIP IN ItemCur
			ENDIF
		ENDIF
			
		STORE 0 TO vMontoDscto, vPorcentajeDscto, vCargosAdicionales, vImpuestoIVA, vTotalDscto, vTotalLinea
		STORE 0 TO vCantidadDevuelta, vFraccionDevuelta, vPrecioOrigDev

		IF !SEEK(CanCur.Linea, "COPIACUR",1) THEN
			SKIP IN CanCur
			LOOP
		ENDIF
		
		IF SEEK(CanCur.Linea, "ITEMCUR",1) THEN
			vPrecioOrigDev=ItemCur.PrecioOrig
			vCantidadDevuelta=ItemCur.Cantidad
			vFraccionDevuelta=ItemCur.Fraccion
			IF (ItemCur.Cantidad+ItemCur.Fraccion)>0 THEN
				vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)
			ENDIF
			
			IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
				DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
					vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)

					IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
						INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
									VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea,"01")
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ENDIF
		ENDIF
		
		STORE 0 TO vCantidadOriginal, vFraccionOriginal
		
		vCantidadOriginal=CanCur.Cantidad
		vFraccionOriginal=CanCur.Fraccion
		
		INSERT INTO VisualCur (StrLinea, Codigo, Detalle, Cantidad, Fraccion, CanDev, FraDev, Precio, Dscto, ;
							   MonDscto, Total, Linea, Nivel) ;
					   VALUES (ALLTRIM(STR(CanCur.Linea)), CopiaCur.Codigo, CopiaCur.Detalle, ;
							   vCantidadOriginal, vFraccionOriginal, ;
							   vCantidadDevuelta, vFraccionDevuelta, ItemCur.PrecioOrig, ;
							   vPorcentajeDscto, vMontoDscto, vTotalLinea, CopiaCur.Linea, "00")

		SKIP IN CanCur
	ENDDO
ELSE
	GO TOP IN ItemCur
	DO WHILE !EOF("ITEMCUR")
		STORE 0 TO vMontoDscto, vPorcentajeDscto, vCargosAdicionales, vImpuestoIVA, vTotalDscto, vTotalLinea
		STORE 0 TO vCantidadDevuelta, vFraccionDevuelta, vPrecioOrigDev

		vPrecioOrigDev=ItemCur.PrecioOrig
		vCantidadDevuelta=ItemCur.Cantidad
		vFraccionDevuelta=ItemCur.Fraccion

		IF (ItemCur.Cantidad+ItemCur.Fraccion)>0 THEN
			vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)
		ENDIF

		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)

				IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
					INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
								VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea,"01")
				ENDIF
				
				SKIP IN DscCur
			ENDDO
		ENDIF
		
*!*			STORE 0 TO vCantidadOriginal, vFraccionOriginal
*!*			
*!*			vCantidadOriginal=ItemCur.Cantidad
*!*			vFraccionOriginal=ItemCur.Fraccion
		
		INSERT INTO VisualCur (StrLinea, Codigo, Detalle, CanDev, FraDev, Precio, Dscto, ;
							   MonDscto, Total, Linea, Nivel) ;
					   VALUES (ALLTRIM(STR(ItemCur.Linea)), "", ItemCur.Detalle, ;
							   vCantidadDevuelta, vFraccionDevuelta, ItemCur.PrecioOrig, ;
							   vPorcentajeDscto, vMontoDscto, vTotalLinea, ItemCur.Linea, "00")
		
		SKIP IN ItemCur
	ENDDO
ENDIF

ENDPROC
PROCEDURE rutina2c
SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur
SET ORDER TO 1 IN OriCur

IF vgTipoNotacredito=1 THEN
	GO TOP IN OriCur
	DO WHILE !EOF("ORICUR")
		IF !EMPTY(ALLTRIM(OriCur.Codigo)) THEN
			IF !SEEK(OriCur.Codigo, "PRODUCTO",1) THEN
				=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(OriCur.Codigo)+")")
				SKIP IN OriCur
			ENDIF
		ENDIF

		STORE 0 TO vSumPorDscto, vSumMonDscto, vSumPorRec, vSumMonRec, vTotalCaracteristica
		STORE 0 TO vCantidadDevuelta, vFraccionDevuelta, vPrecioOriginal
		
		IF SEEK(OriCur.Linea, "ITEMCUR",1) THEN
			vCantidadDevuelta=ItemCur.Cantidad
			vFraccionDevuelta=ItemCur.Fraccion
			vPrecioOriginal=ItemCur.PrecioOrig

			IF SEEK(OriCur.Linea, "DSCCUR",2) THEN
				DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=OriCur.Linea
					IF INLIST(DscCur.TipDSC,1,2,3,4,5) THEN && Solamente Dsc y Rec de Linea
						IF DscCur.ModDsc=1 THEN
							vSumPorDscto=vSumPorDscto+DscCur.PorDsc
							vSumMonDscto=vSumMonDscto+DscCur.monDsc
						ELSE
							vSumPorRec=vSumPorRec+DscCur.PorDsc
							vSumMonRec=vSumMonRec+DscCur.MonDsc
						ENDIF
					ENDIF
								
					vTotalCaracteristica=vTotalCaracteristica+DscCur.MonDsc
					
					vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)
					
*!*		CREATE CURSOR DscCur (Linea n(4), TipDsc n(2), PorDsc n(5,2), MonDsc n(15,3), CodPro c(15),;
*!*							  Fecha d(8), ModDsc n(1), Cod_Iad c(2))


*!*		CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(80), Cantidad n(10), Fraccion n(5), ;
*!*								 CanDev n(10), FraDev n(10), Precio n(10,2), ;
*!*								 Dscto n(8,3), MonDscto n(15,2), ;
*!*								 Recargo n(8,3), MonRecargo n(15,2), ;
*!*								 Total n(15), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad c(2), Exento l(1))
						
					IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
						IF DscCur.ModDsc=1 THEN
							INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
										VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, OriCur.Linea,;
												PADL(ALLTRIM(STR(DscCur.TipDsc)),2,"0"))
						ELSE
							INSERT INTO VisualCur (Detalle, Recargo, MonRecargo, Linea, Nivel) ;
										VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, OriCur.Linea,;
												PADL(ALLTRIM(STR(DscCur.TipDsc)),2,"0"))
						ENDIF 						
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ENDIF
		ENDIF
		
		vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)

	*!*		CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(80), Cantidad n(10), Fraccion n(5), ;
	*!*								 CanDev n(10), FraDev n(10), Precio n(10,2), ;
	*!*								 Dscto n(8,3), MonDscto n(15,2), ;
	*!*								 Recargo n(8,3), MonRecargo n(15,2), ;
	*!*								 Total n(15), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad c(2), Exento l(1))
								 	
		INSERT INTO VisualCur (StrLinea, Codigo, Detalle, Cantidad, Fraccion, CanDev, FraDev, Precio, Dscto, ;
							   MonDscto, Recargo, MonRecargo, Total, Linea, Nivel, Exento) ;
					   VALUES (ALLTRIM(STR(OriCur.Linea)), OriCur.Codigo, OriCur.Detalle, ;
							   OriCur.Cantidad, OriCur.Fraccion, ;
							   vCantidadDevuelta, vFraccionDevuelta, vPrecioOriginal, ;
							   vSumPorDscto, vSumMonDscto, vSumPorRec, vSumMonRec, vTotalLinea, OriCur.Linea, "00",;
							   (OriCur.Exento>0))

		SKIP IN OriCur
	ENDDO
ELSE
	GO TOP IN ItemCur
	DO WHILE !EOF("ITEMCUR")
		IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
			IF !SEEK(ItemCur.Codigo, "PRODUCTO",1) THEN
				=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(ItemCur.Codigo)+")")
				SKIP IN ItemCur
			ENDIF
		ENDIF

		STORE 0 TO vSumPorDscto, vSumMonDscto, vSumPorRec, vSumMonRec, vTotalCaracteristica
		STORE 0 TO vPrecioOriginal
		
		IF SEEK(ItemCur.Linea, "ITEMCUR",1) THEN
			IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
				DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
					vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc)

					IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
						INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
									VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea,;
											PADL(ALLTRIM(STR(DscCur.TipDsc)),2,"0"))
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ENDIF
		ENDIF
		
		vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)

	*!*		CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(80), Cantidad n(10), Fraccion n(5), ;
	*!*								 CanDev n(10), FraDev n(10), Precio n(10,2), ;
	*!*								 Dscto n(8,3), MonDscto n(15,2), ;
	*!*								 Recargo n(8,3), MonRecargo n(15,2), ;
	*!*								 Total n(15), Linea n(4), Nivel c(2), Marca l(1), Cod_Iad c(2), Exento l(1))
								 	
		INSERT INTO VisualCur (StrLinea, Detalle, CanDev, FraDev, Precio, Total, Linea, Nivel, Exento) ;
					   VALUES (ALLTRIM(STR(ItemCur.Linea)), ItemCur.Detalle, ;
							   ItemCur.Cantidad, ItemCur.Fraccion, ItemCur.PrecioOrig, ;
							   vTotalLinea, ItemCur.Linea, "00",(ItemCur.Exento>0))

		SKIP IN ItemCur
	ENDDO
ENDIF

ENDPROC
PROCEDURE rutina3
LPARAMETERS vpCodigo, vpDetalle, vpFecha, vpCantidad, vpFraccion, vpPrecio, vpLinea, ;
			vpSubtot, vpUniMed, vpEnvase, vpTasaIva, vpCodIla, vpNoDesc, vpExento, vpBodega, vpBodegaIn, ;
			vpParcial

STORE 0 TO vAfectoDoc, vExento

IF vpExento!="E" THEN
	vAfectoDoc=vpSubTot
ELSE
	vExento=vpSubTot
ENDIF

IF vpParcial THEN
	INSERT INTO CopiaCur (Codigo, Detalle, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						  Subtot, Afecto, UniMed, Envase, CodIla, noApliDes, Exento, Bodega, BodegaIN,;
						  NetoDetalle) ;
				  VALUES (vpCodigo, vpDetalle, vpCantidad, vpFraccion, vpSubTot, ;
						  vpLinea, vpPrecio, vpSubTot, vAfectoDoc, vpUniMed, vpEnvase, vpCodIla, ;
						  vpNoDesc, vExento, vpBodega, vpBodegaIn, vAfectoDoc)
ELSE
	INSERT INTO ItemCur  (Codigo, Detalle, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						  Subtot, Afecto, UniMed, Envase, CodIla, noApliDes, Exento, Bodega, BodegaIN,;
						  NetoDetalle) ;
				  VALUES (vpCodigo, vpDetalle, vpCantidad, vpFraccion, vpSubTot, ;
						  vpLinea, vpPrecio, vpSubTot, vAfectoDoc, vpUniMed, vpEnvase, vpCodIla, ;
						  vpNoDesc, vExento, vpBodega, vpBodegaIn, vAfectoDoc)
ENDIF 						
				
ENDPROC
PROCEDURE rutina3c
LPARAMETERS vpCodigo, vpDetalle, vpFecha, vpCantidad, vpFraccion, vpPrecio, vpLinea, ;
			vpSubtot, vpUniMed, vpEnvase, vpTasaIva, vpCodIla, vpNoDesc, vpExento, vpBodega, vpBodegaIn

STORE 0 TO vDescuentosLinea, vRecargoFlete, vAfectoDoc, vExento

IF vpExento!="E" THEN
	vAfectoDoc=vpSubTot+vRecargoFlete-vDescuentosLinea
ELSE
	vExento=vpSubTot+vRecargoFlete-vDescuentosLinea
ENDIF


INSERT INTO ItemCur (Codigo, Detalle, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
					 Subtot, Afecto, UniMed, Envase, CodIla, noApliDes, Exento, Bodega, BodegaIN,;
					 NetoDetalle) ;
			VALUES  (vpCodigo, vpDetalle, vpCantidad, vpFraccion, vpSubTot+vRecargoFlete, ;
					 vpLinea, vpPrecio, vpSubTot, vAfectoDoc, vpUniMed, vpEnvase, vpCodIla, ;
					 vpNoDesc, vExento, vpBodega, vpBodegaIn, vAfectoDoc)
ENDPROC
PROCEDURE rutina4
LPARAMETERS vpTipoDoc, vpFolioDoc, vpCodDoc, vpModDoc, vpFechaIni, vpFecVen, vpRutCliente, vpNombreCliente, ;
			vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad, vpMontoNeto, ;
			vpMontoExento, vpTasaIVA, vpMontoIVA, vpMontoTotal, vpMontoDescuentoGlobal, ;
			vpTipoRef, vpFolioRef, vpFecRef, vpTipoAnulacion, vpMotivoRef


*!*	aRespuesta(1)	= Identificador del Cliente
*!*	aRespuesta(2)	= Rut del Emisor
*!*	aRespuesta(3)	= Digito Verificador del Cliente
*!*	aRespuesta(4)	= Nombre del Cliente
*!*	aRespuesta(5)	= Razon Social del Cliente
*!*	aRespuesta(6)	= Giro
*!*	aRespuesta(7)	= ACTECO
*!*	aRespuesta(8)	= Codigo Sucursal SNII
*!*	aRespuesta(9)	= Telefono Contacto
*!*	aRespuesta(10)	= Correo Electronico

#DEFINE NivelPrimario    CHR(9)
#DEFINE NivelSecundario  CHR(9)+CHR(9)
#DEFINE NivelTerciario   CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelCuaternario CHR(9)+CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelQuinto		 CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelSexto		 CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)

vArchivo="c:\zPaso\XMLDTE.XML"
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Clientes, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
	
	RETURN .f.
ENDIF

TEXT TO vEncabezado NOSHOW FLAGS 1
<?xml version="1.0" encoding="ISO-8859-1"?>
<DTE version="1.0">
	<Documento ID="F60T33">
		<Encabezado>
			<IdDoc>
ENDTEXT
vGrab = FPUT(vXML,vEncabezado)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

vSentencia=""
FOR vI=1 TO 4
	DO CASE
		CASE vI=1
			vSentencia=NivelCuaternario+"<TipoDTE>"+vpCodDoc+"</TipoDTE>"
		CASE vI=2
			vSentencia=NivelCuaternario+"<Folio>"+vpFolioDoc+"</Folio>"
		CASE vI=3
			vSentencia=NivelCuaternario+"<FchEmis>"+DTOC(vpFechaIni)+"</FchEmis>"
		CASE vI=4
			vgModalidad=""
			IF vpTipoDoc="NC" THEN
				vSentencia=NivelCuaternario+"<IndNoRebaja>"+ALLTRIM(vgModalidad)+"</IndNoRebaja>"
			ELSE
				vSentencia=NivelCuaternario+"<IndNoRebaja/>"
			ENDIF
	ENDCASE

	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDFOR

TEXT TO vVarDatosDTE NOSHOW FLAGS 1
				<TipoDespacho />
				<IndTraslado />
				<TpoImpresion />
				<IndServicio />
				<MntBruto />
				<FmaPago />
				<FmaPagExp />
				<FchCancel />
				<MntCancel />
				<SaldoInsol />
				<MntPagos />
				<PeriodoDesde />
				<PeriodoHasta />
				<MedioPago />
				<TpoCtaPago />
				<NumCtaPago />
				<BcoPago />
				<TermPagoCdg />
				<TermPagoGlosa />
				<TermPagoDias />
ENDTEXT

vGrab = FPUT(vXML,NivelCuaternario+"<FchVenc>"+DTOC(vpFecVen)+"</FchVenc>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF
	
TEXT TO vSegundaFase NOSHOW FLAGS 1
			</IdDoc>
			<Emisor>
ENDTEXT

vGrab = FPUT(vXML,vSegundaFase)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF

FOR vI=1 TO 18
	DO CASE
		CASE vI=1
			vSentencia=NivelCuaternario+'<RUTEmisor/>'
		CASE vI=2
			vSentencia=NivelCuaternario+'<RznSoc/>'
		CASE vI=3
			vSentencia=NivelCuaternario+'<GiroEmis/>'
		CASE vI=4
			vSentencia=NivelCuaternario+'<Telefono/>'
		CASE vI=5
			vSentencia=NivelCuaternario+'<CorreoEmisor/>'
		CASE vI=6
			vSentencia=NivelCuaternario+'<Acteco/>'
		CASE vI=7
			vSentencia=NivelCuaternario+'<GuiaExport>'
		CASE vI=8
			vSentencia=NivelQuinto+'<CdgTraslado/>'
		CASE vI=9
			vSentencia=NivelQuinto+'<FolioAut/>'
		CASE vI=10
			vSentencia=NivelQuinto+'<FchAut/>'
		CASE vI=11
			vSentencia=NivelCuaternario+'</GuiaExport>'
		CASE vI=12
			vSentencia=NivelCuaternario+'<Sucursal/>'
		CASE vI=13
			vSentencia=NivelCuaternario+'<CdgSIISucur/>'
		CASE vI=14
			vSentencia=NivelCuaternario+'<DirOrigen/>'
		CASE vI=15
			vSentencia=NivelCuaternario+'<CmnaOrigen/>'
		CASE vI=16
			vSentencia=NivelCuaternario+'<CiudadOrigen/>'
		CASE vI=17
			vSentencia=NivelCuaternario+'<CdgVendedor/>'
		CASE vI=18
			vSentencia=NivelCuaternario+'<IdAdicEmisor/>'
	ENDCASE
	
	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

		RETURN .f.
	ENDIF
ENDFOR

TEXT TO vVarPaso NOSHOW FLAGS 1
			</Emisor>
			<RUTMandante />
			<Receptor>
ENDTEXT

vGrab = FPUT(vXML,vVarPaso)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

FOR vI=1 TO 16
	DO CASE
		CASE vI=1
			vSentencia=NivelCuaternario+"<RUTRecep>"+vpRutCliente+"</RUTRecep>"
		CASE vI=2
			vSentencia=NivelCuaternario+"<CdgIntRecep />"
		CASE vI=3
			IF !EMPTY(ALLTRIM(vpNombreCliente)) THEN
				vSentencia=NivelCuaternario+"<RznSocRecep>"+ALLTRIM(vpNombreCliente)+"</RznSocRecep>"
			ELSE
				vSentencia=NivelCuaternario+"<RznSocRecep/>"
			ENDIF
		CASE vI=4
			vSentencia=NivelCuaternario+"<Extranjero />"
		CASE vI=5
			vSentencia=NivelQuinto+"<NumId />"
		CASE vI=6
			vSentencia=NivelQuinto+"<Nacionalidad/>"
		CASE vI=7
			vSentencia=NivelCuaternario+"</Extranjero>"
		CASE vI=8
			IF !EMPTY(ALLTRIM(vpGiro)) THEN
				vSentencia=NivelCuaternario+"<GiroRecep>"+ALLTRIM(vpGiro)+"</GiroRecep>"
			ELSE
				vSentencia=NivelCuaternario+"<GiroRecep />"
			ENDIF
		CASE vI=9
			IF !EMPTY(ALLTRIM(vpContacto)) THEN
				vSentencia=NivelCuaternario+"<Contacto>"+ALLTRIM(vpContacto)+"</Contacto>"
			ELSE
				vSentencia=NivelCuaternario+"<Contacto />"
			ENDIF
		CASE vI=10
			IF !EMPTY(ALLTRIM(vpeMail)) THEN
	 			vSentencia=NivelCuaternario+"<CorreoRecep>"+ALLTRIM(vpeMail)+"</CorreoRecep>"
	 		ELSE
	 			vSentencia=NivelCuaternario+"<CorreoRecep />"
	 		ENDIF
		CASE vI=11
			IF !EMPTY(ALLTRIM(vpDireccion)) THEN
	 			vSentencia=NivelCuaternario+"<DirRecep>"+ALLTRIM(vpDireccion)+"</DirRecep>"
	 		ELSE
	 			vSentencia=NivelCuaternario+"<DirRecep />"
	 		ENDIF
		CASE vI=12
			IF !EMPTY(ALLTRIM(vpComuna)) THEN
	 			vSentencia=NivelCuaternario+"<CmnaRecep>"+ALLTRIM(vpComuna)+"</CmnaRecep>"
	 		ELSE
	 			vSentencia=NivelCuaternario+"<CmnaRecep />"
	 		ENDIF
		CASE vI=13
			IF !EMPTY(ALLTRIM(vpCiudad)) THEN
	 			vSentencia=NivelCuaternario+"<CiudadRecep>"+ALLTRIM(vpCiudad)+"</CiudadRecep>"
	 		ELSE
	 			vSentencia=NivelCuaternario+"<CiudadRecep />"
	 		ENDIF
		CASE vI=14
			vSentencia=NivelCuaternario+"<DirPostal/>"
		CASE vI=15
			vSentencia=NivelCuaternario+"<CmnaPostal/>"
		CASE vI=16
			vSentencia=NivelCuaternario+"<CiudadPostal/>"
	ENDCASE

	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDFOR

vGrab = FPUT(vXML,NivelCuaternario+"</Receptor>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

vGrab = FPUT(vXML,NivelTerciario+"<RUTSolicita/>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

TEXT TO vSentencia NOSHOW FLAGS 1
			<Transporte>
				<Patente />
				<RUTTrans />
				<Chofer />
				<DirDest />
				<CmnaDest />
				<CiudadDest />
				<Aduana>
					<CodModVenta />
					<CodClauVenta />
					<TotClauVenta />
					<CodViaTransp />
					<NombreTransp />
					<RUTCiaTransp />
					<NomCiaTransp />
					<IdAdicTransp />
					<Booking />
					<Operador />
					<CodPtoEmbarque />
					<IdAdicPtoEmb />
					<CodPtoDesemb />
					<IdAdicPtoDesemb />
					<Tara />
					<CodUnidMedTara />
					<PesoBruto />
					<CodUnidPesoBruto />
					<PesoNeto />
					<CodUnidPesoNeto />
					<TotItems />
					<TotBultos />
					<TipoBultos>
						<CodTpoBultos />
						<CantBultos />
						<Marcas />
						<IdContainer />
						<Sello />
						<EmisorSello />
					</TipoBultos>
					<MntFlete />
					<MntSeguro />
					<CodPaisRecep />
					<CodPaisDestin />
				</Aduana>
			</Transporte>
ENDTEXT

vGrab = FPUT(vXML,vSentencia)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

vGrab = FPUT(vXML,NivelTerciario+"<Totales>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

FOR vI=1 TO 26
	DO Case
		CASE vI=1
			vSentencia="<MntNeto>"+ALLTRIM(STR(vpMontoNeto,18))+"</MntNeto>"
		CASE vI=2
			vSentencia="<MntExe>"+ALLTRIM(STR(vpMontoExento,18))+"</MntExe>"
		CASE vI=3
			vSentencia="<MntBase />"
		CASE vI=4
			vSentencia="<MntMargenCom />"
		CASE vI=5
			vSentencia="<TasaIVA>"+ALLTRIM(STR(vpTasaIva,5,2))+"</TasaIVA>"
		CASE vI=6
			vSentencia="<IVA>"+ALLTRIM(STR(vpMontoIva))+"</IVA>"
		CASE vI=7
			vSentencia="<IVAProp/>"
		CASE vI=8
			vSentencia="<IVATerc/>"
		CASE vI=9
			vSentencia="<ImptoReten>"
		CASE vI=10
			vSentencia="	<TipoImp />"
		CASE vI=11
			vSentencia="	<TasaImp />"
		CASE vI=12
			vSentencia="	<MontoImp />"
		CASE vI=13
			vSentencia="</ImptoReten>"
		CASE vI=14
			vSentencia="<IVANoRet />"
		CASE vI=15
			vSentencia="<CredEC />"
		CASE vI=16
			vSentencia="<GrntDep />"
		CASE vI=17
			vSentencia="<Comisiones>"
		CASE vI=18
			vSentencia="	<ValComNeto />"
		CASE vI=19
			vSentencia="	<ValComExe />"
		CASE vI=20
			vSentencia="	<ValComIVA />"
		CASE vI=21
			vSentencia="</Comisiones>"
		CASE vI=22
			vSentencia="<MntTotal>"+ALLTRIM(STR(vpMontoTotal))+"</MntTotal>"
		CASE vI=23
			vSentencia="<MontoNF />"
		CASE vI=24
			vSentencia="<MontoPeriodo />"
		CASE vI=25
			vSentencia="<SaldoAnterior />"
		CASE vI=26
			vSentencia="<VlrPagar />"
	ENDCASE
	vSentencia=NivelCuaternario+vSentencia

	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDFOR

vGrab = FPUT(vXML,NivelTerciario+"</Totales>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF

TEXT TO vSentencia NOSHOW FLAGS 1
			<OtraMoneda>
				<TpoMoneda />
				<TpoCambio />
				<MntNetoOtrMnda />
				<MntExeOtrMnda />
				<MntFaeCarneOtrMnda />
				<MntMargComOtrMnda />
				<IVAOtrMnda />
				<ImpRetOtrMnda>
					<TipoImpOtrMnda />
					<TasaImpOtrMnda />
					<VlrImpOtrMnda />
				</ImpRetOtrMnda>
				<IVANoRetOtrMnda />
				<MntTotOtrMnda />
			</OtraMoneda>
ENDTEXT

vGrab = FPUT(vXML,vSentencia)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

vGrab = FPUT(vXML,NivelSecundario+"</Encabezado>")
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")

	RETURN .f.
ENDIF

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF DELETED("ITEMCUR") THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
	
	vGrab = FPUT(vXML,NivelSecundario+"<Detalle>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NroLinDet>"+ALLTRIM(STR(ItemCur.Linea))+"</NroLinDet>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<CdgItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<TpoCodigo>INT1</TpoCodigo>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<VlrCodigo>"+ALLTRIM(ItemCur.Codigo)+"</VlrCodigo>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"</CdgItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vSentencia NOSHOW FLAGS 1
			<IndExe />
			<Retenedor>
				<IndAgente />
				<MntBaseFaena />
				<MntMargComer />
				<PrcConsFinal />
			</Retenedor>
	ENDTEXT
	
	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NmbItem>"+ALLTRIM(UPPER(ItemCur.Detalle))+"</NmbItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vDetalle NOSHOW FLAGS 1
			<DscItem />
			<QtyRef />
			<UnmdRef />
			<PrcRef />
			<QtyItem />
			<Subcantidad>
				<SubQty />
				<SubCod />
			</Subcantidad>
			<FchElabor />
			<FchVencim />
	ENDTEXT
		
	vGrab = FPUT(vXML,vDetalle)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<UnmdItem>"+ALLTRIM(UPPER(ItemCur.UniMed))+"</UnmdItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	vGrab = FPUT(vXML,NivelTerciario+"<PrcItem>"+ALLTRIM(STR(ItemCur.PrecioOrig,18))+"</PrcItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	TEXT TO vOtrasMonedas NOSHOW FLAGS 1
			<OtrMnda>
				<PrcOtrMon />
				<Moneda />
				<FctConv />
				<DctoOtrMnda />
				<RecargoOtrMnda />
				<MontoItemOtrMnda />
			</OtrMnda>
	ENDTEXT
					
	vGrab = FPUT(vXML,vOtrasMonedas)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF	
	
	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		SELECT DscCur
		SUM PorDsc, MonDsc TO vSumaPorcentajeDescuento, ;
							  vSumaMontoDescuento FOR DscCur.Linea=ItemCur.Linea  .and. ;
											          !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 1, 2, 3)

		SUM PorDsc, MonDsc TO vSumaPorcentajeRecargo, ;
							  vSumaMontoRecargo 	FOR DscCur.Linea=ItemCur.Linea  .and. ;
											   	        !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 4, 5)
																		
		IF vSumaPorcentajeDescuento>0 THEN
			vVariablePorDscto=ALLTRIM(STR(vSumaPorcentajeDescuento,5,2))
			vVariableMonDscto=ALLTRIM(STR(vSumaMontoDescuento,18))
		ELSE
			STORE "0" TO vVariablePorDscto, vVariableMonDscto
		ENDIF
		
		vGrab = FPUT(vXML,NivelTerciario+"<DescuentoPct>"+vVariablePorDscto+"</DescuentoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		vGrab = FPUT(vXML,NivelTerciario+"<DescuentoPct>"+vVariableMonDscto+"</DescuentoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF
		
		IF vSumaPorcentajeDescuento>0 THEN
			SET ORDER TO 2 IN DscCur			
			GO TOP IN DscCur
			IF SEEK(ItemCur.Linea, "DSCCUR", 2) THEN
				DO WHILE !EOF("DSCCUR")
					IF DELETED("DSCCUR") THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					IF DscCur.ModDsc=2 THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					vGrab = FPUT(vXML,NivelTerciario+"<SubDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<TipoDscto>$</TipoDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<ValorDscto>"+ALLTRIM(STR(DscCur.MonDsc, 18, 2))+"</ValorDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelTerciario+"</SubDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ELSE
				TEXT TO vVarDscto NOSHOW FLAGS 1
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
				ENDTEXT 			

				vGrab = FPUT(vXML,vVarDscto)
				IF vGrab=0 then
					=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
					RETURN .f.
				ENDIF
			ENDIF 			
		ELSE
			TEXT TO vVarDscto NOSHOW FLAGS 1
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
			ENDTEXT 			

			vGrab = FPUT(vXML,vVarDscto)
			IF vGrab=0 then
				=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
				RETURN .f.
			ENDIF
		ENDIF

		IF vSumaPorcentajeRecargo>0 THEN
			vVariablePorRec=ALLTRIM(STR(vSumaPorcentajeRecargo,5,2))
			vVariableMonRec=ALLTRIM(STR(vSumaMontoRecargo,18))
		ELSE
			STORE "0" TO vVariablePorRec, vVariableMonRec
		ENDIF
		
		vGrab = FPUT(vXML,NivelTerciario+"<RecargoPct>"+vVariablePorRec+"</RecargoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		vGrab = FPUT(vXML,NivelTerciario+"<RecargoMonto>"+vVariableMonRec+"</RecargoMonto>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		GO TOP IN DscCur
		IF vSumaPorcentajeRecargo>0 THEN
			IF SEEK(ItemCur.Linea, 2) THEN
				DO WHILE !EOF("DSCCUR")
					IF !DELETED("DSCCUR") THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					IF DscCur.ModDsc=1 THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					vGrab = FPUT(vXML,NivelTerciario+"<SubRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<TipoRecargo>$</TipoRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<ValorRecargo>"+ALLTRIM(STR(DscCur.MonDsc, 18, 2))+"</ValorRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelTerciario+"</SubRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ELSE
				TEXT TO vVarRecargo NOSHOW FLAGS 1
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
				ENDTEXT 			

				vGrab = FPUT(vXML,vVarRecargo)
				IF vGrab=0 then
					=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
					RETURN .f.
				ENDIF			
			ENDIF
		ELSE
			TEXT TO vVarRecargo NOSHOW FLAGS 1
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
			ENDTEXT 			

			vGrab = FPUT(vXML,vVarRecargo)
			IF vGrab=0 then
				=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
				RETURN .f.
			ENDIF
		ENDIF
	ELSE
		TEXT TO vVarDscto NOSHOW FLAGS 1
			<DescuentoPct />
			<DescuentoMonto />
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
			<RecargoPct />
			<RecargoMonto />
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
			<CodImpAdic />
		ENDTEXT
		vGrab = FPUT(vXML,vVarDscto)
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF		
	ENDIF 	
	
	IF !EMPTY(ALLTRIM(ItemCur.CodIla)) THEN
		vGrab = FPUT(vXML,NivelTerciario+"<CodImpAdic>"+ALLTRIM(ItemCur.CodIla)+"</CodImpAdic>")
	ELSE
		vGrab = FPUT(vXML,NivelTerciario+"<CodImpAdic />")
	ENDIF
	
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<MontoItem>"+ALLTRIM(STR(ItemCur.Afecto))+"</MontoItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelSecundario+"</Detalle>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	SKIP IN ItemCur
ENDDO

TEXT TO vFinalDetalle NOSHOW FLAGS 1
		<SubTotInfo>
			<NroSTI />
			<GlosaSTI />
			<OrdenSTI />
			<SubTotNetoSTI />
			<SubTotIVASTI />
			<SubTotAdicSTI />
			<SubTotExeSTI />
			<ValSubtotSTI />
			<LineasDeta />
		</SubTotInfo>
ENDTEXT
		
vGrab = FPUT(vXML,vFinalDetalle)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF

SELECT DscCur
SUM PorDsc, MonDsc TO vSumaPorcentajeGlobal, ;
					  vSumaMontoDescuentoGlobal FOR !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 7)

IF vSumaMontoDescuentoGlobal>0 THEN
	vGrab = FPUT(vXML,NivelSecundario+"<DscRcgGlobal>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NroLinDR>1</NroLinDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<TpoMov>D</TpoMov>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<GlosaDR>Descuento Cabecera</GlosaDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<TpoValor>$</TpoValor>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<ValorDR>"+ALLTRIM(STR(vSumaMontoDescuentoGlobal, 18,2))+"</ValorDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vVarDsctoGlobal NOSHOW FLAGS 1
			<ValorDROtrMnda />
			<IndExeDR />
		</DscRcgGlobal>
	ENDTEXT

	vGrab = FPUT(vXML,vVarDsctoGlobal)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ELSE
	TEXT TO vVarDsctoGlobal NOSHOW FLAGS 1
		<DscRcgGlobal>
			<NroLinDR />
			<TpoMov />
			<GlosaDR />
			<TpoValor />
			<ValorDR />
			<ValorDROtrMnda />
			<IndExeDR />
		</DscRcgGlobal>
	ENDTEXT

	vGrab = FPUT(vXML,vVarDsctoGlobal)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDIF

IF vpTipoDoc!="NC" THEN 	
	TEXT TO vVarRef NOSHOW FLAGS 1
		<Referencia>
			<NroLinRef />
			<TpoDocRef />
			<IndGlobal />
			<FolioRef />
			<RUTOtr />
			<FchRef />
			<CodRef />
			<RazonRef />
		</Referencia>
	ENDTEXT

	vGrab = FPUT(vXML,vVarRef)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ELSE
	vGrab = FPUT(vXML,NivelTerciario+"<Referencia>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<NroLinRef />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<TpoDocRef>"+vpCodDoc+"</TpoDocRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<IndGlobal />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<FolioRef>"+vpFolioDoc+"</FolioRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<RUTOtr />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<FchRef>"+vpFechaDoc+"</FchRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<CodRef>"+ALLTRIM(STR(vpTipoAnulacion))+"</CodRef>") && 1=Anulacion Completa, 2=Corrige Texto de Referencia, 3=Corrige Montos
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<RazonRef>"+vpMotivo+"</RazonRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"</Referencia>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDIF

TEXT TO vFinal NOSHOW FLAGS 1
		<Comisiones>
			<NroLinCom />
			<TipoMovim />
			<Glosa />
			<TasaComision />
			<ValComNeto />
			<ValComExe />
			<ValComIVA />
		</Comisiones>
	</Documento>
</DTE>
ENDTEXT

vGrab = FPUT(vXML,vFinal)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF
	
IF !FCLOSE(vXML) then
	=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
	RETURN .f.
ENDIF

ENDPROC
PROCEDURE rutina5
LPARAMETERS vpTipoDoc, vpFolioDoc, vpCodDoc, vpModDoc, vpFechaIni, vpFecVen, vpRutCliente, vpNombreCliente, ;
			vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad, vpMontoNeto, ;
			vpMontoExento, vpTasaIVA, vpMontoIVA, vpMontoTotal, vpMontoDescuentoGlobal, ;
			vpTipoRef, vpFolioRef, vpFecRef, vpTipoAnulacion, vpMotivoRef, vpCodVend

#DEFINE NivelPrimario    CHR(9)
#DEFINE NivelSecundario  CHR(9)+CHR(9)
#DEFINE NivelTerciario   CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelCuaternario CHR(9)+CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelQuinto		 CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)
#DEFINE NivelSexto		 CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)+CHR(9)


*vArchivo="c:\zPaso\"+vgTipoDoc+vpFolioDoc+"XMLDTE.XML"
vArchivo="c:\zPaso\"+vgTipoDoc+vpFolioDoc+".XML"
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Clientes, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
	
	RETURN .f.
ENDIF


GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador

vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR
	
IF This.pExtraeDatosEmisor(vRutCliente, vDigitoVerificador)=0 THEN
	=MESSAGEBOX("No existen Datos del Emisor")
	RETURN .f.
ENDIF

TEXT TO vEncabezado TEXTMERGE NOSHOW FLAGS 1
<?xml version="1.0" encoding="ISO-8859-1"?>
<DTE version="1.0">
	<Documento ID="F60T33">
		<Encabezado>
			<IdDoc>
				<TipoDTE><<vpCodDoc>></TipoDTE>
				<Folio><<vpFolioDoc>></Folio>
				<FchEmis><<DTOC(vpFechaIni)>></FchEmis>
				<IndNoRebaja />
				<TipoDespacho />
				<IndTraslado />
				<TpoImpresion />
				<IndServicio />
				<MntBruto />
				<FmaPago />
				<FmaPagExp />
				<FchCancel />
				<MntCancel />
				<SaldoInsol />
				<MntPagos />
				<PeriodoDesde />
				<PeriodoHasta />
				<MedioPago />
				<TpoCtaPago />
				<NumCtaPago />
				<BcoPago />
				<TermPagoCdg />
				<TermPagoGlosa />
				<TermPagoDias />
				<FchVenc><<DTOC(vpFecVen)>></FchVenc>
			</IdDoc>
			<Emisor>
				<RUTEmisor><<aRespuesta(2)>></RUTEmisor>
				<RznSoc><<aRespuesta(5)>></RznSoc>
				<GiroEmis><<aRespuesta(6)>></GiroEmis>
				<Telefono><<aRespuesta(9)>></Telefono>
				<CorreoEmisor><<aRespuesta(10)>></CorreoEmmisor>
				<Acteco><<aRespuesta(7)>></Acteco>
				<GuiaExport>
					<CdgTraslado />
					<FolioAut />
					<FchAut />
				</GuiaExport>
				<Sucursal />
				<CdgSIISucur><<aRespuesta(8)>></CdgSIISucur>
				<DirOrigen />
				<CmnaOrigen />
				<CiudadOrigen />
				<CdgVendedor><<vpCodVend>></CdgVendedor>
				<IdAdicEmisor />
			</Emisor>
			<RUTMandante />
			<Receptor>
				<RUTRecep><<vpRutCliente>></RUTRecep>
				<CdgIntRecep />
				<RznSocRecep><<vpNombreCliente>></RznSocRecep>
				<Extranjero>
					<NumId />
					<Nacionalidad />
				</Extranjero>
				<GiroRecep><<vpGiro>></GiroRecep>
				<Contacto><<vpContacto>></Contacto>
				<CorreoRecep><<vpeMail>></CorreoRecep>
				<DirRecep><<vpDireccion>></DirRecep>
				<CmnaRecep><<vpComuna>></CmnaRecep>
				<CiudadRecep><<vpCiudad>></CiudadRecep>
				<DirPostal />
				<CmnaPostal />
				<CiudadPostal />
			</Receptor>
			<RUTSolicita />
			<Transporte>
				<Patente />
				<RUTTrans />
				<Chofer />
				<DirDest />
				<CmnaDest />
				<CiudadDest />
				<Aduana>
					<CodModVenta />
					<CodClauVenta />
					<TotClauVenta />
					<CodViaTransp />
					<NombreTransp />
					<RUTCiaTransp />
					<NomCiaTransp />
					<IdAdicTransp />
					<Booking />
					<Operador />
					<CodPtoEmbarque />
					<IdAdicPtoEmb />
					<CodPtoDesemb />
					<IdAdicPtoDesemb />
					<Tara />
					<CodUnidMedTara />
					<PesoBruto />
					<CodUnidPesoBruto />
					<PesoNeto />
					<CodUnidPesoNeto />
					<TotItems />
					<TotBultos />
					<TipoBultos>
						<CodTpoBultos />
						<CantBultos />
						<Marcas />
						<IdContainer />
						<Sello />
						<EmisorSello />
					</TipoBultos>
					<MntFlete />
					<MntSeguro />
					<CodPaisRecep />
					<CodPaisDestin />
				</Aduana>
			</Transporte>
			<Totales>		
				<MntNeto><<vpMontoNeto>></MntNeto>
				<MntExe><<vpMontoExento>></MntExe>
				<MntBase />
				<MntMargenCom />
				<TasaIVA><<vpTasaIva>></TasaIVA>
				<IVA><<vpMontoIVA>></IVA<
				<IVAProp />
				<IVATerc />
				<ImptoReten>
					<TipoImp />
					<TasaImp />
					<MontoImp />
				</ImptoReten>
				<IVANoRet />
				<CredEC />
				<GrntDep />
				<Comisiones>
					<ValComNeto />
					<ValComExe />
					<ValComIVA />
				</Comisiones>
				<MntTotal><<vpMontoTotal>></MntTotal>
				<MontoNF />
				<MontoPeriodo />
				<SaldoAnterior />
				<VlrPagar />
			</Totales>
			<OtraMoneda>
				<TpoMoneda />
				<TpoCambio />
				<MntNetoOtrMnda />
				<MntExeOtrMnda />
				<MntFaeCarneOtrMnda />
				<MntMargComOtrMnda />
				<IVAOtrMnda />
				<ImpRetOtrMnda>
					<TipoImpOtrMnda />
					<TasaImpOtrMnda />
					<VlrImpOtrMnda />
				</ImpRetOtrMnda>
				<IVANoRetOtrMnda />
				<MntTotOtrMnda />
			</OtraMoneda>
		</Encabezado>
ENDTEXT

vGrab = FPUT(vXML,vEncabezado)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF DELETED("ITEMCUR") THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
	
	vGrab = FPUT(vXML,NivelSecundario+"<Detalle>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NroLinDet>"+ALLTRIM(STR(ItemCur.Linea))+"</NroLinDet>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<CdgItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<TpoCodigo>INT1</TpoCodigo>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<VlrCodigo>"+ALLTRIM(ItemCur.Codigo)+"</VlrCodigo>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"</CdgItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vSentencia NOSHOW FLAGS 1
			<IndExe />
			<Retenedor>
				<IndAgente />
				<MntBaseFaena />
				<MntMargComer />
				<PrcConsFinal />
			</Retenedor>
	ENDTEXT
	
	vGrab = FPUT(vXML,vSentencia)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NmbItem>"+ALLTRIM(UPPER(ItemCur.Detalle))+"</NmbItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vDetalle NOSHOW FLAGS 1
			<DscItem />
			<QtyRef />
			<UnmdRef />
			<PrcRef />
			<QtyItem />
			<Subcantidad>
				<SubQty />
				<SubCod />
			</Subcantidad>
			<FchElabor />
			<FchVencim />
	ENDTEXT
		
	vGrab = FPUT(vXML,vDetalle)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<UnmdItem>"+ALLTRIM(UPPER(ItemCur.UniMed))+"</UnmdItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	vGrab = FPUT(vXML,NivelTerciario+"<PrcItem>"+ALLTRIM(STR(ItemCur.PrecioOrig,18))+"</PrcItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	TEXT TO vOtrasMonedas NOSHOW FLAGS 1
			<OtrMnda>
				<PrcOtrMon />
				<Moneda />
				<FctConv />
				<DctoOtrMnda />
				<RecargoOtrMnda />
				<MontoItemOtrMnda />
			</OtrMnda>
	ENDTEXT
					
	vGrab = FPUT(vXML,vOtrasMonedas)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF	
	
	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		SELECT DscCur
		SUM PorDsc, MonDsc TO vSumaPorcentajeDescuento, ;
							  vSumaMontoDescuento FOR DscCur.Linea=ItemCur.Linea  .and. ;
											          !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 1, 2, 3)

		SUM PorDsc, MonDsc TO vSumaPorcentajeRecargo, ;
							  vSumaMontoRecargo 	FOR DscCur.Linea=ItemCur.Linea  .and. ;
											   	        !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 4, 5)
																		
		IF vSumaPorcentajeDescuento>0 THEN
			vVariablePorDscto=ALLTRIM(STR(vSumaPorcentajeDescuento,5,2))
			vVariableMonDscto=ALLTRIM(STR(vSumaMontoDescuento,18))
		ELSE
			STORE "0" TO vVariablePorDscto, vVariableMonDscto
		ENDIF
		
		vGrab = FPUT(vXML,NivelTerciario+"<DescuentoPct>"+vVariablePorDscto+"</DescuentoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		vGrab = FPUT(vXML,NivelTerciario+"<DescuentoPct>"+vVariableMonDscto+"</DescuentoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF
		
		IF vSumaPorcentajeDescuento>0 THEN
			SET ORDER TO 2 IN DscCur			
			GO TOP IN DscCur
			IF SEEK(ItemCur.Linea, "DSCCUR", 2) THEN
				DO WHILE !EOF("DSCCUR")
					IF DELETED("DSCCUR") THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					IF DscCur.ModDsc=2 THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					vGrab = FPUT(vXML,NivelTerciario+"<SubDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<TipoDscto>$</TipoDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<ValorDscto>"+ALLTRIM(STR(DscCur.MonDsc, 18, 2))+"</ValorDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelTerciario+"</SubDscto>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ELSE
				TEXT TO vVarDscto NOSHOW FLAGS 1
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
				ENDTEXT 			

				vGrab = FPUT(vXML,vVarDscto)
				IF vGrab=0 then
					=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
					RETURN .f.
				ENDIF
			ENDIF 			
		ELSE
			TEXT TO vVarDscto NOSHOW FLAGS 1
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
			ENDTEXT 			

			vGrab = FPUT(vXML,vVarDscto)
			IF vGrab=0 then
				=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
				RETURN .f.
			ENDIF
		ENDIF

		IF vSumaPorcentajeRecargo>0 THEN
			vVariablePorRec=ALLTRIM(STR(vSumaPorcentajeRecargo,5,2))
			vVariableMonRec=ALLTRIM(STR(vSumaMontoRecargo,18))
		ELSE
			STORE "0" TO vVariablePorRec, vVariableMonRec
		ENDIF
		
		vGrab = FPUT(vXML,NivelTerciario+"<RecargoPct>"+vVariablePorRec+"</RecargoPct>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		vGrab = FPUT(vXML,NivelTerciario+"<RecargoMonto>"+vVariableMonRec+"</RecargoMonto>")
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF

		GO TOP IN DscCur
		IF vSumaPorcentajeRecargo>0 THEN
			IF SEEK(ItemCur.Linea, 2) THEN
				DO WHILE !EOF("DSCCUR")
					IF !DELETED("DSCCUR") THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					IF DscCur.ModDsc=1 THEN
						SKIP IN DscCur
						LOOP
					ENDIF
					
					vGrab = FPUT(vXML,NivelTerciario+"<SubRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<TipoRecargo>$</TipoRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelCuaternario+"<ValorRecargo>"+ALLTRIM(STR(DscCur.MonDsc, 18, 2))+"</ValorRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF

					vGrab = FPUT(vXML,NivelTerciario+"</SubRecargo>")
					IF vGrab=0 then
						=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
						RETURN .f.
					ENDIF
					
					SKIP IN DscCur
				ENDDO
			ELSE
				TEXT TO vVarRecargo NOSHOW FLAGS 1
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
				ENDTEXT 			

				vGrab = FPUT(vXML,vVarRecargo)
				IF vGrab=0 then
					=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
					RETURN .f.
				ENDIF			
			ENDIF
		ELSE
			TEXT TO vVarRecargo NOSHOW FLAGS 1
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
			ENDTEXT 			

			vGrab = FPUT(vXML,vVarRecargo)
			IF vGrab=0 then
				=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
				RETURN .f.
			ENDIF
		ENDIF
	ELSE
		TEXT TO vVarDscto NOSHOW FLAGS 1
			<DescuentoPct />
			<DescuentoMonto />
			<SubDscto>
				<TipoDscto />
				<ValorDscto />
			</SubDscto>
			<RecargoPct />
			<RecargoMonto />
			<SubRecargo>
				<TipoRecargo />
				<ValorRecargo />
			</SubRecargo>
			<CodImpAdic />
		ENDTEXT
		vGrab = FPUT(vXML,vVarDscto)
		IF vGrab=0 then
			=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
			RETURN .f.
		ENDIF		
	ENDIF 	
	
	IF !EMPTY(ALLTRIM(ItemCur.CodIla)) THEN
		vGrab = FPUT(vXML,NivelTerciario+"<CodImpAdic>"+ALLTRIM(ItemCur.CodIla)+"</CodImpAdic>")
	ELSE
		vGrab = FPUT(vXML,NivelTerciario+"<CodImpAdic />")
	ENDIF
	
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<MontoItem>"+ALLTRIM(STR(ItemCur.Afecto))+"</MontoItem>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelSecundario+"</Detalle>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
	
	SKIP IN ItemCur
ENDDO

TEXT TO vFinalDetalle NOSHOW FLAGS 1
		<SubTotInfo>
			<NroSTI />
			<GlosaSTI />
			<OrdenSTI />
			<SubTotNetoSTI />
			<SubTotIVASTI />
			<SubTotAdicSTI />
			<SubTotExeSTI />
			<ValSubtotSTI />
			<LineasDeta />
		</SubTotInfo>
ENDTEXT
		
vGrab = FPUT(vXML,vFinalDetalle)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF

SELECT DscCur
SUM PorDsc, MonDsc TO vSumaPorcentajeGlobal, ;
					  vSumaMontoDescuentoGlobal FOR !DELETED("DSCCUR") .and. INLIST(DscCur.TipDsc, 7)

IF vSumaMontoDescuentoGlobal>0 THEN
	vGrab = FPUT(vXML,NivelSecundario+"<DscRcgGlobal>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<NroLinDR>1</NroLinDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<TpoMov>D</TpoMov>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<GlosaDR>Descuento Cabecera</GlosaDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<TpoValor>$</TpoValor>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<ValorDR>"+ALLTRIM(STR(vSumaMontoDescuentoGlobal, 18,2))+"</ValorDR>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	TEXT TO vVarDsctoGlobal NOSHOW FLAGS 1
			<ValorDROtrMnda />
			<IndExeDR />
		</DscRcgGlobal>
	ENDTEXT

	vGrab = FPUT(vXML,vVarDsctoGlobal)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ELSE
	TEXT TO vVarDsctoGlobal NOSHOW FLAGS 1
		<DscRcgGlobal>
			<NroLinDR />
			<TpoMov />
			<GlosaDR />
			<TpoValor />
			<ValorDR />
			<ValorDROtrMnda />
			<IndExeDR />
		</DscRcgGlobal>
	ENDTEXT

	vGrab = FPUT(vXML,vVarDsctoGlobal)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDIF

IF vpTipoDoc!="NC" THEN 	
	TEXT TO vVarRef NOSHOW FLAGS 1
		<Referencia>
			<NroLinRef />
			<TpoDocRef />
			<IndGlobal />
			<FolioRef />
			<RUTOtr />
			<FchRef />
			<CodRef />
			<RazonRef />
		</Referencia>
	ENDTEXT

	vGrab = FPUT(vXML,vVarRef)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ELSE
	vGrab = FPUT(vXML,NivelTerciario+"<Referencia>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<NroLinRef />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<TpoDocRef>"+vpCodDoc+"</TpoDocRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<IndGlobal />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"<FolioRef>"+vpFolioDoc+"</FolioRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<RUTOtr />")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<FchRef>"+vpFechaDoc+"</FchRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<CodRef>"+ALLTRIM(STR(vpTipoAnulacion))+"</CodRef>") && 1=Anulacion Completa, 2=Corrige Texto de Referencia, 3=Corrige Montos
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelCuaternario+"<RazonRef>"+vpMotivo+"</RazonRef>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF

	vGrab = FPUT(vXML,NivelTerciario+"</Referencia>")
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
		RETURN .f.
	ENDIF
ENDIF

TEXT TO vFinal NOSHOW FLAGS 1
		<Comisiones>
			<NroLinCom />
			<TipoMovim />
			<Glosa />
			<TasaComision />
			<ValComNeto />
			<ValComExe />
			<ValComIVA />
		</Comisiones>
	</Documento>
</DTE>
ENDTEXT

vGrab = FPUT(vXML,vFinal)
IF vGrab=0 then
	=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	RETURN .f.
ENDIF
	
IF !FCLOSE(vXML) then
	=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
	RETURN .f.
ENDIF

ENDPROC
PROCEDURE rutina6
LPARAMETERS vpTipoNotacredito, vpCodigo, vpFecha, vpCantidad, vpFraccion, vpPrecio, ;
			vpLinea, vpDetalle, vpEnvase, vpUniMed, vpTasaIva, vpBodega, vpBodegaIN, ;
			vpTipoDsctoCabecera, vTipoDocExento, vTipoDocGuia

LOCAL vMontoDscto, vMontoRecargo, vMontoExento, vSubTotal, vPrecioNeto, vPrecioNetoDetalle

DELETE FROM ItemCur WHERE ItemCur.Linea=vpLinea
DELETE FROM DscCur WHERE DscCur.Linea=vpLinea

vPrecioNeto=(vpCantidad+(vpFraccion/vpEnvase))*vpPrecio
STORE 0 TO vMontoDscto, vMontoRecargo, vMontoExento
IF vTipoDocExento THEN
	vMontoExento=vPrecioNeto
ENDIF

IF vpTipoNotaCredito=1 THEN
	IF !EMPTY(ALLTRIM(vpCodigo)) THEN
		IF !SEEK(vpCodigo, "PRODUCTO",1) THEN
			=MESSAGEBOX("Producto no existe en Maestro")
			RETURN .f.
		ENDIF
	ENDIF
	*aDocumentoRef(1,35)= tActual.faExento

	IF SEEK(vpLinea, "ORIDSCCUR",1) THEN
		DO WHILE !EOF("ORIDSCCUR") .and. OriDscCur.Linea=vpLinea
			DO CASE
				CASE INLIST(OriDscCur.TipDsc,1,2,3)
					INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
								VALUES (vpLinea, OriDscCur.TipDsc, OriDscCur.PorDsc, ;
										This.mRedondeo(vPrecioNeto*(OriDscCur.PorDsc/100)), ;
										OriDscCur.CodPro, vpFecha, 1)
					vMontoDscto=vMontoDscto+DscCur.MonDsc
				CASE OriDscCur.TipDsc=4
					INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc) ;
								VALUES (vpLinea, OriDscCur.TipDsc, OriDscCur.PorDsc, ;
										This.mRedondeo(vPrecioNeto*(OriDscCur.PorDsc/100)), ;
										OriDscCur.CodPro, vpFecha, 2)
					vMontoRecargo=vMontoRecargo+DscCur.MonDsc
				CASE OriDscCur.TipDsc=5
					INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
								VALUES (vpLinea, OriDscCur.TipDsc, OriDscCur.PorDsc, ;
										This.mRedondeo(vPrecioNeto*(OriDscCur.PorDsc/100)), ;
										OriDscCur.CodPro, vpFecha, 2, OriDscCur.Cod_IAD)
					vMontoRecargo=vMontoRecargo+DscCur.MonDsc
			ENDCASE
			
			SKIP IN OriDscCur
		ENDDO
	ENDIF
ELSE
	IF vpLinea=0 THEN
		CALCULATE MAX(ItemCur.Linea) TO vpLinea IN ItemCur
		vpLinea=vpLinea+1
	ENDIF

	IF vTipoDocExento THEN
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
					VALUES (vpLinea, 8, 0, vMontoExento, "", vpFecha, 2, 0)
	ELSE
		INSERT INTO DscCur (Linea, TipDsc, PorDsc, MonDsc, CodPro, Fecha, ModDsc, Cod_IAD) ;
					VALUES (vpLinea, 6, prPrm.paIVA, ;
							This.mRedondeo(vPrecioNeto*(prPrm.paIVA/100)), ;
							"", vpFecha, 2, 0)
	ENDIF
ENDIF

IF vMontoExento>0 THEN
	vSubTotal=0
ELSE
	vSubTotal=vPrecioNeto
ENDIF

vPrecioNetoDetalle=vPrecioNeto-vMontoDscto+vMontoRecargo	

INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
					 Subtot, Afecto, Detalle, Unimed, Envase, Exento, ;
					 Bodega, BodegaIN, NetoDetalle) ;
			VALUES  (vpCodigo, vpCantidad, vpFraccion, vpPrecio, ;
					 vpLinea, vpPrecio, vSubtotal, vPrecioNetoDetalle, ALLTRIM(UPPER(vpDetalle)), ;
					 vpUniMed, vpEnvase, vMontoExento, vpBodega, vpBodegaIN, vPrecioNetoDetalle)

IF vgTipoNotaCredito=1 THEN
*LPARAMETERS vpLinea, vpAfectoDscRecCab, vpFechaDoc, vpTipoDev
	vResultadoCalculoRecDscCab= ;
		This.pCalculaDscRecCabDev(vpLinea, vpTipoDsctoCabecera, vpFecha, vpTipoNotacredito)
ENDIF
ENDPROC
PROCEDURE rutina6c
LPARAMETERS vpCodigo, vpFecha, vpCantidad, vpFraccion, vpLinea, vpDsctoCab, vpDsctoMonCab, vpRecCab, vpRecMonCab, ;
			vpDetalle, vpTasaIva, vpTipoDsctoCabecera, vpBndDocExento, vpRetIVA, vpPrecio

LOCAL vDescuentosLinea, vRecargosLinea, vSubTotal, vExento, vNetoDetalle

DELETE FROM ItemCur WHERE ItemCur.Linea=vpLinea
DELETE FROM DscCur 	WHERE DscCur.Linea=vpLinea

IF vpLinea=0 THEN
	CALCULATE MAX(Linea) TO vLineaSiguiente IN ItemCur
	vpLinea =vLineaSiguiente +1
ENDIF

IF vgTipoNotaCredito=1 THEN
	IF !SEEK(vpLinea, "ORICUR",1) THEN
		=MESSAGEBOX("La Linea Seleccionada no existe en Tabla Auxiliar Original")
		RETURN .f.
	ENDIF

	IF OriCur.Exento!=0 THEN
		INSERT INTO DscCur ;
			SELECT Linea, TipDsc, 0, ;
					  This.mRedondeo((vpCantidad+(vpFraccion/OriCur.Envase))*OriCur.Precio), ;
					  CodPro, Fecha, ModDsc, Cod_IAD ;
				FROM OriDscCur ;
				WHERE !INLIST(TipDsc,7,9,10) .and. OriDscCur.Linea=vpLinea
	ELSE
		INSERT INTO DscCur ;
			SELECT Linea, TipDsc, PorDsc, ;
					  This.mRedondeo(This.mRedondeo((vpCantidad+(vpFraccion/OriCur.Envase))*OriCur.Precio)*(PorDsc/100)), ;
					  CodPro, Fecha, ModDsc, Cod_IAD ;
				FROM OriDscCur ;
				WHERE !INLIST(TipDsc,7,8,9,10) .and. OriDscCur.Linea=vpLinea
	ENDIF

	STORE 0 TO vDescuentosLinea, vRecargosLinea, vSubTotal, vExento, vNetoDetalle

	CALCULATE SUM(MonDsc) FOR INLIST(DscCur.TipDsc,1,2,3) 	.and. DscCur.Linea=vpLinea 	TO vDescuentosLinea IN DscCur
	CALCULATE SUM(MonDsc) FOR INLIST(DscCur.TipDsc,4,5) 	.and. DscCur.Linea=vpLinea 	TO vRecargosLinea 	IN DscCur

	IF OriCur.Exento=0 THEN
		vSubTotal=This.mRedondeo((vpCantidad+(vpFraccion/OriCur.Envase))*OriCur.Precio)
		vNetoDetalle=vSubTotal-vDescuentosLinea+vRecargosLinea
	ELSE
		vExento=This.mRedondeo((vpCantidad+(vpFraccion/OriCur.Envase))*OriCur.Precio)
		vNetoDetalle=vExento
	ENDIF

	INSERT INTO ItemCur (Codigo, Cantidad, Fraccion, Precio, Linea, PrecioOrig, ;
						 Subtot, Afecto, Detalle, Unimed, Exento, Bodega, ;
						 BodegaIN, noApliDes, Envase, NetoDetalle) ;
				VALUES  (OriCur.Codigo, vpCantidad, vpFraccion, OriCur.Precio, OriCur.Linea, OriCur.PrecioOrig, ;
						 vSubTotal, vNetoDetalle, OriCur.Detalle, OriCur.UniMed, vExento, OriCur.Bodega, OriCur.BodegaIN, ;
						 "", OriCur.Envase, vNetoDetalle)
				
ELSE
	STORE 0 TO vSubTotal, vNetoDetalle, vExento
	IF !vpBndDocExento THEN
		vSubTotal=This.mRedondeo(vpCantidad*vpPrecio)
		vNetoDetalle=vSubTotal
	ELSE
		vExento=This.mRedondeo(vpCantidad*vpPrecio)
		vNetoDetalle=vExento
	ENDIF

	INSERT INTO ItemCur (Cantidad, Precio, Linea, PrecioOrig, Subtot, Afecto, Detalle, Exento, Bodega, ;
						 Envase, NetoDetalle) ;
				VALUES  (vpCantidad, vpPrecio, vpLinea, vpPrecio, vSubTotal, vNetoDetalle, vpDetalle, ;
						 vExento, aDocumentoRef(1,26), 1, vNetoDetalle)
ENDIF 		

This.pCalculaDscRecCab(vpTipoDsctoCabecera, vpDsctoCab, vpDsctoMonCab, vpRecCab, vpRecMoncab, ;
					   vpBndDocExento, vpFecha, vpRetIVA, aDocumentoRef(1,29))

IF SEEK(vpLinea, "ITEMCUR",1) THEN
	INSERT INTO DscCur ;
		SELECT Linea, TipDsc, PorDsc, ;
				  This.mRedondeo(ItemCur.Afecto*(PorDsc/100)), ;
				  CodPro, Fecha, ModDsc, Cod_IAD ;
			FROM OriDscCur ;
			WHERE TipDsc=9 .and. Linea=vpLinea
ENDIF


ENDPROC
PROCEDURE rutina8
SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
		IF !SEEK(ItemCur.Codigo, "PRODUCTO",1) THEN
			=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(ItemCur.Codigo)+")")
			SKIP IN ItemCur
		ENDIF
	ENDIF
		
	STORE 0 TO vMontoDscto, vPorcentajeDscto, vCargosAdicionales, vImpuestoIVA, vTotalDscto
	
	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
			IF DscCur.ModDsc=1 THEN
				IF DscCur.TipDsc!=7 THEN
					vMontoDscto		=vMontoDscto+DscCur.MonDsc
					vPorcentajeDscto=vPorcentajeDscto+DscCur.PorDsc
				ENDIF
				vTotalDscto=vTotalDscto+DscCur.MonDsc
			ENDIF

			vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc, DscCur.Cod_IAD)			

			IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
				INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
							VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea, "01")
			ENDIF
			
			SKIP IN DscCur
		ENDDO
	ENDIF
	
	vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.SubTot)
	
	INSERT INTO VisualCur (StrLinea, Codigo, Detalle, Cantidad, Fraccion, Precio, Dscto, ;
						   MonDscto, Total, Linea, Nivel) ;
				   VALUES (ALLTRIM(STR(ItemCur.Linea)), ItemCur.Codigo, ItemCur.Detalle, ;
						   ItemCur.Cantidad, ItemCur.Fraccion, ItemCur.PrecioOrig, ;
						   vPorcentajeDscto, vMontoDscto, vTotalLinea, ItemCur.Linea, "00")
	SKIP IN ItemCur
ENDDO



ENDPROC
PROCEDURE rutina8c
SET ORDER TO 1 IN ItemCur
SET ORDER TO 2 IN DscCur

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF !EMPTY(ALLTRIM(ItemCur.Codigo)) THEN
		IF !SEEK(ItemCur.Codigo, "PRODUCTO",1) THEN
			=MESSAGEBOX("(000001). Codigo no econtrado en MAestra de Productos. (Cod: "+ALLTRIM(ItemCur.Codigo)+")")
			SKIP IN ItemCur
		ENDIF
	ENDIF
		
	STORE 0 TO vMontoDscto, vPorcentajeDscto, vCargosAdicionales, vImpuestoIVA, vTotalDscto, ;
			   vMontoRecargo, vPorcentajeRecargo, vIVARetenido, vTotalRecargo

	IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
		DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
			STORE "" TO vDetalleDescuento, vDetalleRecargo
			
			IF DscCur.ModDsc=1 THEN
				IF INLIST(DscCur.TipDsc, 1,2,3) THEN
					vMontoDscto		=vMontoDscto+DscCur.MonDsc
					vPorcentajeDscto=vPorcentajeDscto+DscCur.PorDsc
				ENDIF
				vDetalleDescuento=This.pDetalleDescuento(DscCur.TipDsc, DscCur.Cod_IAD)			
			ELSE
				IF INLIST(DscCur.TipDsc,4) THEN
					vMontoRecargo=vMontoRecargo+DscCur.MonDsc
					vPorcentajeRecargo=vPorcentajeRecargo+DscCur.PorDsc
				ENDIF
				vDetalleRecargo=This.pDetalleDescuento(DscCur.TipDsc, DscCur.Cod_IAD)			
			ENDIF

			vTipoNivel=PADL(ALLTRIM(STR(DscCur.TipDsc)),2,"0")
			
			IF !EMPTY(ALLTRIM(vDetalleDescuento)) THEN
				INSERT INTO VisualCur (Detalle, Dscto, MonDscto, Linea, Nivel) ;
							VALUES (vDetalleDescuento, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea, vTipoNivel)
			ENDIF

*!*		CREATE CURSOR VisualCur (StrLinea c(3), Codigo c(15), Detalle c(80), Cantidad n(10), Fraccion n(5), ;
*!*								 Precio n(10,2), Dscto n(8,3), monDscto n(15,2), Recargo n(8,3), monRecargo n(15,2), ;
*!*								 Total n(15), Linea n(4), Nivel c(2), Cod_Iad c(2), Exento l(1))
							 			
			IF !EMPTY(ALLTRIM(vDetalleRecargo)) THEN
				INSERT INTO VisualCur (Detalle, Recargo, monRecargo, Linea, Nivel) ;
							VALUES (vDetalleRecargo, DscCur.PorDsc, DscCur.MonDsc, ItemCur.Linea, vTipoNivel)
			ENDIF
			
			SKIP IN DscCur
		ENDDO
	ENDIF
	
	vTotalLinea=IIF(ItemCur.Exento>0, ItemCur.Exento, ItemCur.NetoDetalle)
							
	INSERT INTO VisualCur (StrLinea, Codigo, Detalle, Cantidad, Fraccion, Precio, Dscto, ;
						   MonDscto, Recargo, monRecargo, Total, Linea, Nivel, Exento) ;
				   VALUES (ALLTRIM(STR(ItemCur.Linea)), ItemCur.Codigo, ALLTRIM(UPPER(ItemCur.Detalle)), ;
						   ItemCur.Cantidad, ItemCur.Fraccion, ItemCur.PrecioOrig, ;
						   vPorcentajeDscto, vMontoDscto, vPorcentajeRecargo, vMontoRecargo, vTotalLinea, ItemCur.Linea, "00",(ItemCur.Exento>0))

	SKIP IN ItemCur
ENDDO


ENDPROC
PROCEDURE rutina9
LPARAMETERS vpTipoDoc, vpFolioDoc, vpCodDoc, vpModDoc, vpFechaIni, vpFecVen, aDTCli, vpMontoNeto, ;
			vpMontoExento, vpTasaIVA, vpMontoIVA, vpMontoTotal, vpPorDescuentoGlobal, ;
			DocRef, vpCodVend, GDespacho, vTipoDescuentoGlobal, vpMontoDescuentoGlobal, ;
			vpCondicionPago, vpCodSuc, vpTipoDocEnvioDTE, vpDevolucionParcial

PUBLIC vpRutCliente, vpNombreCliente, vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad

vpRutCliente	= aDTCli(1)
vpNombreCliente	= aDTCli(2)
vpGiro			= aDTCli(3)
vpContacto		= aDTCli(4)
vpeMail			= aDTCli(5)
vpDireccion		= aDTCli(6)
vpComuna		= aDTCli(7)	
vpCiudad		= aDTCli(8)

IF SEEK(vgTipoDoc, "DEFDOC",1) THEN
	aAdjuntos(12)	=ALLTRIM(DefDoc.flPrini)
ELSE
	aAdjuntos(12)	=""
ENDIF
aAdjuntos(13)	="1"

GO TOP IN prPrm
DO CASE
	CASE vgTipoDoc="XE"
		vCopiasDoc=prprm.Copias1
	CASE vgTipoDoc="FE"
		vCopiasDoc=prprm.Copias2
	CASE vgTipoDoc="NE"
		vCopiasDoc=prprm.Copias3
	CASE vgTipoDoc="DE"
		vCopiasDoc=prprm.Copias4
	CASE vgTipoDoc="GE"
		vCopiasDoc=prprm.Copias5
OTHERWISE
	vCopiasDoc=2
ENDCASE


IF !This.pVerificaEstructurasEnvioDTE(vpTipoDocEnvioDTE,vpDevolucionParcial) THEN
	=MESSAGEBOX("Existen Problemas en la Estructura necesaria para El Envio del DTE")
	RETURN .f.
ENDIF

STORE "" TO vCadenaObservacionCliente, vCadenaVendedor, vCadenaRuta, ;
			vCadenaCondicionPago, vFormadePago
			
IF SEEK(PADL(ALLTRIM(vpRutCliente),12," "), "CLIENTES",1) THEN
	vCadenaObservacionCliente=ALLTRIM(Clientes.OBSERV1)+" "+ALLTRIM(Clientes.OBSERV2)+" "+;
							  ALLTRIM(Clientes.OBSERV3)+" "+ALLTRIM(Clientes.OBSERV4)+;
							  ALLTRIM(Clientes.OBSERV5)
	IF !EMPTY(ALLTRIM(Clientes.Ruta)) THEN
		IF SEEK(Clientes.Ruta, "CLIRUTAS",1) THEN
			vCadenaRuta=ALLTRIM(CliRutas.Descri)
		ENDIF
	ENDIF
ENDIF

IF SEEK(vpCodVend, "VENDEDOR",1) THEN
	vCadenavendedor="("+ALLTRIM(Vendedor.veCodigo)+") "+ALLTRIM(Vendedor.veNombre)
ENDIF

IF !EMPTY(vpCondicionPago) THEN
	IF SEEK(vpCondicionPago, "CONDIPAG",1) THEN
		vCadenaCondicionPago=ALLTRIM(CondiPag.coDescri)
		vFormaDePago=ALLTRIM(STR(CondiPag.coTipoSNII))
	ENDIF
ENDIF

vNumeroCajas=0

CALCULATE SUM(Cantidad+(Fraccion/Envase)) TO vNumeroCajas IN ItemCur

***** Verifica si el documento es exento o no; y si es Guia de Despacho o no
STORE .f. TO vDocExento, vDocGuiaDespacho, vDocDevRec
vNombreDocumento=""
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vNombreDocumento=ALLTRIM(TipoDoc.DetDoc)
	vDocExento		=TipoDoc.Exento
	vDocGuiaDespacho=TipoDoc.Traslado
	vDocDevRec		=(TipoDoc.bndNc .and. TipoDoc.bndND) .and. TipoDoc.LibVen
ELSE
	=MESSAGEBOX("Error intentando localizar Tipo de Documento en Maestr+o")
	RETURN .f.
ENDIF

IF !vDocDevRec THEN
	IF vDocGuiaDespacho THEN
		vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
				   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
				   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
				   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
	ELSE
		vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
				   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
				   " - CONDICION DE PAGO: "+ALLTRIM(vCadenaCondicionPago)+IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
				   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
	ENDIF
ELSE
	IF VAL(DocRef(1,12))=2 THEN
		vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
				   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
				   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")
	ELSE
		vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+" - "+;
				   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
				   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
				   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
	ENDIF
ENDIF

IF vpPorDescuentoGlobal>0 THEN
	vCadenaOBS=ALLTRIM(vCadenaOBS)+", Descuento Global Aplicado : "+ALLTRIM(STR(vpPorDescuentoGlobal,10,2))+" %"
ENDIF

GO TOP IN prPrm
GO TOP IN Empres

IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
	
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador


vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR

vClienteEmisor=PADL(ALLTRIM(vRutCliente+"-"+vDigitoVerificador),12," ")

STORE "" TO vComunaOrigen, vCiudadOrigen, vDireccionOrigen

IF !EMPTY(ALLTRIM(vClienteEmisor)) THEN
	IF SEEK(vClienteEmisor, "CLIENTES",1) THEN
		vComunaOrigen		=This.pFiltraEspeciales(Clientes.clComuna)
		vCiudadOrigen		=This.pFiltraEspeciales(Clientes.clCiudad)
		vDireccionOrigen	=This.pFiltraEspeciales(Clientes.clDirec)
	ELSE
		=MESSAGEBOX("Error intentando localizar al Emisor en Maestra de Clientes")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("Rut de Emisor no valido")
	RETURN .f.
ENDIF

IF This.pExtraeDatosEmisor(vRutCliente, vDigitoVerificador)=0 THEN
	=MESSAGEBOX("No existen Datos del Emisor")
	RETURN .f.
ENDIF

vNumeroDocumento='"'+vpTipodoc+vpFolioDoc+'33'+'"'
vRutEmisor=ALLTRIM(aRespuesta[2])+"-"+ALLTRIM(aRespuesta[3])


aAdjuntos(1)	=DTOC(DATE())+"T"+TIME()
aAdjuntos(2)	=""
aAdjuntos(3)	=""
aAdjuntos(4)	=""
aAdjuntos(5)	=""
aAdjuntos(6)	=""
aAdjuntos(7)	=""
aAdjuntos(8)	=vCadenaOBS
aAdjuntos(9)	=vpeMail
aAdjuntos(10)	=aRespuesta(10)
aAdjuntos(11)	=vNombreDocumento+" # "+vpFolioDoc


TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
<soapenv:Header/>
<soapenv:Body>
<lsof:PutDTE>
	<lsof:dte>
		<lsof:Documento ID=<<vNumeroDocumento>>>
			<lsof:Encabezado>
				<lsof:IdDoc>
					<lsof:TipoDTE><<ALLTRIM(vpCodDoc)>></lsof:TipoDTE>
					<lsof:Folio><<ALLTRIM(vpFolioDoc)>></lsof:Folio>
					<lsof:FchEmis><<vpFechaIni>></lsof:FchEmis>
					<lsof:IndNoRebaja />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF vDocGuiaDespacho THEN
	IF VAL(gDespacho(4))=0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho />
		ENDTEXT
	ELSE 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho><<GDespacho(4)>></lsof:TipoDespacho>
		ENDTEXT
	ENDIF
	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IndTraslado><<GDespacho(1)>></lsof:IndTraslado>
	ENDTEXT
ELSE 	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho />
					<lsof:IndTraslado />
	ENDTEXT
ENDIF 	
vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TpoImpresion />
					<lsof:IndServicio />
					<lsof:MntBruto />
					<lsof:FmaPago><<ALLTRIM(vFormaDePago)>></lsof:FmaPago>
					<lsof:FmaPagExp />
					<lsof:FchCancel />
					<lsof:MntCancel />
					<lsof:SaldoInsol />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF !vDocGuiaDespacho THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntPagos />
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntPagos>
						<lsof:MntPagos>
							<lsof:FchPago><<vpFecVen>></lsof:FchPago>
							<lsof:MntPago><<vpMontoTotal>></lsof:MntPago>
							<lsof:Descripcion><<gDespacho(2)>></lsof:Descripcion>
						</lsof:MntPagos>
					</lsof:MntPagos>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PeriodoDesde />
					<lsof:PeriodoHasta />
					<lsof:MedioPago />
					<lsof:TpoCtaPago />
					<lsof:NumCtaPago />
					<lsof:BcoPago />
					<lsof:TermPagoCdg />
					<lsof:TermPagoGlosa />
					<lsof:TermPagoDias />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF !EMPTY(ALLTRIM(vpFecVen)) then 			
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 					
					<lsof:FchVenc><<vpFecVen>></lsof:FchVenc>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 					
					<lsof:FchVenc><<vpFechaIni>></lsof:FchVenc>
	ENDTEXT
ENDIF
vEncabezado=vEncabezado+CHR(10)
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
				</lsof:IdDoc>
				<lsof:Emisor>
					<lsof:RUTEmisor><<vRutEmisor>></lsof:RUTEmisor>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)
*aRespuesta(5)=This.pFiltraEspeciales(aRespuesta(5))

IF !EMPTY(ALLTRIM(aRespuesta(5))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RznSoc><<This.pFiltraEspeciales(aRespuesta(5))>></lsof:RznSoc>
	ENDTEXT
ELSE 	
	=MESSAGEBOX("Error al extraer el Numero de Rut del Emisor")
	RETURN .f.
ENDIF

vEncabezado=vEncabezado+CHR(10)
*aRespuesta(5)=This.pFiltraEspeciales(aRespuesta(6))

IF !EMPTY(ALLTRIM(aRespuesta(6))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:GiroEmis><<This.pFiltraEspeciales(aRespuesta(6))>></lsof:GiroEmis>
	ENDTEXT
ELSE
	=MESSAGEBOX("Error al extraer el Giro del Emisor")
	RETURN .f.
ENDIF

vEncabezado=vEncabezado+CHR(10)
*aRespuesta(9)=This.pFiltraEspeciales(aRespuesta(9))

IF !EMPTY(ALLTRIM(aRespuesta(9))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Telefono><<This.pFiltraEspeciales(aRespuesta(9))>></lsof:Telefono>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Telefono/>
	ENDTEXT
ENDIF 	

vEncabezado=vEncabezado+CHR(10)
*aRespuesta(10)=This.pFiltraEspeciales(aRespuesta(10))

IF !EMPTY(ALLTRIM(aRespuesta(10))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CorreoEmisor><<This.pFiltraEspeciales(aRespuesta(10))>></lsof:CorreoEmisor>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CorreoEmisor/>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
IF !EMPTY(ALLTRIM(aRespuesta(7))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Acteco><<aRespuesta(7)>></lsof:Acteco>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Acteco/>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:GuiaExport />
					<lsof:Sucursal />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)
IF !EMPTY(ALLTRIM(aRespuesta(8))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:CdgSIISucur><<aRespuesta(8)>></lsof:CdgSIISucur>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:CdgSIISucur />
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:DirOrigen><<ALLTRIM(vDireccionOrigen)>></lsof:DirOrigen>
					<lsof:CmnaOrigen><<ALLTRIM(vComunaOrigen)>></lsof:CmnaOrigen>
					<lsof:CiudadOrigen><<ALLTRIM(vCiudaDOrigen)>></lsof:CiudadOrigen>
					<lsof:CdgVendedor><<ALLTRIM(vpCodVend)>></lsof:CdgVendedor>
					<lsof:IdAdicEmisor />
				</lsof:Emisor>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

***** Rutina que Filtra los caracteres especiales

vpNombreCliente	=ALLTRIM(This.pFiltraEspeciales(vpNombreCliente))
vpGiro			=ALLTRIM(This.pFiltraEspeciales(vpGiro))
vpContacto		=ALLTRIM(This.pFiltraEspeciales(vpContacto))
vpeMail			=ALLTRIM(This.pFiltraEspeciales(vpEmail))
vpDireccion		=ALLTRIM(This.pFiltraEspeciales(vpDireccion))
vpComuna		=ALLTRIM(This.pFiltraEspeciales(vpComuna))
vpCiudad		=ALLTRIM(This.pFiltraEspeciales(vpCiudad))


IF EMPTY(ALLTRIM(vpGiro)) THEN
	vpGiro="PERSONA NATURAL"
ELSE
	IF LEN(ALLTRIM(vpGiro))>40 THEN
		vpGiro=SUBSTR(ALLTRIM(vpGiro),1,40)
	ELSE
		vpGiro=ALLTRIM(vpGiro)
	ENDIF
ENDIF

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
				<lsof:RUTMandante />
				<lsof:Receptor>
					<lsof:RUTRecep><<ALLTRIM(vpRutCliente)>></lsof:RUTRecep>
					<lsof:CdgIntRecep />
					<lsof:RznSocRecep><<ALLTRIM(vpNombreCliente)>></lsof:RznSocRecep>
					<lsof:Extranjero />
					<lsof:GiroRecep><<ALLTRIM(vpGiro)>></lsof:GiroRecep>
					<lsof:Contacto><<ALLTRIM(vpContacto)>></lsof:Contacto>
					<lsof:CorreoRecep><<ALLTRIM(vpeMail)>></lsof:CorreoRecep>
					<lsof:DirRecep><<ALLTRIM(vpDireccion)>></lsof:DirRecep>
					<lsof:CmnaRecep><<ALLTRIM(vpComuna)>></lsof:CmnaRecep>
					<lsof:CiudadRecep><<ALLTRIM(vpCiudad)>></lsof:CiudadRecep>
					<lsof:DirPostal />
					<lsof:CmnaPostal />
					<lsof:CiudadPostal />
				</lsof:Receptor>
				<lsof:RUTSolicita />
				<lsof:Transporte />
				<lsof:Totales>		
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

*IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*					<lsof:MntNeto>0</lsof:MntNeto>
*					<lsof:MntExe>0</lsof:MntExe>
*					<lsof:MntBase />
*					<lsof:MntMargenCom />
*					<lsof:TasaIVA />
*					<lsof:IVA />
*	ENDTEXT 	
*ELSE

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntNeto><<ALLTRIM(STR(vpMontoNeto))>></lsof:MntNeto>
					<lsof:MntExe><<ALLTRIM(STR(vpMontoExento))>></lsof:MntExe>
					<lsof:MntBase />
					<lsof:MntMargenCom />
ENDTEXT 	
vEncabezado=vEncabezado+CHR(10)

IF !vDocExento THEN
	IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:TasaIVA />
					<lsof:IVA />
		ENDTEXT
	ELSE 		
		IF vpMontoIVA=0 THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
							<lsof:TasaIVA/>
							<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
			ENDTEXT
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
							<lsof:TasaIVA><<vpTasaIva>></lsof:TasaIVA>
							<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
			ENDTEXT
		ENDIF
	ENDIF
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:TasaIVA />
					<lsof:IVA />
	ENDTEXT
ENDIF 	
*ENDIF 	

vEncabezado=vEncabezado+CHR(10)

*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*!*						<lsof:IVAProp />
*!*						<lsof:IVATerc />
*!*						<lsof:ImptoReten>
*!*							<lsof:ImptoReten>
*!*								<lsof:TipoImp />
*!*								<lsof:TasaImp />
*!*								<lsof:MontoImp />
*!*							</lsof:ImptoReten>
*!*						</lsof:ImptoReten>
*!*						<lsof:IVANoRet />
*!*						<lsof:CredEC />
*!*						<lsof:GrntDep />
*!*						<lsof:Comisiones>
*!*							<lsof:Comisiones>
*!*								<lsof:ValComNeto />
*!*								<lsof:ValComExe />
*!*								<lsof:ValComIVA />
*!*							</lsof:Comisiones>
*!*						</lsof:Comisiones>
*!*	ENDTEXT

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IVAProp />
					<lsof:IVATerc />
					<lsof:ImptoReten />
					<lsof:IVANoRet />
					<lsof:CredEC />
					<lsof:GrntDep />
					<lsof:Comisiones />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

*IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*					<lsof:MntTotal>0</lsof:MntTotal>
*	ENDTEXT
*ELSE

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntTotal><<ALLTRIM(STR(vpMontoTotal))>></lsof:MntTotal>
ENDTEXT

*ENDIF

vEncabezado=vEncabezado+CHR(10)

*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*!*						<lsof:MontoNF />
*!*						<lsof:MontoPeriodo />
*!*						<lsof:SaldoAnterior />
*!*						<lsof:VlrPagar />
*!*					</lsof:Totales>
*!*					<lsof:OtraMoneda>
*!*						<lsof:OtraMoneda>
*!*							<lsof:TpoMoneda />
*!*							<lsof:TpoCambio />
*!*							<lsof:MntNetoOtrMnda />
*!*							<lsof:MntExeOtrMnda />
*!*							<lsof:MntFaeCarneOtrMnda />
*!*							<lsof:MntMargComOtrMnda />
*!*							<lsof:ImpRetOtrMnda>
*!*								<lsof:ImpRetOtrMnda>
*!*									<lsof:TipoImpOtrMnda />
*!*									<lsof:TasaImpOtrMnda />
*!*									<lsof:VlrImpOtrMnda />
*!*								</lsof:ImpRetOtrMnda>
*!*							</lsof:ImpRetOtrMnda>
*!*							<lsof:IVAOtrMnda />
*!*							<lsof:MntTotOtrMnda />
*!*							<lsof:IVANoRetOtrMnda />
*!*						</lsof:OtraMoneda>
*!*					</lsof:OtraMoneda>
*!*				</lsof:Encabezado>
*!*				<lsof:Detalle>
*!*	ENDTEXT

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MontoNF />
					<lsof:MontoPeriodo />
					<lsof:SaldoAnterior />
					<lsof:VlrPagar />
				</lsof:Totales>
				<lsof:OtraMoneda />
			</lsof:Encabezado>
			<lsof:Detalle>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF DELETED("ITEMCUR") THEN
		SKIP IN ItemCur
		LOOP
	ENDIF
*!*		IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN 		
*!*			IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 .and. EMPTY(ALLTRIM(ItemCur.Detalle)) THEN
*!*				SKIP IN ItemCur
*!*				LOOP
*!*			ENDIF
*!*		ELSE
*!*			IF VAL(DocRef(1,12))!=2 THEN
*!*				IF vpTipoDocEnvioDTE=1 THEN
*!*					IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
*!*						SKIP IN ItemCur
*!*						LOOP
*!*					ENDIF
*!*				ENDIF
*!*			ENDIF
*!*		ENDIF
	IF !vDocDevRec  THEN 		
		IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 .and. EMPTY(ALLTRIM(ItemCur.Detalle)) THEN
			SKIP IN ItemCur
			LOOP
		ENDIF
	ELSE
		IF VAL(DocRef(1,12))!=2 THEN
			IF vpTipoDocEnvioDTE=1 THEN
				IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
					SKIP IN ItemCur
					LOOP
				ENDIF
			ENDIF
		ENDIF
	ENDIF 	
	vLinea=ALLTRIM(STR(ItemCur.Linea))
	vCodigoProducto=ALLTRIM(ItemCur.Codigo)
	IF ItemCur.Exento>0 THEN
		vItemExento="1"
	ELSE
		vItemExento=""
	ENDIF
	
	vUnidadMedida=This.pFiltraEspeciales(ItemCur.UniMed)
	vPrecioItem=ALLTRIM(STR(ItemCur.PrecioOrig,18,6))
	
	IF ItemCur.NetoDetalle>0 THEN
		vMontoVenta=ItemCur.NetoDetalle
	ELSE
		vMontoVenta=ItemCur.Exento
	ENDIF
	
	vImpuestoAdicional=""
	vNombreProducto=This.pFiltraEspeciales(ItemCur.Detalle)
	vCantidadItem=ALLTRIM(STR(ItemCur.Cantidad+(ItemCur.Fraccion/ItemCur.Envase),18,2))
	
	CALCULATE SUM(MonDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vMontoDescuentos
	CALCULATE SUM(PorDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vSumaDescuentos
	
	vMontoDescuentos=ALLTRIM(STR(vMontoDescuentos))
	vSumaDescuentos=ALLTRIM(STR(vSumaDescuentos))
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Detalle>
					<lsof:NroLinDet><<ALLTRIM(vLinea)>></lsof:NroLinDet>
					<lsof:CdgItem>
						<lsof:CdgItem>
							<lsof:TpoCodigo>INT1</lsof:TpoCodigo>
							<lsof:VlrCodigo><<ALLTRIM(vCodigoProducto)>></lsof:VlrCodigo>
						</lsof:CdgItem>
					</lsof:CdgItem>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
	IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe />
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe><<vItemExento>></lsof:IndExe>
		ENDTEXT
	ENDIF

	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Retenedor />
					<lsof:NmbItem><<ALLTRIM(vNombreProducto)>></lsof:NmbItem>
					<lsof:DscItem />
					<lsof:QtyRef />
					<lsof:UnmdRef />
					<lsof:PrcRef />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
*!*		IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN 		
*!*			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*						<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
*!*			ENDTEXT
*!*		ELSE
*!*			IF VAL(DocRef(1,12))=2 .or. vpTipoDocEnvioDTE=0 THEN
*!*					TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*						<lsof:QtyItem />
*!*					ENDTEXT
*!*			ELSE
*!*				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*						<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
*!*				ENDTEXT
*!*			ENDIF
*!*		ENDIF
	IF !vDocDevRec  THEN 		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
		ENDTEXT
	ELSE
		IF VAL(DocRef(1,12))=2 .or. vpTipoDocEnvioDTE=0 THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem />
				ENDTEXT
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
			ENDTEXT
		ENDIF
	ENDIF	
	vEncabezado=vEncabezado+CHR(10)

*!*		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*						<lsof:Subcantidad>
*!*							<lsof:Subcantidad>
*!*								<lsof:SubQty />
*!*								<lsof:SubCod />
*!*							</lsof:Subcantidad>
*!*						</lsof:Subcantidad>
*!*						<lsof:FchElabor />
*!*						<lsof:FchVencim />
*!*						<lsof:UnmdItem><<vUnidadMedida>></lsof:UnmdItem>
*!*		ENDTEXT

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Subcantidad />
					<lsof:FchElabor />
					<lsof:FchVencim />
					<lsof:UnmdItem><<ALLTRIM(vUnidadMedida)>></lsof:UnmdItem>
	ENDTEXT
	vEncabezado=vEncabezado+CHR(10)
	
	IF IIF(VARTYPE(vpMontoTotal)="N",vpMontoTotal!=0,VAL(vpMontoTotal)!=0) THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PrcItem><<vPrecioItem>></lsof:PrcItem>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PrcItem />
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:OtrMnda />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	IF VAL(vMontoDescuentos)>0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct><<vSumaDescuentos>></lsof:DescuentoPct>
					<lsof:DescuentoMonto><<vMontoDescuentos>></lsof:DescuentoMonto>
		ENDTEXT
	ELSE 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct />
					<lsof:DescuentoMonto />
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)
	CALCULATE CNT() IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3,4) TO vNumeroDescuentos

	
	IF vNumeroDescuentos>0 THEN 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:SubDscto>
		ENDTEXT 		
		
		vEncabezado=vEncabezado+CHR(10)
		
		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF DELETED("DSCCUR") THEN
					SKIP IN DscCur
					LOOP
				ENDIF
				
				IF !INLIST(DscCur.TipDsc,1,2,3) THEN
					SKIP IN DscCur
					LOOP
				ENDIF
		
				vMontoDescuentos=ALLTRIM(STR(DscCur.MonDsc))		
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:SubDscto>
							<lsof:TipoDscto>$</lsof:TipoDscto>
							<lsof:ValorDscto><<vMontoDescuentos>></lsof:ValorDscto>>
						</lsof:SubDscto>
				ENDTEXT
				vEncabezado=vEncabezado+CHR(10)
				SKIP IN DscCur
			ENDDO
		ENDIF
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					</lsof:SubDscto>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:SubDscto />
		ENDTEXT
	ENDIF 		
	vEncabezado=vEncabezado+CHR(10)	
				
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RecargoPct />
					<lsof:RecargoMonto />
					<lsof:SubRecargo />
					<lsof:CodImpAdic />
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)		
*!*	*	IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,14) THEN
*!*	*		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*	*					<lsof:MontoItem>0</lsof:MontoItem>
*!*	*		ENDTEXT
*!*	*	ELSE
*!*			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*					<lsof:MontoItem><<ALLTRIM(STR(vMontoVenta))>></lsof:MontoItem>
*!*			ENDTEXT
*!*	*	ENDIF

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:MontoItem><<ALLTRIM(STR(vMontoVenta))>></lsof:MontoItem>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				</lsof:Detalle>
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	SKIP IN ItemCur
ENDDO 		

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Detalle>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*				<lsof:SubTotInfo>
*!*					<lsof:SubTotInfo>
*!*						<lsof:NroSTI />
*!*						<lsof:GlosaSTI />
*!*						<lsof:OrdenSTI />
*!*						<lsof:SubTotNetoSTI />
*!*						<lsof:SubTotIVASTI />
*!*						<lsof:SubTotAdicSTI />
*!*						<lsof:SubTotExeSTI />
*!*						<lsof:ValSubtotSTI />
*!*						<lsof:LineasDeta />
*!*					</lsof:SubTotInfo>
*!*				</lsof:SubTotInfo>
*!*	ENDTEXT

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:SubTotInfo />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

IF IIF(VARTYPE(vpMontoDescuentoGlobal)="N", vpMontoDescuentoGlobal>0, VAL(vpMontoDescuentoGlobal)>0) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal>
				<lsof:DscRcgGlobal>
					<lsof:NroLinDR>1</lsof:NroLinDR>
					<lsof:TpoMov>D</lsof:TpoMov>
					<lsof:GlosaDR>DESCUENTO GLOBAL</lsof:GlosaDR>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10) 	
	vTipoDescuentoGBL="$"
		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:TpoValor><<vTipoDescuentoGBL>></lsof:TpoValor>
					<lsof:ValorDR><<vpMontoDescuentoGlobal>></lsof:ValorDR>
					<lsof:ValorDROtrMnda />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	IF vDocExento THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExeDR>1</lsof:IndExeDR>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExeDR />
		ENDTEXT
	ENDIF 		
	
	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				</lsof:DscRcgGlobal>
			</lsof:DscRcgGlobal>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal />
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)

IF EMPTY(ALLTRIM(aCasoRef(1))) .and. EMPTY(ALLTRIM(DocRef(1,1))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia />
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia>
	ENDTEXT
	vEncabezado=vEncabezado+CHR(10)

	vNumeroLineaRef=0

	IF !EMPTY(ALLTRIM(aCasoRef(1))) THEN
		vNumeroLineaRef=vNumeroLineaRef+1
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef>SET</lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(vpFolioDoc)))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<vpFechaIni>></lsof:FchRef>
					<lsof:CodRef />
					<lsof:RazonRef><<ALLTRIM(aCasoRef(1))>></lsof:RazonRef>
				</lsof:Referencia>					
		ENDTEXT
		
		vEncabezado=vEncabezado+CHR(10)
	ENDIF 	

	IF !EMPTY(ALLTRIM(DocRef(1,1))) THEN
		vNumeroLineaRef=vNumeroLineaRef+1
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef><<ALLTRIM(DocRef(1,14))>></lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(DocRef(1,17))))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<ALLTRIM(DTOC(DocRef(1,3)))>></lsof:FchRef>
					<lsof:CodRef><<ALLTRIM(DocRef(1,12))>></lsof:CodRef>
					<lsof:RazonRef><<ALLTRIM(DocRef(1,16))>></lsof:RazonRef>
				</lsof:Referencia>
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Referencia>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Comisiones />
			<lsof:Adjuntos>
				<lsof:TmsFirma><<aAdjuntos(1)>></lsof:TmsFirma>
				<lsof:DataBase64Archivo1><<Alltrim(aAdjuntos(2))>></lsof:DataBase64Archivo1>
				<lsof:DataBase64Archivo2><<Alltrim(aAdjuntos(3))>></lsof:DataBase64Archivo2>
				<lsof:DataBase64Archivo3><<Alltrim(aAdjuntos(4))>></lsof:DataBase64Archivo3>
				<lsof:DataBase64Archivo4><<Alltrim(aAdjuntos(5))>></lsof:DataBase64Archivo4>
				<lsof:DataBase64Archivo5><<Alltrim(aAdjuntos(6))>></lsof:DataBase64Archivo5>
				<lsof:DataBase64Archivo6><<Alltrim(aAdjuntos(7))>></lsof:DataBase64Archivo6>
				<lsof:Observacion><<Alltrim(aAdjuntos(8))>></lsof:Observacion>
				<lsof:EmailReceptor><<Alltrim(aAdjuntos(9))>></lsof:EmailReceptor>
				<lsof:EmailEmisor><<This.pFiltraEspeciales(Alltrim(aAdjuntos(10)))>></lsof:EmailEmisor>
				<lsof:Subject><<This.pFiltraEspeciales(Alltrim(aAdjuntos(11)))>></lsof:Subject>
				<lsof:Impresora><<Alltrim(aAdjuntos(12))>></lsof:Impresora>
				<lsof:Copias><<Alltrim(STR(vCopiasDoc))>></lsof:Copias>
                <lsof:DireccionDespacho></lsof:DireccionDespacho>
                <lsof:NotaDeVenta></lsof:NotaDeVenta>
                <lsof:CoordenadasDespacho></lsof:CoordenadasDespacho>
                <lsof:SucursalReceptor></lsof:SucursalReceptor>
                <lsof:MedioPago></lsof:MedioPago>
                <lsof:MontoDescuentoCabecera>0</lsof:MontoDescuentoCabecera>
                <lsof:MontoRecargoCabecera>0</lsof:MontoRecargoCabecera>
                <lsof:TotalImpuestosAdicionales>0</lsof:TotalImpuestosAdicionales>
			</lsof:Adjuntos>		
		</lsof:Documento>
	</lsof:dte>
</lsof:PutDTE>
</soapenv:Body>
</soapenv:Envelope>	
ENDTEXT


vArchivo=ADDBS(ALLTRIM(StdXML))+"PRUEBA"+vgTipoDoc+vpFolioDoc+"-"+;
		  PADL(ALLTRIM(STR(HOUR(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(MINUTE(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(SEC(DATETIME()))),2,"0")+;
		  ".XML"
		
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Clientes, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
ELSE
	vGrab = FPUT(vXML,vEncabezado)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	ELSE
		IF !FCLOSE(vXML) then
			=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
		ENDIF
	ENDIF
ENDIF

*DO FORM wMuestraXML WITH vEncabezado TO bResultado
*!*	IF bResultado=2 THEN
*!*		RETURN .f.
*!*	ENDIF

*RELEASE vpRutCliente, vpNombreCliente, vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad

RETURN vEncabezado
ENDPROC
PROCEDURE rutina9c
LPARAMETERS vpDatosElectronicos

STORE "" TO vCadenaOBS, vNombreDocumento, vImpresoraSeleccionada, vNumeroCopias, vMedioPago

vIDDoc		= STREXTRACT(vpDatosElectronicos, "<IDDoc>", "</IDDoc>")
vEmisor		= STREXTRACT(vpDatosElectronicos, "<Emisor>", "</Emisor>")
vReceptor	= STREXTRACT(vpDatosElectronicos, "<Receptor>", "</Receptor>")
vTotales	= STREXTRACT(vpDatosElectronicos, "<Totales>", "</Totales>")


vCadenaOBS=STREXTRACT(vIDDoc,"<Observaciones>", "</Observaciones>")
vNombreDocumento=STREXTRACT(vIDDoc,"<NombreDocumento>", "</NombreDocumento>")

vImpresoraSeleccionada=STREXTRACT(vIDDoc,"<Impresora>", "</Impresora>")
vNumeroCopias=STREXTRACT(vIDDoc,"<Copias>", "</Copias>")

vNumeroDocumento=STREXTRACT(vIDDoc,"<IDErp>", "</IDErp>")+PADL(STREXTRACT(vIDDoc,"<Folio>", "</Folio>"),9, "0")
vMedioPago=STREXTRACT(vIDDoc,"<MedioPago>", "</MedioPago>")

TEXT TO vEncabezado TEXTMERGE NOSHOW FLAGS 2
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
<soapenv:Header/>
<soapenv:Body>
<lsof:PutDTE>
	<lsof:dte>
		<lsof:Documento ID="<<vNumeroDocumento>>">
			<lsof:Encabezado>
				<lsof:IdDoc>
					<lsof:TipoDTE><<STREXTRACT(vIDDoc,"<TipoDocumento>", "</TipoDocumento>")>></lsof:TipoDTE>
					<lsof:Folio><<STREXTRACT(vIDDoc,"<Folio>", "</Folio>")>></lsof:Folio>
					<lsof:FchEmis><<STREXTRACT(vIDDoc,"<FechaEmis>", "</FechaEmis>")>></lsof:FchEmis>
					<lsof:IndNoRebaja />
					<lsof:TipoDespacho />
					<lsof:IndTraslado />
					<lsof:TpoImpresion />
					<lsof:IndServicio />
					<lsof:MntBruto />
					<lsof:FmaPago><<STREXTRACT(vIDDoc,"<FormaPago>", "</FormaPago>")>></lsof:FmaPago>
					<lsof:FmaPagExp />
					<lsof:FchCancel />
					<lsof:MntCancel />
					<lsof:SaldoInsol />
					<lsof:MntPagos />
					<lsof:PeriodoDesde />
					<lsof:PeriodoHasta />
					<lsof:MedioPago />
					<lsof:TpoCtaPago />
					<lsof:NumCtaPago />
					<lsof:BcoPago />
					<lsof:TermPagoCdg />
					<lsof:TermPagoGlosa />
					<lsof:TermPagoDias />
					<lsof:FchVenc><<STREXTRACT(vIDDoc,"<FechaVencimiento>", "</FechaVencimiento>")>></lsof:FchVenc>
				</lsof:IdDoc>
				<lsof:Emisor>
					<lsof:RUTEmisor><<STREXTRACT(vEmisor,"<Rut>", "</Rut>")>></lsof:RUTEmisor>
					<lsof:RznSoc><<STREXTRACT(vEmisor,"<RazonSocial>", "</RazonSocial>")>></lsof:RznSoc>
					<lsof:GiroEmis><<STREXTRACT(vEmisor,"<Giro>", "</Giro>")>></lsof:GiroEmis>
					<lsof:Telefono><<STREXTRACT(vEmisor,"<Telefono>", "</Telefono>")>></lsof:Telefono>
					<lsof:CorreoEmisor><<STREXTRACT(vEmisor,"<CorreoEmisor>", "</CorreoEmisor>")>></lsof:CorreoEmisor>
					<lsof:Acteco><<STREXTRACT(vEmisor,"<Acteco>", "</Acteco>")>></lsof:Acteco>
					<lsof:GuiaExport />
					<lsof:Sucursal />
					<lsof:CdgSIISucur />
					<lsof:DirOrigen><<STREXTRACT(vEmisor,"<Direccion>", "</Direccion>")>></lsof:DirOrigen>
					<lsof:CmnaOrigen><<STREXTRACT(vEmisor,"<Comuna>", "</Comuna>")>></lsof:CmnaOrigen>
					<lsof:CiudadOrigen><<STREXTRACT(vEmisor,"<Ciudad>", "</Ciudad>")>></lsof:CiudadOrigen>
					<lsof:CdgVendedor />
					<lsof:IdAdicEmisor />
				</lsof:Emisor>
				<lsof:RUTMandante />
				<lsof:Receptor>
					<lsof:RUTRecep><<STREXTRACT(vReceptor,"<Rut>", "</Rut>")>></lsof:RUTRecep>
					<lsof:CdgIntRecep />
					<lsof:RznSocRecep><<STREXTRACT(vReceptor,"<Razon>", "</Razon>")>></lsof:RznSocRecep>
					<lsof:Extranjero />
					<lsof:GiroRecep><<STREXTRACT(vReceptor,"<Giro>", "</Giro>")>></lsof:GiroRecep>
					<lsof:Contacto />
					<lsof:CorreoRecep><<STREXTRACT(vReceptor,"<CorreoElectronico>", "</CorreoElectronico>")>></lsof:CorreoRecep>
					<lsof:DirRecep><<STREXTRACT(vReceptor,"<Direccion>", "</Direccion>")>></lsof:DirRecep>
					<lsof:CmnaRecep><<STREXTRACT(vReceptor,"<Comuna>", "</Comuna>")>></lsof:CmnaRecep>
					<lsof:CiudadRecep><<STREXTRACT(vReceptor,"<Ciudad>", "</Ciudad>")>></lsof:CiudadRecep>
					<lsof:DirPostal />
					<lsof:CmnaPostal />
					<lsof:CiudadPostal />
				</lsof:Receptor>
				<lsof:RUTSolicita />
				<lsof:Transporte />
				<lsof:Totales>		
					<lsof:MntNeto><<STREXTRACT(vTotales,"<MontoNeto>", "</MontoNeto>")>></lsof:MntNeto>
					<lsof:MntExe><<STREXTRACT(vTotales,"<MontoExento>", "</MontoExento>")>></lsof:MntExe>
					<lsof:MntBase />
					<lsof:MntMargenCom />
					<lsof:TasaIVA><<STREXTRACT(vTotales,"<TasaIVA>", "</TasaIVA>")>></lsof:TasaIVA>
					<lsof:IVA><<STREXTRACT(vTotales,"<MontoIVA>", "</MontoIVA>")>></lsof:IVA>
					<lsof:IVAProp />
					<lsof:IVATerc />
					<lsof:ImptoReten>
						<lsof:ImptoReten>
							<lsof:TipoImp>15</lsof:TipoImp>
							<lsof:TasaImp><<STREXTRACT(vTotales,"<TasaIVA>", "</TasaIVA>")>></lsof:TasaImp>
							<lsof:MontoImp><<STREXTRACT(vTotales,"<MontoIVA>", "</MontoIVA>")>></lsof:MontoImp>
						</lsof:ImptoReten>							
					</lsof:ImptoReten>
					<lsof:IVANoRet />
					<lsof:CredEC />
					<lsof:GrntDep />
					<lsof:Comisiones />
					<lsof:MntTotal><<STREXTRACT(vTotales,"<MontoTotal>", "</MontoTotal>")>></lsof:MntTotal>
					<lsof:MontoNF />
					<lsof:MontoPeriodo />
					<lsof:SaldoAnterior />
					<lsof:VlrPagar />
				</lsof:Totales>
				<lsof:OtraMoneda />
			</lsof:Encabezado>
			<lsof:Detalle>
ENDTEXT

vContadorLineas=0
vDetalleDocumento=STREXTRACT(vpDatosElectronicos, "<DetalleDocumento>", "</DetalleDocumento>")

DO WHILE .t.
	vContadorLineas=vContadorLineas+1
	
	vItemActive=STREXTRACT(vDetalleDocumento, "<Linea>", "</Linea>", vContadorLineas)
	
	IF EMPTY(ALLTRIM(vItemActive)) THEN
		EXIT
	ENDIF
		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
				<lsof:Detalle>
					<lsof:NroLinDet><<ALLTRIM(STR(vContadorLineas))>></lsof:NroLinDet>
					<lsof:CdgItem>
						<lsof:CdgItem>
							<lsof:TpoCodigo>INT1</lsof:TpoCodigo>
							<lsof:VlrCodigo>SIN CODIGO</lsof:VlrCodigo>
						</lsof:CdgItem>
					</lsof:CdgItem>
	ENDTEXT
	vCantidadLinea  = VAL(STREXTRACT(vItemActive,"<Cantidad>", "</Cantidad>"))
	vPrecioLinea	= VAL(STREXTRACT(vItemActive,"<Precio>", "</Precio>"))
	vTotalLinea		= VAL(STREXTRACT(vItemActive,"<Total>", "</Total>"))
	
	vProductoNoFacturable=((vCantidadLinea=0) .or. (vPrecioLinea=0) .or. (vTotalLinea=0))

	IF STREXTRACT(vItemActive,"<Exento>", "</Exento>")="true" THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
					<lsof:IndExe>1</lsof:IndExe>
 		ENDTEXT
 	ELSE
		IF vProductoNoFacturable THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
					<lsof:IndExe>2</lsof:IndExe>
 			ENDTEXT
 		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
					<lsof:IndExe />
			ENDTEXT
		ENDIF
	ENDIF
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
					<lsof:Retenedor />
					<lsof:NmbItem><<STREXTRACT(vItemActive,"<Detalle>", "</Detalle>")>></lsof:NmbItem>
					<lsof:DscItem />
					<lsof:QtyRef />
					<lsof:UnmdRef />
					<lsof:PrcRef />	
	ENDTEXT
	
	IF vProductoNoFacturable THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
					<lsof:QtyItem />
					<lsof:Subcantidad />
					<lsof:FchElabor />
					<lsof:FchVencim />
					<lsof:UnmdItem>UN</lsof:UnmdItem>
					<lsof:PrcItem />
					<lsof:OtrMnda />
					<lsof:DescuentoPct />
					<lsof:DescuentoMonto />
					<lsof:SubDscto />
					<lsof:CodImpAdic>					
						<lsof:CodImpAdic>
							<lsof:CodTipImp>15</lsof:CodTipImp>
						</lsof:CodImpAdic>
					</lsof:CodImpAdic>					
					<lsof:MontoItem>0</lsof:MontoItem>
				</lsof:Detalle>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
					<lsof:QtyItem><<STREXTRACT(vItemActive,"<Cantidad>", "</Cantidad>")>></lsof:QtyItem>
					<lsof:Subcantidad />
					<lsof:FchElabor />
					<lsof:FchVencim />
					<lsof:UnmdItem>UN</lsof:UnmdItem>
					<lsof:PrcItem><<STREXTRACT(vItemActive,"<Precio>", "</Precio>")>></lsof:PrcItem>
					<lsof:OtrMnda />
					<lsof:DescuentoPct />
					<lsof:DescuentoMonto />
					<lsof:SubDscto />
					<lsof:CodImpAdic>					
						<lsof:CodImpAdic>
							<lsof:CodTipImp>15</lsof:CodTipImp>
						</lsof:CodImpAdic>
					</lsof:CodImpAdic>					
					<lsof:MontoItem><<STREXTRACT(vItemActive,"<Total>", "</Total>")>></lsof:MontoItem>
				</lsof:Detalle>
		ENDTEXT
	ENDIF
ENDDO

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
			</lsof:Detalle>
			<lsof:SubTotInfo />
ENDTEXT

vDscRecGlobales=STREXTRACT(vpDatosElectronicos, "<DscRecGbl>", "</DscRecGbl>")
STORE 0 TO vMontoDscGbl, vMontoRecGbl

IF !EMPTY(ALLTRIM(vDscRecGlobales)) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
			<lsof:DscRcgGlobal>
	ENDTEXT

	vContadorDscRecGlobales=0

	DO WHILE .t.
		vContadorDscRecGlobales=vContadorDscRecGlobales+1
		vDscRec=STREXTRACT(vDscRecGlobales, "<Globales>", "</Globales>", vContadorDscRecGlobales)

		IF EMPTY(ALLTRIM(vDscRec)) THEN
			EXIT
		ENDIF

		IF STREXTRACT(vDscRec,"<TipoMovimiento>", "</TipoMovimiento>")="D" THEN
			vMontoDscGbl=vMontoDscGbl+VAL(STREXTRACT(vDscRec,"<Monto>", "</Monto>"))
		ELSE
			vMontoRecGbl=vMontoRecGbl+VAL(STREXTRACT(vDscRec,"<Monto>", "</Monto>"))
		ENDIF
		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
					<lsof:DscRcgGlobal>
						<lsof:NroLinDR><<ALLTRIM(STR(vContadorDscRecGlobales))>></lsof:NroLinDR>
						<lsof:TpoMov><<STREXTRACT(vDscRec,"<TipoMovimiento>", "</TipoMovimiento>")>></lsof:TpoMov>
						<lsof:GlosaDR><<STREXTRACT(vDscRec,"<Glosa>", "</Glosa>")>></lsof:GlosaDR>
						<lsof:TpoValor><<STREXTRACT(vDscRec,"<TipoValor>", "</TipoValor>")>></lsof:TpoValor>
						<lsof:ValorDR><<STREXTRACT(vDscRec,"<Monto>", "</Monto>")>></lsof:ValorDR>
						<lsof:ValorDROtrMnda />
						<lsof:IndExeDR />
					</lsof:DscRcgGlobal>
		ENDTEXT
	ENDDO
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
			</lsof:DscRcgGlobal>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
			<lsof:DscRcgGlobal />
	ENDTEXT 	
ENDIF

vReferencia=STREXTRACT(vpDatosElectronicos, "<ReferenciaDocumento>", "</ReferenciaDocumento>")


IF !EMPTY(ALLTRIM(vReferencia)) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
			<lsof:Referencia>
	ENDTEXT
	
	vContadorDocRef=0
	DO WHILE .t.
		vContadorDocRef=vContadorDocRef+1
		vDocRef=STREXTRACT(vReferencia, "<Documento>", "</Documento>", vContadorDocRef)
		
		IF EMPTY(ALLTRIM(vDocRef)) THEN
			EXIT
		ENDIF
		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vContadorDocRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef><<STREXTRACT(vDocRef,"<TipoDoc>", "</TipoDoc>")>></lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<STREXTRACT(vDocRef,"<FolioDoc>", "</FolioDoc>")>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<STREXTRACT(vDocRef,"<FechaRef>", "</FechaRef>")>></lsof:FchRef>
		ENDTEXT
		
		IF EMPTY(ALLTRIM(STREXTRACT(vDocRef,"<TipoCorreccion>", "</TipoCorreccion>"))) THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 		
					<lsof:CodRef />
			ENDTEXT
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 		
					<lsof:CodRef><<STREXTRACT(vDocRef,"<TipoCorreccion>", "</TipoCorreccion>")>></lsof:CodRef>
			ENDTEXT
		ENDIF
		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 			
					<lsof:RazonRef><<STREXTRACT(vDocRef,"<Glosa>", "</Glosa>")>></lsof:RazonRef>
				</lsof:Referencia>					
		ENDTEXT
	ENDDO
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
			</lsof:Referencia>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2 	
			<lsof:Referencia />
	ENDTEXT
ENDIF

*!*	GO TOP IN prPrm
*!*	aAdjuntos(1)	= DTOC(DATE())+"T"+TIME()
*!*	aAdjuntos(2)	= ""
*!*	aAdjuntos(3)	= ""
*!*	aAdjuntos(4)	= ""
*!*	aAdjuntos(5)	= ""
*!*	aAdjuntos(6)	= ""
*!*	aAdjuntos(7)	= ""
*!*	aAdjuntos(8)	= vCadenaOBS
*!*	aAdjuntos(9)	= ""
*!*	*aAdjuntos(10)	= aRespuesta(10)
*!*	aAdjuntos(10)	= ""
*!*	aAdjuntos(11)	= vNombreDocumento

*!*	IF SEEK(vgTipoDoc, "DEFDOC",1) THEN
*!*		aAdjuntos(12)	=ALLTRIM(DefDoc.flPrini)
*!*	ELSE
*!*		aAdjuntos(12)	=""
*!*	ENDIF
*!*	aAdjuntos(13)	="1"

*!*	GO TOP IN prPrm
*!*	DO CASE
*!*		CASE vgTipoDoc="FX"
*!*			vCopiasDoc=prprm.Copias1
*!*		CASE vgTipoDoc="F3"
*!*			vCopiasDoc=prprm.Copias2
*!*		CASE vgTipoDoc="N1"
*!*			vCopiasDoc=prprm.Copias3
*!*		CASE vgTipoDoc="D6"
*!*			vCopiasDoc=prprm.Copias4
*!*		CASE vgTipoDoc="EG"
*!*			vCopiasDoc=prprm.Copias5
*!*	OTHERWISE
*!*		vCopiasDoc=2
*!*	ENDCASE

aAdjuntos(12)=vImpresoraSeleccionada
aAdjuntos(13)=vNumeroCopias
		
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE FLAGS 2
			<lsof:Comisiones />
            <lsof:Adjuntos>
                  <lsof:TmsFirma><<DTOC(DATE())+"T"+TIME()>></lsof:TmsFirma>
                  <lsof:DataBase64Archivo1></lsof:DataBase64Archivo1>
                  <lsof:DataBase64Archivo2></lsof:DataBase64Archivo2>
                  <lsof:DataBase64Archivo3></lsof:DataBase64Archivo3>
                  <lsof:DataBase64Archivo4></lsof:DataBase64Archivo4>
                  <lsof:DataBase64Archivo5></lsof:DataBase64Archivo5>
                  <lsof:DataBase64Archivo6></lsof:DataBase64Archivo6>
                  <lsof:Observacion><<vCadenaOBS>></lsof:Observacion>
                  <lsof:EmailReceptor><<Alltrim(aAdjuntos(9))>></lsof:EmailReceptor>
                  <lsof:EmailEmisor><<ALLTRIM(This.pFiltraEspeciales(aAdjuntos(10)))>></lsof:EmailEmisor>
                  <lsof:Subject><<vNombreDocumento>></lsof:Subject>
                  <lsof:Impresora><<vImpresoraSeleccionada>></lsof:Impresora>
                  <lsof:Copias><<vNumeroCopias>></lsof:Copias>
				  <lsof:DireccionDespacho></lsof:DireccionDespacho>
				  <lsof:NotaDeVenta></lsof:NotaDeVenta>
				  <lsof:CoordenadasDespacho></lsof:CoordenadasDespacho>
                  <lsof:SucursalReceptor></lsof:SucursalReceptor>
                  <lsof:MedioPago><<vMedioPago>></lsof:MedioPago>
                  <lsof:MontoDescuentoCabecera><<IIF(vMontoDscGbl=0, "0", ALLTRIM(STR(vMontoDscGbl)))>></lsof:MontoDescuentoCabecera>
                  <lsof:MontoRecargoCabecera><<IIF(vMontoRecGbl=0, "0", ALLTRIM(STR(vMontoRecGbl)))>></lsof:MontoRecargoCabecera>
                  <lsof:TotalImpuestosAdicionales>0</lsof:TotalImpuestosAdicionales>
               </lsof:Adjuntos>		
		</lsof:Documento>
	</lsof:dte>
</lsof:PutDTE>
</soapenv:Body>
</soapenv:Envelope>	
ENDTEXT

vArchivo=ADDBS(ALLTRIM(StdXML))+vNumeroDocumento+"-"+;
		  PADL(ALLTRIM(STR(HOUR(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(MINUTE(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(SEC(DATETIME()))),2,"0")+;
		  ".XML"
		
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Proveedores, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
ELSE
	vGrab = FPUT(vXML,vEncabezado)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	ELSE
		IF !FCLOSE(vXML) then
			=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
		ENDIF
	ENDIF
ENDIF

RETURN vEncabezado
ENDPROC
PROCEDURE rutina9v
LPARAMETERS vpTipoDoc, vpFolioDoc, vpCodDoc, vpModDoc, vpFechaIni, vpFecVen, aDTCli, vpMontoNeto, ;
			vpMontoExento, vpTasaIVA, vpMontoIVA, vpMontoTotal, DocRef, vpCodVend, GDespacho, ;
			vpCondicionPago, vpCodSuc, vpTipoDocEnvioDTE, vpDevolucionParcial, vpRetenIva, ;
			aDscRecCab, vpNotaVenta, vpDireccionDespacho, vpCoordenadas

PUBLIC vpRutCliente, vpNombreCliente, vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad

vpRutCliente	= aDTCli(1)
vpNombreCliente	= aDTCli(2)
vpGiro			= aDTCli(3)
vpContacto		= aDTCli(4)
vpeMail			= aDTCli(5)
vpDireccion		= aDTCli(6)
vpComuna		= aDTCli(7)	
vpCiudad		= aDTCli(8)

IF !This.pVerificaEstructurasEnvioDTE(vpTipoDocEnvioDTE,vpDevolucionParcial) THEN
	=MESSAGEBOX("Existen Problemas en la Estructura necesaria para El Envio del DTE")
	RETURN .f.
ENDIF

STORE "" TO vCadenaObservacionCliente, vCadenaVendedor, vCadenaRuta, ;
			vCadenaCondicionPago, vFormadePago, vSucursalRecepcion

STORE 0 TO vMontoDscCabecera, vMontoRecCabecera, vMontoImpAdic

IF SEEK(PADL(ALLTRIM(vpRutCliente),12," "), "CLIENTES",1) THEN
	vCadenaObservacionCliente=ALLTRIM(Clientes.OBSERV1)+" "+ALLTRIM(Clientes.OBSERV2)+" "+;
							  ALLTRIM(Clientes.OBSERV3)+" "+ALLTRIM(Clientes.OBSERV4)+;
							  ALLTRIM(Clientes.OBSERV5)
	IF !EMPTY(ALLTRIM(Clientes.Ruta)) THEN
		IF SEEK(Clientes.Ruta, "CLIRUTAS",1) THEN
			vCadenaRuta=ALLTRIM(CliRutas.Descri)
		ENDIF
	ENDIF
	IF VAL(vpCodSuc)>0 THEN
		IF SEEK(vpRutCliente+vpCodSuc, "DIRECCLI",1) THEN
			vSucursalRecepcion=vpCodSuc+"-"+ALLTRIM(Direccli.NomCLi)
		ENDIF
	ENDIF
ENDIF

CALCULATE SUM(MonDsc) TO vMontoDscCabecera FOR INLIST(TipDsc, 7,12) IN DscCur
CALCULATE SUM(MonDsc) TO vMontoRecCabecera FOR INLIST(TipDsc, 10,13) IN DscCur
CALCULATE SUM(MonDsc) TO vMontoImpAdic FOR INLIST(TipDsc, 5,9) IN DscCur

*!*	IF SEEK(PADL(ALLTRIM(vpRutCliente),12," "), "CLIENTES",1) THEN
*!*		vCadenaObservacionCliente=ALLTRIM(Clientes.OBSERV1)+" COORDENADAS: "+ALLTRIM(Clientes.OBSERV6)
*!*		
*!*		IF !EMPTY(ALLTRIM(Clientes.Ruta)) THEN
*!*			IF SEEK(Clientes.Ruta, "CLIRUTAS",1) THEN
*!*				vCadenaRuta=ALLTRIM(CliRutas.Descri)
*!*			ENDIF
*!*		ENDIF
*!*	ENDIF

IF SEEK(vpCodVend, "VENDEDOR",1) THEN
	vCadenavendedor="("+ALLTRIM(Vendedor.veCodigo)+") "+ALLTRIM(Vendedor.veNombre)
ENDIF

IF !EMPTY(vpCondicionPago) THEN
	IF SEEK(vpCondicionPago, "CONDIPAG",1) THEN
		vCadenaCondicionPago=ALLTRIM(CondiPag.coDescri)
		vFormaDePago=ALLTRIM(STR(CondiPag.coTipoSNII))
	ENDIF
ENDIF

vNumeroCajas=0

CALCULATE SUM(Cantidad+(Fraccion/Envase)) TO vNumeroCajas IN ItemCur

***** Verifica si el documento es exento o no; y si es Guia de Despacho o no
STORE .f. TO vDocExento, vDocGuiaDespacho
vNombreDocumento=""
IF SEEK(vgTipoDoc, "TIPODOC",1) THEN
	vNombreDocumento=ALLTRIM(TipoDoc.DetDoc)
	vDocExento		=TipoDoc.Exento
	vDocGuiaDespacho=TipoDoc.Traslado
ENDIF

IF prPrm.IncOBS THEN
	IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN
		IF vDocGuiaDespacho THEN
			vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
					   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
					   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
					   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
		ELSE
*!*				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
*!*						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
*!*						   " - CONDICION DE PAGO: "+ALLTRIM(vCadenaCondicionPago)+IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
*!*						   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
			**** A pedido de Don roman  se saco la descrpicion de la Condicion de Pago
			vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
					   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
					   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
					   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")		
		ENDIF
	ELSE
		IF VARTYPE(DocRef)!="L" THEN
			IF VAL(DocRef(1,12))=2 THEN
				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+;
						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
						   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")
			ELSE
				vCadenaOBS=IIF(EMPTY(ALLTRIM(vObservaciones)),ALLTRIM(vCadenaObservacionCliente), ALLTRIM(vObservaciones))+" - "+;
						   " - VENDEDOR "+ALLTRIM(vCadenaVendedor)+" - RUTA: "+(vCadenaRuta)+;
						   IIF(!EMPTY(vpCodSuc)," - CODSUC: "+vpCodSuc, "")+;
						   IIF(vNumeroCajas>0, " - NRO CAJAS: "+ALLTRIM(STR(vNumeroCajas,10,2)),"")
			ENDIF
		ENDIF
	ENDIF
ELSE
	vCadenaOBS=ALLTRIM(vObservaciones)
ENDIF

*!*	IF VARTYPE(aDscRecCab(1,1))!="L" THEN
*!*		FOR vI=1 TO ALEN(aDscRecCab,1)
*!*			vCadenaOBS=ALLTRIM(vCadenaOBS)+", Descuento Global Aplicado : "+;
*!*					   ALLTRIM(STR(aDscRecCab(vI,2),10,2))+" "+ALLTRIM(aDscRecCab(vI,4))
*!*		ENDFOR
*!*	ENDIF
	
GO TOP IN Empres
IF !EOF("EMPRES") THEN
	IF EMPTY(ALLTRIM(Empres.EmpRut)) THEN
	
		=MESSAGEBOX("El Campo del Rut del Emisor esta vacio, Proceso de envio denegado")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("No existen Datos de la Empresa")
	RETURN .f.
ENDIF 	

STORE "" TO vRutCliente, vDigitoVerificador


vCadenaRut=ALLTRIM(Empres.EmpRut)
vModalidad=1
FOR vI=1 TO LEN(ALLTRIM(Empres.EmpRut))
	vLetraDigito=SUBSTR(vCadenaRut,vI,1)
	IF vLetraDigito=="-" THEN
		vModalidad=2
		LOOP
	ENDIF
	
	IF vModalidad=2 THEN
		vDigitoVerificador=vDigitoVerificador+vLetradigito
	ELSE
		vRutCliente=vRutCliente+vLetraDigito
	ENDIF
ENDFOR

vClienteEmisor=PADL(ALLTRIM(vRutCliente+"-"+vDigitoVerificador),12," ")

STORE "" TO vComunaOrigen, vCiudadOrigen, vDireccionOrigen

IF !EMPTY(ALLTRIM(vClienteEmisor)) THEN
	IF SEEK(vClienteEmisor, "CLIENTES",1) THEN
		vComunaOrigen		=This.pFiltraEspeciales(Clientes.clComuna)
		vCiudadOrigen		=This.pFiltraEspeciales(Clientes.clCiudad)
		vDireccionOrigen	=This.pFiltraEspeciales(Clientes.clDirec)
	ELSE
		=MESSAGEBOX("Error intentando localizar al Emisor en Maestra de Clientes")
		RETURN .f.
	ENDIF
ELSE
	=MESSAGEBOX("Rut de Emisor no valido")
	RETURN .f.
ENDIF

IF This.pExtraeDatosEmisor(vRutCliente, vDigitoVerificador)=0 THEN
	=MESSAGEBOX("No existen Datos del Emisor")
	RETURN .f.
ENDIF

*!*	<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
*!*	xmlns:lsof="http://www.lsof.cl">
*!*	   <soapenv:Header/>
*!*	   <soapenv:Body>
vNumeroDocumento='"'+vpTipodoc+vpFolioDoc+'33'+'"'
vRutEmisor=ALLTRIM(aRespuesta[2])+"-"+ALLTRIM(aRespuesta[3])

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:lsof="http://www.lsof.cl/">
<soapenv:Header/>
<soapenv:Body>
<lsof:PutDTE>
	<lsof:dte>
		<lsof:Documento ID=<<vNumeroDocumento>>>
			<lsof:Encabezado>
				<lsof:IdDoc>
					<lsof:TipoDTE><<ALLTRIM(vpCodDoc)>></lsof:TipoDTE>
					<lsof:Folio><<ALLTRIM(vpFolioDoc)>></lsof:Folio>
					<lsof:FchEmis><<vpFechaIni>></lsof:FchEmis>
					<lsof:IndNoRebaja />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF vDocGuiaDespacho .and. VARTYPE(gDespacho)!="L" THEN
	IF VAL(gDespacho(4))=0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho />
		ENDTEXT
	ELSE 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho><<GDespacho(4)>></lsof:TipoDespacho>
		ENDTEXT
	ENDIF
	vEncabezado=vEncabezado+CHR(10)
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IndTraslado><<GDespacho(1)>></lsof:IndTraslado>
	ENDTEXT
ELSE 	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TipoDespacho />
					<lsof:IndTraslado />
	ENDTEXT
ENDIF 	
vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TpoImpresion />
					<lsof:IndServicio />
					<lsof:MntBruto />
					<lsof:FmaPago><<ALLTRIM(vFormaDePago)>></lsof:FmaPago>
					<lsof:FmaPagExp />
					<lsof:FchCancel />
					<lsof:MntCancel />
					<lsof:SaldoInsol />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF !vDocGuiaDespacho THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntPagos />
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntPagos>	
						<lsof:MntPagos>
							<lsof:FchPago><<vpFecVen>></lsof:FchPago>
							<lsof:MntPago><<vpMontoTotal>></lsof:MntPago>
							<lsof:Descripcion><<IIF(VARTYPE(gDespacho)!="L", gDespacho(2), "")>></lsof:Descripcion>
						</lsof:MntPagos>
					</lsof:MntPagos>
	ENDTEXT
ENDIF
vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PeriodoDesde />
					<lsof:PeriodoHasta />
					<lsof:MedioPago />
					<lsof:TpoCtaPago />
					<lsof:NumCtaPago />
					<lsof:BcoPago />
					<lsof:TermPagoCdg />
					<lsof:TermPagoGlosa />
					<lsof:TermPagoDias />
ENDTEXT
vEncabezado=vEncabezado+CHR(10)

IF !EMPTY(ALLTRIM(vpFecVen)) then 			
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 					
					<lsof:FchVenc><<vpFecVen>></lsof:FchVenc>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 					
					<lsof:FchVenc><<vpFechaIni>></lsof:FchVenc>
	ENDTEXT
ENDIF
vEncabezado=vEncabezado+CHR(10)
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
				</lsof:IdDoc>
				<lsof:Emisor>
					<lsof:RUTEmisor><<vRutEmisor>></lsof:RUTEmisor>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)
aRespuesta(5)=This.pFiltraEspeciales(aRespuesta(5))

IF !EMPTY(ALLTRIM(aRespuesta(5))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RznSoc><<aRespuesta(5)>></lsof:RznSoc>
	ENDTEXT
ELSE 	
	=MESSAGEBOX("Error al extraer el Numero de Rut del Emisor")
	RETURN .f.
ENDIF

vEncabezado=vEncabezado+CHR(10)
aRespuesta(5)=This.pFiltraEspeciales(aRespuesta(6))

IF !EMPTY(ALLTRIM(aRespuesta(6))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:GiroEmis><<aRespuesta(6)>></lsof:GiroEmis>
	ENDTEXT
ELSE
	=MESSAGEBOX("Error al extraer el Giro del Emisor")
	RETURN .f.
ENDIF

vEncabezado=vEncabezado+CHR(10)
aRespuesta(9)=This.pFiltraEspeciales(aRespuesta(9))

IF !EMPTY(ALLTRIM(aRespuesta(9))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Telefono><<aRespuesta(9)>></lsof:Telefono>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Telefono/>
	ENDTEXT
ENDIF 	

vEncabezado=vEncabezado+CHR(10)
aRespuesta(10)=This.pFiltraEspeciales(aRespuesta(10))

IF !EMPTY(ALLTRIM(aRespuesta(10))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CorreoEmisor><<aRespuesta(10)>></lsof:CorreoEmisor>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CorreoEmisor/>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
IF !EMPTY(ALLTRIM(aRespuesta(7))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Acteco><<aRespuesta(7)>></lsof:Acteco>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Acteco/>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*	*!*						<lsof:GuiaExport>
*!*	*!*							<lsof:GuiaExport>
*!*	*!*								<lsof:CdgTraslado />
*!*	*!*								<lsof:FolioAut />
*!*	*!*								<lsof:FchAut />
*!*	*!*							</lsof:GuiaExport>
*!*	*!*						</lsof:GuiaExport>
*!*	*!*						<lsof:Sucursal />
*!*						<lsof:GuiaExport />
*!*						<lsof:Sucursal />
*!*	ENDTEXT

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:GuiaExport />
					<lsof:Sucursal />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)
IF !EMPTY(ALLTRIM(aRespuesta(8))) THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:CdgSIISucur><<aRespuesta(8)>></lsof:CdgSIISucur>
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:CdgSIISucur />
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:DirOrigen><<ALLTRIM(vDireccionOrigen)>></lsof:DirOrigen>
					<lsof:CmnaOrigen><<ALLTRIM(vComunaOrigen)>></lsof:CmnaOrigen>
					<lsof:CiudadOrigen><<ALLTRIM(vCiudadOrigen)>></lsof:CiudadOrigen>
					<lsof:CdgVendedor><<vpCodVend>></lsof:CdgVendedor>
					<lsof:IdAdicEmisor />
				</lsof:Emisor>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

***** Rutina que Filtra los caracteres especiales

vpNombreCliente		= This.pFiltraEspeciales(vpNombreCliente)
vpGiro				= This.pFiltraEspeciales(vpGiro)
vpContacto			= This.pFiltraEspeciales(vpContacto)
vpeMail				= This.pFiltraEspeciales(vpEmail)
vpDireccion			= This.pFiltraEspeciales(vpDireccion)
vpComuna			= This.pFiltraEspeciales(vpComuna)
vpCiudad			= This.pFiltraEspeciales(vpCiudad)
vpDireccionDespacho = This.pFiltraEspeciales(vpDireccionDespacho)

GO TOP IN prPrm
vpCoordenadas		= IIF(prPrm.ImpExt,ALLTRIM(vpCoordenadas),"")


IF EMPTY(ALLTRIM(vpGiro)) THEN
	vpGiro="PERSONA NATURAL"
ELSE
	IF LEN(ALLTRIM(vpGiro))>40 THEN
		vpGiro=SUBSTR(ALLTRIM(vpGiro),1,40)
	ELSE
		vpGiro=ALLTRIM(vpGiro)
	ENDIF
ENDIF

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
				<lsof:RUTMandante />
				<lsof:Receptor>
					<lsof:RUTRecep><<ALLTRIM(vpRutCliente)>></lsof:RUTRecep>
					<lsof:CdgIntRecep />
					<lsof:RznSocRecep><<ALLTRIM(vpNombreCliente)>></lsof:RznSocRecep>
					<lsof:Extranjero />
					<lsof:GiroRecep><<ALLTRIM(vpGiro)>></lsof:GiroRecep>
					<lsof:Contacto><<ALLTRIM(vpContacto)>></lsof:Contacto>
					<lsof:CorreoRecep><<ALLTRIM(vpeMail)>></lsof:CorreoRecep>
					<lsof:DirRecep><<ALLTRIM(vpDireccion)>></lsof:DirRecep>
					<lsof:CmnaRecep><<ALLTRIM(vpComuna)>></lsof:CmnaRecep>
					<lsof:CiudadRecep><<ALLTRIM(vpCiudad)>></lsof:CiudadRecep>
					<lsof:DirPostal />
					<lsof:CmnaPostal />
					<lsof:CiudadPostal />
				</lsof:Receptor>
				<lsof:RUTSolicita />
				<lsof:Transporte />
				<lsof:Totales>		
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntNeto><<ALLTRIM(STR(vpMontoNeto))>></lsof:MntNeto>
					<lsof:MntExe><<ALLTRIM(STR(vpMontoExento))>></lsof:MntExe>
					<lsof:MntBase />
					<lsof:MntMargenCom />
ENDTEXT 	
vEncabezado=vEncabezado+CHR(10)
IF !vDocExento THEN
	IF VARTYPE(gDespacho)!="L" THEN
		IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:TasaIVA />
					<lsof:IVA />
			ENDTEXT
		ELSE 		
			IF vpMontoIVA=0 THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TasaIVA/>
					<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
				ENDTEXT
			ELSE
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TasaIVA><<vpTasaIva>></lsof:TasaIVA>
					<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
				ENDTEXT
			ENDIF
		ENDIF
	ELSE
*!*			IF vpMontoIVA=0 THEN
*!*				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*!*						<lsof:TasaIVA/>
*!*						<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
*!*				ENDTEXT
*!*			ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:TasaIVA><<vpTasaIva>></lsof:TasaIVA>
					<lsof:IVA><<ALLTRIM(STR(vpMontoIVA))>></lsof:IVA>
			ENDTEXT
*!*			ENDIF
	ENDIF
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:TasaIVA />
					<lsof:IVA />
	ENDTEXT
ENDIF 	

vEncabezado=vEncabezado+CHR(10)

*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
*!*						<lsof:IVAProp />
*!*						<lsof:IVATerc />
*!*						<lsof:ImptoReten>
*!*							<lsof:ImptoReten>
*!*								<lsof:TipoImp />
*!*								<lsof:TasaImp />
*!*								<lsof:MontoImp />
*!*							</lsof:ImptoReten>
*!*						</lsof:ImptoReten>
*!*						<lsof:IVANoRet />
*!*						<lsof:CredEC />
*!*						<lsof:GrntDep />
*!*						<lsof:Comisiones>
*!*							<lsof:Comisiones>
*!*								<lsof:ValComNeto />
*!*								<lsof:ValComExe />
*!*								<lsof:ValComIVA />
*!*							</lsof:Comisiones>
*!*						</lsof:Comisiones>
*!*	ENDTEXT

*!*	                     <lsof:ImptoReten>
*!*	                        <lsof:ImptoReten>
*!*	                           <lsof:TipoImp>?</lsof:TipoImp>
*!*	                           <lsof:TasaImp>?</lsof:TasaImp>
*!*	                           <lsof:MontoImp>?</lsof:MontoImp>
*!*	                        </lsof:ImptoReten>
*!*	                     </lsof:ImptoReten>

CALCULATE SUM(DscCur.MonDsc) FOR DscCur.TipDsc=5 TO vSumaImptoAdic IN DscCur

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IVAProp />
					<lsof:IVATerc />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

IF vSumaImptoAdic=0 THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:ImptoReten />
	ENDTEXT
	vEncabezado=vEncabezado+CHR(10)
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:ImptoReten>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
	
	SELECT Cod_IAD as Codigo, ImptoAdic.id_SNII as CodSii, ImptoAdic.Monto as Porcentaje, SUM(MonDsc) as Monto ;
		FROM DscCur ;
		LEFT JOIN ImptoAdic ON ImptoAdic.Codigo=Cod_IAD ;
		WHERE TipDsc=5 ;
		GROUP BY Cod_IAD ;
		INTO CURSOR cImptoAdic
		
	IF _Tally>0 THEN 	
		GO TOP IN cImptoAdic
		DO WHILE !EOF("cIMPTOADIC")
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
	                    <lsof:ImptoReten>
                           <lsof:TipoImp><<ALLTRIM(STR(cImptoAdic.CodSII))>></lsof:TipoImp>
                           <lsof:TasaImp><<ALLTRIM(STR(cImptoAdic.Porcentaje,5,2))>></lsof:TasaImp>
                           <lsof:MontoImp><<ALLTRIM(STR(cImptoAdic.Monto))>></lsof:MontoImp>
                        </lsof:ImptoReten>
			ENDTEXT
			
			vEncabezado=vEncabezado+CHR(10)
			
			SKIP IN cImptoAdic
		ENDDO 		
	ENDIF

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					</lsof:ImptoReten>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
ENDIF 	

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:IVANoRet />
					<lsof:CredEC />
					<lsof:GrntDep />
					<lsof:Comisiones />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MntTotal><<ALLTRIM(STR(vpMontoTotal))>></lsof:MntTotal>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE
					<lsof:MontoNF />
					<lsof:MontoPeriodo />
					<lsof:SaldoAnterior />
					<lsof:VlrPagar />
				</lsof:Totales>
				<lsof:OtraMoneda />
			</lsof:Encabezado>
			<lsof:Detalle>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

vNumeroLinea=0

vDocExentoAfecto=.f.
IF VARTYPE(DocRef)!="L"  THEN
	IF SEEK(DocRef(1,14), "TIPODOC",2) THEN
		vDocExentoAfecto=TipoDoc.Exento
	ENDIF
ENDIF

GO TOP IN ItemCur
DO WHILE !EOF("ITEMCUR")
	IF DELETED("ITEMCUR") THEN
		SKIP IN ItemCur
		LOOP
	ENDIF

	IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN 		
		IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 .and. EMPTY(ALLTRIM(ItemCur.Detalle)) THEN
			SKIP IN ItemCur
			LOOP
		ENDIF
	ELSE
		IF VARTYPE(DocRef)!="L" THEN
			IF VAL(DocRef(1,12))!=2 THEN
				IF vpTipoDocEnvioDTE=1 THEN
					IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
						SKIP IN ItemCur
						LOOP
					ENDIF
				ENDIF
			ENDIF
		ELSE
			IF (ItemCur.Cantidad+ItemCur.Fraccion)<=0 THEN
				SKIP IN ItemCur
				LOOP
			ENDIF
		ENDIF
	ENDIF
	
	vLinea=ALLTRIM(STR(ItemCur.Linea))
	vNumeroLinea=vNumeroLinea+1
	
	vCodigoProducto=ALLTRIM(ItemCur.Codigo)
	
	IF ItemCur.Exento>0 THEN
		vItemExento="1"
	ELSE
		vItemExento=""
	ENDIF
	
	vUnidadMedida=This.pFiltraEspeciales(ItemCur.UniMed)
	vPrecioItem=ALLTRIM(STR(ItemCur.PrecioOrig,18,6))
	IF ItemCur.NetoDetalle>0 THEN
		vMontoVenta=ItemCur.NetoDetalle
	ELSE
		vMontoVenta=ItemCur.Exento
	ENDIF
	
	vImpuestoAdicional=""
	vNombreProducto=This.pFiltraEspeciales(ItemCur.Detalle)
	vCantidadItem=ALLTRIM(STR(ItemCur.Cantidad+(ItemCur.Fraccion/ItemCur.Envase),18,2))
	
	CALCULATE SUM(MonDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vMontoDescuentos
	CALCULATE SUM(PorDsc) IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vSumaDescuentos
	
	vMontoDescuentos=ALLTRIM(STR(vMontoDescuentos))
	vSumaDescuentos=ALLTRIM(STR(vSumaDescuentos))
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Detalle>
					<lsof:NroLinDet><<ALLTRIM(STR(vNumeroLinea))>></lsof:NroLinDet>
					<lsof:CdgItem>
						<lsof:CdgItem>
							<lsof:TpoCodigo><<vLinea>></lsof:TpoCodigo>
							<lsof:VlrCodigo><<vCodigoProducto>></lsof:VlrCodigo>
						</lsof:CdgItem>
					</lsof:CdgItem>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
	IF vDocExento THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe />
		ENDTEXT
	ELSE 		
		IF VARTYPE(gDespacho)!="L" THEN
			IF vDocGuiaDespacho .and. BETWEEN(gDespacho(3),3,10) THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe />
				ENDTEXT
			ELSE
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe><<vItemExento>></lsof:IndExe>
				ENDTEXT
			ENDIF
		ELSE
			IF vDocExentoAfecto THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe />
				ENDTEXT
			ELSE 	
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExe><<vItemExento>></lsof:IndExe>
				ENDTEXT
			ENDIF
		ENDIF
	ENDIF
	vEncabezado=vEncabezado+CHR(10)

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Retenedor />
					<lsof:NmbItem><<ALLTRIM(vNombreProducto)>></lsof:NmbItem>
					<lsof:DscItem />
					<lsof:QtyRef />
					<lsof:UnmdRef />
					<lsof:PrcRef />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	
	IF !INLIST(vpTipoDoc,"NE","NC","DE","ND") THEN 		
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
		ENDTEXT
	ELSE
		IF VARTYPE(DocRef)!="L" THEN
			IF VAL(DocRef(1,12))=2 .or. vpTipoDocEnvioDTE=0 THEN
					TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem />
					ENDTEXT
			ELSE
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
				ENDTEXT
			ENDIF
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:QtyItem><<vCantidadItem>></lsof:QtyItem>
			ENDTEXT
		ENDIF
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:Subcantidad />
					<lsof:FchElabor />
					<lsof:FchVencim />
					<lsof:UnmdItem><<ALLTRIM(vUnidadMedida)>></lsof:UnmdItem>
	ENDTEXT
	vEncabezado=vEncabezado+CHR(10)
	
	IF IIF(VARTYPE(vpMontoTotal)="N",vpMontoTotal!=0,VAL(vpMontoTotal)!=0) THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PrcItem><<vPrecioItem>></lsof:PrcItem>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:PrcItem />
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:OtrMnda />
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	IF VAL(vMontoDescuentos)>0 THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct><<vSumaDescuentos>></lsof:DescuentoPct>
					<lsof:DescuentoMonto><<vMontoDescuentos>></lsof:DescuentoMonto>
		ENDTEXT
	ELSE 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:DescuentoPct />
					<lsof:DescuentoMonto />
		ENDTEXT
	ENDIF
	
	vEncabezado=vEncabezado+CHR(10)
	CALCULATE CNT() IN DscCur FOR DscCur.Linea=ItemCur.Linea .and. INLIST(TipDsc,1,2,3) TO vNumeroDescuentos

	
	IF vNumeroDescuentos>0 THEN 	
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:SubDscto>
		ENDTEXT 		
		
		vEncabezado=vEncabezado+CHR(10)
	
		IF SEEK(ItemCur.Linea, "DSCCUR",2) THEN
			DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea
				IF DELETED("DSCCUR") THEN
					SKIP IN DscCur
					LOOP
				ENDIF
				
				IF !INLIST(DscCur.TipDsc,1,2,3) THEN
					SKIP IN DscCur
					LOOP
				ENDIF
		
				vMontoDescuentos=ALLTRIM(STR(DscCur.MonDsc))		
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:SubDscto>
							<lsof:TipoDscto>$</lsof:TipoDscto>
							<lsof:ValorDscto><<vMontoDescuentos>></lsof:ValorDscto>>
						</lsof:SubDscto>
				ENDTEXT
				vEncabezado=vEncabezado+CHR(10)
				SKIP IN DscCur
			ENDDO
*!*				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*							<lsof:SubDscto>
*!*								<lsof:TipoDscto />
*!*								<lsof:ValorDscto />
*!*							</lsof:SubDscto>
*!*				ENDTEXT

		ENDIF 		

		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					</lsof:SubDscto>
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:SubDscto />
		ENDTEXT
	ENDIF 		

	vEncabezado=vEncabezado+CHR(10)	
			
*!*		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*						<lsof:RecargoPct />
*!*						<lsof:RecargoMonto />
*!*						<lsof:SubRecargo>
*!*							<lsof:SubRecargo>
*!*								<lsof:TipoRecargo />
*!*								<lsof:ValorRecargo />
*!*							</lsof:SubRecargo>
*!*						</lsof:SubRecargo>
*!*		ENDTEXT

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RecargoPct />
					<lsof:RecargoMonto />
					<lsof:SubRecargo />
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)	
	
*	INDEX on STR(Linea,4)+STR(TipDsc,1) TAG TipDsc &3
	SET ORDER TO 3 IN DscCur
	IF SEEK(STR(ItemCur.Linea,4)+"5","DSCCUR",3) THEN
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:CodImpAdic>
		ENDTEXT 	

		vEncabezado=vEncabezado+CHR(10)	

		DO WHILE !EOF("DSCCUR") .and. DscCur.Linea=ItemCur.Linea .and. DscCur.TipDsc=5
			IF SEEK(DscCur.Cod_Iad, "IMPTOADIC",1) THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:CodImpAdic>
							<lsof:CodTipImp><<ALLTRIM(ImptoAdic.id_Snii)>></lsof:CodTipImp>
						</lsof:CodImpAdic>
				ENDTEXT
				vEncabezado=vEncabezado+CHR(10)	
			ENDIF
			
			SKIP IN DscCur
		ENDDO

		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
					</lsof:CodImpAdic>					
		ENDTEXT
	ELSE
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
					<lsof:CodImpAdic />					
		ENDTEXT 		
	ENDIF

	vEncabezado=vEncabezado+CHR(10)		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:MontoItem><<ALLTRIM(STR(vMontoVenta))>></lsof:MontoItem>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)		
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				</lsof:Detalle>
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	SKIP IN ItemCur
ENDDO 		

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Detalle>
ENDTEXT

vEncabezado=vEncabezado+CHR(10)

*!*	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
*!*				<lsof:SubTotInfo>
*!*					<lsof:SubTotInfo>
*!*						<lsof:NroSTI />
*!*						<lsof:GlosaSTI />
*!*						<lsof:OrdenSTI />
*!*						<lsof:SubTotNetoSTI />
*!*						<lsof:SubTotIVASTI />
*!*						<lsof:SubTotAdicSTI />
*!*						<lsof:SubTotExeSTI />
*!*						<lsof:ValSubtotSTI />
*!*						<lsof:LineasDeta />
*!*					</lsof:SubTotInfo>
*!*				</lsof:SubTotInfo>
*!*	ENDTEXT

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:SubTotInfo />
ENDTEXT

vEncabezado=vEncabezado+CHR(10)


IF VARTYPE(aDscRecCab(1,1))="L" THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal />
	ENDTEXT
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:DscRcgGlobal>
	ENDTEXT
	
	vEncabezado=vEncabezado+CHR(10)
	
	FOR vI=1 TO ALEN(aDscRecCab,1)
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 		
				<lsof:DscRcgGlobal>
					<lsof:NroLinDR><<ALLTRIM(STR(vI))>></lsof:NroLinDR>
					<lsof:TpoMov><<ALLTRIM(aDscRecCab(vI,1))>></lsof:TpoMov>
					<lsof:GlosaDR><<ALLTRIM(UPPER(aDscRecCab(vI,4)))>></lsof:GlosaDR>
					<lsof:TpoValor><<ALLTRIM(aDscRecCab(vI,3))>></lsof:TpoValor>
					<lsof:ValorDR><<ALLTRIM(STR(aDscRecCab(vI,2)))>></lsof:ValorDR>
					<lsof:ValorDROtrMnda />
		ENDTEXT
		vEncabezado=vEncabezado+CHR(10)
		IF aDscRecCab(vI,5)=0 THEN
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
						<lsof:IndExeDR />
			ENDTEXT
		ELSE
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:IndExeDR><<ALLTRIM(STR(aDscRecCab(vI,5)))>></lsof:IndExeDR>
			ENDTEXT
		ENDIF 		
		vEncabezado=vEncabezado+CHR(10)
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				</lsof:DscRcgGlobal>
		ENDTEXT
		vEncabezado=vEncabezado+CHR(10)
	ENDFOR

	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:DscRcgGlobal>
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)
vNumeroLineaRef=0

IF VARTYPE(aCasoRef)!="U" .or. VARTYPE(DocRef)!="L" .or. VARTYPE(aOrdenCompra)!="U" THEN
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)

	IF VARTYPE(aCasoRef)!="U" THEN
		vNumeroLineaRef=vNumeroLineaRef+1
		TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef>SET</lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(vpFolioDoc)))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<vpFechaIni>></lsof:FchRef>
					<lsof:CodRef />
					<lsof:RazonRef><<"CASO "+ALLTRIM(aCasoRef(1))>></lsof:RazonRef>
				</lsof:Referencia>					
		ENDTEXT
			
		vEncabezado=vEncabezado+CHR(10)
	ENDIF

	IF VARTYPE(DocRef)!="L" THEN 	
		FOR vI=1 TO ALEN(DocRef,1)
			vNumeroLineaRef=vNumeroLineaRef+1
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef><<ALLTRIM(DocRef(vI,14))>></lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(STR(VAL(DocRef(vI,17))))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<ALLTRIM(DTOC(DocRef(vI,3)))>></lsof:FchRef>
					<lsof:CodRef><<ALLTRIM(DocRef(vI,12))>></lsof:CodRef>
			ENDTEXT
			vEncabezado=vEncabezado+CHR(10)
			IF VARTYPE(aCasoRef)!="U" THEN
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RazonRef><<ALLTRIM(aCasoRef(2))>></lsof:RazonRef>
				</lsof:Referencia>
				ENDTEXT
			ELSE
				TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
					<lsof:RazonRef><<ALLTRIM(DocRef(vI,42))>></lsof:RazonRef>
				</lsof:Referencia>
				ENDTEXT
			ENDIF
			
			vEncabezado=vEncabezado+CHR(10)
		ENDFOR
	ENDIF
	
	IF VARTYPE(aOrdenCompra)!="U" THEN
		FOR vI=1 TO ALEN(aOrdenCompra,1)
			vNumeroLineaRef=vNumeroLineaRef+1
			TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
				<lsof:Referencia>
					<lsof:NroLinRef><<ALLTRIM(STR(vNumeroLineaRef))>></lsof:NroLinRef>
					<lsof:TpoDocRef>801</lsof:TpoDocRef>
					<lsof:IndGlobal />
					<lsof:FolioRef><<ALLTRIM(aOrdenCompra(vI,3))>></lsof:FolioRef>
					<lsof:RUTOtr />
					<lsof:FchRef><<ALLTRIM(DTOC(aOrdenCompra(vI,2)))>></lsof:FchRef>
					<lsof:CodRef />
					<lsof:RazonRef><<ALLTRIM(aOrdenCompra(vI,4))>></lsof:RazonRef>
				</lsof:Referencia>
			ENDTEXT
			vEncabezado=vEncabezado+CHR(10)
		ENDFOR 			
	ENDIF
	
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			</lsof:Referencia>
	ENDTEXT

	vEncabezado=vEncabezado+CHR(10)
ELSE
	TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Referencia />
	ENDTEXT
ENDIF

vEncabezado=vEncabezado+CHR(10)

GO TOP IN prPrm

aAdjuntos(1)	=DTOC(DATE())+"T"+TIME()
aAdjuntos(2)	=""
aAdjuntos(3)	=""
aAdjuntos(4)	=""
aAdjuntos(5)	=""
aAdjuntos(6)	=""
aAdjuntos(7)	=""
aAdjuntos(8)	=vCadenaOBS
aAdjuntos(9)	=vpeMail
aAdjuntos(10)	=aRespuesta(10)
aAdjuntos(11)	=vNombreDocumento+" # "+vpFolioDoc

IF SEEK(vgTipoDoc, "DEFDOC",1) THEN
	aAdjuntos(12)	=ALLTRIM(DefDoc.flPrini)
ELSE
	aAdjuntos(12)	=""
ENDIF
aAdjuntos(13)	="1"

GO TOP IN prPrm
DO CASE
	CASE vgTipoDoc="XE"
		vCopiasDoc=prprm.Copias1
	CASE vgTipoDoc="FE"
		vCopiasDoc=prprm.Copias2
	CASE vgTipoDoc="NE"
		vCopiasDoc=prprm.Copias3
	CASE vgTipoDoc="DE"
		vCopiasDoc=prprm.Copias4
	CASE vgTipoDoc="GE"
		vCopiasDoc=prprm.Copias5
OTHERWISE
	vCopiasDoc=2
ENDCASE

TEXT TO vEncabezado TEXTMERGE NOSHOW ADDITIVE 	
			<lsof:Comisiones />
            <lsof:Adjuntos>
                  <lsof:TmsFirma><<aAdjuntos(1)>></lsof:TmsFirma>
                  <lsof:DataBase64Archivo1><<Alltrim(aAdjuntos(2))>></lsof:DataBase64Archivo1>
                  <lsof:DataBase64Archivo2><<Alltrim(aAdjuntos(3))>></lsof:DataBase64Archivo2>
                  <lsof:DataBase64Archivo3><<Alltrim(aAdjuntos(4))>></lsof:DataBase64Archivo3>
                  <lsof:DataBase64Archivo4><<Alltrim(aAdjuntos(5))>></lsof:DataBase64Archivo4>
                  <lsof:DataBase64Archivo5><<Alltrim(aAdjuntos(6))>></lsof:DataBase64Archivo5>
                  <lsof:DataBase64Archivo6><<Alltrim(aAdjuntos(7))>></lsof:DataBase64Archivo6>
                  <lsof:Observacion><<Alltrim(aAdjuntos(8))>></lsof:Observacion>
                  <lsof:EmailReceptor><<Alltrim(aAdjuntos(9))>></lsof:EmailReceptor>
                  <lsof:EmailEmisor><<This.pFiltraEspeciales(Alltrim(aAdjuntos(10)))>></lsof:EmailEmisor>
                  <lsof:Subject><<This.pFiltraEspeciales(Alltrim(aAdjuntos(11)))>></lsof:Subject>
                  <lsof:Impresora><<Alltrim(aAdjuntos(12))>></lsof:Impresora>
                  <lsof:Copias><<Alltrim(STR(vCopiasDoc))>></lsof:Copias>
				  <lsof:DireccionDespacho><<IIF(VARTYPE(vpDireccionDespacho)="L", "", ALLTRIM(vpDireccionDespacho))>></lsof:DireccionDespacho>
				  <lsof:NotaDeVenta><<IIF(VARTYPE(vpNotaVenta)="L","", vpNotaVenta)>></lsof:NotaDeVenta>
				  <lsof:CoordenadasDespacho><<IIF(VARTYPE(vpCoordenadas)="L","", ALLTRIM(vpCoordenadas))>></lsof:CoordenadasDespacho>
                  <lsof:SucursalReceptor><<vSucursalRecepcion>></lsof:SucursalReceptor>
                  <lsof:MedioPago><<ALLTRIM(vCadenaCondicionPago)>></lsof:MedioPago>
                  <lsof:MontoDescuentoCabecera><<IIF(vMontoDscCabecera=0, "0", ALLTRIM(STR(vMontoDscCabecera)))>></lsof:MontoDescuentoCabecera>
                  <lsof:MontoRecargoCabecera><<IIF(vMontoRecCabecera =0, "0", ALLTRIM(STR(vMontoRecCabecera )))>></lsof:MontoRecargoCabecera>
                  <lsof:TotalImpuestosAdicionales><<IIF(vMontoImpAdic =0, "0", ALLTRIM(STR(vMontoImpAdic)))>></lsof:TotalImpuestosAdicionales>
               </lsof:Adjuntos>		
		</lsof:Documento>
	</lsof:dte>
</lsof:PutDTE>
</soapenv:Body>
</soapenv:Envelope>	
ENDTEXT
*vpNotaVenta, vpDireccionDespacho, vpCoordenadas


vArchivo=ADDBS(ALLTRIM(StdXML))+"PRUEBA"+vgTipoDoc+vpFolioDoc+"-"+;
		  PADL(ALLTRIM(STR(HOUR(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(MINUTE(DATETIME()))),2,"0")+;
		  PADL(ALLTRIM(STR(SEC(DATETIME()))),2,"0")+;
		  ".XML"
		
vXML=FCREATE(vArchivo)
IF vXML=-1 THEN
	=MESSAGEBOX("Error al Crear el Archivo XML de Clientes, por Favor revisar la ruta seleccionada"+CHR(13)+"Ruta y Archivo : "+ALLTRIM(vArchivo))
ELSE
	vGrab = FPUT(vXML,vEncabezado)
	IF vGrab=0 then
		=MESSAGEBOX("Ocurrio un Error al intentar escribir en el disco, operacion suspendida")
	ELSE
		IF !FCLOSE(vXML) then
			=MESSAGEBOX("Error al intentar cerrar el Archivo, operacion suspendida, sistema inestable")
		ENDIF
	ENDIF
ENDIF
*DO FORM wMuestraXML WITH vEncabezado TO bResultado
*!*	IF bResultado=2 THEN
*!*		RETURN .f.
*!*	ENDIF

*RELEASE vpRutCliente, vpNombreCliente, vpGiro, vpContacto, vpeMail, vpDireccion, vpComuna, vpCiudad

RETURN vEncabezado
ENDPROC
PROCEDURE saldoultimoproducto
LPARAMETERS vpBodega, vpProducto

GO BOTTOM in CtrlPer

vFechaUltima=CTOD("01/"+PADL(ALLTRIM(STR(CtrlPer.MesPer)),2,"0")+"/"+PADL(ALLTRIM(STR(CtrlPer.AnoPer)),4,"0"))

IF This.mActivaTablas(.f.,vFechaUltima,.f.,.f.,.f.,.f.,.t.) THEN
	IF SEEK(vpBodega+vpProducto, "tSALDOS",1) THEN
		.CantidadUltima=tSaldos.SalFinTmp
		.FraccionUltima=tSaldos.SalFraFinT
	ELSE
		.CantidadUltima=0
		.FraccionUltima=0
	ENDIF 		
ELSE
	=MESSAGEBOX("No se logro ubicar los archivos del ultimo periodo abierto")
	RETURN .f.
ENDIF

USE IN tSaldos

RETURN .t.

ENDPROC
[END METHODS]
[START RESERVED1]
Class[END RESERVED1]
[START RESERVED2]
1[END RESERVED2]
[START RESERVED3]
cantidadultima
fraccionultima
pcansumatotales
dirwebservice
*marreglomeses 
*mactivatablas 
*msetpropiedades 
*pvalidarut 
*rutina1 Rutina que permite la Adicion de un nuevo producto y su edicion en la generacion de un Documento como la Factura y la Boleta.
*rutina2 Esta Rutina llena el Cursor VisualCur que desplega los datos en los formularios de los Documentos
*pidefolio 
*crearequest 
*pconexionsql 
*menviainformaciondte 
*rutina3 Rutina que adiciona un producto a la Tabla de ITEMCur al momento de Recuperar los datos de un Documento X para una Nota de Credito apuntada.
*rutina4 Rutina que exporta el XML pero lo arma rusticamente linea por linea para la Facturacion Electronica
*pextraedatosemisor 
*rutina5 Rutina de Exportacion del XML que precisa el sistema de Facturacion Electronica pero en la Modalidad TextMerge
*rutina6 Esta Rutina Actualiza un Item de Producto en una Nota de Credito ya que solo actualiza al Item y no asi a los Descuentos, ya que estos se mantienen
*rutina8 
*pcreacursores 
*pdetalledescuento 
*saldoultimoproducto 
*rutina9 
*penviadte 
*precuperaivapordefecto 
*pfiltraespeciales 
*prutempresa 
*pseleccionasignumero 
*paccededatosarreglo 
*menviafechastandar 
*mredondeo 
*psumacabecera 
*pverificasaldosreales 
*pdevuelvesaldostemporales 
*pfoliosrestantes 
*pdocumentoreferencia 
*rutina10 Es la que carga  los datos de un documento  a la grilla visual en el Formulario de Anulacion Total de Documentos
*rutina12 
*rutina13 
*pseleccionaorden 
*pverificaestructurasenviodte 
*mcargadatoscliente 
*rutina14 
*pselsignumc 
*parmaxmlventas 
*parmaxmlcompras 
*padicionalibro 
*rutina9c 
*rutina8c 
*rutina6c 
*rutina3c 
*rutina2c 
*rutina1c 
*pdocrefc 
*rutina9v 
*pactualizaedosii 
*pfiltradocedo Esta Rutina Filtra los Documentos que se encuentran y sus distintos estados y los resume en un cursor que contiene los tipos de documentos agrupados. 
*pseldocedo 
*pextraeimpresorasservidor 
*penviadteimpresoras 
*pimpresionelec 
*pactivaimpresion 
*pactivaparametrosiniciales 
*paceptarecorrido 
*pverificavalidezdocsii 
*pactivainicialescompra 
*backuprutina1c 
*pcalculadscreccab 
*pcalculaiad 
*pcreacursoresc 
*muestraform 
*pfiltradocedoc 
*pseldocedoc 
*pactualizaedosiic 
*pcmbpmc 
*penviaxmlreceptorelec 
*pcalculadscreccabv 
*pgeneravectordscreccab 
*pcalculadscreccabdev 
*mredondeo2 
*pgenerasabana 
*pgrabalogerror 
*pimpresioseriadaelectronica 
*rutina1_2dafase 
*rutina1_1rafase 
*rutina1_4tafase 
*mgeneravectordscreccab 
*rutina1_5tafase 
*pcalculatotalescompra 
*pselsignumc_neo 
*pidefolioc 
*penviadte_emitidasterceros 
*pimpresionelec_compras 
[END RESERVED3]
[START RESERVED6]
Pixels[END RESERVED6]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[OBJNAME] facturador

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] commandbutton
[BASECLASS] commandbutton
[OBJNAME] botonespos
[START PROPERTIES]
Height = 27
Width = 84
Caption = "Command1"
codigofamilia = .F.
Name = "botonespos"
[END PROPERTIES]
[START RESERVED1]
Class[END RESERVED1]
[START RESERVED2]
1[END RESERVED2]
[START RESERVED3]
codigofamilia
[END RESERVED3]
[START RESERVED6]
Pixels[END RESERVED6]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[OBJNAME] botonespos
[START PROPERTIES]
Arial, 0, 9, 5, 15, 12, 32, 3, 0
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3SU0Q4HAQ
[CLASS] custom
[BASECLASS] custom
[OBJNAME] generaprecio
[START PROPERTIES]
codigoproducto = 0
descuentoseleccionado = 0
precioseleccionado = 
detalleproducto = .F.
fechaproc = .F.
listaprecio = 
Name = "generaprecio"
[END PROPERTIES]
[START METHODS]
PROCEDURE pgeneraprecio
IF VAL(This.CodigoProducto)=0 THEN
	RETURN .f.
ENDIF

IF !USED("Producto") THEN
	RETURN .f.
ENDIF

STORE 0 TO vMontoFlete, vMontoIla, vPorcentajeIla, vPrecioSeleccionado, vPrecioFinal, vDescuento

SELECT Producto
SET ORDER TO 1
SEEK(This.CodigoProducto)
IF FOUND() THEN
	SELECT prprm
	GO Top
	DO CASE
		CASE This.ListaPrecio=1
			vPrecioSeleccionado=Producto.Prec1/IIF(Producto.UnixEnv=0,1,Producto.UnixEnv)
		CASE This.ListaPrecio=1
			vPrecioSeleccionado=Producto.Prec2/IIF(Producto.UnixEnv=0,1,Producto.UnixEnv)
		CASE This.ListaPrecio=1
			vPrecioSeleccionado=Producto.Prec3/IIF(Producto.UnixEnv=0,1,Producto.UnixEnv)
	ENDCASE 						

	IF prPrm.paConIva1="S"
		vPrecioFinal=vPrecioSeleccionado
	ELSE
		IF Producto.DesctoMax>0 THEN
			IF This.FechaProc>=Producto.FecDesIni .and. This.FechaProc<=Producto.FecDesFin THEN
				vDescuento=Producto.DesctoMax
				vPrecioSeleccionado=vPrecioSeleccionado-ROUND((vPrecioSeleccionado*vDescuento)/100,0)
			ENDIF
		ENDIF
		IF Producto.TipoFlete=1 THEN
			vMontoFlete=(vPrecioSeleccionado*Producto.Flete2)/100
		ENDIF
		IF Producto.TipoFlete=2 THEN
			vMontoFlete=Producto.Flete
		ENDIF
		vPrecioSeleccionado=vPrecioSeleccionado+vMontoFlete
		
		IF VAL(Producto.TipoIla)>0 THEN
			DO CASE
				CASE VAL(Producto.TipoIla)=1
					vPorcentajeIla=ImptoIla.Ila1
				CASE VAL(Producto.TipoIla)=2
					vPorcentajeIla=ImptoIla.Ila2
				CASE VAL(Producto.TipoIla)=3
					vPorcentajeIla=ImptoIla.Ila3
				CASE VAL(Producto.TipoIla)=4
					vPorcentajeIla=ImptoIla.Ila4
				CASE VAL(Producto.TipoIla)=5
					vPorcentajeIla=ImptoIla.Ila5
				CASE VAL(Producto.TipoIla)=6
					vPorcentajeIla=ImptoIla.Ila6
				CASE VAL(Producto.TipoIla)=7
					vPorcentajeIla=ImptoIla.Ila7
				CASE VAL(Producto.TipoIla)=8
					vPorcentajeIla=ImptoIla.Ila8
				CASE VAL(Producto.TipoIla)=9
					vPorcentajeIla=ImptoIla.Ila9
			ENDCASE
		ENDIF
		vMontoIla=(vPrecioSeleccionado*vPorcentajeIla)/100
		
		vMontoIva=(vPrecioSeleccionado*prPrm.paIva)/100
		
		vPrecioFinal=vPrecioSeleccionado+vMontoIla+vMontoIva
	ENDIF
	.PrecioSeleccionado=vPrecioFinal
	.DescuentoSeleccionado=vDescuento
	.DetalleProducto=ALLTRIM(UPPER(Producto.prDescrip))
ELSE
	.PrecioSeleccionado=0
	.DescuentoSeleccionado=0
	.DetalleProducto=""
	RETURN .f.
ENDIF 	
	
								

ENDPROC
[END METHODS]
[START RESERVED1]
Class[END RESERVED1]
[START RESERVED2]
1[END RESERVED2]
[START RESERVED3]
codigoproducto
descuentoseleccionado
precioseleccionado
detalleproducto
fechaproc
listaprecio
*pgeneraprecio 
[END RESERVED3]
[START RESERVED6]
Pixels[END RESERVED6]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[OBJNAME] generaprecio

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3SW0P321J
[CLASS] commandbutton
[BASECLASS] commandbutton
[OBJNAME] botonesmesas
[START PROPERTIES]
Height = 31
Width = 86
Caption = "Command1"
numeromesa = .F.
codigovendedor = .F.
montodeuda = .F.
tipo = .F.
Name = "botonesmesas"
[END PROPERTIES]
[START METHODS]
PROCEDURE Click
SELECT tDetCom
SET ORDER TO 1
vContadorItem=0

vNumeroComanda=""

SELECT tComanda
SET ORDER TO 2
SET NEAR ON
SEEK(This.Tipo+STR(This.NumeroMesa,3))
SET NEAR OFF
DO WHILE !EOF() .and. (tComanda.aTipPos+STR(tComanda.aNroPos,3))=(This.Tipo+STR(This.NumeroMesa,3))
	IF DELETED() then
		SKIP
		LOOP
	ENDIF
	IF ALLTRIM(tcomanda.aEdoPos)="00" THEN
		vNumeroComanda=tComanda.aIdCom
		EXIT 		
	ELSE
		vNumeroComanda=""
	ENDIF
	
	SELECT tComanda
	SKIP
ENDDO

DO FORM wListaComanda WITH This.Tipo, This.NumeroMesa, This.MontoDeuda, vCodigoVendedor, ;
						   vDetalleVendedor, vNumeroComanda


ENDPROC
[END METHODS]
[START RESERVED1]
Class[END RESERVED1]
[START RESERVED2]
1[END RESERVED2]
[START RESERVED3]
numeromesa
codigovendedor
montodeuda
tipo
[END RESERVED3]
[START RESERVED6]
Pixels[END RESERVED6]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[OBJNAME] botonesmesas
[START PROPERTIES]
Arial, 0, 9, 5, 15, 12, 32, 3, 0
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G114QEAB
[CLASS] form
[BASECLASS] form
[OBJNAME] visordocumentoscompra
[START PROPERTIES]
Top = 0
Left = 0
Height = 537
Width = 963
ShowWindow = 1
DoCreate = .T.
Caption = "Documento generado"
WindowType = 1
Themes = .F.
Name = "visordocumentoscompra"
[END PROPERTIES]
[START METHODS]
PROCEDURE Init
LPARAMETERS vpTipoDocumento, vpNumeroDocumento

IF !SEEK(vpTipoDocumento+vpNumeroDocumento, "CLIDOCTO",1) THEN
	=MESSAGEBOX("No es Posible Localizar el Documento en Historico ("+vpTipoDocumento+"-"+vpNumeroDocumento+")")
	RETURN .f.
ENDIF
SET STEP ON
*IF This.mActivaTablas(.f., CliDocto.FecFac, .t.,.t.) THEN
	
ENDPROC
[END METHODS]
[START RESERVED1]
Class[END RESERVED1]
[START RESERVED2]
59[END RESERVED2]
[START RESERVED6]
Pixels[END RESERVED6]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label1
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Documento"
Height = 17
Left = 36
Top = 36
Width = 67
Name = "Label1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 34
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label2
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Cliente"
Height = 17
Left = 36
Top = 61
Width = 41
Name = "Label2"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text2
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 57
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text2"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text3
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 229
ReadOnly = .T.
SelectOnEntry = .T.
Top = 57
Width = 364
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text3"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label3
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Fechas"
Height = 17
Left = 36
Top = 83
Width = 43
Name = "Label3"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text4
[PARENT] visordocumentoscompra
[START PROPERTIES]
Format = "D"
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 80
Width = 92
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text4"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8Z1
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text5
[PARENT] visordocumentoscompra
[START PROPERTIES]
Format = "D"
Height = 23
Left = 200
ReadOnly = .T.
SelectOnEntry = .T.
Top = 80
Width = 92
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text5"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label4
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Direccion"
Height = 17
Left = 36
Top = 106
Width = 56
Name = "Label4"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text6
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 103
Width = 482
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text6"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text7
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 96
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text7"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text8
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 216
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text8"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3SU0Q4HAQ
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text9
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 336
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text9"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZH
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text10
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 457
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text10"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZI
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text11
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 577
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text11"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text12
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 697
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text12"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label5
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "SubTotal"
Height = 17
Left = 133
Top = 492
Width = 52
Name = "Label5"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label6
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Dsctos"
Height = 17
Left = 252
Top = 492
Width = 42
Name = "Label6"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label7
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Exentos"
Height = 17
Left = 372
Top = 492
Width = 48
Name = "Label7"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label8
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Afectos"
Height = 17
Left = 494
Top = 492
Width = 46
Name = "Label8"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label9
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Adicionales"
Height = 17
Left = 602
Top = 492
Width = 68
Name = "Label9"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] label
[BASECLASS] label
[OBJNAME] Label10
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "IVA"
Height = 17
Left = 739
Top = 492
Width = 21
Name = "Label10"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZQ
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text13
[PARENT] visordocumentoscompra
[START PROPERTIES]
Alignment = 3
Value = 0
Format = "Z"
Height = 23
InputMask = "999,999,999,999"
Left = 816
ReadOnly = .T.
SelectOnEntry = .T.
Top = 468
Width = 118
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text13"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZR
[CLASS] label
[BASECLASS] label
[OBJNAME] Label11
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Total"
Height = 17
Left = 858
Top = 492
Width = 30
Name = "Label11"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZS
[CLASS] label
[BASECLASS] label
[OBJNAME] Label12
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Totales"
Height = 17
Left = 33
Top = 472
Width = 44
Name = "Label12"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZT
[CLASS] grid
[BASECLASS] grid
[OBJNAME] Grid1
[PARENT] visordocumentoscompra
[START PROPERTIES]
ColumnCount = 9
FontSize = 8
DeleteMark = .F.
Height = 259
Left = 30
Panel = 1
ReadOnly = .T.
RecordSource = ""
RowHeight = 17
Top = 197
Width = 903
GridLineColor = 192,192,192
Name = "Grid1"
Column1.FontSize = 8
Column1.ControlSource = ""
Column1.Width = 36
Column1.ReadOnly = .T.
Column1.Name = "Column1"
Column2.FontSize = 8
Column2.ControlSource = ""
Column2.Width = 92
Column2.ReadOnly = .T.
Column2.Name = "Column2"
Column3.FontSize = 8
Column3.ControlSource = ""
Column3.Width = 290
Column3.ReadOnly = .T.
Column3.Name = "Column3"
Column4.FontSize = 8
Column4.ControlSource = ""
Column4.Width = 34
Column4.ReadOnly = .T.
Column4.Name = "Column4"
Column5.FontSize = 8
Column5.ControlSource = ""
Column5.ReadOnly = .T.
Column5.Name = "Column5"
Column6.FontSize = 8
Column6.ControlSource = ""
Column6.Width = 60
Column6.ReadOnly = .T.
Column6.Name = "Column6"
Column7.FontSize = 8
Column7.ControlSource = ""
Column7.ReadOnly = .T.
Column7.Name = "Column7"
Column8.FontSize = 8
Column8.ControlSource = ""
Column8.Width = 57
Column8.ReadOnly = .T.
Column8.Name = "Column8"
Column9.FontSize = 8
Column9.ControlSource = ""
Column9.Width = 82
Column9.ReadOnly = .T.
Column9.Name = "Column9"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZW
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column1
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Linea"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZX
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column1
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZY
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column2
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "CodPro"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U8ZZ
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column2
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U900
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column3
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Detalle"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U901
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column3
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U902
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column4
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "UM"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U903
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column4
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U904
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column5
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Cant."
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U905
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column5
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U906
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column6
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Fra."
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U907
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column6
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U908
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column7
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Valor"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U909
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column7
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90A
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column8
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "% Dscto"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90B
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column8
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90C
[CLASS] header
[BASECLASS] header
[OBJNAME] Header1
[PARENT] visordocumentoscompra.Grid1.Column9
[START PROPERTIES]
FontSize = 8
Alignment = 2
Caption = "Total"
Name = "Header1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90D
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text1
[PARENT] visordocumentoscompra.Grid1.Column9
[START PROPERTIES]
FontSize = 8
BorderStyle = 0
Margin = 0
ReadOnly = .T.
ForeColor = 0,0,0
BackColor = 255,255,255
Name = "Text1"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label13
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Dsc.Cab."
Height = 17
Left = 612
Top = 57
Width = 52
Name = "Label13"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text14
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 674
ReadOnly = .T.
SelectOnEntry = .T.
Top = 54
Width = 92
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text14"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label14
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Con.Pago"
Height = 17
Left = 613
Top = 80
Width = 56
Name = "Label14"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text15
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 674
ReadOnly = .T.
SelectOnEntry = .T.
Top = 77
Width = 165
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text15"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label15
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Vendedor"
Height = 17
Left = 37
Top = 130
Width = 57
Name = "Label15"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text16
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 127
Width = 239
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text16"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label16
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Bodega"
Height = 17
Left = 613
Top = 103
Width = 45
Name = "Label16"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90I
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text17
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 674
ReadOnly = .T.
SelectOnEntry = .T.
Top = 100
Width = 165
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text17"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _3ST11DOFK
[CLASS] label
[BASECLASS] label
[OBJNAME] Label17
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "L. Precios"
Height = 17
Left = 613
Top = 129
Width = 59
Name = "Label17"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] RESERVED  
[CLASS] optiongroup
[BASECLASS] optiongroup
[OBJNAME] Optiongroup1
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
ButtonCount = 3
Value = 1
Enabled = .F.
Height = 27
Left = 674
Top = 124
Width = 89
Name = "Optiongroup1"
Option1.Caption = "1"
Option1.Value = 1
Option1.Height = 17
Option1.Left = 5
Option1.Style = 0
Option1.Top = 5
Option1.Width = 25
Option1.AutoSize = .F.
Option1.Name = "Option1"
Option2.Caption = "2"
Option2.Height = 17
Option2.Left = 32
Option2.Style = 0
Option2.Top = 5
Option2.Width = 25
Option2.AutoSize = .F.
Option2.Name = "Option2"
Option3.Caption = "3"
Option3.Height = 17
Option3.Left = 59
Option3.Style = 0
Option3.Top = 5
Option3.Width = 25
Option3.AutoSize = .F.
Option3.Name = "Option3"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90M
[CLASS] label
[BASECLASS] label
[OBJNAME] Label18
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Doc. Afecto"
Height = 17
Left = 36
Top = 165
Width = 67
Name = "Label18"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90N
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text18
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 108
ReadOnly = .T.
SelectOnEntry = .T.
Top = 162
Width = 239
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text18"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90O
[CLASS] label
[BASECLASS] label
[OBJNAME] Label19
[PARENT] visordocumentoscompra
[START PROPERTIES]
AutoSize = .T.
FontBold = .T.
BackStyle = 0
Caption = "Tipo.Rev."
Height = 17
Left = 356
Top = 165
Width = 53
Name = "Label19"
[END PROPERTIES]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _4G116U90P
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] Text19
[PARENT] visordocumentoscompra
[START PROPERTIES]
Height = 23
Left = 413
ReadOnly = .T.
SelectOnEntry = .T.
Top = 162
Width = 176
DisabledBackColor = 255,255,255
DisabledForeColor = 0,0,0
Name = "Text19"
[END PROPERTIES]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[OBJNAME] visordocumentoscompra
[START PROPERTIES]
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 0, 8, 5, 14, 11, 29, 3, 0
[END PROPERTIES]
[EOF]
